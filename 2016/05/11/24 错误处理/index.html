<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    
    <title>24 错误处理 | Sean</title>
    <meta name="renderer" content="webkit">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta name="description" content="do things for fun">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="24 错误处理 | Sean">
    <meta name="twitter:description" content="do things for fun">

    <meta property="og:type" content="article">
    <meta property="og:title" content="24 错误处理 | Sean">
    <meta property="og:description" content="do things for fun">

    
    <meta name="author" content="Sean">
    
    <link rel="stylesheet" href="/css/vno.css">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css">

    
    <link rel="icon" href="/images/sean.png">
    

    <meta name="generator" content="hexo"/>
    

    <link rel="canonical" href="http://laputa-er.github.io/2016/05/11/24 错误处理/"/>

    
</head>

<body class="home-template no-js">

    <span class="mobile btn-mobile-menu">
        <i class="fa fa-list btn-mobile-menu__icon"></i>
        <i class="fa fa-angle-up btn-mobile-close__icon hidden"></i>
    </span>
    
<header class="panel-cover panel-cover--collapsed" style="background-image: url(/images/mengxiang.jpg)">
  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
      <span class="panel-arrow panel-left-arrow disabled">
        <i class="fa fa-angle-left"></i>
      </span>
      <span class="panel-arrow panel-right-arrow">
        <i class="fa fa-angle-right"></i>
      </span>

      <div class="panel-animation-container">
        <div class="panel-content panel-main__content">
            <a href="/" title="前往 Sean 的主页"><img src="/images/sean.png" width="80" alt="Sean logo" class="panel-cover__logo logo" /></a>
            <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage for Sean">Sean</a></h1>
            
            <span class="panel-cover__subtitle panel-subtitle">笔记分享</span>
            
            <hr class="panel-cover__divider" />
            <p class="panel-cover__description">整理了一批过去一段时间ios相关的笔记，其它的笔记也整理下？源码分享出来？再说吧...反正也只有自己会看吧...</p>
            <hr class="panel-cover__divider panel-cover__divider--secondary" />

            <div class="navigation-wrapper">
              <div>
              <nav class="cover-navigation cover-navigation--primary">
                <ul class="navigation">
                  <li class="navigation__item"><a href="/#blog" title="访问笔记" class="blog-button">笔记</a></li>
                  <li style="display: none;">
                    <textarea>
                      
                        <li class="navigation__item"><a href="/projects">项目作品</a></li>
                      
                        <li class="navigation__item"><a href="/aboutme">关于我</a></li>
                      
                    </textarea>
                  </li>
                </ul>
              </nav>
              </div>
              <div>
              <nav class="cover-navigation navigation--social">
  <ul class="navigation">

  <!-- Weibo-->
  

  <!-- Github -->
  

<!-- Stack Overflow -->
        

  <!-- Google Plus -->
  

<!-- Facebook -->

  
<!-- Twitter -->

  



  </ul>
</nav>

              </div>
            </div>

          </div>
          <div class="panel-content panel-tagcloud_content">
            
              <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">笔记分类</h3>
    <div class="widget tagcloud">
      <a href="/tags/Objective-C基础教程第二版/">Objective-C基础教程第二版</a> <a href="/tags/The-Swift-Program-Language-2/">The Swift Program Language 2</a> <a href="/tags/c语言程序设计－现代方法/">c语言程序设计－现代方法</a> <a href="/tags/iOS/">iOS</a> <a href="/tags/imooc/">imooc</a> <a href="/tags/pug/">pug</a> <a href="/tags/极客学院-ios中级/">极客学院_ios中级</a> <a href="/tags/极客学院-ios初级/">极客学院_ios初级</a> <a href="/tags/极客学院-ios高级/">极客学院_ios高级</a>
    </div>
  </div>

  
</aside>
            
          </div>
        </div>  

      </div>
      <div class="panel-cover--overlay cover-blue"></div>
  </div>
  </header>
    
    <div class="content-wrapper">
        <div class="content-wrapper__inner">
            <article class="post-container post-container--single">

  <header class="post-header">
    <div class="post-meta">
      <time datetime="2016-05-11T03:42:41.000Z" class="post-list__meta--date date">2016-05-11</time> &#8226; <span class="post-meta__tags tags">于&nbsp;
  <a class="tag-link" href="/tags/c语言程序设计－现代方法/">c语言程序设计－现代方法</a>
</span>
    </div>
    <h1 class="post-title">24 错误处理</h1>
  </header>

  <section class="post">
    <!-- Table of Contents -->
    
    <div id="top-toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#24-1-assert-h：诊断"><span class="toc-number">1.</span> <span class="toc-text">24.1    assert.h：诊断</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#assert宏（函数）"><span class="toc-number">1.0.1.</span> <span class="toc-text">assert宏（函数）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#24-2-errno-h：错误"><span class="toc-number">2.</span> <span class="toc-text">24.2    errno.h：错误</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#errno宏"><span class="toc-number">2.0.1.</span> <span class="toc-text">errno宏</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#perror函数"><span class="toc-number">2.0.2.</span> <span class="toc-text">perror函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#strerror函数"><span class="toc-number">2.0.3.</span> <span class="toc-text">strerror函数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#24-3-signal-h：信号处理"><span class="toc-number">3.</span> <span class="toc-text">24.3    signal.h：信号处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#24-3-1-信号宏"><span class="toc-number">3.1.</span> <span class="toc-text">24.3.1    信号宏</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#24-3-2-signal函数"><span class="toc-number">3.2.</span> <span class="toc-text">24.3.2    signal函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#24-3-3-预定义的信号处理函数"><span class="toc-number">3.3.</span> <span class="toc-text">24.3.3    预定义的信号处理函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SIG-DFL宏（函数）"><span class="toc-number">3.3.1.</span> <span class="toc-text">SIG_DFL宏（函数）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SIG-IGN宏（函数）"><span class="toc-number">3.3.2.</span> <span class="toc-text">SIG_IGN宏（函数）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#24-3-4-raise函数"><span class="toc-number">3.4.</span> <span class="toc-text">24.3.4    raise函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#24-3-5-程序：测试信号"><span class="toc-number">3.5.</span> <span class="toc-text">24.3.5    程序：测试信号</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#24-4-setjmp-h：非局部跳转"><span class="toc-number">4.</span> <span class="toc-text">24.4    setjmp.h：非局部跳转</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#setjmp宏（函数）"><span class="toc-number">4.1.</span> <span class="toc-text">setjmp宏（函数）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#longjmp函数"><span class="toc-number">4.2.</span> <span class="toc-text">longjmp函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#程序：测试setjmp和longjmp"><span class="toc-number">4.3.</span> <span class="toc-text">程序：测试setjmp和longjmp</span></a></li></ol></li></ol>
    </div>
    <div id="tocShell"></div>
    <div id="toc" class="toc-article">
      <div class="btn-group drag-me">
        <i class="social fa fa-ellipsis-v"></i>
      </div>
      <div class="btn-group dropup-catelog">
        <button class="btn"><i class="social fa fa-list-ol"></i></button>
        <div class="catelog-content">
          <p class="toc-title-wrap">
            <strong class="toc-title">文章目录</strong>
          </p>
          <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#24-1-assert-h：诊断"><span class="toc-number">1.</span> <span class="toc-text">24.1    assert.h：诊断</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#assert宏（函数）"><span class="toc-number">1.0.1.</span> <span class="toc-text">assert宏（函数）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#24-2-errno-h：错误"><span class="toc-number">2.</span> <span class="toc-text">24.2    errno.h：错误</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#errno宏"><span class="toc-number">2.0.1.</span> <span class="toc-text">errno宏</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#perror函数"><span class="toc-number">2.0.2.</span> <span class="toc-text">perror函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#strerror函数"><span class="toc-number">2.0.3.</span> <span class="toc-text">strerror函数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#24-3-signal-h：信号处理"><span class="toc-number">3.</span> <span class="toc-text">24.3    signal.h：信号处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#24-3-1-信号宏"><span class="toc-number">3.1.</span> <span class="toc-text">24.3.1    信号宏</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#24-3-2-signal函数"><span class="toc-number">3.2.</span> <span class="toc-text">24.3.2    signal函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#24-3-3-预定义的信号处理函数"><span class="toc-number">3.3.</span> <span class="toc-text">24.3.3    预定义的信号处理函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SIG-DFL宏（函数）"><span class="toc-number">3.3.1.</span> <span class="toc-text">SIG_DFL宏（函数）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SIG-IGN宏（函数）"><span class="toc-number">3.3.2.</span> <span class="toc-text">SIG_IGN宏（函数）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#24-3-4-raise函数"><span class="toc-number">3.4.</span> <span class="toc-text">24.3.4    raise函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#24-3-5-程序：测试信号"><span class="toc-number">3.5.</span> <span class="toc-text">24.3.5    程序：测试信号</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#24-4-setjmp-h：非局部跳转"><span class="toc-number">4.</span> <span class="toc-text">24.4    setjmp.h：非局部跳转</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#setjmp宏（函数）"><span class="toc-number">4.1.</span> <span class="toc-text">setjmp宏（函数）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#longjmp函数"><span class="toc-number">4.2.</span> <span class="toc-text">longjmp函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#程序：测试setjmp和longjmp"><span class="toc-number">4.3.</span> <span class="toc-text">程序：测试setjmp和longjmp</span></a></li></ol></li></ol>
        </div>
      </div>
    </div>
    
    <blockquote>
<p><strong>C语言的弱项：</strong>错误的检测和处理并不是c语言的强项</p>
<ul>
<li>C语言对运行时错误以多种形式表示，而没有提供一种统一的方式</li>
<li>程序员必须将检测错误的代码编写在程序代码中，因此很容易忽略一些错误</li>
</ul>
<p><strong>扩展：</strong>C++语言对C语言的这一弱点进行了改进，提供了一种新的错误错误的方式－异常处理（exception handling）。</p>
</blockquote>
<h2 id="24-1-assert-h：诊断"><a href="#24-1-assert-h：诊断" class="headerlink" title="24.1    assert.h：诊断"></a>24.1    <code>assert.h</code>：诊断</h2><h4 id="assert宏（函数）"><a href="#assert宏（函数）" class="headerlink" title="assert宏（函数）"></a>assert宏（函数）</h4><blockquote>
<p><strong>断言：</strong>一个我们认为在正常情况下一顶为真的表达式。<br><strong>错误信息：</strong>标准C要求在显示的消息中指明以下内容</p>
<ul>
<li>传递给assert函数的参数</li>
<li>包括assert调用的文件名</li>
<li>assert调用所在的行号</li>
</ul>
<p><strong>说明：</strong>检查断言，如果值不为0，会向<code>stderr</code>输出一条信息，并调用<code>abort函数</code>终止程序。<br><strong>技巧：</strong>因为引入了额外的检查，因此会增加程序的运行时间。可以在测试没问题后通过<code>NDEBUG</code>（宏）进制<code>assert</code>调用。<br><strong>注意：</strong>因为assert可能会被禁用，因此不要在assert调用中使用有副作用的表达式。<br><strong>原型</strong><code>assert.h</code></p>
</blockquote>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* @param &#123;int&#125; expresstion 断言</span><br><span class="line">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">assert</span><span class="params">(<span class="keyword">int</span> expression)</span></span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">a[i];</span><br><span class="line">assert(<span class="number">0</span> &lt;= i &amp;&amp; i &lt; N);<span class="comment">// 保证下标不回溢出</span></span><br><span class="line">a [i] = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p><em>禁止assert调用</em></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NDEBUG<span class="comment">// 值不重要，定义了就行</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br></pre></td></tr></table></figure>
<h2 id="24-2-errno-h：错误"><a href="#24-2-errno-h：错误" class="headerlink" title="24.2    errno.h：错误"></a>24.2    <code>errno.h</code>：错误</h2><blockquote>
<p><strong>说明：</strong>除了<code>EDOM</code>和<code>ERANGE</code>,还定义了其他宏，这是合法的，但命名要遵循C标准，即<code>E数组或大写字母</code></p>
</blockquote>
<h4 id="errno宏"><a href="#errno宏" class="headerlink" title="errno宏"></a>errno宏</h4><hr>
<blockquote>
<p><strong>描述：</strong>如果确实是宏，C语言标准要求它表示左值<a href="">4.2.2</a>，以便和变量一样使用。<br><strong>说明：</strong>如果确实是宏，C语言标准要求它表示左值<a href="">4.2.2</a>，以便和普通变量一样使用。<br><strong>用途：</strong>函数被调用后会会为<code>errno</code>赋值，如果<code>errno</code>不为0，代表函数调用过程中有错误发生。<br><strong>应用：</strong>大部分使用<code>errno</code>变量的函数集中在<code>math.h</code>，也有一些在标准库的其他部分。<br><strong>相关宏：</strong><code>EDOM</code>和<code>ERANGE</code>,errno中存储的值通常是这两个宏</p>
</blockquote>
<table>
<thead>
<tr>
<th>宏（errno的值）</th>
<th>错误类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>EDOM</td>
<td>定义域错误</td>
<td>传递给函数的一个参数不属于函数的定义域</td>
</tr>
<tr>
<td>ERANGE</td>
<td>取值范围错误</td>
<td>函数的返回值太大，无法用double</td>
</tr>
</tbody>
</table>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">errno = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用库函数</span></span><br><span class="line">y = <span class="built_in">sqrt</span>(x);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (errno != <span class="number">0</span>) &#123;</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"sqrt"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="perror函数"><a href="#perror函数" class="headerlink" title="perror函数"></a>perror函数</h4><hr>
<blockquote>
<p><strong>描述：</strong>向<code>stderr</code>输出一条错误信息。<br><strong>错误信息：</strong><code>sqrt error: Math argument</code>（定义域错误）</p>
</blockquote>
<table>
<thead>
<tr>
<th style="text-align:center">perror的参数</th>
<th style="text-align:center">分号</th>
<th style="text-align:center">空格</th>
<th style="text-align:center">出错消息</th>
<th style="text-align:center">换行符</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">sqrt error</td>
<td style="text-align:center">:</td>
<td style="text-align:center"></td>
<td style="text-align:center">Math argument</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>原型：</strong><code>stdio.h</code></p>
</blockquote>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* @param &#123;char *&#125; s 错误描述</span><br><span class="line">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">perror</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span></span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">errno = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用sqrt</span></span><br><span class="line">y = <span class="built_in">sqrt</span>(x);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检测运行状况</span></span><br><span class="line"><span class="keyword">if</span> (errno != <span class="number">0</span>) &#123;</span><br><span class="line">	perror(<span class="string">"sqrt error"</span>);</span><br><span class="line">	<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="strerror函数"><a href="#strerror函数" class="headerlink" title="strerror函数"></a>strerror函数</h4><hr>
<blockquote>
<p><strong>描述：</strong>根据错误类型行值返回指向错误字符串的指针。<br><strong>原型：</strong><code>string.h</code></p>
</blockquote>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* @param &#123;int&#125; errnum 错误类型值</span><br><span class="line">* @return &#123;char *&#125; 对应的错误字符串 </span><br><span class="line">*/</span></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">strerror</span><span class="params">(<span class="keyword">int</span> errnum)</span></span>;</span><br></pre></td></tr></table></figure>
<h2 id="24-3-signal-h：信号处理"><a href="#24-3-signal-h：信号处理" class="headerlink" title="24.3    signal.h：信号处理"></a>24.3    <code>signal.h</code>：信号处理</h2><blockquote>
<p><strong>信号（signal）：</strong>处理异常情况的工具</p>
<ul>
<li><p>运行时错误</p>
<blockquote>
<p>例如：除以0</p>
</blockquote>
</li>
<li><p>程序以外导致的事件</p>
<blockquote>
<p>例如：许多操作系统都允许用户终端或终止运行的程序</p>
</blockquote>
</li>
</ul>
<p><strong>异步的：</strong>它们可以在程序执行过程中的任意时刻发生，而不仅是在程序员所知道的特定时刻发生</p>
</blockquote>
<h3 id="24-3-1-信号宏"><a href="#24-3-1-信号宏" class="headerlink" title="24.3.1    信号宏"></a>24.3.1    信号宏</h3><blockquote>
<p><strong>兼容性：</strong>C标准不要求下面列表中的信号都会发生，大多数C语言的实现都至少支持其中一部分。</p>
</blockquote>
<table>
<thead>
<tr>
<th>宏名</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>SIGABRT</td>
<td>异常终止（可能由于调用abort导致）</td>
</tr>
<tr>
<td>SIGFPE</td>
<td>在数学运算中发生错误（可能是除以0或溢出）</td>
</tr>
<tr>
<td>SIGILL</td>
<td>非法指令</td>
</tr>
<tr>
<td>SIGINT</td>
<td>中断</td>
</tr>
<tr>
<td>SIGSEGV</td>
<td>非法存储访问</td>
</tr>
<tr>
<td>SIGTERM</td>
<td>终止请求</td>
</tr>
</tbody>
</table>
<h3 id="24-3-2-signal函数"><a href="#24-3-2-signal函数" class="headerlink" title="24.3.2    signal函数"></a>24.3.2    signal函数</h3><hr>
<blockquote>
<p><strong>描述：</strong>为指定信号注册指定处理函数。<br><strong>相关宏：</strong><code>SIG_ERR</code></p>
<blockquote>
<p><strong>说明：</strong>当注册失败时会返回该值<br><strong>用途：</strong>检测注册处理函数是否成功</p>
</blockquote>
<p><strong>特点</strong></p>
<blockquote>
<p><strong>多对一：</strong><code>信号</code>与处理函数是<code>多对一</code>的关系</p>
<ul>
<li>可以对多种信号绑定同一个处理函数，处理函数可以根据传入的参数（信号类型）决定进行哪种操作</li>
<li>也可以对同一个信号注册多个处理程序，但前面注册的会被后面注册的处理函数覆盖。</li>
</ul>
<p><strong>同步性：</strong>发出信号的行为是异步的，但处理函数处理的过程是同步的。也就是说，注册了处理函数的信号出现后，程序会暂停并执行信号处理函数，返回后暂停的程序从信号发生点恢复并继续执行。</p>
</blockquote>
</blockquote>
<table>
<thead>
<tr>
<th>信号</th>
<th>处理函数返回后程序行为</th>
</tr>
</thead>
<tbody>
<tr>
<td>SIGABRT</td>
<td>终止</td>
</tr>
<tr>
<td>SIGFPE</td>
<td>处理函数返回后的程序行为未定义</td>
</tr>
<tr>
<td>其它</td>
<td>暂停的程序从信号发生点恢复并继续执行</td>
</tr>
</tbody>
</table>
<blockquote>
<blockquote>
<p><strong>一次性：</strong>信号处理完之后，除非处理函数被重新注册，否则该信号不回被同一个函数处理两遍。<br><strong>无限递归问题：</strong>如果信号是由处理这个信号的函数引发的，如果没有其它机制将会发生无限递归。所以，C语言要求，除了<code>SIGTLL</code>，当一个信号的处理函数被调用时，该信号对应的处理函数要么要被重置为<code>SIG_DFL</code>或以其它方式加以封锁。</p>
</blockquote>
<p><strong>限制：</strong>处理函数和普通函数相比多了一些限制</p>
</blockquote>
<table>
<thead>
<tr>
<th>可以</th>
<th>不可以</th>
</tr>
</thead>
<tbody>
<tr>
<td>可以忽略该信号</td>
<td>自由调用库函数</td>
</tr>
<tr>
<td>执行一些错误修复</td>
<td>访问静态存储期限的变量</td>
</tr>
<tr>
<td>终止程序</td>
<td></td>
</tr>
<tr>
<td>可以调用<code>signal</code>，只要第一个参数为正被处理的信号</td>
<td></td>
</tr>
<tr>
<td>调用库函数，只要信号处理函数是由raise或abort调用的</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>原型：</strong><code>signal.h</code></p>
</blockquote>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* @param &#123;int&#125; sig 信号类型</span><br><span class="line">* @param &#123;func *&#125; func 处理函数</span><br><span class="line">* @return &#123;func *&#125; 指向注册过同样信号的上一个处理函数的指针：成功；SIG_ERR：注册失败（同时会在errno中存储一个正值）</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">void</span> *(*signal)(<span class="keyword">int</span> sig, <span class="keyword">void</span> (*func)(int));<span class="comment">// 书上写法是：void (*signal(int sig, void (*func)(int)))(int);</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 声明函数指针</span></span><br><span class="line"><span class="keyword">void</span> (*orig_handler)(<span class="keyword">int</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为中断注册处理函数，并将之前的处理函数存储下来</span></span><br><span class="line">orig_handler = signal(SIGINT, handler);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (orig_handler == SIG_ERR) &#123;</span><br><span class="line">	<span class="comment">// 注册处理函数失败</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 换成原来的处理函数</span></span><br><span class="line">signal(SIGINT, SIG_DFL);</span><br></pre></td></tr></table></figure>
<h3 id="24-3-3-预定义的信号处理函数"><a href="#24-3-3-预定义的信号处理函数" class="headerlink" title="24.3.3    预定义的信号处理函数"></a>24.3.3    预定义的信号处理函数</h3><blockquote>
<p><strong>说明：</strong>出了编写我们自己的信号处理函数，我们还可以选择使用<code>signal.h</code>提供的预定义的处理函数。<br><strong>预定义的信号处理函数命名规则：</strong></p>
<blockquote>
<p><code>SIG_</code>大写字母</p>
</blockquote>
</blockquote>
<h4 id="SIG-DFL宏（函数）"><a href="#SIG-DFL宏（函数）" class="headerlink" title="SIG_DFL宏（函数）"></a>SIG_DFL宏（函数）</h4><hr>
<blockquote>
<p><strong>说明：</strong>按“默认”的方式处理<br><strong>描述：</strong>行为由实现定义，大多数情况下会导致程序终止。<br><strong>原型：</strong><code>signal.h</code></p>
</blockquote>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* @param &#123;int&#125; signal 信号类型</span><br><span class="line">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SIG_DFL</span><span class="params">(<span class="keyword">int</span> signal)</span></span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">signal(SIGINT, SIG_IGN); <span class="comment">// 使用默认行为响应“中断”信号</span></span><br></pre></td></tr></table></figure>
<h4 id="SIG-IGN宏（函数）"><a href="#SIG-IGN宏（函数）" class="headerlink" title="SIG_IGN宏（函数）"></a>SIG_IGN宏（函数）</h4><hr>
<blockquote>
<p><strong>描述：</strong>什么都不做，忽略信号<br><strong>原型：</strong><code>signal.h</code></p>
</blockquote>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* @param &#123;int&#125; signal 信号类型</span><br><span class="line">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SIG_IGN</span><span class="params">(<span class="keyword">int</span> signal)</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="24-3-4-raise函数"><a href="#24-3-4-raise函数" class="headerlink" title="24.3.4    raise函数"></a>24.3.4    raise函数</h3><hr>
<blockquote>
<p><strong>说明：</strong>触发信号<br><strong>原型：</strong><code>signal.h</code></p>
</blockquote>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* @param &#123;int&#125; sig 信号类型</span><br><span class="line">* @return &#123;int&#125; 0：成功；非0：失败</span><br><span class="line">*/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">raise</span><span class="params">(<span class="keyword">int</span> sig)</span></span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 触发SIGABORT</span></span><br><span class="line">raise(SIGABOUT);</span><br></pre></td></tr></table></figure>
<h3 id="24-3-5-程序：测试信号"><a href="#24-3-5-程序：测试信号" class="headerlink" title="24.3.5    程序：测试信号"></a>24.3.5    程序：测试信号</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Tests signals</span><br><span class="line"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handler</span><span class="params">(<span class="keyword">int</span> sig)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">raise_sig</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 声明函数指针</span></span><br><span class="line">	<span class="keyword">void</span> (*orig_handler)(<span class="keyword">int</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*1. 第一次实验*/</span></span><br><span class="line">	<span class="comment">// 注册处理函数</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"---first--- %d\n"</span>, SIGILL);</span><br><span class="line">	signal(SIGILL, handler);</span><br><span class="line">	<span class="comment">// 触发信号</span></span><br><span class="line">	raise_sig();</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*2. 第二次实验*/</span></span><br><span class="line">	<span class="comment">// 再次注册,忽略相应信号</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"---second---\n"</span>);</span><br><span class="line">	orig_handler = signal(SIGILL, SIG_IGN);</span><br><span class="line">	raise_sig();</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*3. 第三次实验*/</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"---third---\n"</span>);</span><br><span class="line">	<span class="comment">// 更改为第一次实验使用的处理函数</span></span><br><span class="line">	signal(SIGILL, orig_handler);</span><br><span class="line">	raise_sig();</span><br><span class="line">	return <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handler</span> <span class="params">(<span class="keyword">int</span> sig)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Handler called for signal %d\n"</span>, sig);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">raise_sig</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">	raise(SIGILL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ./tsignal</span><br><span class="line"> ---first--- 4</span><br><span class="line"> Handler called <span class="keyword">for</span> signal 4</span><br><span class="line"> ---second---</span><br><span class="line"> ---third---</span><br><span class="line"> Handler called <span class="keyword">for</span> signal 4</span><br></pre></td></tr></table></figure>
<h2 id="24-4-setjmp-h：非局部跳转"><a href="#24-4-setjmp-h：非局部跳转" class="headerlink" title="24.4    setjmp.h：非局部跳转"></a>24.4    setjmp.h：非局部跳转</h2><blockquote>
<p><strong>说明：</strong>通常情况下，函数调用后会回到它被调用的位置。但<code>setjmp.h</code>提供了使一个函数直接跳转到另一个函数（而且不需要返回）的方式。<br><strong>goto：</strong>只能配合标记实现<code>局部跳转</code>，也就是在同一个函数内部跳转。</p>
</blockquote>
<h3 id="setjmp宏（函数）"><a href="#setjmp宏（函数）" class="headerlink" title="setjmp宏（函数）"></a>setjmp宏（函数）</h3><blockquote>
<p><strong>描述：</strong>标记程序中的一个“位置”<br><strong>应用：</strong>生成标记位置，稍后提供给<code>longjmp函数</code><br><strong>限制：</strong>按照<code>标准C</code>，只有两种使用setjmp的方式是合法的(否则不具备可移植性)</p>
<ul>
<li>作为表达式语句（可能会前置转换成void）</li>
<li>作为<code>if、switch、while、do、for</code>语句中控制表达式的一部分(<code>constexp</code>：计算结果为整数的<em>常量表达式</em>；<code>op</code>：<em>关系</em>或<em>判等</em>运算符)</li>
</ul>
<ol>
<li>setjmp(…)</li>
<li>!setjmp(…)</li>
<li><code>constexp</code> <code>op</code> <code>constexp</code></li>
<li>setjmp(…) <code>op</code> <code>constexp</code></li>
</ol>
<p><strong>原型：</strong><code>setjmp.h</code></p>
</blockquote>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* @param &#123;jmp_buf&#125; env 用来保存生成的被调用时所处的“位置”(数组)</span><br><span class="line">* @return &#123;int&#125; 0：第一次调用时返回；非0：longjmp将控制权重新转给最初的setjmp宏调用，后者这次的返回值非零</span><br><span class="line">*/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setjmp</span><span class="params">(jmp_buf env)</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="longjmp函数"><a href="#longjmp函数" class="headerlink" title="longjmp函数"></a>longjmp函数</h3><hr>
<blockquote>
<p><strong>描述：</strong>首先根据参数env的值恢复当前环境，然后从<code>setjmp宏</code>调用中返回<br><strong>注意：</strong>一定要确保参数env已经被<code>setjmp宏</code>初始化了，否则程序可能会崩溃。<br><strong>应用：</strong>可以由多种潜在的用途，但主要被用于错误处理。<br><strong>原型：</strong><code>setjmp.h</code></p>
</blockquote>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* @param &#123;jmp_buf&#125; env</span><br><span class="line">* @param &#123;int&#125; val</span><br><span class="line">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">longjmp</span><span class="params">(jmp_buf env, <span class="keyword">int</span> val)</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="程序：测试setjmp和longjmp"><a href="#程序：测试setjmp和longjmp" class="headerlink" title="程序：测试setjmp和longjmp"></a>程序：测试setjmp和longjmp</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Tests setjmp/longjmp</span><br><span class="line"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;setjmp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * @type &#123;jmp_buf&#125; env 存储位置数据的全局变量</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">static</span> jmp_buf env;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f1</span> <span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f2</span> <span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line">	<span class="comment">// 获得存储位置</span></span><br><span class="line">	ret = setjmp(env);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"setjmp returned %d\n"</span>, ret);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 第二次执行到这里的时候值不为0</span></span><br><span class="line">	<span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Program terminates: longjmp called\n"</span>);</span><br><span class="line">		return <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	f1();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 下面这句不会执行</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Program terminates normally\n"</span>);</span><br><span class="line">	return <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f1</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"f1 begins\n"</span>);</span><br><span class="line">	f2();</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"f1 returns\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f2</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"f2 begins\n"</span>);</span><br><span class="line">	<span class="comment">// 按照env的值跳转到指定的环境</span></span><br><span class="line">	longjmp(env, <span class="number">1</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"f2 returns\n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">$ ./tsetjmp               </span><br><span class="line"> setjmp returned <span class="number">0</span></span><br><span class="line"> f1 begins</span><br><span class="line"> f2 begins</span><br><span class="line"> setjmp returned <span class="number">1</span></span><br><span class="line"> Program terminates: longjmp called</span><br></pre></td></tr></table></figure>

  </section>

</article>


<section class="post-comments">
  <!-- 多说评论框 start -->
  <div id="ds-thread" class="ds-thread" data-thread-key="http://laputa-er.github.io/2016/05/11/24 错误处理/" data-title="24 错误处理" data-url="http://laputa-er.github.io/2016/05/11/24 错误处理/"></div>
  <!-- 多说评论框 end -->
  <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
  <script type="text/javascript">
  var duoshuoQuery = {short_name:"lapuda-er"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>
<!-- 多说公共JS代码 end -->
</section>




            <footer class="footer">
    <span class="footer__copyright">
        本站点采用<a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>
    </span>
    <span class="footer__copyright">
        基于 <a href="http://hexo.io">Hexo</a> 搭建，感谢 <a href="https://pages.github.com/">GitHub Pages</a> 提供免费的托管服务
    </span>
    <span class="footer__copyright">
        &copy; 2016 - 
        本站修改自<a href="https://github.com/lenbo-ma/hexo-theme-vno" target="_blank">hexo-theme-vno</a>
    </span>
</footer>

        </div>
    </div>

    <script src="http://cdn.bootcss.com/jquery/2.1.4/jquery.min.js"></script>
    <script src="/js/main.js"></script>

     
</body>
</html>
