<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="MongoDB,nodejs," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="网址
0 课程介绍实战项目

环境和工具
课程步骤

重要知识点☑ 域名和服务器选购备案
☑ 域名 IP 解析指向
☑ 服务器远程链接与系统权限
☑ NodeJS 生产环境搭建
☑ MongoDB 数据库安装配置备份前一
☑ 单主机 Nginx 多端口映射多个应用
☑ 项目仓库代码从本地到线上同步
☑Nodejs 项目更新发布与进程守护
☑ …
最终效果
1 课程预热1.1 为什么是全栈最后一公里">
<meta property="og:type" content="article">
<meta property="og:title" content="NodeJS线上服务器部署与发布">
<meta property="og:url" content="http://laputa-er.github.io/2017/04/22/慕课网/imooc_NodeJS 线上服务器部署与发布/index.html">
<meta property="og:site_name" content="Sean">
<meta property="og:description" content="网址
0 课程介绍实战项目

环境和工具
课程步骤

重要知识点☑ 域名和服务器选购备案
☑ 域名 IP 解析指向
☑ 服务器远程链接与系统权限
☑ NodeJS 生产环境搭建
☑ MongoDB 数据库安装配置备份前一
☑ 单主机 Nginx 多端口映射多个应用
☑ 项目仓库代码从本地到线上同步
☑Nodejs 项目更新发布与进程守护
☑ …
最终效果
1 课程预热1.1 为什么是全栈最后一公里">
<meta property="og:image" content="http://o6ul1xz4z.bkt.clouddn.com/2017-04-22-3FD89E7B-FC0E-4B84-89B7-502E642CB745.png">
<meta property="og:image" content="http://o6ul1xz4z.bkt.clouddn.com/2017-04-22-0BD1730A-1F74-4203-A5EB-A9BFF8BCB92E.png">
<meta property="og:image" content="http://o6ul1xz4z.bkt.clouddn.com/2017-04-22-3A533661-987A-443A-8F7A-9BE227D19B8F.png">
<meta property="og:image" content="http://o6ul1xz4z.bkt.clouddn.com/2017-04-22-AA7D06D7-76C7-4058-B593-3ECE38FC6C24.png">
<meta property="og:image" content="http://o6ul1xz4z.bkt.clouddn.com/2017-04-22-947E24CE-F03B-4CDD-8519-5D4EE7EFCAC1.png">
<meta property="og:image" content="http://o6ul1xz4z.bkt.clouddn.com/2017-04-22-65CB39FB-0290-47F9-A838-03FF523FCAC2.png">
<meta property="og:image" content="http://o6ul1xz4z.bkt.clouddn.com/2017-04-23-0B4E68B4-15DB-4845-A430-B445A0753AD2.png">
<meta property="og:image" content="http://o6ul1xz4z.bkt.clouddn.com/2017-04-23-A77C3832-A33F-4071-B632-6F356E426F82.png">
<meta property="og:image" content="http://o6ul1xz4z.bkt.clouddn.com/2017-04-23-6FD47491-4730-4E0D-881D-C0E2A5CEF8A0.png">
<meta property="og:image" content="http://o6ul1xz4z.bkt.clouddn.com/2017-04-23-88DC5498-2EA6-49DB-BE68-3E0B3EE6977F.png">
<meta property="og:image" content="http://o6ul1xz4z.bkt.clouddn.com/2017-04-23-2873AE79-479D-467F-8FFF-90F87AC33C87.png">
<meta property="og:image" content="http://o6ul1xz4z.bkt.clouddn.com/2017-04-23-0FDFDC79-8AAE-42F3-93E5-6748F2F0AFE0.png">
<meta property="og:image" content="http://o6ul1xz4z.bkt.clouddn.com/2017-04-24-7A834090-215B-421E-89F4-9D8D2221407B.png">
<meta property="og:image" content="http://o6ul1xz4z.bkt.clouddn.com/2017-04-24-9187181B-E182-482B-BE3C-69022E8E34B1.png">
<meta property="og:image" content="http://o6ul1xz4z.bkt.clouddn.com/2017-04-26-FD361328-37D6-41F4-81DD-EFD7B1775F3A.png">
<meta property="og:image" content="http://o6ul1xz4z.bkt.clouddn.com/2017-04-30-8782E41E-3983-4F69-A558-820E5D7B90CE.png">
<meta property="og:image" content="http://o6ul1xz4z.bkt.clouddn.com/2017-04-30-D77D9188-AC9B-4A2E-AB09-1481B359BB5B.png">
<meta property="og:image" content="http://o6ul1xz4z.bkt.clouddn.com/2017-05-01-77C5FC78-04E7-42EB-93A4-94BF00F698C0.png">
<meta property="og:image" content="http://o6ul1xz4z.bkt.clouddn.com/2017-05-01-D8174179-AE4F-4C2A-8097-9752AB6FB211.png">
<meta property="og:image" content="http://o6ul1xz4z.bkt.clouddn.com/2017-05-05-3315EC54-A689-41E9-AE53-CE84CE12E99A.png">
<meta property="og:image" content="http://o6ul1xz4z.bkt.clouddn.com/2017-05-06-578BF6DF-6610-4D46-ABE5-68140E9535A6.png">
<meta property="og:image" content="http://laputa-er.github.io/./_image/2017-05-06-23-24-45.jpg">
<meta property="og:image" content="http://laputa-er.github.io/./_image/2017-05-06-23-26-55.jpg">
<meta property="og:image" content="http://laputa-er.github.io/./_image/2017-05-06-23-28-06.jpg">
<meta property="og:image" content="http://laputa-er.github.io/./_image/2017-05-06-23-29-16.jpg">
<meta property="og:image" content="http://laputa-er.github.io/./_image/2017-05-06-23-30-31.jpg">
<meta property="og:image" content="http://laputa-er.github.io/./_image/2017-05-06-23-35-50.jpg">
<meta property="og:image" content="http://laputa-er.github.io/./_image/2017-05-06-23-37-30.jpg">
<meta property="og:image" content="http://laputa-er.github.io/./_image/2017-05-06-23-40-37.jpg">
<meta property="og:image" content="http://laputa-er.github.io/./_image/2017-05-07-00-47-02.jpg">
<meta property="og:image" content="http://laputa-er.github.io/./_image/2017-05-06-23-52-22.jpg">
<meta property="og:updated_time" content="2017-05-10T07:54:58.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="NodeJS线上服务器部署与发布">
<meta name="twitter:description" content="网址
0 课程介绍实战项目

环境和工具
课程步骤

重要知识点☑ 域名和服务器选购备案
☑ 域名 IP 解析指向
☑ 服务器远程链接与系统权限
☑ NodeJS 生产环境搭建
☑ MongoDB 数据库安装配置备份前一
☑ 单主机 Nginx 多端口映射多个应用
☑ 项目仓库代码从本地到线上同步
☑Nodejs 项目更新发布与进程守护
☑ …
最终效果
1 课程预热1.1 为什么是全栈最后一公里">
<meta name="twitter:image" content="http://o6ul1xz4z.bkt.clouddn.com/2017-04-22-3FD89E7B-FC0E-4B84-89B7-502E642CB745.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://laputa-er.github.io/2017/04/22/慕课网/imooc_NodeJS 线上服务器部署与发布/"/>

  <title> NodeJS线上服务器部署与发布 | Sean </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?898688f51c5a3d6b37dd23e04441e5bd";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Sean</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">笔记分享</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                NodeJS线上服务器部署与发布
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-04-22T10:52:35+08:00" content="2017-04-22">
              2017-04-22
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/慕课网学习笔记/" itemprop="url" rel="index">
                    <span itemprop="name">慕课网学习笔记</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/04/22/慕课网/imooc_NodeJS 线上服务器部署与发布/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/04/22/慕课网/imooc_NodeJS 线上服务器部署与发布/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><a href="http://coding.imooc.com/class/95.html" target="_blank" rel="external">网址</a></p>
<h1 id="0-课程介绍"><a href="#0-课程介绍" class="headerlink" title="0 课程介绍"></a>0 课程介绍</h1><h2 id="实战项目"><a href="#实战项目" class="headerlink" title="实战项目"></a>实战项目</h2><p><img src="http://o6ul1xz4z.bkt.clouddn.com/2017-04-22-3FD89E7B-FC0E-4B84-89B7-502E642CB745.png" alt="3FD89E7B-FC0E-4B84-89B7-502E642CB745"></p>
<p><img src="http://o6ul1xz4z.bkt.clouddn.com/2017-04-22-0BD1730A-1F74-4203-A5EB-A9BFF8BCB92E.png" alt="0BD1730A-1F74-4203-A5EB-A9BFF8BCB92E"></p>
<h2 id="环境和工具"><a href="#环境和工具" class="headerlink" title="环境和工具"></a>环境和工具</h2><p><img src="http://o6ul1xz4z.bkt.clouddn.com/2017-04-22-3A533661-987A-443A-8F7A-9BE227D19B8F.png" alt="3A533661-987A-443A-8F7A-9BE227D19B8F"></p>
<h2 id="课程步骤"><a href="#课程步骤" class="headerlink" title="课程步骤"></a>课程步骤</h2><p><img src="http://o6ul1xz4z.bkt.clouddn.com/2017-04-22-AA7D06D7-76C7-4058-B593-3ECE38FC6C24.png" alt="AA7D06D7-76C7-4058-B593-3ECE38FC6C24"></p>
<hr>
<h2 id="重要知识点"><a href="#重要知识点" class="headerlink" title="重要知识点"></a>重要知识点</h2><p>☑ 域名和服务器选购备案</p>
<p>☑ 域名 IP 解析指向</p>
<p>☑ 服务器远程链接与系统权限</p>
<p>☑ NodeJS 生产环境搭建</p>
<p>☑ MongoDB 数据库安装配置备份前一</p>
<p>☑ 单主机 Nginx 多端口映射多个应用</p>
<p>☑ 项目仓库代码从本地到线上同步</p>
<p>☑Nodejs 项目更新发布与进程守护</p>
<p>☑ …</p>
<h2 id="最终效果"><a href="#最终效果" class="headerlink" title="最终效果"></a>最终效果</h2><p><img src="http://o6ul1xz4z.bkt.clouddn.com/2017-04-22-947E24CE-F03B-4CDD-8519-5D4EE7EFCAC1.png" alt="947E24CE-F03B-4CDD-8519-5D4EE7EFCAC1"></p>
<h1 id="1-课程预热"><a href="#1-课程预热" class="headerlink" title="1 课程预热"></a>1 课程预热</h1><h2 id="1-1-为什么是全栈最后一公里"><a href="#1-1-为什么是全栈最后一公里" class="headerlink" title="1.1 为什么是全栈最后一公里"></a>1.1 为什么是全栈最后一公里</h2><h2 id="1-2-搭建线上生产环境需要做什么"><a href="#1-2-搭建线上生产环境需要做什么" class="headerlink" title="1.2 搭建线上生产环境需要做什么"></a>1.2 搭建线上生产环境需要做什么</h2><p>☑ 购买自己的域名</p>
<p>☑ 购买自己的服务器</p>
<p>☑ 域名备案</p>
<p>☑ 配置服务器应用环境</p>
<p>☑ 安装配置数据库</p>
<p>☑ 项目远程部署发布与更新</p>
<h1 id="2-待部署的-5-个本地-Nodejs-项目"><a href="#2-待部署的-5-个本地-Nodejs-项目" class="headerlink" title="2 待部署的 5 个本地 Nodejs 项目"></a>2 待部署的 5 个本地 Nodejs 项目</h1><h2 id="2-1-快速搭建一个纯静态简易站点"><a href="#2-1-快速搭建一个纯静态简易站点" class="headerlink" title="2.1 快速搭建一个纯静态简易站点"></a>2.1 快速搭建一个纯静态简易站点</h2><p><a href="https://coding.net/u/eli01/p/imooc_nodejs_deploy/git/tree/master/website" target="_blank" rel="external">https://coding.net/u/eli01/p/imooc_nodejs_deploy/git/tree/master/website</a></p>
<p>/app.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"><span class="keyword">const</span> homePage = <span class="string">`</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;meta charset='utf-8'&gt;</span><br><span class="line">    &lt;title&gt;Nodejs 部署上线示例&lt;/title&gt;</span><br><span class="line">    &lt;style type="text/css"&gt;</span><br><span class="line">      * &#123;</span><br><span class="line">        padding: 0;</span><br><span class="line">        margin: 0;</span><br><span class="line">      &#125;</span><br><span class="line">      body &#123;</span><br><span class="line">        padding: 30px 0;</span><br><span class="line">        text-align: center;</span><br><span class="line">        font-size: 16px;</span><br><span class="line">        background-color: #333;</span><br><span class="line">      &#125;</span><br><span class="line">      h1, h2 &#123;</span><br><span class="line">        color: #fff;</span><br><span class="line">      &#125;</span><br><span class="line">      nav &#123;</span><br><span class="line">        margin-top: 20px;</span><br><span class="line">      &#125;</span><br><span class="line">      a &#123;</span><br><span class="line">        color: #ccc;</span><br><span class="line">        text-decoration: none;</span><br><span class="line">      &#125;</span><br><span class="line">      a:hover &#123;</span><br><span class="line">        text-decoration: underline;</span><br><span class="line">      &#125;</span><br><span class="line">    &lt;/style&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;h1&gt;慕课网 Nodejs 高级课程&lt;/h1&gt;</span><br><span class="line">    &lt;h2&gt;项目部署上线示例&lt;/h2&gt;</span><br><span class="line">    &lt;nav&gt;</span><br><span class="line">      &lt;ul&gt;</span><br><span class="line">        &lt;li&gt;&lt;a href="" target="_blank",href="/a"&gt;Nodejs 电影网站&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">        &lt;li&gt;&lt;a href="" target="_blank",href="/a"&gt;狗狗说 App 后台&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">        &lt;li&gt;&lt;a href="" target="_blank",href="/a"&gt;微信小程序后台&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">        &lt;li&gt;&lt;a href="" target="_blank",href="/a"&gt;微信公众号后台&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">      &lt;/ul&gt;</span><br><span class="line">    &lt;/nav&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">`</span></span><br><span class="line">http.createServer((req, res) =&gt; &#123;</span><br><span class="line">  res.statusCode =</span><br><span class="line">  $  res.setHeader(<span class="string">'Content-Type'</span>, <span class="string">'text/html'</span>)</span><br><span class="line">  res.end(homePage)</span><br><span class="line">&#125;)</span><br><span class="line">.listen(<span class="number">3000</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Server Running At 3000'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><strong>启动服务</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ node app.js</span><br></pre></td></tr></table></figure>
<p><strong>浏览</strong></p>
<p><img src="http://o6ul1xz4z.bkt.clouddn.com/2017-04-22-65CB39FB-0290-47F9-A838-03FF523FCAC2.png" alt="65CB39FB-0290-47F9-A838-03FF523FCAC2"></p>
<h2 id="2-2-Nodejs-电影网站项目上线准备"><a href="#2-2-Nodejs-电影网站项目上线准备" class="headerlink" title="2.2 Nodejs 电影网站项目上线准备"></a>2.2 Nodejs 电影网站项目上线准备</h2><p><strong>使用老课程里的一个项目-电影网站项目</strong></p>
<p><a href="http://www.imooc.com/learn/197" target="_blank" rel="external">课程地址</a></p>
<p><a href="https://coding.net/u/eli01/p/imooc_nodejs_deploy/git/tree/master/movie" target="_blank" rel="external">源码</a></p>
<h3 id="2-2-1-升级下老旧的模块"><a href="#2-2-1-升级下老旧的模块" class="headerlink" title="2.2.1 升级下老旧的模块"></a>2.2.1 升级下老旧的模块</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先升级个别模块</span></span><br><span class="line">$ npm --registry=https://registry.npm.taobao.org install bcrypt@0.8.7 --save</span><br><span class="line">$ npm --registry=https://registry.npm.taobao.org install jade@1.11.0 --save</span><br><span class="line">$ npm --registry=https://registry.npm.taobao.org install mongoose@4.8.2 --save</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再安装其它模块</span></span><br><span class="line">$ npm --registry=https://registry.npm.taobao.org install</span><br></pre></td></tr></table></figure>
<h3 id="2-2-2-mongodb"><a href="#2-2-2-mongodb" class="headerlink" title="2.2.2 mongodb"></a>2.2.2 mongodb</h3><p>一言难尽，瞎折腾了一下，废了一整天的时间。</p>
<p>☑ 树莓派上尝试安装别人编译的，结果会报错。</p>
<p>☑ 我的 vps (centos 6.7 32位)上尝试安装 monggoDB，结果 mongoDB 官方没提供 32 位版本。</p>
<p>最后在本地机器上安装了 Archlinux 虚拟机，使用 pacman 安装 mongoDB。</p>
<h4 id="安装-mongoDB"><a href="#安装-mongoDB" class="headerlink" title="安装 mongoDB"></a>安装 mongoDB</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo pacman -S mongodb</span><br><span class="line">$ sudo pacman -S mongodb-tools</span><br><span class="line">$ sudo systemctl <span class="built_in">enable</span> mongodb</span><br></pre></td></tr></table></figure>
<h4 id="设置-mongoDB"><a href="#设置-mongoDB" class="headerlink" title="设置 mongoDB"></a>设置 mongoDB</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/mongodb.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># See http://www.mongodb.org/display/DOCS/File+Based+Configuration for format details</span></span><br><span class="line"><span class="comment"># Run mongod --help to see a list of options</span></span><br><span class="line"><span class="comment">#auth = true</span></span><br><span class="line"><span class="comment">#bind_ip = 192.168.11.169 </span></span><br><span class="line">quiet = <span class="literal">true</span></span><br><span class="line">dbpath = /var/lib/mongodb</span><br><span class="line">logpath = /var/<span class="built_in">log</span>/mongodb/mongod.log</span><br><span class="line">logappend = <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h4 id="设置用户"><a href="#设置用户" class="headerlink" title="设置用户"></a>设置用户</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ mongo</span><br><span class="line"><span class="comment"># 切换到 movies 数据库</span></span><br><span class="line">&gt; use movies</span><br><span class="line">switched to db movies</span><br><span class="line"></span><br><span class="line"><span class="comment"># 给 movies 数据库创建一个新用户</span></span><br><span class="line">&gt; db.createUser(&#123;user:<span class="string">"neo"</span>, <span class="built_in">pwd</span>:<span class="string">"xxx"</span>,roles:[&#123;role:<span class="string">"dbAdmin"</span>,db:<span class="string">"movies"</span>&#125;]&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="启动-amp-amp-关闭-amp-amp-远程登录"><a href="#启动-amp-amp-关闭-amp-amp-远程登录" class="headerlink" title="启动 &amp;&amp; 关闭 &amp;&amp; 远程登录"></a>启动 &amp;&amp; 关闭 &amp;&amp; 远程登录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动</span></span><br><span class="line">$ sudo systemctl start mongodb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭</span></span><br><span class="line">$ sudo systemctl stop mongodb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 远程登录</span></span><br><span class="line">$ mongo -u neo -p xxx --authenticationDatabase movies --host [IP 地址]</span><br></pre></td></tr></table></figure>
<h3 id="2-2-3-项目修改并测试"><a href="#2-2-3-项目修改并测试" class="headerlink" title="2.2.3 项目修改并测试"></a>2.2.3 项目修改并测试</h3><h4 id="本地启动"><a href="#本地启动" class="headerlink" title="本地启动"></a>本地启动</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> imooc_nodejs_deploy/movie</span><br><span class="line">$ grunt</span><br></pre></td></tr></table></figure>
<h4 id="浏览"><a href="#浏览" class="headerlink" title="浏览"></a>浏览</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># 首页</span></span><br><span class="line">/admin/user/list <span class="comment"># 用户列表页(只有超级用户能够进入这个页面)</span></span><br><span class="line">/admin/movie/new <span class="comment"># 后台录入页</span></span><br><span class="line">/movie/[ID] <span class="comment"># 详情页, 比如 http://localhost:3000/movie/58fcce8faf5c603f4c3e77b5</span></span><br></pre></td></tr></table></figure>
<p><strong>首页</strong></p>
<p><img src="http://o6ul1xz4z.bkt.clouddn.com/2017-04-23-0B4E68B4-15DB-4845-A430-B445A0753AD2.png" alt="0B4E68B4-15DB-4845-A430-B445A0753AD2"></p>
<p><img src="http://o6ul1xz4z.bkt.clouddn.com/2017-04-23-A77C3832-A33F-4071-B632-6F356E426F82.png" alt="A77C3832-A33F-4071-B632-6F356E426F82"></p>
<p><strong>用户列表页</strong></p>
<ol>
<li>注册一个新用户，然后设置这个用户为<strong>超级用户</strong>。</li>
</ol>
<p><img src="http://o6ul1xz4z.bkt.clouddn.com/2017-04-23-6FD47491-4730-4E0D-881D-C0E2A5CEF8A0.png" alt="6FD47491-4730-4E0D-881D-C0E2A5CEF8A0"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ mongo -u neo -p xxx --authenticationDatabase movies --host [mongoDB IP 地址]</span><br><span class="line">MongoDB shell version v3.4.3</span><br><span class="line">connecting to: mongodb://172.16.16.144:27017/</span><br><span class="line">MongoDB server version: 3.4.1</span><br><span class="line">&gt; use movies</span><br><span class="line">switched to db movies</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"58fcb193ba823d06b2c78ffe"</span>), <span class="string">"name"</span> : <span class="string">"孟庆申"</span>, <span class="string">"password"</span> : <span class="string">"<span class="variable">$2a</span><span class="variable">$10</span><span class="variable">$yaf1RLwE</span>/aIncrWzyaiEb.ZMZqrF9HHDjr/VFJIVbKdx4rFZzB2sC"</span>, <span class="string">"meta"</span> : &#123; <span class="string">"updateAt"</span> : ISODate(<span class="string">"2017-04-23T13:52:19.949Z"</span>), <span class="string">"createAt"</span> : ISODate(<span class="string">"2017-04-23T13:52:19.949Z"</span>) &#125;, <span class="string">"role"</span> : 0, <span class="string">"__v"</span> : 0 &#125;</span><br><span class="line">&gt; db.users.update(&#123;name: <span class="string">'孟庆申'</span>&#125;, &#123;<span class="variable">$set</span>: &#123;role: 51&#125;&#125;)</span><br><span class="line">WriteResult(&#123; <span class="string">"nMatched"</span> : 1, <span class="string">"nUpserted"</span> : 0, <span class="string">"nModified"</span> : 1 &#125;)</span><br></pre></td></tr></table></figure>
<ol>
<li><p>用该<strong>超级用户</strong>用户登陆，并查看用户列表。</p>
<p><img src="http://o6ul1xz4z.bkt.clouddn.com/2017-04-23-88DC5498-2EA6-49DB-BE68-3E0B3EE6977F.png" alt="88DC5498-2EA6-49DB-BE68-3E0B3EE6977F"></p>
</li>
</ol>
<p><strong>后台录入页</strong></p>
<p>☑ 简介: 在<strong>豆瓣同步</strong>中输入 ID(比如<code>7054604</code>) ，可以自动获取豆瓣相应电影并完成填充。</p>
<p><img src="http://o6ul1xz4z.bkt.clouddn.com/2017-04-23-2873AE79-479D-467F-8FFF-90F87AC33C87.png" alt="2873AE79-479D-467F-8FFF-90F87AC33C87"></p>
<p><strong>详情页</strong></p>
<p><img src="http://o6ul1xz4z.bkt.clouddn.com/2017-04-23-0FDFDC79-8AAE-42F3-93E5-6748F2F0AFE0.png" alt="0FDFDC79-8AAE-42F3-93E5-6748F2F0AFE0"></p>
<h2 id="2-3-狗狗说-React-Native-开发的-App-后台项目分析"><a href="#2-3-狗狗说-React-Native-开发的-App-后台项目分析" class="headerlink" title="2.3 狗狗说 React Native 开发的 App 后台项目分析"></a>2.3 狗狗说 React Native 开发的 App 后台项目分析</h2><p><a href="http://coding.imooc.com/class/56.html" target="_blank" rel="external">慕课网-React Native 贯穿全栈开发 App</a></p>
<p>该项目是一个ios app项目的后台，采用 <code>koa</code> 框架，给 App 提供 API 接口，并提供面向运营的管理后台。支持基于 SSL 的 HTTPS 协议。</p>
<h2 id="2-4-微信小程序的项目介绍"><a href="#2-4-微信小程序的项目介绍" class="headerlink" title="2.4 微信小程序的项目介绍"></a>2.4 微信小程序的项目介绍</h2><p>☑ 后端采用 koa </p>
<p>☑ 支持采用 HTTPS 协议</p>
<h2 id="2-5-电影微信公众号的项目概况"><a href="#2-5-电影微信公众号的项目概况" class="headerlink" title="2.5 电影微信公众号的项目概况"></a>2.5 电影微信公众号的项目概况</h2><p><a href="http://coding.imooc.com/class/38.html" target="_blank" rel="external">慕课网-Node.js 7天搞定微信公众号</a></p>
<h2 id="2-6-从一个故事理解整个部署思路"><a href="#2-6-从一个故事理解整个部署思路" class="headerlink" title="2.6 从一个故事理解整个部署思路"></a>2.6 从一个故事理解整个部署思路</h2><p><img src="http://o6ul1xz4z.bkt.clouddn.com/2017-04-24-7A834090-215B-421E-89F4-9D8D2221407B.png" alt="7A834090-215B-421E-89F4-9D8D2221407B"></p>
<h1 id="3-选购域名服务器及备案"><a href="#3-选购域名服务器及备案" class="headerlink" title="3 选购域名服务器及备案"></a>3 选购域名服务器及备案</h1><h2 id="3-1-选购域名的经验分享"><a href="#3-1-选购域名的经验分享" class="headerlink" title="3.1 选购域名的经验分享"></a>3.1 选购域名的经验分享</h2><h3 id="相关网站"><a href="#相关网站" class="headerlink" title="相关网站"></a>相关网站</h3><ul>
<li><a href="http://www.22.cn/" target="_blank" rel="external">爱名网</a></li>
<li><a href="https://www.aliyun.com/" target="_blank" rel="external">阿里云(推荐)</a></li>
<li><a href="https://sg.godaddy.com/zh/" target="_blank" rel="external">godaddy</a></li>
</ul>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ul>
<li>传播效果:(纯英文 &gt; 纯数字 &gt; 英文数字混合)</li>
</ul>
<ul>
<li>不要使用过于冷僻的后缀名(不好备案)</li>
<li>cn 后缀比 com 域名更便宜</li>
<li>godaddy 的域名国家会不会有一天阻拦备案？</li>
<li>SSL 整数可以通过 JS 来生成，不一定非要购买。</li>
<li>无论在哪里购买的域名，都需要到<a href="https://www.dnspod.cn/" target="_blank" rel="external">DNSPOD</a>这个网站设置域名解析指向。</li>
</ul>
<h2 id="3-2-主机选择"><a href="#3-2-主机选择" class="headerlink" title="3.2 主机选择"></a>3.2 主机选择</h2><p>☑ 相关运营商</p>
<table>
<thead>
<tr>
<th>国外</th>
<th>国内</th>
</tr>
</thead>
<tbody>
<tr>
<td>亚马逊 AWS</td>
<td>阿里云 ECS（推荐）</td>
</tr>
<tr>
<td>Linode</td>
<td>青云/UCloud/百度云</td>
</tr>
<tr>
<td>DigitOcean/Heroku</td>
</tr>
</tbody>
</table>
<p>☑ 注意</p>
<ul>
<li>尽量选择大厂商，不要图便宜</li>
<li>尽量选择国内的主机运营商（政策风险小，容易备案，速度快）</li>
</ul>
<p><img src="http://o6ul1xz4z.bkt.clouddn.com/2017-04-24-9187181B-E182-482B-BE3C-69022E8E34B1.png" alt="9187181B-E182-482B-BE3C-69022E8E34B1"></p>
<p>讲师提供了一个优惠码: 1abqbf</p>
<h2 id="3-3-域名备案流程走起来"><a href="#3-3-域名备案流程走起来" class="headerlink" title="3.3 域名备案流程走起来"></a>3.3 域名备案流程走起来</h2><h3 id="注意事项-1"><a href="#注意事项-1" class="headerlink" title="注意事项"></a>注意事项</h3><p>☑ 不要图快，争取一次通过。</p>
<p>☑ 推荐阿里云提供的<strong>购买域名</strong>、<strong>购买云服务</strong>、<strong>备案</strong>一条龙服务，省心，快捷。</p>
<p>☑ 备案需要材料</p>
<ul>
<li>身份证(个人备案)</li>
<li>单位证件+ 备案负责人证件(单位备案)</li>
<li>清晰的电子版照片</li>
</ul>
<p>☑ 域名首次备案前不允许线上访问（备案期间不要使用这个域名）</p>
<h3 id="在阿里云官网进行备案"><a href="#在阿里云官网进行备案" class="headerlink" title="在阿里云官网进行备案"></a>在阿里云官网进行备案</h3><ol>
<li>备案服务号申请。</li>
<li>在 ICP 代备案管理系统中进行备案。</li>
<li>等 3 周左右在阿里云查看备案是否通过。</li>
</ol>
<h1 id="4-远程登录服务器"><a href="#4-远程登录服务器" class="headerlink" title="4 远程登录服务器"></a>4 远程登录服务器</h1><h2 id="4-1-第一次-ssh-远程登录服务器"><a href="#4-1-第一次-ssh-远程登录服务器" class="headerlink" title="4.1 第一次 ssh 远程登录服务器"></a>4.1 第一次 ssh 远程登录服务器</h2><ol>
<li>设置密码</li>
<li>登录</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh root@[IP ID地址]</span><br></pre></td></tr></table></figure>
<h2 id="4-2-配置-root-及应用账号权限"><a href="#4-2-配置-root-及应用账号权限" class="headerlink" title="4.2 配置 root 及应用账号权限"></a>4.2 配置 root 及应用账号权限</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ adduser imooc_manager <span class="comment"># 自动加入群组 imooc_manager，生成 /home/imooc_manager</span></span><br><span class="line">$ gpasswd <span class="_">-a</span> imooc_manager sudo <span class="comment"># 将 imooc_manager 加入到 群组 sudo</span></span><br><span class="line">$ sudo visudo <span class="comment"># 设置</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># User privilege specification</span></span><br><span class="line">imooc_manager ALL=(ALL:ALL) ALL</span><br></pre></td></tr></table></figure>
<p>用新账号远程联机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh imooc_manager@[外网 IP]</span><br></pre></td></tr></table></figure>
<h2 id="4-3-配置本地无密码-SSH-登录"><a href="#4-3-配置本地无密码-SSH-登录" class="headerlink" title="4.3 配置本地无密码 SSH 登录"></a>4.3 配置本地无密码 SSH 登录</h2><p><img src="http://o6ul1xz4z.bkt.clouddn.com/2017-04-26-FD361328-37D6-41F4-81DD-EFD7B1775F3A.png" alt="FD361328-37D6-41F4-81DD-EFD7B1775F3A"></p>
<p>(1) 客户端配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 确保还没有创建过（没有 id_rsa）</span></span><br><span class="line">$ ls ~/.ssh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建公钥和私钥</span></span><br><span class="line">$ ssh-keygen -t rsa -b 4096 -C <span class="string">"[电子邮件地址]"</span> <span class="comment"># 会生成 id_rsa 和 id_rsa.pub 两个文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">$ <span class="built_in">eval</span> <span class="string">"<span class="variable">$(ssh-agent -s)</span>"</span></span><br><span class="line">$ ssh-add ~/.ssh/id_rsa</span><br></pre></td></tr></table></figure>
<p>(2) 服务端配置 <code>~/.ssh/authorized_keys</code> 文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将客户端的 id_rsa.pub 中的公钥信息复制到这个文件</span></span><br><span class="line">$ vi ~/.ssh/authorized_keys</span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件权限设置</span></span><br><span class="line">$ sudo chmod 600 ~/.ssh/authorized_keys</span><br><span class="line"></span><br><span class="line">$ sudo service ssh restart</span><br></pre></td></tr></table></figure>
<p>(3) 然后就可以通过 ssh登录服务器而不需要密码了</p>
<h1 id="5-增强服务安全等级"><a href="#5-增强服务安全等级" class="headerlink" title="5 增强服务安全等级"></a>5 增强服务安全等级</h1><h2 id="5-1-修改服务器默认ssh登录端口"><a href="#5-1-修改服务器默认ssh登录端口" class="headerlink" title="5.1 修改服务器默认ssh登录端口"></a>5.1 修改服务器默认ssh登录端口</h2><p>注意：远程修改 ssh 的配置文件有可能不小心就导致当前 ssh 连接断线，再也不能用 ssh 远程登录。因此可以多开一个 ssh 登录服务器。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/ssh/sshd_config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以是 0-65536，其中 0-1024 通常会被系统程序使用，而且必须占用这个端口的程序用 root 身份才能启动，因此最好别用 0-1024</span></span><br><span class="line">Port 12345</span><br><span class="line">PermitRootLogin no</span><br><span class="line">UseDNS no</span><br><span class="line">PasswordAuthentication no</span><br><span class="line">PermitEmptyPasswords no</span><br><span class="line">AllowUsers [允许 ssh 远程登录的用户名]</span><br><span class="line"></span><br><span class="line">$ sudo service ssh restart</span><br></pre></td></tr></table></figure>
<h2 id="5-2-配置-iptables-和-Fall2Ban-增强安全等级"><a href="#5-2-配置-iptables-和-Fall2Ban-增强安全等级" class="headerlink" title="5.2 配置 iptables 和 Fall2Ban 增强安全等级"></a>5.2 配置 iptables 和 Fall2Ban 增强安全等级</h2><h3 id="iptables"><a href="#iptables" class="headerlink" title="iptables"></a>iptables</h3><hr>
<p>☑ 注意: 为了防止 iptables 设置不当导致远程无法登陆，额外开一个 ssh 远程登录。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 清空当前所有 iptables 规则</span></span><br><span class="line">$ sudo iptables -F</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编写 iptables 规则的配置文件</span></span><br><span class="line">$ sudo vim /etc/iptables.up.rules</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">*filter</span><br><span class="line"><span class="comment"># allow all input</span></span><br><span class="line">-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># allow all output</span></span><br><span class="line">-A OUTPUT -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># allow http(s)</span></span><br><span class="line">-A INPUT -p tcp --dport 443 -j ACCEPT</span><br><span class="line">-A INPUT -p tcp --dport 80 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># allow ssh port login</span></span><br><span class="line">-A INPUT -p tcp -m state --state NEW --dport 12345 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># allow ping</span></span><br><span class="line">-A INPUT -p icmp -m icmp --icmp-type 8 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># log denied calls</span></span><br><span class="line">-A INPUT -m <span class="built_in">limit</span> --limit 5/min -j LOG --log-prefix <span class="string">"iptables denied:"</span> --log-level 7</span><br><span class="line"></span><br><span class="line"><span class="comment"># drop incoming sensitive connections</span></span><br><span class="line">-A INPUT -p tcp --dport 80 -i eth0 -m state --state NEW -m recent --set</span><br><span class="line">-A INPUT -p tcp --dport 80 -i eth0 -m state --state NEW -m recent --update --seconds 60 --hitcount 150 -j DROP</span><br><span class="line"></span><br><span class="line"><span class="comment"># reject all other inbound</span></span><br><span class="line">-A INPUT -j REJECT</span><br><span class="line">-A FORWARD -j REJECT</span><br><span class="line"></span><br><span class="line">COMMIT</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 应用防火墙规则</span></span><br><span class="line">$ sudo iptables-restore &lt; /etc/iptables.up.rules</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看防火墙是否开启</span></span><br><span class="line">$ sudo ufw status</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启防火墙</span></span><br><span class="line">$ sudo ufw <span class="built_in">enable</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 iptables 在网络服务启动时自动启动</span></span><br><span class="line">$ vim /etc/network/<span class="keyword">if</span>-up.d/iptables</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">iptables-restore /etc/iptables.up.rules</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo chmod +x /etc/network/<span class="keyword">if</span>-up.d/iptables</span><br></pre></td></tr></table></figure>
<h3 id="Fail2Ban"><a href="#Fail2Ban" class="headerlink" title="Fail2Ban"></a>Fail2Ban</h3><hr>
<p>☑ 说明： 一个安防模块，可以看作一个防御性的动作库，通过监控系统的日志文件，根据检测到任意可疑的行为，出发不同的环境动作，比如对可疑的目标执行 ip 锁定等。</p>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install fail2ban</span><br></pre></td></tr></table></figure>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p>/etc/fail2ban/jail.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bantime = 3600</span><br><span class="line">destemail = mengqingshen_sean@outlook.com</span><br><span class="line">action = %(action_mw)s</span><br></pre></td></tr></table></figure>
<h4 id="运行状态"><a href="#运行状态" class="headerlink" title="运行状态"></a>运行状态</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo service fail2ban status</span><br></pre></td></tr></table></figure>
<h4 id="开启与关闭"><a href="#开启与关闭" class="headerlink" title="开启与关闭"></a>开启与关闭</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo servive fail2ban start</span><br><span class="line">$ sudo servive fail2ban stop</span><br></pre></td></tr></table></figure>
<h1 id="6-搭建-Nodejs-生产环境"><a href="#6-搭建-Nodejs-生产环境" class="headerlink" title="6 搭建 Nodejs 生产环境"></a>6 搭建 Nodejs 生产环境</h1><h2 id="6-1-搭建服务器的-Nodejs-环境"><a href="#6-1-搭建服务器的-Nodejs-环境" class="headerlink" title="6.1 搭建服务器的 Nodejs 环境"></a>6.1 搭建服务器的 Nodejs 环境</h2><h3 id="依赖环境"><a href="#依赖环境" class="headerlink" title="依赖环境"></a>依赖环境</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install vim openssl build-essential libssl-dev wget curl git</span><br></pre></td></tr></table></figure>
<h3 id="nvm"><a href="#nvm" class="headerlink" title="nvm"></a>nvm</h3><p><a href="https://github.com/creationix/nvm" target="_blank" rel="external">GitHub 地址</a></p>
<p>☑ 注意: 安装后，需要重新登入终端，从而载入 nvm 相关的环境变量。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget -qO- https://raw.githubusercontent.com/creationix/nvm/v0.33.2/install.sh | bash</span><br></pre></td></tr></table></figure>
<h3 id="nodejs"><a href="#nodejs" class="headerlink" title="nodejs"></a>nodejs</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ nvm ls-remote</span><br><span class="line">$ nvm install v7.9.0</span><br><span class="line">$ nvm use v7.9.0</span><br><span class="line">$ nvm <span class="built_in">alias</span> default v7.9.0</span><br></pre></td></tr></table></figure>
<h3 id="升级-npm"><a href="#升级-npm" class="headerlink" title="升级 npm"></a>升级 npm</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 国内网速慢的话，可以考虑用淘宝的源</span></span><br><span class="line">$ npm install --registry=https://registry.npm.taobao.org install -g npm</span><br></pre></td></tr></table></figure>
<h3 id="设置系统文件监控数目"><a href="#设置系统文件监控数目" class="headerlink" title="设置系统文件监控数目"></a>设置系统文件监控数目</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> fs.inotify.max_user_watches=524288 | sudo tee <span class="_">-a</span> /etc/sysctl.conf &amp;&amp; sudo sysctl -p</span><br></pre></td></tr></table></figure>
<h3 id="使用-cnpm-取代-npm"><a href="#使用-cnpm-取代-npm" class="headerlink" title="使用 cnpm 取代 npm"></a>使用 cnpm 取代 npm</h3><p>☑ 注意: 只要网络不是太糟糕，建议始终使用 npm 而不是 cnpm。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ npm install --registry=https://registry.npm.taobao.org install -g cnpm</span><br><span class="line">$ cnpm sync koa <span class="comment"># 即使使用 npm， 也会强制从国内源安装 koa</span></span><br></pre></td></tr></table></figure>
<h3 id="常用-nodejs-包"><a href="#常用-nodejs-包" class="headerlink" title="常用 nodejs 包"></a>常用 nodejs 包</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm i pm2 webpack gulp grunt-cli -g</span><br></pre></td></tr></table></figure>
<h2 id="6-2-借助-pm2-让-Nodejs-服务常驻"><a href="#6-2-借助-pm2-让-Nodejs-服务常驻" class="headerlink" title="6.2 借助 pm2 让 Nodejs 服务常驻"></a>6.2 借助 pm2 让 Nodejs 服务常驻</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动 nodejs 程序</span></span><br><span class="line">$ pm2 start app.js</span><br><span class="line"></span><br><span class="line"><span class="comment"># 当前 pm2 管理的 nodejs 程序列表</span></span><br><span class="line">$ pm2 list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看某个程序的详细信息</span></span><br><span class="line">$ pm2 show app</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看实时日志</span></span><br><span class="line">$ pm2 logs</span><br></pre></td></tr></table></figure>
<h1 id="7-配置-nginx-实现反向代理"><a href="#7-配置-nginx-实现反向代理" class="headerlink" title="7 配置 nginx 实现反向代理"></a>7 配置 nginx 实现反向代理</h1><h2 id="删除-apache2"><a href="#删除-apache2" class="headerlink" title="删除 apache2"></a>删除 apache2</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo service apache2 stop</span><br><span class="line">$ sudo service apache stop</span><br><span class="line">$ update-rc.d <span class="_">-f</span> apache2 remove</span><br><span class="line">$ sudo apt-get remove apache2</span><br></pre></td></tr></table></figure>
<h2 id="安装-nginx"><a href="#安装-nginx" class="headerlink" title="安装 nginx"></a>安装 nginx</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install nginx</span><br></pre></td></tr></table></figure>
<h2 id="配置-nginx"><a href="#配置-nginx" class="headerlink" title="配置 nginx"></a>配置 nginx</h2><p><strong>/etc/nginx/conf.d/webappbook-8081.conf</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">upstream imooc &#123;</span><br><span class="line">  server 127.0.0.1:8081;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name [服务器外网 IP 地址];</span><br><span class="line">  location / &#123;</span><br><span class="line">    proxy_<span class="built_in">set</span>_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">    proxy_<span class="built_in">set</span>_header X-Forward-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    proxy_<span class="built_in">set</span>_header Host <span class="variable">$http_host</span>;</span><br><span class="line">    proxy_<span class="built_in">set</span>_header X-Nginx-Proxy <span class="literal">true</span>;</span><br><span class="line">    proxy_pass http://imooc;</span><br><span class="line">    proxy_redirect off;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>/etc/nginx/nginx.conf</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">http &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment"># 响应头中隐藏 nginx 版本信息</span></span><br><span class="line">  server_tokens off;</span><br><span class="line">  include /etc/nginx/conf.d/*.conf;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试 nginx 有没有问题</span></span><br><span class="line">$ sudo nginx -t</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 nginx</span></span><br><span class="line">$ sudo nginx start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新载入配置</span></span><br><span class="line">$ sudo nginx <span class="_">-s</span> reload</span><br></pre></td></tr></table></figure>
<h1 id="8-利用-DNSPod-管理域名解析"><a href="#8-利用-DNSPod-管理域名解析" class="headerlink" title="8 利用 DNSPod 管理域名解析"></a>8 利用 DNSPod 管理域名解析</h1><h2 id="8-1-更改域名的-DNS-根服务器"><a href="#8-1-更改域名的-DNS-根服务器" class="headerlink" title="8.1 更改域名的 DNS 根服务器"></a>8.1 更改域名的 DNS 根服务器</h2><h3 id="8-1-1-为什么要更改-DNS-根服务器？"><a href="#8-1-1-为什么要更改-DNS-根服务器？" class="headerlink" title="8.1.1 为什么要更改 DNS 根服务器？"></a>8.1.1 为什么要更改 DNS 根服务器？</h3><p><strong>阿里云的云解析 vs DNSPod</strong></p>
<ul>
<li>NDSPod 技术更加成熟，预案更加全面</li>
<li>域名可能并不是在阿里云购买的，因此无法使用阿里云的云解析。统一在 DNSPod 管理更加效率。</li>
</ul>
<h3 id="8-1-2-步骤"><a href="#8-1-2-步骤" class="headerlink" title="8.1.2 步骤"></a>8.1.2 步骤</h3><p>(1) 在 <a href="https://www.dnspod.cn" target="_blank" rel="external">DNSPod</a> 拿到 DNS 根服务器</p>
<p>首页 &gt; 常见问题 &gt; 功能介绍及使用教程 &gt; 哥哥注册商修改域名 DNS 地址的方法 &gt; <a href="https://support.dnspod.cn/Kb/showarticle/tsid/40/" target="_blank" rel="external">万网注册商域名修改DNS地址</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">f1g1ns1.dnspod.net</span><br><span class="line">f1g1ns2.dnspod.net</span><br></pre></td></tr></table></figure>
<p>(2) 在<a href="https://aliyun.com/" target="_blank" rel="external">阿里云</a>更改 DNS 根服务器</p>
<p>管理控制台 &gt; 域名 &gt; 域名列表 &gt; (某个域名的) 管理 &gt; DNS 修改</p>
<p><img src="http://o6ul1xz4z.bkt.clouddn.com/2017-04-30-8782E41E-3983-4F69-A558-820E5D7B90CE.png" alt="8782E41E-3983-4F69-A558-820E5D7B90CE"></p>
<p>(3) 使用 DNSPod 的域名解析功能，解析在阿里云买的域名</p>
<h2 id="8-2-配置解析项目的域名-A-记录和-CNAME"><a href="#8-2-配置解析项目的域名-A-记录和-CNAME" class="headerlink" title="8.2 配置解析项目的域名 A 记录和 CNAME"></a>8.2 配置解析项目的域名 A 记录和 CNAME</h2><p><img src="http://o6ul1xz4z.bkt.clouddn.com/2017-04-30-D77D9188-AC9B-4A2E-AB09-1481B359BB5B.png" alt="D77D9188-AC9B-4A2E-AB09-1481B359BB5B"></p>
<p><strong>扩展</strong></p>
<p>DNSPod 的域名解析服务不但可以解析到具体的 ip ，也可以解析到其它服务。比如配合<a href="https://www.qiniu.com" target="_blank" rel="external">七牛</a>的对象存储提供的<code>融合 CDN 加速域名</code>就可以解析到图床中的图片地址。</p>
<h1 id="9-服务器配置安装-MongoDB"><a href="#9-服务器配置安装-MongoDB" class="headerlink" title="9 服务器配置安装 MongoDB"></a>9 服务器配置安装 MongoDB</h1><p>注意： 因为成本原因，MongoDB 和 Web 服务在同一个 ECS 实例上，在商业实践中，为了解耦，应当放在不同的实例中。或者有条件的话，可以购买阿里云专门的 MongoDB 数据库服务。</p>
<h2 id="9-1-在-Ubuntu-14-04-上安装-MongoDB"><a href="#9-1-在-Ubuntu-14-04-上安装-MongoDB" class="headerlink" title="9.1 在 Ubuntu 14.04 上安装 MongoDB"></a>9.1 在 Ubuntu 14.04 上安装 MongoDB</h2><h3 id="9-1-1-安装"><a href="#9-1-1-安装" class="headerlink" title="9.1.1 安装"></a>9.1.1 安装</h3><p>参考 MongoDB 官网 <a href="https://docs.mongodb.com/manual/tutorial/install-mongodb-on-ubuntu/" target="_blank" rel="external">Install on Ubuntu</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 0C49F3730359A14518585931BC711F9BA15703C6</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"deb [ arch=amd64,arm64 ] http://repo.mongodb.org/apt/ubuntu xenial/mongodb-org/3.4 multiverse"</span> | sudo tee /etc/apt/sources.list.d/mongodb-org-3.4.list</span><br><span class="line"></span><br><span class="line">$ sudo apt-get update</span><br><span class="line"></span><br><span class="line">$ sudo apt-get install -y mongodb-org</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果上一步提示找不到 mongodb-org，则将 aliyun 的源注释掉，使用 ubuntu 官方的源。</span></span><br><span class="line"><span class="comment"># $ sudo vim /etc/apt/apt.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 然后，如果要加快加快下载速度，可以将 mongodb 的源改为 aliyun</span></span><br><span class="line"><span class="comment"># $ sudo vim /etc/apt/sources.list.d/mongodb-org-3.4.list </span></span><br><span class="line"><span class="comment"># deb [ arch=amd64,arm64 ] http://mirrors.aliyun.com/apt/ubuntu trusty/mongodb-org/3.4 multiverse</span></span><br></pre></td></tr></table></figure>
<h3 id="9-1-2-配置"><a href="#9-1-2-配置" class="headerlink" title="9.1.2 配置"></a>9.1.2 配置</h3><h4 id="MongoDB-配置"><a href="#MongoDB-配置" class="headerlink" title="MongoDB 配置"></a>MongoDB 配置</h4><p><strong>/etc/mongod.conf</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net:</span><br><span class="line">	port 27018 <span class="comment"># 为了安全起见，不使用默认端口</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo service mongod restart</span><br></pre></td></tr></table></figure>
<h4 id="防火墙配置"><a href="#防火墙配置" class="headerlink" title="防火墙配置"></a>防火墙配置</h4><p><strong>/etc/iptables.up.rules</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mongodb connect</span></span><br><span class="line">-A INPUT <span class="_">-s</span> 127.0.1 -p tcp --destination-port 27017 -m state --state NEW,ESTABLISHED -j ACCEPT</span><br><span class="line">-A OUTPUT <span class="_">-s</span> 127.0.1 -p tcp --source-port 27017 -m state --state ESTABLISHED -j ACCEPT</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo iptables-restore &lt; /etc/iptables.up.rules</span><br></pre></td></tr></table></figure>
<h3 id="9-1-3-启动-amp-关闭"><a href="#9-1-3-启动-amp-关闭" class="headerlink" title="9.1.3 启动&amp;关闭"></a>9.1.3 启动&amp;关闭</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mongodb 的日志文件</span></span><br><span class="line">$ cat /var/<span class="built_in">log</span>/mongodb/mongod.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 mongodb 服务</span></span><br><span class="line">$ sudo service mongod start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启 mongodb 服务</span></span><br><span class="line">$ sudo service mongod restart</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 mongodb 服务的状态</span></span><br><span class="line">$ sudo service mongod status</span><br></pre></td></tr></table></figure>
<h3 id="9-1-4-连接"><a href="#9-1-4-连接" class="headerlink" title="9.1.4 连接"></a>9.1.4 连接</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mongo --port 27018</span><br></pre></td></tr></table></figure>
<h2 id="9-2-往线上-MongoDB-导入单表数据或数据库"><a href="#9-2-往线上-MongoDB-导入单表数据或数据库" class="headerlink" title="9.2 往线上 MongoDB 导入单表数据或数据库"></a>9.2 往线上 MongoDB 导入单表数据或数据库</h2><p>☑ 技巧: 导入的时机一般是在数据库软件安装好之后，数据库用户创建前。从而避免用户权限带来的一些麻烦。</p>
<h3 id="9-2-1-项目预览"><a href="#9-2-1-项目预览" class="headerlink" title="9.2.1 项目预览"></a>9.2.1 项目预览</h3><p>讲师以自己的微信小程序为例，钥匙往线上 MongoDB 导数据，该小程序没有课程出来，通过下面的启动过程一窥微信小程序面貌。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 项目根目录</span></span><br><span class="line">$ <span class="built_in">cd</span> indust-app</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过微信模拟器在本地启动(在 chrome 中预览)</span></span><br><span class="line">$ wept</span><br></pre></td></tr></table></figure>
<p><img src="http://o6ul1xz4z.bkt.clouddn.com/2017-05-01-77C5FC78-04E7-42EB-93A4-94BF00F698C0.png" alt="77C5FC78-04E7-42EB-93A4-94BF00F698C0"></p>
<h3 id="9-2-2-整个数据库"><a href="#9-2-2-整个数据库" class="headerlink" title="9.2.2 整个数据库"></a>9.2.2 整个数据库</h3><p><strong>本地导出、打包、上传</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 存放项目备份数据的文件夹</span></span><br><span class="line">$ <span class="built_in">cd</span> deploy-projects</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将本地 MongoDB 中的名为indust-app的数据库导出到当前目录下的 indust-app-backup 文件夹下</span></span><br><span class="line">$ mongodump -h 127.0.0.1:27017 <span class="_">-d</span> indust-app -o indust-app-backup</span><br></pre></td></tr></table></figure>
<p><img src="http://o6ul1xz4z.bkt.clouddn.com/2017-05-01-D8174179-AE4F-4C2A-8097-9752AB6FB211.png" alt="D8174179-AE4F-4C2A-8097-9752AB6FB211"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 打包 MongoDB 数据库数据并压缩</span></span><br><span class="line">$ tar zcvf indust-app.tar.gz indust-app-backup</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传到服务器</span></span><br><span class="line">$ scp -P [ssh端口] ./indust-app-backup.tar.gz [远程服务器用户名]@[远程服务器 IP]:[远程服务器目录]</span><br></pre></td></tr></table></figure>
<p><strong>服务器解压、导入</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ tar xvf indust-app-backup.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> indust-app-backup</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将解压的数据导入当前机器中的 MongoDB 的 indust-app 数据库</span></span><br><span class="line">$ mongorestore --host 127.0.0.1:[mongoDB 服务端口] <span class="_">-d</span> indust-app ./indust-app/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看导入的数据</span></span><br><span class="line">$ mongo --port [mongoDB 服务端口]</span><br><span class="line">&gt; use indust-app</span><br><span class="line">&gt; show tables</span><br></pre></td></tr></table></figure>
<h3 id="9-2-3-单表"><a href="#9-2-3-单表" class="headerlink" title="9.2.3 单表"></a>9.2.3 单表</h3><p><strong>本地导出、打包、上传</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> deploy-projects</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导出 imooc_movie 库下的 users 表(其实是一个 json 文件)</span></span><br><span class="line">$ mongoexport <span class="_">-d</span> imooc_movie -c users -q <span class="string">'&#123;"name": &#123;$ne: null&#125;&#125;'</span> -o ./movie-users.json</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传到服务器</span></span><br><span class="line">$ scp -P 39999 ./movie-users.json [远程服务器用户名]@[远程服务器 IP]:[远程服务器目录]</span><br></pre></td></tr></table></figure>
<p><strong>服务器导入</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入前面上传的表数据 movie-users.json</span></span><br><span class="line">$ mongoimport --host 127.0.0.1:[mongoDB 服务端口] <span class="_">-d</span> imooc-movie -c users ./movie-users.json</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看导入的效果</span></span><br><span class="line">$ mongo --port [mongoDB 服务端口]</span><br><span class="line">&gt; use imooc-movie</span><br><span class="line">&gt; show tables</span><br><span class="line">users</span><br><span class="line">&gt; db.users.find(&#123;&#125;)</span><br></pre></td></tr></table></figure>
<p><strong>删除刚刚导入的数据表</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除服务端 MongoDB 中的 imooc-movie 数据表</span></span><br><span class="line">$ mongo --host 127.0.0.1:[mongoDB 服务端口] imooc-movie --eval <span class="string">"db.dropDatabase()"</span></span><br></pre></td></tr></table></figure>
<h2 id="9-3-为上线项目配置-MongoDB-数据库读写权限"><a href="#9-3-为上线项目配置-MongoDB-数据库读写权限" class="headerlink" title="9.3 为上线项目配置 MongoDB 数据库读写权限"></a>9.3 为上线项目配置 MongoDB 数据库读写权限</h2><h3 id="9-3-1-创建-MongoDB-账号"><a href="#9-3-1-创建-MongoDB-账号" class="headerlink" title="9.3.1 创建 MongoDB 账号"></a>9.3.1 创建 MongoDB 账号</h3><p><strong>MongoDB 账户注意事项</strong></p>
<ul>
<li>没有默认的管理员账号；</li>
<li>只有切换到 admin 数据库，添加的账号才是管理员账号；</li>
<li>用户(包括管理员)只能登录用户所在的数据库；</li>
<li>管理员可以管理所有数据库，但不能直接管理，需要先切换到 admin 数据库认证之后才可以；</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 连接本地(服务器)数据库</span></span><br><span class="line">$ mongo --port [MongoDB 服务端口]</span><br><span class="line">&gt; use admin</span><br><span class="line"><span class="comment"># 数据库管理员</span></span><br><span class="line">&gt; db.createUser(&#123;user: <span class="string">'imooc_cases_owner'</span>, <span class="built_in">pwd</span>: <span class="string">'Safe1*24$'</span>, roles: [&#123;role: <span class="string">'userAdminAnyDatabase'</span>, db: <span class="string">'admin'</span>&#125;]&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">###### imooc-movie(网站) ######</span></span><br><span class="line">&gt; use admin</span><br><span class="line">&gt; db.auth(<span class="string">'imooc_cases_owner'</span>, <span class="string">'Safe1*24$'</span>)</span><br><span class="line">&gt; use imooc-movie</span><br><span class="line"><span class="comment"># 可以操作数据的账号</span></span><br><span class="line">&gt; db.createUser(&#123;user: <span class="string">'imooc_movie_runner'</span>, <span class="built_in">pwd</span>: <span class="string">'F**k9001$'</span>, roles: [&#123;role: <span class="string">'readWrite'</span>, db: <span class="string">'imooc-movie'</span>&#125;]&#125;)</span><br><span class="line"><span class="comment"># 可以备份数据的账号</span></span><br><span class="line">&gt; db.createUser(&#123;user: <span class="string">'imooc_movie_wheel'</span>, <span class="built_in">pwd</span>: <span class="string">'B**kup2017$'</span>, roles: [&#123;role: <span class="string">'read'</span>, db: <span class="string">'imooc-movie'</span>&#125;]&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">###### imooc-app(狗狗说 App 后台) ######</span></span><br><span class="line">&gt; user admin</span><br><span class="line">&gt; db.auth(<span class="string">'imooc_cases_owner'</span>)</span><br><span class="line">&gt; use imooc-app</span><br><span class="line">&gt; db.createUser(&#123;user: <span class="string">'imooc_app_runner'</span>, <span class="built_in">pwd</span>: <span class="string">'Ack!24$'</span>&#125;, roles: [&#123;role: <span class="string">'readWrite'</span>, db: <span class="string">'imooc-app'</span>&#125;])</span><br><span class="line">&gt; db.createUser(&#123;user: <span class="string">'imooc_app_wheel'</span>, <span class="built_in">pwd</span>: <span class="string">'DSGFG*DF$'</span>, roles: [&#123;role: <span class="string">'read'</span>, db: <span class="string">'imooc-app'</span>&#125;]&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">###### indust-app(微信小程序) ######</span></span><br><span class="line">&gt; use admin</span><br><span class="line">&gt; db.auth(<span class="string">'imooc_cases_owner'</span>)</span><br><span class="line">&gt; use indust-app</span><br><span class="line">&gt; db.createUser(&#123;user: <span class="string">'indust_app_runner'</span>, <span class="built_in">pwd</span>: <span class="string">'FA*EAT'</span>&#125;, roles: [&#123;role: <span class="string">'readWrite'</span>, db: <span class="string">'indust-app'</span>&#125;])</span><br><span class="line">&gt; db.createUser(&#123;user: <span class="string">'indust_app_wheel'</span>, <span class="built_in">pwd</span>: <span class="string">'GJSHGK**F'</span>, roles: [&#123;role: <span class="string">'read'</span>, db: <span class="string">'indust-app'</span>&#125;]&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">###### imooc-wechart(微信公众号) ######</span></span><br><span class="line">&gt; use admin</span><br><span class="line">&gt; db.auth(<span class="string">'imooc_cases_owner'</span>)</span><br><span class="line">&gt; use indust-app</span><br><span class="line">&gt; db.createUser(&#123;user: <span class="string">'imooc_wechat_runner'</span>, <span class="built_in">pwd</span>: <span class="string">'KLLKDS'</span>&#125;, roles: [&#123;role: <span class="string">'readWrite'</span>, db: <span class="string">'imooc-wechart'</span>&#125;])</span><br><span class="line">&gt; db.createUser(&#123;user: <span class="string">'imooc_wechat_wheel'</span>, <span class="built_in">pwd</span>: <span class="string">'KLHFS^$S'</span>, roles: [&#123;role: <span class="string">'read'</span>, db: <span class="string">'imooc-wechart'</span>&#125;]&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="9-3-2-开启-MongoDB-安全认证"><a href="#9-3-2-开启-MongoDB-安全认证" class="headerlink" title="9.3.2 开启 MongoDB 安全认证"></a>9.3.2 开启 MongoDB 安全认证</h3><p><strong>服务器端 MongoDB 服务开启安全认证</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启权限安全认证</span></span><br><span class="line">$ sudo vi /etc/mongod.conf</span><br><span class="line"></span><br><span class="line">security:</span><br><span class="line">	authorization: <span class="string">'enabled'</span></span><br><span class="line"></span><br><span class="line">$ sudo service mongod restart</span><br></pre></td></tr></table></figure>
<p><strong>连接 MongoDB</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ mongo --port [MongoDB 服务端口]</span><br><span class="line">&gt; use admin</span><br><span class="line">&gt; db.auth(<span class="string">'imooc_cases_owner'</span>, <span class="string">'Safe1*24$'</span>)</span><br><span class="line">&gt; show dbs</span><br></pre></td></tr></table></figure>
<p><strong>远程连接 MongoDB 到具体的数据库</strong>(imooc-movie)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mongo [IP 地址]:[MongoDB 服务端口]/imooc-movie -u imooc_movie_runner -p F**k9001$</span><br><span class="line">&gt; show tables</span><br><span class="line">&gt; db.users.find(&#123;&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="9-4-从一台服务器迁移数据到另一个线上-MongoDB-中"><a href="#9-4-从一台服务器迁移数据到另一个线上-MongoDB-中" class="headerlink" title="9.4 从一台服务器迁移数据到另一个线上 MongoDB 中"></a>9.4 从一台服务器迁移数据到另一个线上 MongoDB 中</h2><p>为什么会需要这么做？比如说</p>
<ul>
<li>服务器欠费了</li>
<li>服务器 IP 被屏蔽了</li>
<li>服务器光缆被挖断了</li>
<li>服务器需要升级到高配置或降到低配置</li>
</ul>
<p>以 <code>indust-app</code>这个数据库为例:</p>
<p><strong>生产服务器 A</strong><br>数据库 indust-app<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir db &amp;&amp; <span class="built_in">cd</span> db</span><br><span class="line"></span><br><span class="line"><span class="comment">#将 MongoDB 中的 indust-app 数据库导出为 indust-app-old 文件</span></span><br><span class="line">$ mongodump -h 127.0.0.1:[MongoDB 服务端口] <span class="_">-d</span> indust-app -u indust_app_wheel -p GJSHGK**F -o indust-app-old</span><br><span class="line"></span><br><span class="line"><span class="comment"># 压缩</span></span><br><span class="line">$ tar zcvf indust-app-old.tar.gz indust-app-old/</span><br></pre></td></tr></table></figure></p>
<p>数据库 imooc-movie 的表 user</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将 MongoDB 中的 imooc-movie 数据库的表 user 导出为 movie-users-old.json 文件</span></span><br><span class="line">$ mongoexport -h 127.0.0.1 [MongoDB 服务端口] <span class="_">-d</span> imooc-movie -u imooc_movie_wheel -p B**kup2017$ -c user -q <span class="string">'&#123;"name": &#123;$ne: null&#125;&#125;'</span> -o ./movie-users-old.json</span><br></pre></td></tr></table></figure>
<p><strong>生产服务器 A &gt; 本地</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ scp -P [ssh 端口] imooc_manager@[生产服务器A IP]:/[path/to]/db/indust-app-old.tar.gz ./</span><br><span class="line">$ scp -P [ssh 端口] imooc_manager@[生产服务器A IP]:/[path/to]/db/movie-users ./movie-users-old.json</span><br></pre></td></tr></table></figure></p>
<p><strong>生产服务器 B</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir newdb</span><br></pre></td></tr></table></figure></p>
<p><strong>本地 &gt; 生产服务器 B</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ scp -P [ssh 端口] ./indust-app-old.tar.gz imooc_manager@[生产服务器B IP]:/[path/to]/newdb/</span><br><span class="line">$ scp -P [ssh 端口] ./movie-users-old.json imooc_manager@[生产服务器B IP]:/[path/to]/newdb/</span><br></pre></td></tr></table></figure>
<p><strong>生产服务器 B</strong></p>
<p>(1) 初始化数据库，为导入数据做好准备</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ mongo --port [MongoDB 服务端口]</span><br><span class="line">&gt; use admin</span><br><span class="line">&gt; db.auth(<span class="string">'imooc_cases_owner'</span>, <span class="string">'Safe1*24$'</span>)</span><br><span class="line"><span class="comment"># imooc-movie-target</span></span><br><span class="line">&gt; use imooc-movie-target</span><br><span class="line">&gt; db.createUser(&#123;user: <span class="string">'imooc_movie_target'</span>, <span class="built_in">pwd</span>: <span class="string">'12345'</span>, roles: [&#123;role: <span class="string">'readWrite'</span>, db: <span class="string">'imooc-movie-target'</span>&#125;]&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># indust-app-target</span></span><br><span class="line">&gt; use admin</span><br><span class="line">&gt; db.auth(<span class="string">'imooc_cases_owner'</span>, <span class="string">'Safe1*24$'</span>)</span><br><span class="line">&gt; use indust-app-target</span><br><span class="line">&gt; db.createUser(&#123;user: <span class="string">'indust_app_target'</span>, <span class="built_in">pwd</span>: <span class="string">'54321'</span>, roles: [&#123;role: <span class="string">'readWrite'</span>, db: <span class="string">'indust-app-target'</span>&#125;]&#125;)</span><br></pre></td></tr></table></figure>
<p>(2) 导入数据，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> newdb</span><br><span class="line">$ tar xvf indust-app-old.tar.gz</span><br><span class="line">$ mongorestore -h 127.0.0.1:[MongoDB 服务端口] <span class="_">-d</span> indust-app-target -u indust_app_target -p 54321 ./indust-app-old/indust-app</span><br><span class="line">$ mongoimport -h 127.0.0.1:[MongoDB 服务端口] <span class="_">-d</span> imooc-movie-target -u imooc_movie_target -p 12345 -c users ./movie-users-old.json</span><br></pre></td></tr></table></figure>
<p>(3) 检查导入情况</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查 imooc-movie-target 数据库中 user 表的导入情况</span></span><br><span class="line">$ mongo 127.0.0.1:[MongoDB 端口号]/imooc-movie-target -u imooc_movie_target -p 12345</span><br><span class="line">&gt; show tables</span><br><span class="line">users</span><br><span class="line">&gt; db.users.find(&#123;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查 imooc-movie-target 数据库的导入情况</span></span><br><span class="line">$ mongo 127.0.0.1:[MongoDB 端口号]/indust-app-target -u indust_app_target -p 54321</span><br><span class="line">&gt; show tables</span><br><span class="line">&gt; db.categories.find(&#123;&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="9-4-为数据库实现定时备份方案"><a href="#9-4-为数据库实现定时备份方案" class="headerlink" title="9.4 为数据库实现定时备份方案"></a>9.4 为数据库实现定时备份方案</h2><p><strong>说明</strong>: 为数据库做备份有很多种方法，有很多不同级别的容灾机制，我们探讨一种比较容易理解也比较容易实现的方法，那就是利用系统的任务，通过自动定时为数据库备份。<br><strong>建议</strong>: 针对每个数据库都建立一个本分脚本，而不是都写到一个脚本中，从而避免一个数据库备份失败连累其它数据库。</p>
<h3 id="9-4-1-编写定时任务脚本"><a href="#9-4-1-编写定时任务脚本" class="headerlink" title="9.4.1 编写定时任务脚本"></a>9.4.1 编写定时任务脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir tasks &amp;&amp; <span class="built_in">cd</span> tasks</span><br><span class="line">$ vim movie.backup.sh</span><br></pre></td></tr></table></figure>
<p><strong>tasks/movie.backup.sh</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">backUpFolder=/home/imooc_manager/movie</span><br><span class="line">data_now=`date +%Y_%m_%d_%H%M`</span><br><span class="line">backFileName=movie_<span class="variable">$date_now</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$backUpFolder</span></span><br><span class="line">mkdir -p <span class="variable">$backFileName</span></span><br><span class="line"><span class="comment"># 导出数据库 imooc-movie</span></span><br><span class="line">mongodump -h 127.0.0.1:[MongoDB 端口号] <span class="_">-d</span> imooc-movie -u imooc_movie_wheel</span><br><span class="line">tar zcvf <span class="variable">$backFileName</span>.tar.gz <span class="variable">$backFileName</span></span><br><span class="line">rm -rf <span class="variable">$backFileName</span></span><br></pre></td></tr></table></figure>
<h3 id="9-4-2-设置定时任务规则"><a href="#9-4-2-设置定时任务规则" class="headerlink" title="9.4.2 设置定时任务规则"></a>9.4.2 设置定时任务规则</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ crontab <span class="_">-e</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 每天 00:13 执行脚本</span></span><br><span class="line"><span class="comment"># m h dom mon dow command</span></span><br><span class="line">13 00 * * * sh /path/to/tasks/movie.backup.sh</span><br></pre></td></tr></table></figure>
<h3 id="9-4-3-上传数据库备份到七牛私有云"><a href="#9-4-3-上传数据库备份到七牛私有云" class="headerlink" title="9.4.3 上传数据库备份到七牛私有云"></a>9.4.3 上传数据库备份到七牛私有云</h3><p>(1) 编写 nodejs 脚本实现上传功能；<br><a href="https://developer.qiniu.com/kodo/sdk/1289/nodejs" target="_blank" rel="external">上传代码</a><br>需要修改的地方</p>
<ol>
<li>Access Key 和 Secret Key</li>
<li>通过变量获取动态获取要上传的文件及其路径</li>
<li>要上传的空间名</li>
<li>上传到七牛后保存的文件名</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim tasks/upload.js</span><br></pre></td></tr></table></figure>
<p><strong>tasks/upload.js</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">var qiniu = require("qiniu");</span><br><span class="line">var parts = process.env.NODE_ENV.split('@')</span><br><span class="line">var file = parts[1] + '.tar.gz'</span><br><span class="line">var filePath = parts[0] + '/' + file</span><br><span class="line"></span><br><span class="line">//需要填写你的 Access Key 和 Secret Key</span><br><span class="line">qiniu.conf.ACCESS_KEY = 'Access_Key'; # 1</span><br><span class="line">qiniu.conf.SECRET_KEY = 'Secret_Key'; # 2</span><br><span class="line">//要上传的空间</span><br><span class="line">bucket = 'imoocdeploydb'; # 3</span><br><span class="line">//上传到七牛后保存的文件名</span><br><span class="line">key = file; # 4</span><br><span class="line">//构建上传策略函数</span><br><span class="line">function uptoken(bucket, key) &#123;</span><br><span class="line">  var putPolicy = new qiniu.rs.PutPolicy(bucket+":"+key);</span><br><span class="line">  return putPolicy.token();</span><br><span class="line">&#125;</span><br><span class="line">//生成上传 Token</span><br><span class="line">token = uptoken(bucket, key);</span><br><span class="line">//要上传文件的本地路径</span><br><span class="line">// filePath = filePath; # 5</span><br><span class="line">//构造上传函数</span><br><span class="line">function uploadFile(uptoken, key, localFile) &#123;</span><br><span class="line">  var extra = new qiniu.io.PutExtra();</span><br><span class="line">    qiniu.io.putFile(uptoken, key, localFile, extra, function(err, ret) &#123;</span><br><span class="line">      if(!err) &#123;</span><br><span class="line">        // 上传成功， 处理返回值</span><br><span class="line">        console.log(ret.hash, ret.key, ret.persistentId);       </span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        // 上传失败， 处理返回代码</span><br><span class="line">        console.log(err);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line">//调用uploadFile上传</span><br><span class="line">uploadFile(token, key, filePath);</span><br></pre></td></tr></table></figure>
<p>(2) 在备份脚本中加入上传罗辑</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim tasks/movie.backup.sh</span><br></pre></td></tr></table></figure>
<p><strong>tasks/movie.backup.sh</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NODE_ENV=<span class="variable">$backUpFolder</span>@<span class="variable">$backFileName</span> node /path/to/tasks/upload.js</span><br></pre></td></tr></table></figure>
<p>(3) 在<a href="https://portal.qiniu.com/create" target="_blank" rel="external">七牛</a>添加一个新的对象存储空间 imoocdeploydb</p>
<p><img src="http://o6ul1xz4z.bkt.clouddn.com/2017-05-05-3315EC54-A689-41E9-AE53-CE84CE12E99A.png" alt="3315EC54-A689-41E9-AE53-CE84CE12E99A"></p>
<p>(4) 安装七牛模块, 测试备份脚本能不能备份到到七牛</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> tasks</span><br><span class="line">$ npm install qiniu</span><br><span class="line">$ ./movie.backup.sh</span><br></pre></td></tr></table></figure>
<p>(5) 完善备份任务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ crontab <span class="_">-e</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 每天 04:00 和 08:00 执行备份任务</span></span><br><span class="line"><span class="comment"># m h dom mon dow command</span></span><br><span class="line">00 4 * * * sh /path/to/tasks/movie.backup.sh</span><br><span class="line">00 8 * * * sh /path/to/tasks/movie.backup.sh</span><br></pre></td></tr></table></figure>
<h3 id="9-4-4-扩展-安装-mysql"><a href="#9-4-4-扩展-安装-mysql" class="headerlink" title="9.4.4 扩展(安装 mysql)"></a>9.4.4 扩展(安装 mysql)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">$ sudo apt-get install mysql-server mysql-client</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录</span></span><br><span class="line">$ mysql -u root -p</span><br></pre></td></tr></table></figure>
<h1 id="10-项服务器正式部署和发布上线-Nodejs-项目"><a href="#10-项服务器正式部署和发布上线-Nodejs-项目" class="headerlink" title="10 项服务器正式部署和发布上线 Nodejs 项目"></a>10 项服务器正式部署和发布上线 Nodejs 项目</h1><h2 id="10-1-上传项目代码到线上私有-Git-仓库"><a href="#10-1-上传项目代码到线上私有-Git-仓库" class="headerlink" title="10.1 上传项目代码到线上私有 Git 仓库"></a>10.1 上传项目代码到线上私有 Git 仓库</h2><p>☑ 自己搭建</p>
<ul>
<li>单纯的 Git 服务</li>
<li>GitLab</li>
</ul>
<p>☑ 使用第三方服务</p>
<ul>
<li><a href="http://git.oschina.net/" target="_blank" rel="external">coding.net</a></li>
<li><a href="http://git.oschina.net/" target="_blank" rel="external">git.oschina.net(课程以此为例)</a></li>
<li><a href="http://git.oschina.net/" target="_blank" rel="external">Github(付费)</a></li>
</ul>
<p><strong>私有仓库 &gt; 本地</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ git config --global user.name <span class="string">"Scott"</span></span><br><span class="line">$ git config --global user.email <span class="string">"xx@xx.xx"</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> deploy-project/website-server</span><br><span class="line"><span class="comment"># 初始化 git 仓库</span></span><br><span class="line">$ git init</span><br><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'First commit'</span></span><br><span class="line"><span class="comment"># 关联线上仓库</span></span><br><span class="line">$ git remote add origin git@git.oschina.net:wolf18387/backend-website.git</span><br><span class="line"><span class="comment"># 同步数据</span></span><br><span class="line">$ git push -u origin master</span><br><span class="line">$ git fetch</span><br><span class="line">$ git merge origin/master</span><br><span class="line">$ git push -u origin master</span><br></pre></td></tr></table></figure>
<p><strong>私有仓库 &gt; 服务器</strong><br>(1) 将服务器的公钥添加到到码云<br>(2) 在服务器 clone 私有仓库<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> git@git.oschina.net:wolf18387/backend-website.git</span><br></pre></td></tr></table></figure></p>
<h2 id="10-2-配置-PM2-一键部署线上项目结构"><a href="#10-2-配置-PM2-一键部署线上项目结构" class="headerlink" title="10.2 配置 PM2 一键部署线上项目结构"></a>10.2 配置 PM2 一键部署线上项目结构</h2><p>使用 PM2，并采用<a href="http://pm2.keymetrics.io/docs/usage/deployment/" target="_blank" rel="external">配置文件</a>的方式来部署项目。</p>
<h3 id="10-2-1-服务端准备"><a href="#10-2-1-服务端准备" class="headerlink" title="10.2.1 服务端准备"></a>10.2.1 服务端准备</h3><p>(1) 准备好程序所在的文件夹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mkdir -p /www/website</span><br><span class="line">$ sudo chmod 777 /www/website</span><br></pre></td></tr></table></figure>
<h3 id="10-2-2-从客户端发布"><a href="#10-2-2-从客户端发布" class="headerlink" title="10.2.2 从客户端发布"></a>10.2.2 从客户端发布</h3><p>(1) 本地在项目中创建PM2 配置文件</p>
<p><strong>website-server/ecosystem.json</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"apps"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"name"</span>: <span class="string">"Website"</span>, <span class="comment">// 应用名称</span></span><br><span class="line">      <span class="string">"script"</span>: <span class="string">"app.js"</span>, <span class="comment">// 应用入口</span></span><br><span class="line">      <span class="string">"env"</span>: &#123;<span class="comment">// 启动应用时的环境变量</span></span><br><span class="line">        <span class="string">"COMMON_VARIABLE"</span>: <span class="literal">true</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"env_production"</span>: &#123;<span class="comment">// 生产环境启动应用时的环境变量</span></span><br><span class="line">        <span class="string">"NODE_ENV"</span>: <span class="string">"production"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"deploy"</span>: &#123;</span><br><span class="line">    <span class="string">"production"</span>: &#123; <span class="comment">// 任务名</span></span><br><span class="line">      <span class="string">"user"</span>: <span class="string">"imooc_manager"</span>, <span class="comment">// 生产服务器账号</span></span><br><span class="line">      <span class="string">"host"</span>: [<span class="string">"120.26.235.4"</span>], <span class="comment">// 生产服务器地址</span></span><br><span class="line">      <span class="string">"port"</span>: <span class="string">"39999"</span>, <span class="comment">// 服务器 SSH 端口</span></span><br><span class="line">      <span class="string">"ref"</span>: <span class="string">"origin/master"</span>, <span class="comment">// 分支</span></span><br><span class="line">      <span class="string">"repo"</span>: <span class="string">"git@git.oschina.net:wolf18387/backend-website.git"</span>, <span class="comment">// 仓库地址</span></span><br><span class="line">      <span class="string">"path"</span>: <span class="string">"/www/website/production"</span>, <span class="comment">// 应用部署路径(绝对路径, 要确保该路径对 imooc_manager 可读可写可执行)</span></span><br><span class="line">      <span class="string">"ssh_options"</span>: <span class="string">"StrictHostKeyChecking=no"</span>,</span><br><span class="line">      <span class="string">"env"</span>: &#123; <span class="comment">// 环境变量设置</span></span><br><span class="line">        <span class="string">"NODE_ENV"</span>: <span class="string">"production"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(2) 本地使用 PM2 部署到线上服务器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pm2 deploy ecosystem.json production setup</span><br></pre></td></tr></table></figure>
<h2 id="10-3-从本地发布上线和更新服务器的-Nodejs-项目"><a href="#10-3-从本地发布上线和更新服务器的-Nodejs-项目" class="headerlink" title="10.3 从本地发布上线和更新服务器的 Nodejs 项目"></a>10.3 从本地发布上线和更新服务器的 Nodejs 项目</h2><p>使用 PM2 实现本地控制远端代码更新和服务重启。</p>
<h3 id="10-3-1-服务端准备"><a href="#10-3-1-服务端准备" class="headerlink" title="10.3.1 服务端准备"></a>10.3.1 服务端准备</h3><p><strong>~/.bashrc</strong></p>
<p>由于 PM2 需要以交互的方式通过 SSH 连接服务器，需要注释掉下面的代码:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># If not running interactively, don't do anything</span></span><br><span class="line"><span class="comment">#case $- in</span></span><br><span class="line"><span class="comment">#	*i*);;</span></span><br><span class="line"><span class="comment">#	*) return;;</span></span><br><span class="line"><span class="comment">#esac</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></table></figure>
<h3 id="10-3-2-从客户端发布到服务端并启动应用"><a href="#10-3-2-从客户端发布到服务端并启动应用" class="headerlink" title="10.3.2 从客户端发布到服务端并启动应用"></a>10.3.2 从客户端发布到服务端并启动应用</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pm2 deploy ecosystem.json production</span><br></pre></td></tr></table></figure>
<h2 id="10-4-部署发布电影网站并连接线上-MongoDB"><a href="#10-4-部署发布电影网站并连接线上-MongoDB" class="headerlink" title="10.4 部署发布电影网站并连接线上 MongoDB"></a>10.4 部署发布电影网站并连接线上 MongoDB</h2><ol>
<li>在 DNSPOD 为电影网站添加一条记录(子域 movie.iblack7.com) ；</li>
<li>连接 MongoDB 的代码需要兼容开发环境和线上环境；</li>
<li>npm 包的药保证版本足够新；</li>
<li>Nginx 支持静态问价的访问能力。</li>
</ol>
<h3 id="10-4-1-修改入口的代码"><a href="#10-4-1-修改入口的代码" class="headerlink" title="10.4.1 修改入口的代码"></a>10.4.1 修改入口的代码</h3><p><strong>imooc_nodejs_deploy/movie/app.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">var env = process.env.NODE_ENV || <span class="string">'development'</span></span><br><span class="line"><span class="keyword">var</span> options = &#123;</span><br><span class="line">  dbUser: <span class="string">'imooc_movie_runner'</span>,</span><br><span class="line">  dbPwd: <span class="string">'F**k9001$'</span>,</span><br><span class="line">  dbHost: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">  dbPort: <span class="number">27018</span>,</span><br><span class="line">  dbName: <span class="string">'imooc_movie'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 开发环境连接测试使用的 MongoDB 服务器</span></span><br><span class="line"><span class="keyword">if</span> (env === <span class="string">'development'</span>) &#123;</span><br><span class="line">  options = &#123;</span><br><span class="line">    dbUser: <span class="string">'neo'</span>,</span><br><span class="line">    dbPwd: <span class="string">'xxx'</span>,</span><br><span class="line">    dbHost: <span class="string">'172.16.16.144'</span>,</span><br><span class="line">    dbPort: <span class="number">27017</span>,</span><br><span class="line">    dbName: <span class="string">'movies'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> dbUrl = <span class="string">`mongodb://<span class="subst">$&#123;options.dbUser&#125;</span>:<span class="subst">$&#123;options.dbPwd&#125;</span>@<span class="subst">$&#123;options.dbHost&#125;</span>:<span class="subst">$&#123;options.dbPort&#125;</span>/<span class="subst">$&#123;options.dbName&#125;</span>`</span></span><br><span class="line"></span><br><span class="line">mongoose.connect(dbUrl)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h3 id="10-4-2-PM2-配置文件"><a href="#10-4-2-PM2-配置文件" class="headerlink" title="10.4.2 PM2 配置文件"></a>10.4.2 PM2 配置文件</h3><p><strong>imooc_nodejs_deploy/movie/ecosystem.json</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"apps"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"name"</span>: <span class="string">"Movie"</span>, <span class="comment">// 应用名称</span></span><br><span class="line">      <span class="string">"script"</span>: <span class="string">"app.js"</span>, <span class="comment">// 应用入口</span></span><br><span class="line">      <span class="string">"env"</span>: &#123;<span class="comment">// 启动应用时的环境变量</span></span><br><span class="line">        <span class="string">"COMMON_VARIABLE"</span>: <span class="literal">true</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"env_production"</span>: &#123;<span class="comment">// 生产环境启动应用时的环境变量</span></span><br><span class="line">        <span class="string">"NODE_ENV"</span>: <span class="string">"production"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"deploy"</span>: &#123;</span><br><span class="line">    <span class="string">"production"</span>: &#123; <span class="comment">// 任务名</span></span><br><span class="line">      <span class="string">"user"</span>: <span class="string">"imooc_manager"</span>, <span class="comment">// 生产服务器账号</span></span><br><span class="line">      <span class="string">"host"</span>: [<span class="string">"120.26.235.4"</span>], <span class="comment">// 生产服务器地址</span></span><br><span class="line">      <span class="string">"port"</span>: <span class="string">"39999"</span>, <span class="comment">// 服务器 SSH 端口</span></span><br><span class="line">      <span class="string">"ref"</span>: <span class="string">"origin/master"</span>, <span class="comment">// 分支</span></span><br><span class="line">      <span class="string">"repo"</span>: <span class="string">"git@git.oschina.net:wolf18387/backend-movie.git"</span>, <span class="comment">// 仓库地址</span></span><br><span class="line">      <span class="string">"path"</span>: <span class="string">"/www/movie/production"</span>, <span class="comment">// 应用部署路径(绝对路径, 要确保该路径对 imooc_manager 可读可写可执行)</span></span><br><span class="line">      <span class="string">"ssh_options"</span>: <span class="string">"StrictHostKeyChecking=no"</span>,</span><br><span class="line">      <span class="comment">// 代码更新后</span></span><br><span class="line">      <span class="comment">// 1. 安装 npm 依赖</span></span><br><span class="line">      <span class="comment">// 2. 构建</span></span><br><span class="line">      <span class="comment">// 3. 重启 pm2</span></span><br><span class="line">      <span class="string">"post-deploy"</span>: <span class="string">"npm install --registry=https://registry.npm.taobao.org &amp;&amp; grunt build &amp;&amp; pm2 startOrRestart ecosystem.json --env production"</span>,</span><br><span class="line">      <span class="string">"env"</span>: &#123; <span class="comment">// 环境变量设置</span></span><br><span class="line">        <span class="string">"NODE_ENV"</span>: <span class="string">"production"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="10-4-3-服务端"><a href="#10-4-3-服务端" class="headerlink" title="10.4.3 服务端"></a>10.4.3 服务端</h3><p>(1) 创建个需要的目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mkdir -p /www/movie</span><br><span class="line">$ chmod 777 /www/movie</span><br></pre></td></tr></table></figure>
<p>(2) 配置 Nginx</p>
<p><strong>/etc/nginx/conf.d/www-iblack7-com-3000.conf</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">upstream movie &#123;</span><br><span class="line">  server 127.0.0.1:3001;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name movie.iblack7.com;</span><br><span class="line">  location / &#123;</span><br><span class="line">    proxy_<span class="built_in">set</span>_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">    proxy_<span class="built_in">set</span>_header X-Forward-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    proxy_<span class="built_in">set</span>_header Host <span class="variable">$http_host</span>;</span><br><span class="line">    proxy_<span class="built_in">set</span>_header X-Nginx-Proxy <span class="literal">true</span>;</span><br><span class="line">    proxy_pass http://movie;</span><br><span class="line">    proxy_redirect off;</span><br><span class="line">  &#125;</span><br><span class="line">  // 静态文件路由配置</span><br><span class="line">  localtion ~* ^.+\.(jpg|jpeg|gif|png|ico|css|js|pdf|txt) &#123;</span><br><span class="line">    root /www/movie/production/current/public;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(3) 设置 iptables ，放开 3001 端口</p>
<p><strong>/etc/iptables.up.rules</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># movie</span></span><br><span class="line">-A INPUT <span class="_">-s</span> 127.0.0.1 -p tcp --destination-port 3001 -m state --state NEW,ESTABLISHED -j ACCEPT</span><br><span class="line">-A OUTPUT <span class="_">-s</span> 127.0.0.1 -p tcp --source-port 3001 -m state --state ESTABLISHED -j ACCEPT</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo iptables-restore &lt; /etc/iptables.up.rules</span><br></pre></td></tr></table></figure>
<h3 id="10-4-4-本地使用-PM2-部署"><a href="#10-4-4-本地使用-PM2-部署" class="headerlink" title="10.4.4 本地使用 PM2 部署"></a>10.4.4 本地使用 PM2 部署</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> imooc_nodejs_deploy/movie</span><br><span class="line">$ git add . &amp;&amp; git commit -m <span class="string">"select mongodb besed on env"</span> &amp;&amp; git push origin master</span><br><span class="line">$ pm2 deploy ecosystem.json production</span><br></pre></td></tr></table></figure>
<h2 id="10-5-部署-ReactNative-App-线上-API-服务"><a href="#10-5-部署-ReactNative-App-线上-API-服务" class="headerlink" title="10.5 部署 ReactNative App 线上 API 服务"></a>10.5 部署 ReactNative App 线上 API 服务</h2><ol>
<li>在 DNSPOD 为电影网站添加一条记录(子域 free.iblack7.com) ；</li>
<li>入口文件中端口改为 3002, MongoDB 连接参数确保没问题且兼容线上和线下环境；</li>
<li>创建 PM2 配置文件 ecosystem.json；</li>
<li>配置好服务器配置。</li>
</ol>
<h3 id="10-5-1-项目准备好相关配置文件"><a href="#10-5-1-项目准备好相关配置文件" class="headerlink" title="10.5.1 项目准备好相关配置文件"></a>10.5.1 项目准备好相关配置文件</h3><p>(1) 创建 PM2 配置文件 ecosystem.json</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"apps"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"name"</span>: <span class="string">"free"</span>, // 应用名称</span><br><span class="line">      <span class="string">"script"</span>: <span class="string">"app.js"</span>, // 应用入口</span><br><span class="line">      <span class="string">"env"</span>: &#123;// 启动应用时的环境变量</span><br><span class="line">        <span class="string">"COMMON_VARIABLE"</span>: <span class="literal">true</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"env_production"</span>: &#123;// 生产环境启动应用时的环境变量</span><br><span class="line">        <span class="string">"NODE_ENV"</span>: <span class="string">"production"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"deploy"</span>: &#123;</span><br><span class="line">    <span class="string">"production"</span>: &#123; // 任务名</span><br><span class="line">      <span class="string">"user"</span>: <span class="string">"imooc_manager"</span>, // 生产服务器账号</span><br><span class="line">      <span class="string">"host"</span>: [<span class="string">"120.26.235.4"</span>], // 生产服务器地址</span><br><span class="line">      <span class="string">"port"</span>: <span class="string">"39999"</span>, // 服务器 SSH 端口</span><br><span class="line">      <span class="string">"ref"</span>: <span class="string">"origin/master"</span>, // 分支</span><br><span class="line">      <span class="string">"repo"</span>: <span class="string">"git@git.oschina.net:wolf18387/backend-app.git"</span>, // 仓库地址</span><br><span class="line">      <span class="string">"path"</span>: <span class="string">"/www/free/production"</span>, // 应用部署路径(绝对路径, 要确保该路径对 imooc_manager 可读可写可执行)</span><br><span class="line">      <span class="string">"ssh_options"</span>: <span class="string">"StrictHostKeyChecking=no"</span>,</span><br><span class="line">      <span class="string">"post-deploy"</span>: <span class="string">"npm install -- registry=https://registry.npm.taobao.org &amp;&amp; pm2 startOrRestart ecosystem.json --env production"</span>,</span><br><span class="line">      <span class="string">"env"</span>: &#123; // 环境变量设置</span><br><span class="line">        <span class="string">"NODE_ENV"</span>: <span class="string">"production"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(2) nodejs 服务添加一条路由规则</p>
<p><strong>imooc_nodejs_deploy/gougou-server/config/routes.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">router.get(<span class="string">'/'</span>, App.homePage)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><strong>imooc_nodejs_deploy/gougou-server/app/controllers/app.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">exports.homePage = <span class="function"><span class="keyword">function</span> *(<span class="params">next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.body = &#123;</span><br><span class="line">    success: <span class="literal">true</span>,</span><br><span class="line">    msg: <span class="string">'必须通过 API 访问'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>(3) app 中的 base url 改为线上地址</p>
<p><strong>imooc_nodejs_deploy/gougou-app/app/common/config.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> baseUrl = <span class="string">'http://free.ibblack7.com/'</span></span><br></pre></td></tr></table></figure>
<h3 id="10-5-2-配置好服务器配置"><a href="#10-5-2-配置好服务器配置" class="headerlink" title="10.5.2 配置好服务器配置"></a>10.5.2 配置好服务器配置</h3><p>(1) 准备好文件夹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mkdir -p /www/free</span><br><span class="line">$ sudo chmod -R 777 /www/free</span><br></pre></td></tr></table></figure>
<p>(2) 配置 Nginx</p>
<p><strong>/etc/nginx/conf.d/free-iblack7-com-3000.conf</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">upstream free &#123;</span><br><span class="line">  server 127.0.0.1:3002;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name free.iblack7.com;</span><br><span class="line">  location / &#123;</span><br><span class="line">    proxy_<span class="built_in">set</span>_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">    proxy_<span class="built_in">set</span>_header X-Forward-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    proxy_<span class="built_in">set</span>_header Host <span class="variable">$http_host</span>;</span><br><span class="line">    proxy_<span class="built_in">set</span>_header X-Nginx-Proxy <span class="literal">true</span>;</span><br><span class="line">    proxy_pass http://free;</span><br><span class="line">    proxy_redirect off;</span><br><span class="line">  &#125;</span><br><span class="line">  // 静态文件路由配置</span><br><span class="line">  localtion ~* ^.+\.(jpg|jpeg|gif|png|ico|css|js|pdf|txt) &#123;</span><br><span class="line">    root /www/app/production/current/public;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(3) 设置 iptables ，放开 3002 端口</p>
<p><strong>/etc/iptables.up.rules</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app</span></span><br><span class="line">-A INPUT <span class="_">-s</span> 127.0.0.1 -p tcp --destination-port 3002 -m state --state NEW,ESTABLISHED -j ACCEPT</span><br><span class="line">-A OUTPUT <span class="_">-s</span> 127.0.0.1 -p tcp --source-port 3002 -m state --state ESTABLISHED -j ACCEPT</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo iptables-restore &lt; /etc/iptables.up.rules</span><br></pre></td></tr></table></figure>
<h3 id="10-5-3-部署到服务器"><a href="#10-5-3-部署到服务器" class="headerlink" title="10.5.3 部署到服务器"></a>10.5.3 部署到服务器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'添加 PM2 配置；nodejs 服务针对非 API 请求提供提示信息'</span></span><br><span class="line">$ git push origin master</span><br><span class="line">$ pm2 deploy ecosystem.json production setup <span class="comment"># (第一次)部署到服务器</span></span><br><span class="line">$ pm2 deploy ecosystem.json production <span class="comment"># 启动服务</span></span><br></pre></td></tr></table></figure>
<h2 id="10-6-部署微信程序线上-API-服务"><a href="#10-6-部署微信程序线上-API-服务" class="headerlink" title="10.6 部署微信程序线上 API 服务"></a>10.6 部署微信程序线上 API 服务</h2><ol>
<li>在 DNSPOD 为电影网站添加一条记录(子域 mini.iblack7.com)；</li>
<li>入口文件中端口改为 3003, MongoDB 连接参数确保没问题且兼容线上和线下环境；</li>
<li>创建 PM2 配置文件 ecosystem.json；</li>
<li>配置好服务器配置。</li>
</ol>
<h3 id="10-6-1-项目准备好相关配置文件"><a href="#10-6-1-项目准备好相关配置文件" class="headerlink" title="10.6.1 项目准备好相关配置文件"></a>10.6.1 项目准备好相关配置文件</h3><p>(1) 创建 PM2 配置文件 ecosystem.json</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"apps"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"name"</span>: <span class="string">"mini"</span>, <span class="comment">// 应用名称</span></span><br><span class="line">      <span class="string">"script"</span>: <span class="string">"app.js"</span>, <span class="comment">// 应用入口</span></span><br><span class="line">      <span class="string">"env"</span>: &#123; <span class="comment">// 启动应用时的环境变量</span></span><br><span class="line">        <span class="string">"COMMON_VARIABLE"</span>: <span class="literal">true</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"env_production"</span>: &#123; <span class="comment">// 生产环境启动应用时的环境变量</span></span><br><span class="line">        <span class="string">"NODE_ENV"</span>: <span class="string">"production"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"deploy"</span>: &#123;</span><br><span class="line">    <span class="string">"production"</span>: &#123; <span class="comment">// 任务名</span></span><br><span class="line">      <span class="string">"user"</span>: <span class="string">"imooc_manager"</span>, <span class="comment">// 生产服务器账号</span></span><br><span class="line">      <span class="string">"host"</span>: [<span class="string">"120.26.235.4"</span>], <span class="comment">// 生产服务器地址</span></span><br><span class="line">      <span class="string">"port"</span>: <span class="string">"39999"</span>, <span class="comment">// 服务器 SSH 端口</span></span><br><span class="line">      <span class="string">"ref"</span>: <span class="string">"origin/master"</span>, <span class="comment">// 分支</span></span><br><span class="line">      <span class="string">"repo"</span>: <span class="string">"git@git.oschina.net:wolf18387/backend-indust.git"</span>, <span class="comment">// 仓库地址</span></span><br><span class="line">      <span class="string">"path"</span>: <span class="string">"/www/mini/production"</span>, <span class="comment">// 应用部署路径(绝对路径, 要确保该路径对 imooc_manager 可读可写可执行)</span></span><br><span class="line">      <span class="string">"ssh_options"</span>: <span class="string">"StrictHostKeyChecking=no"</span>,</span><br><span class="line">      <span class="string">"post-deploy"</span>: <span class="string">"npm install -- registry=https://registry.npm.taobao.org &amp;&amp; pm2 startOrRestart ecosystem.json --env production"</span>,</span><br><span class="line">      <span class="string">"env"</span>: &#123; <span class="comment">// 环境变量设置</span></span><br><span class="line">        <span class="string">"NODE_ENV"</span>: <span class="string">"production"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(2) MongoDB 连接兼容线下和线上</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> env = process.env.NODE_ENV || <span class="string">'development'</span></span><br><span class="line"><span class="keyword">var</span> dbUrl = <span class="string">'mongodb://imooc_app_runner:F**k9001@127.0.0.1:19999/imooc-indust'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (env === <span class="string">'development'</span>) &#123;</span><br><span class="line">  dbUrl = <span class="string">'mondodb://localhost/imooc-indust'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(3) nodejs 服务添加一条路由规则</p>
<p><strong>imooc_nodejs_deploy/gougou-server/config/routes.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">router.get(<span class="string">'/'</span>, App.homePage)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><strong>imooc_nodejs_deploy/gougou-server/app/controllers/app.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">exports.homePage = <span class="function"><span class="keyword">function</span> *(<span class="params">next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.body = &#123;</span><br><span class="line">    success: <span class="literal">true</span>,</span><br><span class="line">    msg: <span class="string">'必须通过 API 访问'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>(4) app 中的 base url 改为线上地址</p>
<p><strong>imooc_nodejs_deploy/indust-app/util/utils/api.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> base = <span class="string">'https://mini.ibblack7.com/api/'</span></span><br></pre></td></tr></table></figure>
<h3 id="10-6-2-配置好服务器配置"><a href="#10-6-2-配置好服务器配置" class="headerlink" title="10.6.2 配置好服务器配置"></a>10.6.2 配置好服务器配置</h3><p>(1) 准备好文件夹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mkdir -p /www/mini</span><br><span class="line">$ sudo chmod -R 777 /www/mini</span><br></pre></td></tr></table></figure>
<p>(2) 配置 Nginx</p>
<p><strong>/etc/nginx/conf.d/mini-iblack7-com-3000.conf</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">upstream mini &#123;</span><br><span class="line">  server 127.0.0.1:3003;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name mini.iblack7.com;</span><br><span class="line">  location / &#123;</span><br><span class="line">    proxy_<span class="built_in">set</span>_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">    proxy_<span class="built_in">set</span>_header X-Forward-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    proxy_<span class="built_in">set</span>_header Host <span class="variable">$http_host</span>;</span><br><span class="line">    proxy_<span class="built_in">set</span>_header X-Nginx-Proxy <span class="literal">true</span>;</span><br><span class="line">    proxy_pass http://mini;</span><br><span class="line">    proxy_redirect off;</span><br><span class="line">  &#125;</span><br><span class="line">  // 静态文件路由配置</span><br><span class="line">  localtion ~* ^.+\.(jpg|jpeg|gif|png|ico|css|js|pdf|txt) &#123;</span><br><span class="line">    root /www/mini/production/current/public;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(3) 设置 iptables ，放开 3003 端口</p>
<p><strong>/etc/iptables.up.rules</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># indust</span></span><br><span class="line">-A INPUT <span class="_">-s</span> 127.0.0.1 -p tcp --destination-port 3003 -m state --state NEW,ESTABLISHED -j ACCEPT</span><br><span class="line">-A OUTPUT <span class="_">-s</span> 127.0.0.1 -p tcp --source-port 3003 -m state --state ESTABLISHED -j ACCEPT</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo iptables-restore &lt; /etc/iptables.up.rules</span><br></pre></td></tr></table></figure>
<h3 id="10-6-3-部署到服务器"><a href="#10-6-3-部署到服务器" class="headerlink" title="10.6.3 部署到服务器"></a>10.6.3 部署到服务器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'添加 PM2 配置；nodejs 服务针对非 API 请求提供提示信息'</span></span><br><span class="line">$ git push origin master</span><br><span class="line">$ pm2 deploy ecosystem.json production setup <span class="comment"># (第一次)部署到服务器</span></span><br><span class="line">$ pm2 deploy ecosystem.json production <span class="comment"># 启动服务</span></span><br></pre></td></tr></table></figure>
<h2 id="10-7-部署配置微信公众号项目后台"><a href="#10-7-部署配置微信公众号项目后台" class="headerlink" title="10.7 部署配置微信公众号项目后台"></a>10.7 部署配置微信公众号项目后台</h2><ol>
<li>在 DNSPOD 为电影网站添加一条记录(子域 wechat.iblack7.com)；</li>
<li>入口文件中端口改为 3003, MongoDB 连接参数确保没问题且兼容线上和线下环境；</li>
<li>创建 PM2 配置文件 ecosystem.json；</li>
<li>配置好服务器配置。</li>
</ol>
<h3 id="10-7-1-项目准备好相关配置文件"><a href="#10-7-1-项目准备好相关配置文件" class="headerlink" title="10.7.1 项目准备好相关配置文件"></a>10.7.1 项目准备好相关配置文件</h3><p>(1) 创建 PM2 配置文件 ecosystem.json</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"apps"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"name"</span>: <span class="string">"wechat"</span>, <span class="comment">// 应用名称</span></span><br><span class="line">      <span class="string">"script"</span>: <span class="string">"app.js"</span>, <span class="comment">// 应用入口</span></span><br><span class="line">      <span class="string">"env"</span>: &#123; <span class="comment">// 启动应用时的环境变量</span></span><br><span class="line">        <span class="string">"COMMON_VARIABLE"</span>: <span class="literal">true</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"env_production"</span>: &#123; <span class="comment">// 生产环境启动应用时的环境变量</span></span><br><span class="line">        <span class="string">"NODE_ENV"</span>: <span class="string">"production"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"deploy"</span>: &#123;</span><br><span class="line">    <span class="string">"production"</span>: &#123; <span class="comment">// 任务名</span></span><br><span class="line">      <span class="string">"user"</span>: <span class="string">"imooc_manager"</span>, <span class="comment">// 生产服务器账号</span></span><br><span class="line">      <span class="string">"host"</span>: [<span class="string">"120.26.235.4"</span>], <span class="comment">// 生产服务器地址</span></span><br><span class="line">      <span class="string">"port"</span>: <span class="string">"39999"</span>, <span class="comment">// 服务器 SSH 端口</span></span><br><span class="line">      <span class="string">"ref"</span>: <span class="string">"origin/master"</span>, <span class="comment">// 分支</span></span><br><span class="line">      <span class="string">"repo"</span>: <span class="string">"git@git.oschina.net:wolf18387/backend-wechat.git"</span>, <span class="comment">// 仓库地址</span></span><br><span class="line">      <span class="string">"path"</span>: <span class="string">"/www/wechat/production"</span>, <span class="comment">// 应用部署路径(绝对路径, 要确保该路径对 imooc_manager 可读可写可执行)</span></span><br><span class="line">      <span class="string">"ssh_options"</span>: <span class="string">"StrictHostKeyChecking=no"</span>,</span><br><span class="line">      <span class="string">"post-deploy"</span>: <span class="string">"npm install -- registry=https://registry.npm.taobao.org &amp;&amp; pm2 startOrRestart ecosystem.json --env production"</span>,</span><br><span class="line">      <span class="string">"env"</span>: &#123; <span class="comment">// 环境变量设置</span></span><br><span class="line">        <span class="string">"NODE_ENV"</span>: <span class="string">"production"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(2) MongoDB 连接兼容线下和线上</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> env = process.env.NODE_ENV || <span class="string">'development'</span></span><br><span class="line"><span class="keyword">var</span> dbUrl = <span class="string">'mongodb://imooc_wechat_runner:KLLKDS@127.0.0.1:19999/imooc-wechat'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (env === <span class="string">'development'</span>) &#123;</span><br><span class="line">  dbUrl = <span class="string">'mondodb://localhost/imooc-wechat'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(3) nodejs 服务添加一条路由规则</p>
<p><strong>imooc_nodejs_deploy/gougou-server/config/routes.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">router.get(<span class="string">'/'</span>, App.homePage)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><strong>imooc_nodejs_deploy/gougou-server/app/controllers/app.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">exports.homePage = <span class="function"><span class="keyword">function</span> *(<span class="params">next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.body = &#123;</span><br><span class="line">    success: <span class="literal">true</span>,</span><br><span class="line">    msg: <span class="string">'必须通过 API 访问'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>(4) app 中的 base url 改为线上地址</p>
<p><strong>imooc_nodejs_deploy/gougou-app/app/common/config.js</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> baseUrl = <span class="string">'http://wechat.ibblack7.com/'</span></span><br></pre></td></tr></table></figure>
<h3 id="10-7-2-配置好服务器配置"><a href="#10-7-2-配置好服务器配置" class="headerlink" title="10.7.2 配置好服务器配置"></a>10.7.2 配置好服务器配置</h3><p>(1) 准备好文件夹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mkdir -p /www/wechat</span><br><span class="line">$ sudo chmod -R 777 /www/wechat</span><br></pre></td></tr></table></figure>
<p>(2) 配置 Nginx</p>
<p><strong>/etc/nginx/conf.d/wechat-iblack7-com-3000.conf</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">upstream wechat &#123;</span><br><span class="line">  server 127.0.0.1:3004;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name wechat.iblack7.com;</span><br><span class="line">  location / &#123;</span><br><span class="line">    proxy_<span class="built_in">set</span>_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">    proxy_<span class="built_in">set</span>_header X-Forward-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    proxy_<span class="built_in">set</span>_header Host <span class="variable">$http_host</span>;</span><br><span class="line">    proxy_<span class="built_in">set</span>_header X-Nginx-Proxy <span class="literal">true</span>;</span><br><span class="line">    proxy_pass http://wechat;</span><br><span class="line">    proxy_redirect off;</span><br><span class="line">  &#125;</span><br><span class="line">  // 静态文件路由配置</span><br><span class="line">  localtion ~* ^.+\.(jpg|jpeg|gif|png|ico|css|js|pdf|txt) &#123;</span><br><span class="line">    root /www/wechat/production/current/public;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(3) 设置 iptables ，放开 3004 端口</p>
<p><strong>/etc/iptables.up.rules</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># indust</span></span><br><span class="line">-A INPUT <span class="_">-s</span> 127.0.0.1 -p tcp --destination-port 3004 -m state --state NEW,ESTABLISHED -j ACCEPT</span><br><span class="line">-A OUTPUT <span class="_">-s</span> 127.0.0.1 -p tcp --source-port 3004 -m state --state ESTABLISHED -j ACCEPT</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo iptables-restore &lt; /etc/iptables.up.rules</span><br></pre></td></tr></table></figure>
<h3 id="10-7-3-部署到服务器"><a href="#10-7-3-部署到服务器" class="headerlink" title="10.7.3 部署到服务器"></a>10.7.3 部署到服务器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'添加 PM2 配置；nodejs 服务针对非 API 请求提供提示信息'</span></span><br><span class="line">$ git push origin master</span><br><span class="line">$ pm2 deploy ecosystem.json production setup <span class="comment"># (第一次)部署到服务器</span></span><br><span class="line">$ pm2 deploy ecosystem.json production <span class="comment"># 启动服务</span></span><br></pre></td></tr></table></figure>
<h3 id="10-7-4-微信公众号后台配置"><a href="#10-7-4-微信公众号后台配置" class="headerlink" title="10.7.4 微信公众号后台配置"></a>10.7.4 微信公众号后台配置</h3><p><img src="http://o6ul1xz4z.bkt.clouddn.com/2017-05-06-578BF6DF-6610-4D46-ABE5-68140E9535A6.png" alt="578BF6DF-6610-4D46-ABE5-68140E9535A6"></p>
<h1 id="11-使用和配置更安全的-HTTPS-协议"><a href="#11-使用和配置更安全的-HTTPS-协议" class="headerlink" title="11 使用和配置更安全的 HTTPS 协议"></a>11 使用和配置更安全的 HTTPS 协议</h1><h2 id="11-1-选购申请-SSL-证书的一些建议"><a href="#11-1-选购申请-SSL-证书的一些建议" class="headerlink" title="11.1 选购申请 SSL 证书的一些建议"></a>11.1 选购申请 SSL 证书的一些建议</h2><h3 id="为什么要使用-HTTPS"><a href="#为什么要使用-HTTPS" class="headerlink" title="为什么要使用 HTTPS?"></a>为什么要使用 HTTPS?</h3><ul>
<li>从 2017 年开始，Chrome 会将 HTTP 的网站标记为不安全的网站。</li>
<li>从 2017 年开始，苹果邀请所有 APP 都要使用 HTTPS 的加密连接。</li>
<li>微信小程序要求必须使用 HTTPS 协议。 </li>
</ul>
<h3 id="SSL-证书"><a href="#SSL-证书" class="headerlink" title="SSL 证书"></a>SSL 证书</h3><p><strong>SSL 证书分类</strong><br>| SSL 证书分类 | 安全级别                                     | 用途                                | 获取                              |<br>| ——– | —————————————- | ——————————— | ——————————- |<br>| DV       | 一般                                       | 个人博客、产品演示、中小企业网站                  | 有些免费的可以选择，即便收费的也通常不贵，申请流程也比较简单。 |<br>| OV       | 企业级别，等级较高                                | 常用在一些电商网站、社交、 O2O等涉及到用户资料、订单支付的场景 | 审核比较严格，价格不亲民，对业务有一定规模的可以考虑。     |<br>| EV       | 按照严格身份验证标准颁发的证书，是目前全球最高等级的 SSL 证书，安全性非常高，使用这个证书的网站，浏览器地址栏一般会显示为绿色 | 常用金融支付、网上银行等资金交易比较敏感的场景。          |                                 |</p>
<p><strong>SSL 证书有效期</strong><br>有的证书 3 个月过期，有的一年过期，每次过期后都需要更新证书，或者重新提交申请。可以通过一些工具或脚本，实现证书的自动更新。</p>
<p><strong>免费的 SSL 证书</strong><br>下面两家提供的免费的 DV SSL 已经被 Firefox 和 Chrome 屏蔽了，不推荐使用。</p>
<ul>
<li><a href="http://www.wosign.com/products/ssl.htm" target="_blank" rel="external">沃通(不推荐)</a></li>
<li><a href="https://www.startcomca.com" target="_blank" rel="external">StartSSL(不推荐)</a></li>
</ul>
<p><strong>付费的 SSL 证书</strong></p>
<ul>
<li><a href="https://www.symantec.com/zh/cn/ssl-certificates/" target="_blank" rel="external">赛门铁克 SSL 证书</a>: 资历老、风险小，推荐。</li>
<li><a href="https://www.geotrust.com/" target="_blank" rel="external">GeoTrust</a>: 全球第二大 SSL 证书颁发机构。</li>
<li><a href="https://www.trustasia.com/" target="_blank" rel="external">亚洲诚信</a>: 和赛门铁克有合作，根证书来自赛门铁克，国内用得比较多。</li>
</ul>
<h2 id="11-2-云平台申请免费证书及-Nginx-配置"><a href="#11-2-云平台申请免费证书及-Nginx-配置" class="headerlink" title="11.2 云平台申请免费证书及 Nginx 配置"></a>11.2 云平台申请免费证书及 Nginx 配置</h2><h3 id="11-2-1-云平台申请免费证书"><a href="#11-2-1-云平台申请免费证书" class="headerlink" title="11.2.1 云平台申请免费证书"></a>11.2.1 云平台申请免费证书</h3><p><strong>注意</strong>: 申请证书的域名必需是备案过的。</p>
<h4 id="又拍云"><a href="#又拍云" class="headerlink" title="又拍云"></a>又拍云</h4><p>可以在 <a href="https://www.upyun.com/https" target="_blank" rel="external">又拍云</a> 购买免费或付费的 SSL 证书，具体流程见<a href="http://docs.upyun.com/cdn/ssl/#ssl" target="_blank" rel="external">官方文档</a>。大致流程为：</p>
<ol>
<li>在后台创建服务；</li>
<li>创建服务后申请相应的证书；</li>
<li>域名的解析指向；</li>
</ol>
<h4 id="七牛"><a href="#七牛" class="headerlink" title="七牛"></a>七牛</h4><p><a href="https://portal.qiniu.com/certificate/ssl" target="_blank" rel="external">七牛 &gt; ssl 证书管理</a>中也可以购买 SSL 证书(默认赛门铁克)，七牛云用户免费。</p>
<h4 id="腾讯云-推荐"><a href="#腾讯云-推荐" class="headerlink" title="腾讯云(推荐)"></a>腾讯云(推荐)</h4><p><strong>注意</strong>: 如果要免费的证书，点击<code>申请证书</code>而不是<code>购买证书</code>。</p>
<p><a href="https://portal.qiniu.com/certificate/ssl" target="_blank" rel="external">云产品 &gt;  SSL 证书管理</a></p>
<p>(1) 申请证书<br><img src="./_image/2017-05-06-23-24-45.jpg" alt=""><br>(2) 选择 CA<br><img src="./_image/2017-05-06-23-26-55.jpg" alt=""><br>(3) 免费证书申请<br><img src="./_image/2017-05-06-23-28-06.jpg" alt=""></p>
<p>(4)选择 “手动 DNS 验证”<br><img src="./_image/2017-05-06-23-29-16.jpg" alt=""><br>(5) 获取<strong>主机记录</strong>和<strong>记录值</strong>;</p>
<p><img src="./_image/2017-05-06-23-30-31.jpg" alt=""><br>(6) 在 DNSPOD 中的 <code>iblack7.com</code> 下添加记录，使用上一步得到的的<strong>主机记录</strong>和<strong>记录值</strong>；</p>
<p><img src="./_image/2017-05-06-23-35-50.jpg" alt=""></p>
<p>(7) 获取 SSL 证书成功</p>
<p><img src="./_image/2017-05-06-23-37-30.jpg" alt=""><br>(8) 下载证书到本地，备用<br>默认提供了 Apache、IIS、Nginx 三种服务器的对应的 key。<br><img src="./_image/2017-05-06-23-40-37.jpg" alt=""></p>
<h4 id="阿里云"><a href="#阿里云" class="headerlink" title="阿里云"></a>阿里云</h4><p><a href="https://yundun.console.aliyun.com/?p=cas#/cas/home" target="_blank" rel="external">控制台 &gt; 安全(云盾) &gt; 证书服务</a></p>
<p><img src="./_image/2017-05-07-00-47-02.jpg" alt=""></p>
<h3 id="11-2-2-Nginx-配置"><a href="#11-2-2-Nginx-配置" class="headerlink" title="11.2.2 Nginx 配置"></a>11.2.2 Nginx 配置</h3><p>(1) 将 SSL 证书文件上传到服务器</p>
<ul>
<li>mini.iblack7.com 域名的 SSL 证书相关文件</li>
<li>free.iblack7.com 域名的 SSL 证书相关文件</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将 mini.iblack7.com 对应的 SSL 证书的 key 文件上传到服务器</span></span><br><span class="line">$ scp -P [ssh 端口] mini.iblack7.com/Nginx/2_mini.iblack7.com.key imoooc_manager@[服务器IP]:/home/imooc_manager/</span><br><span class="line"><span class="comment"># 将 mini.iblack7.com 对应的 SSL 证书的证书文件上传到服务器</span></span><br><span class="line">$ scp -P [ssh 端口] mini.iblack7.com/Nginx/1_mini.iblack7.com_bundle.crt imoooc_manager@[服务器IP]:/home/imooc_manager/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 free.iblack7.com 对应的 SSL 证书的 key 文件上传到服务器</span></span><br><span class="line">$ scp -P [ssh 端口] free.iblack7.com/Nginx/2_free.iblack7.com.key imoooc_manager@[服务器IP]:/www/ssl/</span><br><span class="line"><span class="comment"># 将 mini.iblack7.com 对应的 SSL 证书的证书文件上传到服务器</span></span><br><span class="line">$ scp -P [ssh 端口] free.iblack7.com/Nginx/1_free.iblack7.com_bundle.crt imoooc_manager@[服务器IP]:/www/ssl/</span><br></pre></td></tr></table></figure>
<p>(2) 证书安装<br>参考腾讯云的指引文档</p>
<p><img src="./_image/2017-05-06-23-52-22.jpg" alt=""></p>
<p>(1) nginx 配置更新<br><strong>/etc/nginx/conf.d/free-iblack7-3002.conf</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">upstream free &#123;</span><br><span class="line">  server 127.0.0.1:3002;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 HTTP 请求都重定向到 HTTPS 协议</span></span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name free.iblack7.com;</span><br><span class="line">  <span class="comment"># rewrite ^(.*) https://$host$1 permanent;</span></span><br><span class="line">  <span class="built_in">return</span> 301 https://free.iblack7.com<span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">  <span class="comment">#SSL--</span></span><br><span class="line">  listen 443; <span class="comment"># https 协议的默认端口</span></span><br><span class="line">  server_name free.iblack7.com;</span><br><span class="line">  ssl on; <span class="comment"># 启动 ssl 认证</span></span><br><span class="line">  ssl_certificate /www/ssl/1_free.iblack7.com_bundle.crt; <span class="comment"># SSL 证书文件的路径</span></span><br><span class="line">  ssl_certificate_key /www/ssl/2_free.iblack7.com.key; <span class="comment"># SSL key 文件的路径</span></span><br><span class="line">  ssl_session_timeout 5m;</span><br><span class="line">  ssl_protocals TLSv1 TLSv1.1 TLSv1.2; <span class="comment"># SSL 证书采用的协议</span></span><br><span class="line">  ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE; <span class="comment"># 配置的加密套件</span></span><br><span class="line">  ssl_prefer_server_chiphers on;</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable">$ssl_protocol</span> = <span class="string">""</span>) &#123;</span><br><span class="line">       rewrite ^(.*) https://<span class="variable">$host</span><span class="variable">$1</span> permanent;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">#-- SSL</span></span><br><span class="line">  location / &#123;</span><br><span class="line">    proxy_<span class="built_in">set</span>_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">    proxy_<span class="built_in">set</span>_header X-Forward-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    proxy_<span class="built_in">set</span>_header Host <span class="variable">$http_host</span>;</span><br><span class="line">    proxy_<span class="built_in">set</span>_header X-Nginx-Proxy <span class="literal">true</span>;</span><br><span class="line">    proxy_pass http://free;</span><br><span class="line">    proxy_redirect off;</span><br><span class="line">  &#125;</span><br><span class="line">  // 静态文件路由配置</span><br><span class="line">  localtion ~* ^.+\.(jpg|jpeg|gif|png|ico|css|js|pdf|txt) &#123;</span><br><span class="line">    root /www/app/production/current/public;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>/etc/nginx/conf.d/mini-iblack7-com-3000.conf</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">upstream mini &#123;</span><br><span class="line">  server 127.0.0.1:3003;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 将 HTTP 请求都重定向到 HTTPS 协议</span></span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name mini.iblack7.com;</span><br><span class="line">  <span class="comment"># rewrite ^(.*) https://$host$1 permanent;</span></span><br><span class="line">  <span class="built_in">return</span> 301 https://mini.iblack7.com<span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">  <span class="comment">#SSL--</span></span><br><span class="line">  listen 443; <span class="comment"># https 协议的默认端口</span></span><br><span class="line">  server_name mini.iblack7.com;</span><br><span class="line">  ssl on; <span class="comment"># 启动 ssl 认证</span></span><br><span class="line">  ssl_certificate /www/ssl/1_mini.iblack7.com_bundle.crt; <span class="comment"># SSL 证书文件的路径</span></span><br><span class="line">  ssl_certificate_key /www/ssl/2_mini.iblack7.com.key; <span class="comment"># SSL key 文件的路径</span></span><br><span class="line">  ssl_session_timeout 5m;</span><br><span class="line">  ssl_protocals TLSv1 TLSv1.1 TLSv1.2; <span class="comment"># SSL 证书采用的协议</span></span><br><span class="line">  ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE; <span class="comment"># 配置的加密套件</span></span><br><span class="line">  ssl_prefer_server_chiphers on;</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable">$ssl_protocol</span> = <span class="string">""</span>) &#123;</span><br><span class="line">       rewrite ^(.*) https://<span class="variable">$host</span><span class="variable">$1</span> permanent;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">#-- SSL</span></span><br><span class="line">  location / &#123;</span><br><span class="line">    proxy_<span class="built_in">set</span>_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">    proxy_<span class="built_in">set</span>_header X-Forward-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    proxy_<span class="built_in">set</span>_header Host <span class="variable">$http_host</span>;</span><br><span class="line">    proxy_<span class="built_in">set</span>_header X-Nginx-Proxy <span class="literal">true</span>;</span><br><span class="line">    proxy_pass http://mini;</span><br><span class="line">    proxy_redirect off;</span><br><span class="line">  &#125;</span><br><span class="line">  // 静态文件路由配置</span><br><span class="line">  localtion ~* ^.+\.(jpg|jpeg|gif|png|ico|css|js|pdf|txt) &#123;</span><br><span class="line">    root /www/mini/production/current/public;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo nginx -t</span><br><span class="line">$ sudo nginx <span class="_">-s</span> reload</span><br></pre></td></tr></table></figure>
<h2 id="11-3-聊一聊运维安全和应对思路"><a href="#11-3-聊一聊运维安全和应对思路" class="headerlink" title="11.3 聊一聊运维安全和应对思路"></a>11.3 聊一聊运维安全和应对思路</h2><p>这一期的课程到这里正式告一段落，相信大家看完之后会有一个实际执行的思路。沿着这个思路，大家要去多尝试，多充点，这样才不会很快忘记。</p>
<p>Nodejs 上线之后就涉及到运维，涉及到运维就等于涉及到了一个更深层次的厄安全课题，而安全是分等级的。一个100人的运维安全团队能够创造极高级别的安全环境，一个单兵作战的自己同样可以搭建相对安全的环境。所投入的人力成本不同，所获得的安全等级就有所不同。大家不必过多去纠结这个，因为也不存在绝对的安全。事实上，可以破坏你的安全环境的手段成千上万：前端的脚本漏洞、第三方的模块漏洞、Nodejs 本身的执行漏洞、服务器厂商的安全漏洞甚至是域名和 DNS 都可能出现劫持和污染，更别提通过社会工程学窃取你的社交账号和密码。密集的上游到下游的任何一个环节都可能会被人钻了空子。但对于大部分普通人或普通公司，不会有人盯着你的资源，试图获取你的数据或者资金，尽管如此，我们还是有必要在运维和安全的领域多多积累，就算不能做到保家卫国，至少也能强身健体。即便做非运营的岗位，也能跟运维团队做更好的沟通。</p>
<p>本期帮大家打通了从本地到线上的发布流程，从开发到生产环境的操作方式，大家可以沿着这个线，继续往下挖。无论是 2017 年还是 2018 年，Nodejs 这个有点年纪的新技术都会在这个市场是得到更佳充分的验证和使用，也对我们有了更多更大的挑战，无论是 Nodejs 本身在线上环境的进程守护、进程通信、错误的处理、日志的收集、性能的监控，还是多端口、多服务器的集群管理、基于 Docker 的环境部署、Nodejs 新老版本的交替兼容，还是 es 新语法的普及和使用、前后端模块的重用、静态资源的大包、服务端的渲染等等这些常见的课题都值得我们去尝试，夺取总结。我也会尽量收集大家的问题，等到合适的时候再推出更加深入的课程。比如 Docker 下的 Nodejs , MongoDB 的部署等等。</p>
<p>最后基于我个人的经验，给大家一个小小的建议，大家遇到一些服务器的问题，比如服务器连不上，可以自己先 Google 一下，如果20分钟还搞不定，千万一定要骚扰你的云服务器厂商，比如说阿里云。无论他们提供的文档，还是电话沟通，还是工单对接，从我的经验看，他们的工程师是最资深的，解决问题也是很有效率、非常专业的。同时可以利用这个机会适当的咨询一些技术问题，让他们解答。这也是一个非常好的付费学习途径。</p>
<p>这里是<a href="https://help.aliyun.com/knowledge_detail/41470.html" target="_blank" rel="external">阿里云服务器相关的文档地址</a>，没事来逛逛，混一个眼熟，遇到问题可以先到这里来瞄一眼。</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/MongoDB/" rel="tag">#MongoDB</a>
          
            <a href="/tags/nodejs/" rel="tag">#nodejs</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/04/21/BOOK_高性能网站建设指南_WEB开发者性能优化最佳实践/01_理解Ajax性能/" rel="next" title="01 理解 Ajax 性能">
                <i class="fa fa-chevron-left"></i> 01 理解 Ajax 性能
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/05/01/慕课网/imooc_React-Native-贯穿全栈开发-APP/" rel="prev" title="React Native 贯穿全栈开发 APP">
                React Native 贯穿全栈开发 APP <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2017/04/22/慕课网/imooc_NodeJS 线上服务器部署与发布/"
           data-title="NodeJS线上服务器部署与发布" data-url="http://laputa-er.github.io/2017/04/22/慕课网/imooc_NodeJS 线上服务器部署与发布/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Sean" />
          <p class="site-author-name" itemprop="name">Sean</p>
          <p class="site-description motion-element" itemprop="description">整理了一批过去一段时间ios相关的笔记，其它的笔记也整理下？源码分享出来？再说吧...反正也只有自己会看吧...</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">218</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">27</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">36</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#0-课程介绍"><span class="nav-text">0 课程介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#实战项目"><span class="nav-text">实战项目</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#环境和工具"><span class="nav-text">环境和工具</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#课程步骤"><span class="nav-text">课程步骤</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#重要知识点"><span class="nav-text">重要知识点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#最终效果"><span class="nav-text">最终效果</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#1-课程预热"><span class="nav-text">1 课程预热</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-为什么是全栈最后一公里"><span class="nav-text">1.1 为什么是全栈最后一公里</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-搭建线上生产环境需要做什么"><span class="nav-text">1.2 搭建线上生产环境需要做什么</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-待部署的-5-个本地-Nodejs-项目"><span class="nav-text">2 待部署的 5 个本地 Nodejs 项目</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-快速搭建一个纯静态简易站点"><span class="nav-text">2.1 快速搭建一个纯静态简易站点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-Nodejs-电影网站项目上线准备"><span class="nav-text">2.2 Nodejs 电影网站项目上线准备</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-1-升级下老旧的模块"><span class="nav-text">2.2.1 升级下老旧的模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-2-mongodb"><span class="nav-text">2.2.2 mongodb</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#安装-mongoDB"><span class="nav-text">安装 mongoDB</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#设置-mongoDB"><span class="nav-text">设置 mongoDB</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#设置用户"><span class="nav-text">设置用户</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启动-amp-amp-关闭-amp-amp-远程登录"><span class="nav-text">启动 && 关闭 && 远程登录</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-3-项目修改并测试"><span class="nav-text">2.2.3 项目修改并测试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#本地启动"><span class="nav-text">本地启动</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#浏览"><span class="nav-text">浏览</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-狗狗说-React-Native-开发的-App-后台项目分析"><span class="nav-text">2.3 狗狗说 React Native 开发的 App 后台项目分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-微信小程序的项目介绍"><span class="nav-text">2.4 微信小程序的项目介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-5-电影微信公众号的项目概况"><span class="nav-text">2.5 电影微信公众号的项目概况</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-6-从一个故事理解整个部署思路"><span class="nav-text">2.6 从一个故事理解整个部署思路</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-选购域名服务器及备案"><span class="nav-text">3 选购域名服务器及备案</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-选购域名的经验分享"><span class="nav-text">3.1 选购域名的经验分享</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#相关网站"><span class="nav-text">相关网站</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#注意事项"><span class="nav-text">注意事项</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-主机选择"><span class="nav-text">3.2 主机选择</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-域名备案流程走起来"><span class="nav-text">3.3 域名备案流程走起来</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#注意事项-1"><span class="nav-text">注意事项</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在阿里云官网进行备案"><span class="nav-text">在阿里云官网进行备案</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-远程登录服务器"><span class="nav-text">4 远程登录服务器</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-第一次-ssh-远程登录服务器"><span class="nav-text">4.1 第一次 ssh 远程登录服务器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-配置-root-及应用账号权限"><span class="nav-text">4.2 配置 root 及应用账号权限</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-配置本地无密码-SSH-登录"><span class="nav-text">4.3 配置本地无密码 SSH 登录</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-增强服务安全等级"><span class="nav-text">5 增强服务安全等级</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-修改服务器默认ssh登录端口"><span class="nav-text">5.1 修改服务器默认ssh登录端口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2-配置-iptables-和-Fall2Ban-增强安全等级"><span class="nav-text">5.2 配置 iptables 和 Fall2Ban 增强安全等级</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#iptables"><span class="nav-text">iptables</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Fail2Ban"><span class="nav-text">Fail2Ban</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#安装"><span class="nav-text">安装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置"><span class="nav-text">配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#运行状态"><span class="nav-text">运行状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#开启与关闭"><span class="nav-text">开启与关闭</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6-搭建-Nodejs-生产环境"><span class="nav-text">6 搭建 Nodejs 生产环境</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#6-1-搭建服务器的-Nodejs-环境"><span class="nav-text">6.1 搭建服务器的 Nodejs 环境</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#依赖环境"><span class="nav-text">依赖环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nvm"><span class="nav-text">nvm</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nodejs"><span class="nav-text">nodejs</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#升级-npm"><span class="nav-text">升级 npm</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设置系统文件监控数目"><span class="nav-text">设置系统文件监控数目</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-cnpm-取代-npm"><span class="nav-text">使用 cnpm 取代 npm</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#常用-nodejs-包"><span class="nav-text">常用 nodejs 包</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-2-借助-pm2-让-Nodejs-服务常驻"><span class="nav-text">6.2 借助 pm2 让 Nodejs 服务常驻</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#7-配置-nginx-实现反向代理"><span class="nav-text">7 配置 nginx 实现反向代理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#删除-apache2"><span class="nav-text">删除 apache2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装-nginx"><span class="nav-text">安装 nginx</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置-nginx"><span class="nav-text">配置 nginx</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#8-利用-DNSPod-管理域名解析"><span class="nav-text">8 利用 DNSPod 管理域名解析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#8-1-更改域名的-DNS-根服务器"><span class="nav-text">8.1 更改域名的 DNS 根服务器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-1-为什么要更改-DNS-根服务器？"><span class="nav-text">8.1.1 为什么要更改 DNS 根服务器？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-2-步骤"><span class="nav-text">8.1.2 步骤</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-2-配置解析项目的域名-A-记录和-CNAME"><span class="nav-text">8.2 配置解析项目的域名 A 记录和 CNAME</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#9-服务器配置安装-MongoDB"><span class="nav-text">9 服务器配置安装 MongoDB</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#9-1-在-Ubuntu-14-04-上安装-MongoDB"><span class="nav-text">9.1 在 Ubuntu 14.04 上安装 MongoDB</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-1-安装"><span class="nav-text">9.1.1 安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-2-配置"><span class="nav-text">9.1.2 配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#MongoDB-配置"><span class="nav-text">MongoDB 配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#防火墙配置"><span class="nav-text">防火墙配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-3-启动-amp-关闭"><span class="nav-text">9.1.3 启动&关闭</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-4-连接"><span class="nav-text">9.1.4 连接</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-2-往线上-MongoDB-导入单表数据或数据库"><span class="nav-text">9.2 往线上 MongoDB 导入单表数据或数据库</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-1-项目预览"><span class="nav-text">9.2.1 项目预览</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-2-整个数据库"><span class="nav-text">9.2.2 整个数据库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-3-单表"><span class="nav-text">9.2.3 单表</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-3-为上线项目配置-MongoDB-数据库读写权限"><span class="nav-text">9.3 为上线项目配置 MongoDB 数据库读写权限</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-3-1-创建-MongoDB-账号"><span class="nav-text">9.3.1 创建 MongoDB 账号</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-3-2-开启-MongoDB-安全认证"><span class="nav-text">9.3.2 开启 MongoDB 安全认证</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-4-从一台服务器迁移数据到另一个线上-MongoDB-中"><span class="nav-text">9.4 从一台服务器迁移数据到另一个线上 MongoDB 中</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-4-为数据库实现定时备份方案"><span class="nav-text">9.4 为数据库实现定时备份方案</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-4-1-编写定时任务脚本"><span class="nav-text">9.4.1 编写定时任务脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-4-2-设置定时任务规则"><span class="nav-text">9.4.2 设置定时任务规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-4-3-上传数据库备份到七牛私有云"><span class="nav-text">9.4.3 上传数据库备份到七牛私有云</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-4-4-扩展-安装-mysql"><span class="nav-text">9.4.4 扩展(安装 mysql)</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#10-项服务器正式部署和发布上线-Nodejs-项目"><span class="nav-text">10 项服务器正式部署和发布上线 Nodejs 项目</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#10-1-上传项目代码到线上私有-Git-仓库"><span class="nav-text">10.1 上传项目代码到线上私有 Git 仓库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-2-配置-PM2-一键部署线上项目结构"><span class="nav-text">10.2 配置 PM2 一键部署线上项目结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#10-2-1-服务端准备"><span class="nav-text">10.2.1 服务端准备</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-2-2-从客户端发布"><span class="nav-text">10.2.2 从客户端发布</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-3-从本地发布上线和更新服务器的-Nodejs-项目"><span class="nav-text">10.3 从本地发布上线和更新服务器的 Nodejs 项目</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#10-3-1-服务端准备"><span class="nav-text">10.3.1 服务端准备</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-3-2-从客户端发布到服务端并启动应用"><span class="nav-text">10.3.2 从客户端发布到服务端并启动应用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-4-部署发布电影网站并连接线上-MongoDB"><span class="nav-text">10.4 部署发布电影网站并连接线上 MongoDB</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#10-4-1-修改入口的代码"><span class="nav-text">10.4.1 修改入口的代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-4-2-PM2-配置文件"><span class="nav-text">10.4.2 PM2 配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-4-3-服务端"><span class="nav-text">10.4.3 服务端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-4-4-本地使用-PM2-部署"><span class="nav-text">10.4.4 本地使用 PM2 部署</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-5-部署-ReactNative-App-线上-API-服务"><span class="nav-text">10.5 部署 ReactNative App 线上 API 服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#10-5-1-项目准备好相关配置文件"><span class="nav-text">10.5.1 项目准备好相关配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-5-2-配置好服务器配置"><span class="nav-text">10.5.2 配置好服务器配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-5-3-部署到服务器"><span class="nav-text">10.5.3 部署到服务器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-6-部署微信程序线上-API-服务"><span class="nav-text">10.6 部署微信程序线上 API 服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#10-6-1-项目准备好相关配置文件"><span class="nav-text">10.6.1 项目准备好相关配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-6-2-配置好服务器配置"><span class="nav-text">10.6.2 配置好服务器配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-6-3-部署到服务器"><span class="nav-text">10.6.3 部署到服务器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-7-部署配置微信公众号项目后台"><span class="nav-text">10.7 部署配置微信公众号项目后台</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#10-7-1-项目准备好相关配置文件"><span class="nav-text">10.7.1 项目准备好相关配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-7-2-配置好服务器配置"><span class="nav-text">10.7.2 配置好服务器配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-7-3-部署到服务器"><span class="nav-text">10.7.3 部署到服务器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-7-4-微信公众号后台配置"><span class="nav-text">10.7.4 微信公众号后台配置</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#11-使用和配置更安全的-HTTPS-协议"><span class="nav-text">11 使用和配置更安全的 HTTPS 协议</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#11-1-选购申请-SSL-证书的一些建议"><span class="nav-text">11.1 选购申请 SSL 证书的一些建议</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#为什么要使用-HTTPS"><span class="nav-text">为什么要使用 HTTPS?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SSL-证书"><span class="nav-text">SSL 证书</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-2-云平台申请免费证书及-Nginx-配置"><span class="nav-text">11.2 云平台申请免费证书及 Nginx 配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#11-2-1-云平台申请免费证书"><span class="nav-text">11.2.1 云平台申请免费证书</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#又拍云"><span class="nav-text">又拍云</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#七牛"><span class="nav-text">七牛</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#腾讯云-推荐"><span class="nav-text">腾讯云(推荐)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#阿里云"><span class="nav-text">阿里云</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-2-2-Nginx-配置"><span class="nav-text">11.2.2 Nginx 配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-3-聊一聊运维安全和应对思路"><span class="nav-text">11.3 聊一聊运维安全和应对思路</span></a></li></ol></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Sean</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"lapuda-er"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
       search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();

    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
            // get the contents from search data
            isfetched = true;
            $('.popup').detach().appendTo('.header-inner');
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var matchcounts = 0;
                var str='<ul class=\"search-result-list\">';
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length > 1) {
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = true;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = data.url;
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '' && data_content != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title < 0 && index_content < 0 ){
                                isMatch = false;
                            } else {
                                if (index_content < 0) {
                                    index_content = 0;
                                }
                                if (i == 0) {
                                    first_occur = index_content;
                                }
                            }
                        });
                    }
                    // show search results
                    if (isMatch) {
                        matchcounts += 1;
                        str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 50;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substring(start, end);
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                            });

                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                        str += "</li>";
                    }
                })};
                str += "</ul>";
                if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
                if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
                $resultContent.innerHTML = str;
            });
            proceedsearch();
        }
    });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };

    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  

</body>
</html>
