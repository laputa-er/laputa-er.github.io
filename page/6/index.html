<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="整理了一批过去一段时间ios相关的笔记，其它的笔记也整理下？源码分享出来？再说吧...反正也只有自己会看吧...">
<meta property="og:type" content="website">
<meta property="og:title" content="Sean">
<meta property="og:url" content="http://laputa-er.github.io/page/6/index.html">
<meta property="og:site_name" content="Sean">
<meta property="og:description" content="整理了一批过去一段时间ios相关的笔记，其它的笔记也整理下？源码分享出来？再说吧...反正也只有自己会看吧...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Sean">
<meta name="twitter:description" content="整理了一批过去一段时间ios相关的笔记，其它的笔记也整理下？源码分享出来？再说吧...反正也只有自己会看吧...">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://laputa-er.github.io/page/6/"/>

  <title> Sean </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Sean</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">笔记分享</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/13/o-c基础教程第二版_18 键／值编码/" itemprop="url">
                  18 键/值编码
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-13T10:42:32+08:00" content="2016-05-13">
              2016-05-13
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/13/o-c基础教程第二版_18 键／值编码/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/13/o-c基础教程第二版_18 键／值编码/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="18-1-入门项目"><a href="#18-1-入门项目" class="headerlink" title="18.1    入门项目"></a>18.1    入门项目</h2><blockquote>
<p><strong>说明：</strong></p>
</blockquote>
<h2 id="18-2-KVC简介"><a href="#18-2-KVC简介" class="headerlink" title="18.2    KVC简介"></a>18.2    KVC简介</h2><blockquote>
<p><strong>说明：</strong>通过<code>键／值编码（KVC）</code>，没有相应<code>getter</code>方法也能获取属性值，没有相应<code>setter</code>方法也能设置属性值。<br><strong>自动开箱和装箱：</strong>仅<code>KVC</code>具有这种功能，常规方法调用和属性语法不具备该功能。</p>
</blockquote>
<h3 id="valueForKey实例方法"><a href="#valueForKey实例方法" class="headerlink" title="valueForKey实例方法"></a>valueForKey实例方法</h3><blockquote>
<p><strong>说明：</strong>将属性名作为<code>键</code>获取属性的<code>值</code>。<br><strong>原理：</strong>在<code>Objective-C</code>的运行中使用元数据打开对象并进入其中查找需要的信息，查找顺序为</p>
<ol>
<li>以参数命名(<code>key</code>或<code>isKey</code>)的<code>getter</code></li>
<li>名称为<code>_key</code>或<code>key</code>的实例变量</li>
</ol>
<p><strong>自动装箱：</strong>通过该方法获取属性值时，如果属性为<code>标量(int、float、struct)</code>，该方法会根据需要将属性放入<code>NSNumber</code>或<code>NSValue</code>中。<br><strong>兼容性：</strong>在<code>C</code>或<code>C++</code>中不能执行这种操作。<br><strong>原型：</strong><code>NSKeyValueCoding.h</code></p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* @param &#123;NSString *&#125; key 属性名</span><br><span class="line">* @return &#123;id&#125; 属性值（标量会被自动装箱）</span><br><span class="line">*/</span></span><br><span class="line">- (nullable <span class="keyword">id</span>)valueForKey:(<span class="built_in">NSString</span> *)key;</span><br></pre></td></tr></table></figure>
<h3 id="setValue-forkey实例方法"><a href="#setValue-forkey实例方法" class="headerlink" title="setValue:forkey实例方法"></a>setValue:forkey实例方法</h3><blockquote>
<p><strong>说明：</strong>将属性名作为<code>键</code>设置属性的<code>值</code>。<br><strong>自动开箱：</strong>使用该方法设置属性时，如果属性是<code>标量（int、float、struct）</code>，则会从新值（<code>id</code>）中提取出和属性类型相符的<code>标量</code>。<br><strong>技巧：</strong>如果想设置一个<code>标量</code>值，在调用<code>setValue</code>方法之前需要将它们包装掐来（封装到对象中）。<br><strong>原型：</strong><code>NSKeyValueCoding.h</code></p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* @param &#123;id&#125; value 要设置的值（需要的话会被开箱）</span><br><span class="line">* @param &#123;NSString *&#125; key 属性名</span><br><span class="line">*/</span></span><br><span class="line">- (<span class="keyword">void</span>)setValue:(nullable <span class="keyword">id</span>)value forKey:(<span class="built_in">NSString</span> *)key;</span><br></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 创建 Car 对象</span></span><br><span class="line">Car *car = [[Car alloc] init];</span><br><span class="line">car.name = <span class="string">@"Herbie"</span>;</span><br><span class="line">car.make = <span class="string">@"Honda"</span>;</span><br><span class="line">car.model = <span class="string">@"CRX"</span>;</span><br><span class="line">car.modelYear = <span class="number">1984</span>;</span><br><span class="line">car.numberOfDoors = <span class="number">2</span>;</span><br><span class="line">car.mileage = <span class="number">110000</span>;</span><br><span class="line"><span class="comment">// 初始化轮胎</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">    AllWeatherRadial *tire;</span><br><span class="line">    tire = [[AllWeatherRadial alloc] init];</span><br><span class="line">    [car setTire: tire atIndex:i];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 初始化引擎</span></span><br><span class="line">Slant6 *engine = [[Slant6 alloc] init];</span><br><span class="line">car.engine = engine;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过 KVC 访问车的引擎的马力</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"horsepower is %@"</span>, [engine valueForKey:<span class="string">@"horsepower"</span>]);</span><br><span class="line"><span class="comment">// 通过 KVC 重新设置车的引擎的马力</span></span><br><span class="line">[engine setValue:[<span class="built_in">NSNumber</span> numberWithInt:<span class="number">150</span>] forKey:<span class="string">@"horsepower"</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"horsepower is %@"</span>, [engine valueForKey:<span class="string">@"horsepower"</span>]);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"Car is %@"</span>, car);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过 KVC 访问车的名字</span></span><br><span class="line"><span class="built_in">NSString</span> *name = [car valueForKey:<span class="string">@"name"</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, name);</span><br><span class="line"><span class="comment">// 通过 KVC 访问车的制造商</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"make is %@"</span>, [car valueForKey:<span class="string">@"make"</span>]);</span><br><span class="line"><span class="comment">// 通过 KVC 访问车的车型出厂日期</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"model year is %@"</span>, [car valueForKey:<span class="string">@"modelYear"</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过 KVC 设置车名</span></span><br><span class="line">[car setValue:<span class="string">@"Harold"</span> forKey:<span class="string">@"name"</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"new car name is %@"</span>, [car name]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过 KVC 设置里程数</span></span><br><span class="line">[car setValue:[<span class="built_in">NSNumber</span> numberWithFloat:<span class="number">25062.4</span>] forKey:<span class="string">@"mileage"</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"new mileage is %.1f"</span>, [car mileage]);</span><br></pre></td></tr></table></figure>
<h2 id="18-3-键路径"><a href="#18-3-键路径" class="headerlink" title="18.3    键路径"></a>18.3    键路径</h2><blockquote>
<p><strong>说明：</strong>进行<code>get</code>和<code>set</code>操作，除了通过<code>键</code>，还可以通过<code>键路径</code>。<code>键路径</code>可以根据<code>对象图</code>访问到任意深度的对象，比使用一系列嵌套方法调用更容易访问到对象。</p>
</blockquote>
<h3 id="valueForKeyPath实例方法"><a href="#valueForKeyPath实例方法" class="headerlink" title="valueForKeyPath实例方法"></a>valueForKeyPath实例方法</h3><blockquote>
<p><strong>说明：</strong>将属性名作为<code>键</code>获取属性的<code>值</code>。<br><strong>原型：</strong><code>NSKeyValueCoding.h</code></p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* @param &#123;NSString *&#125; keyPath 键路径</span><br><span class="line">* @return &#123;id&#125; 属性值（标量会被自动装箱）</span><br><span class="line">*/</span></span><br><span class="line">- (nullable <span class="keyword">id</span>)valueForKeyPath:(<span class="built_in">NSString</span> *)keyPath;</span><br></pre></td></tr></table></figure>
<h3 id="setValue-forKeyPath实例方法"><a href="#setValue-forKeyPath实例方法" class="headerlink" title="setValue:forKeyPath实例方法"></a>setValue:forKeyPath实例方法</h3><blockquote>
<p><strong>说明：</strong>将属性名作为<code>键</code>设置属性的<code>值</code>。<br><strong>原型：</strong><code>NSKeyValueCoding.h</code></p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* @param &#123;id&#125; value 要设置的值（需要的话会被开箱）</span><br><span class="line">* @param &#123;NSString *&#125; keyPath 键路径</span><br><span class="line">*/</span></span><br><span class="line">- (<span class="keyword">void</span>)setValue:(nullable <span class="keyword">id</span>)value forKeyPath:(<span class="built_in">NSString</span> *)keyPath;</span><br></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过 KVC 设置车的引擎的马力</span></span><br><span class="line">[car setValue:[<span class="built_in">NSNumber</span> numberWithInt:<span class="number">155</span>] forKeyPath:<span class="string">@"engine.horsepower"</span>];</span><br><span class="line"><span class="comment">// 通过 KVC 访问车的引擎的马力</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"horsepower is %@"</span>, [car valueForKeyPath:<span class="string">@"engine.horsepower"</span>]);</span><br></pre></td></tr></table></figure>
<h2 id="18-4-整体操作"><a href="#18-4-整体操作" class="headerlink" title="18.4    整体操作"></a>18.4    整体操作</h2><blockquote>
<p><strong>说明：</strong>如果使用<code>键值</code>或<code>键路径</code>访问位于对象中的数组类型的<code>实例属性</code>的元素，实际上会对数组中所有元素进行操作。如果是查询操作，则还会将查询结果打包到另一个数组中并返回。<br><strong>注意：</strong>这种<code>整体操作</code>意味着无法在<code>键路径</code>中单独索引数组类型的属性的其中一个元素。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过 KVC 访问车的轮胎的胎压，会便利tires的每个属性，并将所有tires的属性的pressure变量封装到 NSNumber 对象中并返回</span></span><br><span class="line"><span class="built_in">NSArray</span> *pressures = [car valueForKeyPath:<span class="string">@"tires.pressure"</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"pressures %@"</span>, pressures);</span><br></pre></td></tr></table></figure>
<h3 id="18-4-1-休息一下"><a href="#18-4-1-休息一下" class="headerlink" title="18.4.1    休息一下"></a>18.4.1    休息一下</h3><blockquote>
<p><strong>说明：</strong>创建一个新的类用于后面的学习使用。</p>
</blockquote>
<p><em>Garage.h</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Cocoa/Cocoa.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@class</span> <span class="title">Car</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Garage</span> : <span class="title">NSObject</span> </span>&#123;</span><br><span class="line">	<span class="built_in">NSString</span> *name;</span><br><span class="line">	<span class="built_in">NSMutableArray</span> *cars;</span><br><span class="line">	<span class="built_in">NSMutableDictionary</span> *stuff;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>) addCar: (Car *) car;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>) print;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span> <span class="comment">// Garage</span></span><br></pre></td></tr></table></figure>
<p><em>Garage.m</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"Garage.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Garage</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@synthesize</span> name;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>) addCar: (Car *) car &#123;</span><br><span class="line">	<span class="keyword">if</span> (cars == <span class="literal">nil</span>) &#123;</span><br><span class="line">		cars = [[<span class="built_in">NSMutableArray</span> alloc] init];</span><br><span class="line">	&#125;</span><br><span class="line">	[cars addObject: car];</span><br><span class="line">	</span><br><span class="line">&#125; <span class="comment">// addCar</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>) dealloc &#123;</span><br><span class="line">	[name release];</span><br><span class="line">	[cars release];</span><br><span class="line">	[stuff release];</span><br><span class="line">	[<span class="keyword">super</span> dealloc];</span><br><span class="line">&#125; <span class="comment">// dealloc</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>) print &#123;</span><br><span class="line">	<span class="built_in">NSLog</span> (<span class="string">@"%@:"</span>, name);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span> (Car *car <span class="keyword">in</span> cars) &#123;</span><br><span class="line">		<span class="built_in">NSLog</span> (<span class="string">@"    %@"</span>, car);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125; <span class="comment">// print</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>) setValue: (<span class="keyword">id</span>) value  forUndefinedKey: (<span class="built_in">NSString</span> *) key &#123;</span><br><span class="line">	<span class="keyword">if</span> (stuff == <span class="literal">nil</span>) &#123;</span><br><span class="line">		stuff = [[<span class="built_in">NSMutableDictionary</span> alloc] init];</span><br><span class="line">	&#125;</span><br><span class="line">	[stuff setValue: value forKey: key];</span><br><span class="line">&#125; <span class="comment">// setValueForUndefinedKey</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>) valueForUndefinedKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">	<span class="keyword">id</span> value = [stuff valueForKey: key];</span><br><span class="line">	<span class="keyword">return</span> (value);</span><br><span class="line">&#125; <span class="comment">// valueForUndefinedKey</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span>  <span class="comment">// Car</span></span><br></pre></td></tr></table></figure>
<p><em>main.m</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 汽车集合</span></span><br><span class="line">Garage *garage = [[Garage alloc] init];</span><br><span class="line">garage.name = <span class="string">@"Joe's Garage"</span>;</span><br><span class="line"><span class="comment">// 创建一些汽车实例</span></span><br><span class="line">Car *car;</span><br><span class="line">car = makeCar(<span class="string">@"Herbie"</span>, <span class="string">@"Honda"</span>, <span class="string">@"CRX"</span>, <span class="number">1984</span>, <span class="number">2</span>, <span class="number">110000</span>, <span class="number">58</span>);</span><br><span class="line">[garage addCar:car];</span><br><span class="line">car = makeCar(<span class="string">@"Badger"</span>, <span class="string">@"Acura"</span>, <span class="string">@"integra"</span>, <span class="number">1987</span>, <span class="number">5</span>, <span class="number">217036</span>, <span class="number">130</span>);</span><br><span class="line">[garage addCar:car];</span><br><span class="line">car = makeCar(<span class="string">@"Elvis"</span>, <span class="string">@"Acura"</span>, <span class="string">@"Legend"</span>, <span class="number">1989</span>, <span class="number">4</span>, <span class="number">28123.4</span>, <span class="number">151</span>);</span><br><span class="line">[garage addCar:car];</span><br><span class="line">car = makeCar(<span class="string">@"Phoenix"</span>, <span class="string">@"Pontiac"</span>, <span class="string">@"Firebird"</span>, <span class="number">1969</span>, <span class="number">2</span>, <span class="number">85128.3</span>, <span class="number">345</span>);</span><br><span class="line">[garage addCar:car];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 观察汽车集合</span></span><br><span class="line">[garage print];</span><br></pre></td></tr></table></figure>
<h3 id="18-4-2-快速运算"><a href="#18-4-2-快速运算" class="headerlink" title="18.4.2    快速运算"></a>18.4.2    快速运算</h3><blockquote>
<p><strong>说明：</strong><code>键路径</code>中可以使用进行引用一些运算符进行一些运算，比如</p>
<ul>
<li><strong>prevProperty.<code>@count</code>：</strong>计算 <strong>prevProperty</strong> 包含的对象的总数</li>
<li><strong>prevProperty.<code>@sum</code>.nextProperty：</strong>计算<strong>prevProperty</strong>包含的所有对象的<strong>nextProperty</strong>属性的总和</li>
<li><strong>prevProperty.<code>@avg</code>.nextProperty：</strong>计算<strong>prevProperty</strong>包含的所有对象的<strong>nextProperty</strong>属性的平均值</li>
<li><strong>prevProperty.<code>@max</code>.nextProperty：</strong>计算<strong>prevProperty</strong>包含的所有对象的<strong>nextProperty</strong>属性的最大值</li>
<li><strong>prevProperty.<code>@min</code>.nextProperty：</strong>计算<strong>prevProperty</strong>包含的所有对象的<strong>nextProperty</strong>属性的最小值</li>
<li><strong>prevProperty.<code>@distinctUnionOfObjects</code>.nextProperty：</strong>获得从<strong>prevProperty</strong>包含的所有对象的<strong>nextProperty</strong>属性构成的集合去重后的集合</li>
</ul>
<p><strong>注意：</strong>不要滥用<code>KVC</code>通过<code>键路径</code>提供的处理集合类的<code>快速运算</code>特性，因为</p>
<ul>
<li>速度比较慢</li>
<li>编译器无法对它进行错误检查（出现运行时错误时才能发觉）</li>
</ul>
<p><strong>限制：</strong>无法添加自定义的运算符</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// @count</span></span><br><span class="line"><span class="built_in">NSNumber</span> *count = [garage valueForKeyPath:<span class="string">@"cars.@count"</span>];</span><br><span class="line"><span class="comment">// @sum</span></span><br><span class="line"><span class="built_in">NSNumber</span> *sum = [garage valueForKeyPath:<span class="string">@"cars.@sum.mileage"</span>];</span><br><span class="line"><span class="comment">// @avg</span></span><br><span class="line"><span class="built_in">NSNumber</span> *avgMileage = [garage valueForKeyPath:<span class="string">@"cars.@avg.mileage"</span>];</span><br><span class="line"><span class="comment">// @max、 @min</span></span><br><span class="line"><span class="built_in">NSNumber</span> *min, *max;</span><br><span class="line">max = [garage valueForKeyPath:<span class="string">@"cars.@max.mileage"</span>];</span><br><span class="line">min = [garage valueForKeyPath:<span class="string">@"cars.@max.mileage"</span>];</span><br><span class="line"><span class="comment">// @distinctUnionOfObjects</span></span><br><span class="line"><span class="built_in">NSArray</span> *manufacture = [garage valueForKeyPath:<span class="string">@"cars.@distinctUnionOfObjects.make"</span>];</span><br></pre></td></tr></table></figure>
<h2 id="18-5-批处理"><a href="#18-5-批处理" class="headerlink" title="18.5    批处理"></a>18.5    批处理</h2><blockquote>
<p><strong>说明：</strong><code>KVC</code>提供了对对象进行批量操作的方式。</p>
</blockquote>
<h3 id="setValuesForKeysWithDictionary实例方法"><a href="#setValuesForKeysWithDictionary实例方法" class="headerlink" title="setValuesForKeysWithDictionary实例方法"></a>setValuesForKeysWithDictionary实例方法</h3><blockquote>
<p><strong>说明：</strong>通过<code>字典</code>对对象进行批量<code>set</code>。<br><strong>原型：</strong><code>NSKeyValueCoding.h</code></p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* @param &#123;NSDictionary&lt;NSString *, id&gt; *&#125; keyedValues 包含一系列属性名和值的字典</span><br><span class="line">*/</span></span><br><span class="line">- (<span class="keyword">void</span>)setValuesForKeysWithDictionary:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *, <span class="keyword">id</span>&gt; *)keyedValues;</span><br></pre></td></tr></table></figure>
<h3 id="dictionaryWithValuesForKeys实例方法"><a href="#dictionaryWithValuesForKeys实例方法" class="headerlink" title="dictionaryWithValuesForKeys实例方法"></a>dictionaryWithValuesForKeys实例方法</h3><blockquote>
<p><strong>说明：</strong>通过<code>数组</code>对对象进行批量<code>set</code><br><strong>原型：</strong><code>NSKeyValueCoding.h</code></p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* @param &#123;NSArray&lt;NSString *&gt; *&#125; keys 包含要获取的属性的属性名</span><br><span class="line">* @return &#123;NSDictionary&lt;NSString *, id&gt; *&#125; 包含要获取的属性名/属性值对的字典</span><br><span class="line">*/</span></span><br><span class="line">- (<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *, <span class="keyword">id</span>&gt; *)dictionaryWithValuesForKeys:(<span class="built_in">NSArray</span>&lt;<span class="built_in">NSString</span> *&gt; *)keys;</span><br></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取汽车集合中的最后一个汽车实例</span></span><br><span class="line">car = [[garage valueForKeyPath:<span class="string">@"cars"</span>] lastObject];</span><br><span class="line"><span class="comment">// 创建一个数组：包含创建字典需要的键集合</span></span><br><span class="line"><span class="built_in">NSArray</span> *keys = [<span class="built_in">NSArray</span> arrayWithObjects:<span class="string">@"make"</span>, <span class="string">@"model"</span>, <span class="string">@"modelYear"</span>, <span class="literal">nil</span>];</span><br><span class="line"><span class="comment">// 使用 KVC 批量get：利用上一步创建的包含一系列键的数组</span></span><br><span class="line"><span class="built_in">NSDictionary</span> *carValues = [car dictionaryWithValuesForKeys:keys];</span><br><span class="line"><span class="comment">// 创建字典：用于初始化汽车实例的属性</span></span><br><span class="line"><span class="built_in">NSDictionary</span> *newValues = [<span class="built_in">NSDictionary</span> dictionaryWithObjectsAndKeys:</span><br><span class="line">                           <span class="string">@"Chevy"</span>, <span class="string">@"make"</span>,</span><br><span class="line">                           <span class="string">@"Nova"</span>,<span class="string">@"model"</span>,</span><br><span class="line">                           [<span class="built_in">NSNumber</span> numberWithInt:<span class="number">1964</span>], <span class="string">@"modelYear"</span>,</span><br><span class="line">                           [<span class="built_in">NSNull</span> null], <span class="string">@"mileage"</span>,</span><br><span class="line">                           <span class="literal">nil</span>];</span><br><span class="line"><span class="comment">// 使用 KVC 批量set汽车</span></span><br><span class="line">[car setValuesForKeysWithDictionary:newValues];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"car with new values is %@"</span>, car);</span><br></pre></td></tr></table></figure>
<h2 id="18-6-nil-仍然可用"><a href="#18-6-nil-仍然可用" class="headerlink" title="18.6    nil 仍然可用"></a>18.6    nil 仍然可用</h2><blockquote>
<p><strong>背景：</strong>默认情况下，应用<code>KVC</code>调用<code>setValue:forKey</code>设置某个属性的值为<code>nil</code>时，编译器会给出警告。<br><strong>解决：</strong>可以通过重写<code>setNilValueForKey</code>方法给出有意义个返回值而避免警告。<br><strong>扩展：</strong>这里的 <code>nil</code>是标量<code>nil</code>，不要和<code>[NSNull null]</code>相混淆</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>) setNilValueForKey: (<span class="built_in">NSString</span> *) key &#123;</span><br><span class="line">	<span class="keyword">if</span> ([key isEqualToString: <span class="string">@"mileage"</span>]) &#123;</span><br><span class="line">		mileage = <span class="number">0</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		[<span class="keyword">super</span> setNilValueForKey: key];</span><br><span class="line">	&#125;</span><br><span class="line">&#125; <span class="comment">// setNilValueForKey</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 会将 mileage 设置为 0</span></span><br><span class="line">[car setValue: <span class="literal">nil</span> forKey: <span class="string">@"mileage"</span>];</span><br></pre></td></tr></table></figure>
<h2 id="18-7-处理未定义键"><a href="#18-7-处理未定义键" class="headerlink" title="18.7    处理未定义键"></a>18.7    处理未定义键</h2><blockquote>
<p><strong>背景：</strong>如果<code>KVC</code>机制无法找到处理方法，会退回并询问该如何处理。默认的实现会取消操作。<br><strong>解决：</strong>通过重写<code>setValue:forUndefinedKey</code>和<code>valueForUndefinedKey</code>更改默认行为，使对象可以设置和获取任何键。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> *  @override</span><br><span class="line"> *  处理通过 KVC 设置不存在的属性的值</span><br><span class="line"> *</span><br><span class="line"> *  @param value 要设置的值</span><br><span class="line"> *  @param key   要设置的属性名</span><br><span class="line"> */</span></span><br><span class="line">- (<span class="keyword">void</span>) setValue:(<span class="keyword">id</span>)value forUndefinedKey: (<span class="built_in">NSString</span> *) key</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 惰性初始化</span></span><br><span class="line">    <span class="keyword">if</span> (stuff == <span class="literal">nil</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        stuff = [[<span class="built_in">NSMutableDictionary</span> alloc] init];</span><br><span class="line">    &#125;</span><br><span class="line">    [stuff setValue:value forKey:key];</span><br><span class="line">&#125;<span class="comment">// setValueForUndefinedKey</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> *  @override</span><br><span class="line"> *  处理通过 KVC 方式获取不存在的属性的值</span><br><span class="line"> *</span><br><span class="line"> *  @param key 属性名</span><br><span class="line"> *</span><br><span class="line"> *  @return 试图获取不存在的属性的值时的返回值</span><br><span class="line"> */</span></span><br><span class="line">- (<span class="keyword">id</span>) valueForUndefinedKey:(<span class="built_in">NSString</span> *)key</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">id</span> value = [stuff valueForKey:key];</span><br><span class="line">    <span class="keyword">return</span> (value);</span><br><span class="line">&#125;<span class="comment">// valueForUnderfinedKey</span></span><br></pre></td></tr></table></figure>
<h2 id="18-8-小结"><a href="#18-8-小结" class="headerlink" title="18.8    小结"></a>18.8    小结</h2>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/13/o-c基础教程第二版_17 文件的加载于保存/" itemprop="url">
                  17 文件的加载与保存
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-13T10:42:12+08:00" content="2016-05-13">
              2016-05-13
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/13/o-c基础教程第二版_17 文件的加载于保存/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/13/o-c基础教程第二版_17 文件的加载于保存/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="17-1-属性列表"><a href="#17-1-属性列表" class="headerlink" title="17.1    属性列表"></a>17.1    属性列表</h2><h3 id="17-1-1-NSDate"><a href="#17-1-1-NSDate" class="headerlink" title="17.1.1    NSDate"></a>17.1.1    NSDate</h3><h4 id="date类方法"><a href="#date类方法" class="headerlink" title="date类方法"></a>date类方法</h4><blockquote>
<p><strong>说明：</strong>获取当前日期和时间。<br><strong>原型：</strong><code>NSDate</code></p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* @return &#123;instancetype&#125; NSDate类实例</span><br><span class="line">*/</span></span><br><span class="line">+ (instancetype)date;</span><br></pre></td></tr></table></figure>
<h4 id="dateWithTimeIntervalSinceNow类方法"><a href="#dateWithTimeIntervalSinceNow类方法" class="headerlink" title="dateWithTimeIntervalSinceNow类方法"></a>dateWithTimeIntervalSinceNow类方法</h4><blockquote>
<p><strong>说明：</strong>获取与当前时间相隔一定时差的日期<br><strong>原型：</strong><code>NSDate</code></p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">*@return &#123;instancetype&#125; NSDate实例</span><br><span class="line">*/</span></span><br><span class="line">+ (instancetype)dateWithTimeIntervalSinceNow:(<span class="built_in">NSTimeInterval</span>)secs;</span><br></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取当前的日期和时间</span></span><br><span class="line"><span class="built_in">NSDate</span> *date = [<span class="built_in">NSDate</span> date];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"today is %@"</span>, date);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取24小时之前的时间</span></span><br><span class="line"><span class="built_in">NSDate</span> *yesterday = [<span class="built_in">NSDate</span> dateWithTimeIntervalSinceNow:-(<span class="number">24</span>* <span class="number">60</span> *<span class="number">60</span>)];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"yesterday is %@"</span>, yesterday);</span><br></pre></td></tr></table></figure>
<h3 id="17-1-2-NSData"><a href="#17-1-2-NSData" class="headerlink" title="17.1.2    NSData"></a>17.1.2    NSData</h3><blockquote>
<p><strong>说明：</strong>该类可以包含大量的字节，可以获得数据的长度和指向字节启示位置的指针<br><strong>用途：</strong>如果想将数据块传递给一个函数或方法，可以通过传递一个<code>NSData</code>来实现。<br>注意：<code>NSData</code>是一个对象，支持<code>自动释放</code>的，常规的内存管理对它是有效的，因而无需担心内存清理的问题。</p>
</blockquote>
<h4 id="dataWithBytes类方法"><a href="#dataWithBytes类方法" class="headerlink" title="dataWithBytes类方法"></a>dataWithBytes类方法</h4><blockquote>
<p><strong>说明：</strong>创建一个保存一个普通C字符串（一个字节序列）的<code>NSData</code>对象。<br><strong>原型：</strong><code>NSData</code></p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* @param &#123;nullable const void *&#125; bytes 字符串</span><br><span class="line">* @param &#123;NSUInteger&#125; length 字符串的长度（包括尾部的`\0`）</span><br><span class="line">* @return &#123;instancetype&#125; NSData实例</span><br><span class="line">*/</span></span><br><span class="line">+ (instancetype)dataWithBytes:(nullable <span class="keyword">const</span> <span class="keyword">void</span> *)bytes length:(<span class="built_in">NSUInteger</span>)length;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>扩展：</strong><code>NSData</code>是不可变的，创建后不能改变其中的内容来；<code>NSMutableData</code>是可变的，可以在数据中添加和删除字节。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// c 语言字符串</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *string = <span class="string">"hi there, this is a C string!"</span>;</span><br><span class="line"><span class="comment">// 创建 NSData 对象</span></span><br><span class="line"><span class="built_in">NSData</span> *data = [<span class="built_in">NSData</span> dataWithBytes:string length:strlen(string) + <span class="number">1</span>];</span><br><span class="line"><span class="comment">// 操作 NSData 对象</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"data is %@"</span>, data);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%ld byte string is '%s'"</span>, [data length], [data bytes]);</span><br></pre></td></tr></table></figure>
<h3 id="17-1-3-写入和读取属性列表"><a href="#17-1-3-写入和读取属性列表" class="headerlink" title="17.1.3    写入和读取属性列表"></a>17.1.3    写入和读取属性列表</h3><blockquote>
<p><strong>说明：</strong>属性列表类可以存储到文件中，也可以从文件中读取出来。此外，<code>Xcode</code>包含一个属性列表编辑器，可以用来方便地查看<code>plist</code>文件。<br><strong>注意：</strong>如果出现问题，下面介绍的函数都不会返回具体的错误的原因。</p>
</blockquote>
<h4 id="writeToFile实例方法"><a href="#writeToFile实例方法" class="headerlink" title="writeToFile实例方法"></a>writeToFile实例方法</h4><blockquote>
<p><strong>说明：</strong>将属性列表的内容写入到文件。<br><strong>技巧：</strong>应尽量使用<code>atomically</code>的方式保存文件，除非保存的文件容量非常大，会占用用户大量的磁盘空间。<br><strong>原型：</strong><code>NSArray</code></p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* @param &#123;NSString *&#125; 文件路径</span><br><span class="line">* @param &#123;BOOL&#125;useAuxiliaryFile 是否首先将文件内容保存到临时文件中（防止极端情况下原始文件被破坏）</span><br><span class="line">*/</span></span><br><span class="line">(<span class="built_in">BOOL</span>)writeToFile:(<span class="built_in">NSString</span> *)path atomically:(<span class="built_in">BOOL</span>)useAuxiliaryFile;</span><br></pre></td></tr></table></figure>
<h4 id="arrayWithContentsOfFile类方法"><a href="#arrayWithContentsOfFile类方法" class="headerlink" title="arrayWithContentsOfFile类方法"></a>arrayWithContentsOfFile类方法</h4><blockquote>
<p><strong>说明：</strong>读取文件中的数组信息并据此创建数组。<br><strong>原型：</strong><code>NSArray</code></p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* @param &#123;NSString *&#125; path 文件路径</span><br><span class="line">* @return &#123;NSArray&#125; 数组实例</span><br><span class="line">*/</span></span><br><span class="line">+ (nullable <span class="built_in">NSArray</span>&lt;ObjectType&gt; *)arrayWithContentsOfFile:(<span class="built_in">NSString</span> *)path;</span><br></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建 NSArray 实例</span></span><br><span class="line"><span class="built_in">NSArray</span> *phrase;</span><br><span class="line">phrase = [<span class="built_in">NSArray</span> arrayWithObjects:<span class="string">@"I"</span>, <span class="string">@"seem"</span>, <span class="string">@"to"</span>, <span class="string">@"be"</span>, <span class="string">@"a"</span>, <span class="string">@"verb"</span>, <span class="literal">nil</span>];</span><br><span class="line"><span class="comment">// 将 NSArray 对象写入文件</span></span><br><span class="line">[phrase writeToFile:<span class="string">@"/tmp/verbiage.txt"</span> atomically:<span class="literal">YES</span>];</span><br><span class="line"><span class="comment">// 通过文件创建 NSArray 实例</span></span><br><span class="line"><span class="built_in">NSArray</span> *phrase2 = [<span class="built_in">NSArray</span> arrayWithContentsOfFile:<span class="string">@"/tmp/veribage.txt"</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, phrase2);</span><br></pre></td></tr></table></figure>
<p><em>/tmp/verbiage.txt</em></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plist</span> <span class="attr">version</span>=<span class="string">"1.0"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">array</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">string</span>&gt;</span>I<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">string</span>&gt;</span>seem<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">string</span>&gt;</span>to<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">string</span>&gt;</span>be<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">string</span>&gt;</span>a<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">string</span>&gt;</span>verb<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plist</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="17-1-4-修改对象类型"><a href="#17-1-4-修改对象类型" class="headerlink" title="17.1.4    修改对象类型"></a>17.1.4    修改对象类型</h3><blockquote>
<p><strong>说明：</strong>存储或加载属性列表时可以使用<code>NSPropertyListSerialization</code>添加一些设定项。</p>
</blockquote>
<h4 id="dataFromPropertyList类方法"><a href="#dataFromPropertyList类方法" class="headerlink" title="dataFromPropertyList类方法"></a>dataFromPropertyList类方法</h4><blockquote>
<p><strong>说明：</strong>存储到文件时指定设定项。已过时。<br><strong>原型：</strong><code>NSPropertyListSerialization</code></p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* @param &#123;id&#125; plist 属性列表类型对象</span><br><span class="line">* @param &#123;NSPropertyListFormat&#125; format 存储属性列表的方式</span><br><span class="line">* @param &#123;NSString *&#125; errorDescription 错误信息</span><br><span class="line">*/</span></span><br><span class="line">+ (nullable <span class="built_in">NSData</span> *)dataFromPropertyList:(<span class="keyword">id</span>)plist format:(<span class="built_in">NSPropertyListFormat</span>)format errorDescription:(<span class="keyword">out</span> __<span class="keyword">strong</span> <span class="built_in">NSString</span> * __nullable * __nullable)errorString <span class="built_in">NS_DEPRECATED</span>(<span class="number">10</span>_0, <span class="number">10</span>_10, <span class="number">2</span>_0, <span class="number">8</span>_0, <span class="string">"Use dataWithPropertyList:format:options:error: instead."</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 可变数组(首都集合)</span></span><br><span class="line"><span class="built_in">NSMutableArray</span> *capitols = [<span class="built_in">NSMutableArray</span> arrayWithCapacity:<span class="number">10</span>];</span><br><span class="line"><span class="comment">// 第一个国家</span></span><br><span class="line"><span class="built_in">NSMutableDictionary</span> *capitol = [<span class="built_in">NSMutableDictionary</span> dictionaryWithObject:<span class="string">@"Canada"</span> forKey:<span class="string">@"country"</span>];</span><br><span class="line">[capitol setObject:<span class="string">@"Ottawa"</span> forKey:<span class="string">@"capitol"</span>];</span><br><span class="line">[capitols addObject:capitol];</span><br><span class="line"><span class="comment">// 第二个国家</span></span><br><span class="line">capitol = [<span class="built_in">NSMutableDictionary</span> dictionaryWithObject:<span class="string">@"Norway"</span> forKey:<span class="string">@"country"</span>];</span><br><span class="line">[capitol setObject:<span class="string">@"Oslo"</span> forKey:<span class="string">@"capitol"</span>];</span><br><span class="line">[capitols addObject:capitol];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSString</span> *error = <span class="literal">nil</span>;</span><br><span class="line"><span class="comment">// 将 plist 数据内容以二进制形式写入文件</span></span><br><span class="line"><span class="built_in">NSData</span> *encodeArray = [<span class="built_in">NSPropertyListSerialization</span> dataFromPropertyList:capitols format:<span class="built_in">NSPropertyListXMLFormat_v1_0</span> errorDescription:&amp;error];</span><br><span class="line">[encodeArray writeToFile:<span class="string">@"/tmp/capitols.txt"</span> atomically:<span class="literal">YES</span>];</span><br></pre></td></tr></table></figure>
<h4 id="propertyListFromData实例方法"><a href="#propertyListFromData实例方法" class="headerlink" title="propertyListFromData实例方法"></a>propertyListFromData实例方法</h4><blockquote>
<p><strong>说明：</strong>以指定形式将文件读取到内存。<br><strong>原型：</strong><code>NSPropertyListSerialization</code></p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* @param &#123;NSData *&#125; data 从文件读取原始数据</span><br><span class="line">* @param &#123;NSPropertyListMutabilityOptions&#125; opt format 读取形式</span><br><span class="line">* @param &#123;NSString *&#125; errorString 可能的错误信息</span><br><span class="line">*/</span></span><br><span class="line">+ (nullable <span class="keyword">id</span>)propertyListFromData:(<span class="built_in">NSData</span> *)data mutabilityOption:(<span class="built_in">NSPropertyListMutabilityOptions</span>)opt format:(nullable <span class="built_in">NSPropertyListFormat</span> *)format errorDescription:(<span class="keyword">out</span> __<span class="keyword">strong</span> <span class="built_in">NSString</span> * __nullable * __nullable)errorString <span class="built_in">NS_DEPRECATED</span>(<span class="number">10</span>_0, <span class="number">10</span>_10, <span class="number">2</span>_0, <span class="number">8</span>_0, <span class="string">"Use propertyListWithData:options:format:error: instead."</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从文件中读取属性列表数据</span></span><br><span class="line"><span class="built_in">NSData</span> *data = [<span class="built_in">NSData</span> dataWithContentsOfFile:<span class="string">@"/tmp/capitols.txt"</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 以指定的格式将文件中的内容读取到内存</span></span><br><span class="line"><span class="built_in">NSPropertyListFormat</span> properyListFormat = <span class="built_in">NSPropertyListXMLFormat_v1_0</span>;</span><br><span class="line"><span class="built_in">NSString</span> *error = <span class="literal">nil</span>;</span><br><span class="line"><span class="built_in">NSMutableArray</span> *capitols = [<span class="built_in">NSPropertyListSerialization</span> propertyListFromData:data mutabilityOption:<span class="built_in">NSPropertyListMutableContainersAndLeaves</span> format:&amp;properyListFormat errorDescription:&amp;error];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"capitols %@"</span>, capitols);</span><br></pre></td></tr></table></figure>
<h2 id="17-2-编码对象"><a href="#17-2-编码对象" class="headerlink" title="17.2    编码对象"></a>17.2    编码对象</h2><blockquote>
<p><strong>说明：</strong><code>Cocoa</code>具备一种将任意对象转换成某种格式并保存到磁盘中的机制。</p>
<ul>
<li><strong>序列化（编码）：</strong>将对象的实例变量和其他数据编码为数据块，然后保存到磁盘</li>
<li><strong>反序列化（解码）：</strong>将数据块读回内存，并基于保存的数据创建新对象</li>
</ul>
</blockquote>
<h3 id="NSCoding协议"><a href="#NSCoding协议" class="headerlink" title="NSCoding协议"></a>NSCoding协议</h3><blockquote>
<p><strong>说明：</strong>通过采纳该协议，可以使对象具备<code>序列化和反序列化</code>的能力。<br><strong>原型：</strong></p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">NSCoding</span></span></span><br><span class="line"><span class="comment">// 序列化</span></span><br><span class="line">- (<span class="keyword">void</span>) encodeWithCoder: (<span class="built_in">NSCoder</span> *) encoder;</span><br><span class="line"><span class="comment">// 反序列化</span></span><br><span class="line">- (<span class="keyword">id</span>) initWithCoder: (<span class="built_in">NSCoder</span> *) decoder;</span><br><span class="line">&gt;<span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h3 id="archiveDataWithRootObject类方法"><a href="#archiveDataWithRootObject类方法" class="headerlink" title="archiveDataWithRootObject类方法"></a>archiveDataWithRootObject类方法</h3><blockquote>
<p><strong>说明：</strong>对对象进行编码。</p>
<ol>
<li>创建了一个<code>KSKeyedArchier</code>实例</li>
<li>将上一步创建的实例传递给参数指定的对象的<code>encodeWithCoder</code>方法</li>
<li>递归编码自身使用到的其它对象，比如字符串、数组及放入数组中的任何对象</li>
<li>所有对象完成键值编码后，被放入一个<code>NSData</code>对象并返回</li>
</ol>
<p><strong>原型：</strong><code>KSKeyedArchiver</code></p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* @param &#123;id&#125; rootObject 要被序列化的对象</span><br><span class="line">* @return &#123;NSData *&#125; 序列化为 NSData 型数据</span><br><span class="line">*/</span></span><br><span class="line">+ (<span class="built_in">NSData</span> *)archivedDataWithRootObject:(<span class="keyword">id</span>)rootObject;</span><br></pre></td></tr></table></figure>
<p><em>Thingie.h</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Thingie</span> : <span class="title">NSObject</span></span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSString</span> *name;</span><br><span class="line">    <span class="keyword">int</span> magicNumber;</span><br><span class="line">    <span class="keyword">float</span> shoeSize;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *subThingies;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="keyword">@property</span> <span class="keyword">int</span> magicNumber;</span><br><span class="line"><span class="keyword">@property</span> <span class="keyword">float</span> shoeSize;</span><br><span class="line"><span class="keyword">@property</span> (retain) <span class="built_in">NSMutableArray</span> *subThingies;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>) initWithName: (<span class="built_in">NSString</span> *) n</span><br><span class="line">        magicNumber: (<span class="keyword">int</span>) mn</span><br><span class="line">           shoeSize: (<span class="keyword">float</span>) ss;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p><em>Thingie.m</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"Thingie.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Thingie</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@synthesize</span> name;</span><br><span class="line"><span class="keyword">@synthesize</span> magicNumber;</span><br><span class="line"><span class="keyword">@synthesize</span> shoeSize;</span><br><span class="line"><span class="keyword">@synthesize</span> subThingies;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 便利构造函数：通过用户名</span></span><br><span class="line">- (<span class="keyword">id</span>) initWithName:(<span class="built_in">NSString</span> *)</span><br><span class="line">        magicNumber:(<span class="keyword">int</span>)mn</span><br><span class="line">        shoeSize:(<span class="keyword">float</span>)ss</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init])</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">self</span>.name = n;</span><br><span class="line">        <span class="keyword">self</span>.magicNumber = mn;</span><br><span class="line">        <span class="keyword">self</span>.showSize = ss;</span><br><span class="line">        <span class="keyword">self</span>.subThingies = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 采纳协议:反序列化</span></span><br><span class="line">- (<span class="keyword">id</span>) initWithCoder: (<span class="built_in">NSCoder</span> *) decoder</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init])</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">self</span>.name = [decoder decodeObjectForKey:<span class="string">@"name"</span>];</span><br><span class="line">        <span class="keyword">self</span>.magicNumber = [decoder decodeIntForKey:<span class="string">@"magicNumber"</span>];</span><br><span class="line">        <span class="keyword">self</span>.shoeSize = [decoder decodeIntForKey:<span class="string">@"shoeSize"</span>];</span><br><span class="line">        <span class="keyword">self</span>.subThingies = [decoder decodeObjectForKey:<span class="string">@"subThingies"</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 采纳协议：序列化</span></span><br><span class="line">- (<span class="keyword">void</span>) encodeWithCoder: (<span class="built_in">NSCoder</span> *) coder</span><br><span class="line">&#123;</span><br><span class="line">    [coder encodeObject:name</span><br><span class="line">                 forKey:<span class="string">@"name"</span>];</span><br><span class="line">    [coder encodeInt:magicNumber</span><br><span class="line">              forKey:<span class="string">@"magicNumber"</span>];</span><br><span class="line">    [coder encodeFloat:shoeSize</span><br><span class="line">                forKey:<span class="string">@"shoeSize"</span>];</span><br><span class="line">    [coder encodeObject:subThingies</span><br><span class="line">                 forKey:<span class="string">@"subThingies"</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSString</span> *) description&#123;</span><br><span class="line">    <span class="built_in">NSString</span> *description = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@: %d/%.1f %@"</span>, name, magicNumber, shoeSize, subThingies];</span><br><span class="line">    <span class="keyword">return</span> (description);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>) dealloc</span><br><span class="line">&#123;</span><br><span class="line">    [name release];</span><br><span class="line">    [subThingies release];</span><br><span class="line">    [<span class="keyword">super</span> dealloc];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p><em>main.m</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"Thingie.h"</span></span></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="comment">/** 简单情形 **/</span></span><br><span class="line">        <span class="comment">// 创建可序列化的对象</span></span><br><span class="line">        Thingie *thing1;</span><br><span class="line">        thing1 = [[Thingie alloc]</span><br><span class="line">                  initWithName:<span class="string">@"thing1"</span></span><br><span class="line">                  magicNumber:<span class="number">42</span></span><br><span class="line">                  shoeSize:<span class="number">10.5</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"some thing: @"</span>, thing1);</span><br><span class="line">        <span class="comment">// 序列化为 NSData 对象</span></span><br><span class="line">        <span class="built_in">NSData</span> *freezeDried;</span><br><span class="line">        freezeDried = [<span class="built_in">NSKeyedArchiver</span> archivedDataWithRootObject:thing1];</span><br><span class="line">        [thing1 release];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 反序列化</span></span><br><span class="line">        thing1 = [<span class="built_in">NSKeyedUnarchiver</span> unarchiveObjectWithData:freezeDried];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"reconstitued thing: %@"</span>, thing1);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* 复杂情形：递归序列化 */</span></span><br><span class="line">        <span class="comment">// 初始化thing1.subThingies（数组）</span></span><br><span class="line">        Thingie *anotherThing;</span><br><span class="line">        anotherThing = [[[Thingle alloc]</span><br><span class="line">                         initWithName:<span class="string">@"thing2"</span></span><br><span class="line">                         magicNumber:<span class="number">23</span> shoeSize:<span class="number">13.0</span>]];</span><br><span class="line">        [thing1.subThingies addObject:anotherThing];</span><br><span class="line">        anotherThing = [[[Thingle alloc]</span><br><span class="line">                         initWithName:<span class="string">@"thing3"</span></span><br><span class="line">                         magicNumber:<span class="number">17</span> shoeSize:<span class="number">9.0</span>]];</span><br><span class="line">        [thing1.subThingies addObject:anotherThing];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"reconstitued muthing: %@"</span>, thing1);</span><br><span class="line">        <span class="comment">// 序列化</span></span><br><span class="line">        [freezeDried = [<span class="built_in">NSKeyedArchiver</span> archivedDataWithRootObject:thing1];</span><br><span class="line">        <span class="comment">// 反序列化</span></span><br><span class="line">        thing1 = [<span class="built_in">NSKeyedUnarchiver</span> unarchiveObjectWithData:freezeDried];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"reconstitued multiting: %@"</span>, thing1);</span><br><span class="line">         </span><br><span class="line">        <span class="comment">/* 复杂情形：设置一处引用自己的数据，序列化和反序列化仍能正常工作 */</span></span><br><span class="line">        [thing1.subThingies addObject:thing1];</span><br><span class="line">        <span class="comment">// 序列化</span></span><br><span class="line">        freezeDried = [<span class="built_in">NSKeyedArchiver</span> archivedDataWithRootObject:thing1];</span><br><span class="line">        <span class="comment">// 反序列化</span></span><br><span class="line">        thing1 = [<span class="built_in">NSKeyedUnarchiver</span> unarchiveObjectWithData:freezeDried];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="17-3-小结"><a href="#17-3-小结" class="headerlink" title="17.3    小结"></a>17.3    小结</h2>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/13/o-c基础教程第二版_16 UIKit简介/" itemprop="url">
                  16 UIKit简介
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-13T10:41:48+08:00" content="2016-05-13">
              2016-05-13
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/13/o-c基础教程第二版_16 UIKit简介/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/13/o-c基础教程第二版_16 UIKit简介/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><strong>说明：</strong><code>Mac</code>应用程序使用的是<code>AppKit</code>框架，而<code>iOS</code>应用程序使用的是<code>UIKit</code>框架，它包含了所有的<code>UI</code>组件和构成<code>iOS</code>应用程序的资源。<br><strong>注意：</strong><code>iOS</code>和<code>OS X</code>存在以下区别</p>
<ul>
<li>没有<code>shell</code>和控制台</li>
<li>应用程序在<code>Mac</code>电脑的模拟器中运行</li>
<li>无法支持一些无<code>UI</code>界面的<code>API</code></li>
<li>大部分程序员都认为开发<code>iOS</code>应用更加轻松</li>
</ul>
<p><strong>项目创建：</strong>步骤如下</p>
<ol>
<li><code>File-&gt;New-&gt;New Project</code>(command + shift + n)</li>
<li>选择应用程序模版：左边列表选择<code>iOS</code>下的<code>Application</code>，然后右边选择<code>Single View Application</code></li>
</ol>
<ul>
<li><code>Master-Detail</code>：用一个导航控制器和一个表视图来显示项目列表遗迹项目的详细信息</li>
<li><code>OpenGL Game</code>：游戏</li>
<li><code>Page-Based</code>：创建电子书式的应用，拥有翻页动画效果（该效果支持ipad）</li>
<li><code>Tabbed</code>：多视图应用程序，底部又一个标签栏并且每个标签都有一个视图香关联的那种应用程序</li>
<li><code>Utility</code>：和<code>Single View Application</code>相似，但还多处一个翻转视图</li>
<li><code>Empty</code>：是一个高级选项，如果没有合适的模版，或是你非常了解如何构建你的应用程序，那么刻意选择使用这个模版</li>
</ul>
<ol>
<li>点击<code>Next</code>按钮，弹出询问程序名等信息的对话框</li>
</ol>
<ul>
<li>复选框：不选择<code>Use Storyboard</code>和<code>Include Unit Tests</code>，选中<code>Use Automatic Reference Counting</code></li>
<li><code>Device Family</code>：选择<code>Universal</code>（意味着可以同时运行在<code>iPhone</code>、<code>iPod</code>、<code>iPad</code>上）</li>
</ul>
</blockquote>
<p><img src="http://o6ul1xz4z.bkt.clouddn.com/img/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-01-26%20%E4%B8%8B%E5%8D%8811.15.54.png" alt="Alt text"></p>
<p><em>AppDelegate.h</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;UIKit/UIKit.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">@class</span> <span class="title">ViewController</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AppDelegate</span> : <span class="title">UIResponder</span> &lt;<span class="title">UIApplicationDelegate</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 窗口对象</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) <span class="built_in">UIWindow</span> *window;</span><br><span class="line"><span class="comment">// 视图控制器</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) ViewController *viewController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p><em>AppDelegate.m</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"AppDelegate.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"ViewController.h"</span></span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AppDelegate</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">AppDelegate</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@synthesize</span> window = _window;</span><br><span class="line"><span class="keyword">@synthesize</span> viewController = _viewController;</span><br><span class="line"><span class="comment">// 窗口被创建时回被调用</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)application:(<span class="built_in">UIApplication</span> *)application didFinishLaunchingWithOptions:(<span class="built_in">NSDictionary</span> *)launchOptions &#123;</span><br><span class="line">    <span class="comment">/* 初始化窗口对象 */</span></span><br><span class="line">    <span class="keyword">self</span>.window = [[<span class="built_in">UIWindow</span> alloc] initWithFrame:[[<span class="built_in">UIScreen</span> mainScreen] bounds]];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 初始视图控制器 */</span></span><br><span class="line">    <span class="comment">// iPhone</span></span><br><span class="line">    <span class="keyword">if</span> ([[<span class="built_in">UIDevice</span> currentDevice] userInterfaceIdiom] == <span class="built_in">UIUserInterfaceIdiomPhone</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.viewController = [[ViewController alloc] initWithNibName:<span class="string">@"ViewController_iPhone"</span> bundle:<span class="literal">nil</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// iPad</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.viewController = [[ViewController alloc] initWithNibName:<span class="string">@"ViewController_iPad"</span> bundle:<span class="literal">nil</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 将视图控制器的视图添加到应用程序层级</span></span><br><span class="line">    <span class="keyword">self</span>.window.rootViewController = <span class="keyword">self</span>.viewController;</span><br><span class="line">    [<span class="keyword">self</span>.window makeKeyAndVisible];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)applicationWillResignActive:(<span class="built_in">UIApplication</span> *)application &#123;</span><br><span class="line">    <span class="comment">// Sent when the application is about to move from active to inactive state. This can occur for certain types of temporary interruptions (such as an incoming phone call or SMS message) or when the user quits the application and it begins the transition to the background state.</span></span><br><span class="line">    <span class="comment">// Use this method to pause ongoing tasks, disable timers, and throttle down OpenGL ES frame rates. Games should use this method to pause the game.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)applicationDidEnterBackground:(<span class="built_in">UIApplication</span> *)application &#123;</span><br><span class="line">    <span class="comment">// Use this method to release shared resources, save user data, invalidate timers, and store enough application state information to restore your application to its current state in case it is terminated later.</span></span><br><span class="line">    <span class="comment">// If your application supports background execution, this method is called instead of applicationWillTerminate: when the user quits.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)applicationWillEnterForeground:(<span class="built_in">UIApplication</span> *)application &#123;</span><br><span class="line">    <span class="comment">// Called as part of the transition from the background to the inactive state; here you can undo many of the changes made on entering the background.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)applicationDidBecomeActive:(<span class="built_in">UIApplication</span> *)application &#123;</span><br><span class="line">    <span class="comment">// Restart any tasks that were paused (or not yet started) while the application was inactive. If the application was previously in the background, optionally refresh the user interface.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)applicationWillTerminate:(<span class="built_in">UIApplication</span> *)application &#123;</span><br><span class="line">    <span class="comment">// Called when the application is about to terminate. Save data if appropriate. See also applicationDidEnterBackground:.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h2 id="16-1-视图控制器"><a href="#16-1-视图控制器" class="headerlink" title="16.1    视图控制器"></a>16.1    视图控制器</h2><blockquote>
<p><strong>说明：</strong><code>Cocoa</code>主要使用的是<code>MVC</code>模式</p>
<ul>
<li><strong>视图：</strong>从<code>nib</code>文件中获取视图</li>
<li><strong>模型：</strong>一组数据</li>
<li><strong>控制器：</strong><code>UIViewController</code>的子类</li>
</ul>
</blockquote>
<h3 id="16-1-1-在Nib文件中添加控件"><a href="#16-1-1-在Nib文件中添加控件" class="headerlink" title="16.1.1    在Nib文件中添加控件"></a>16.1.1    在Nib文件中添加控件</h3><blockquote>
<p><strong>说明：</strong>完成视图的部分</p>
<ul>
<li>拖进一个<code>TextField</code>对象</li>
<li>拖进一个<code>Label</code></li>
<li>拖进两个<code>Button</code></li>
</ul>
</blockquote>
<p><img src="./屏幕快照 2016-01-26 下午10.07.01.png" alt="Alt text"></p>
<h3 id="16-1-2-视图（Nib文件）和控制器建立连接"><a href="#16-1-2-视图（Nib文件）和控制器建立连接" class="headerlink" title="16.1.2    视图（Nib文件）和控制器建立连接"></a>16.1.2    视图（Nib文件）和控制器建立连接</h3><blockquote>
<p><strong>说明：</strong>打开辅助窗口，通过拖拽完成<code>视图</code>(<code>Nib</code>文件)和<code>控制器</code>(<code>ViewController.h</code>)之间的连接。</p>
<ol>
<li>代开辅助窗口：<code>Command+Option+Return</code>或<code>Editor</code>组中间的按钮</li>
<li>为<code>Text Field</code>和<code>Label</code>创建输出口（<code>outlet</code>）：按住<code>control</code>键，将鼠标从视图中的图像元素一直拖到<code>ViewController.h</code>相应位置<br><img src="./屏幕快照 2016-01-26 下午10.01.24 2.png" alt="Alt text"><br><img src="./屏幕快照 2016-01-26 下午10.01.30 2.png" alt="Alt text"></li>
<li>为两个按钮创建<code>操作</code>(Action)</li>
</ol>
<ul>
<li>Name：操作的名称</li>
<li>Type：操作方法参数的类型（默认为<code>id</code>）</li>
<li>Event：事件类型</li>
<li>Arguments：<code>None</code>、<code>Sender</code>和<code>Event</code>（包含一个<code>UIEvent</code>类型的参数）<br><img src="./屏幕快照 2016-01-26 下午10.23.36.png" alt="Alt text"></li>
</ul>
</blockquote>
<h3 id="16-1-3-完成代码的手动编写部分"><a href="#16-1-3-完成代码的手动编写部分" class="headerlink" title="16.1.3    完成代码的手动编写部分"></a>16.1.3    完成代码的手动编写部分</h3><blockquote>
<p><strong>说明：</strong>包括程序核心功能的实现以及一些事件的回调。</p>
</blockquote>
<p><em>ViewController.h</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;UIKit/UIKit.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> : <span class="title">UIViewController</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">weak</span>, <span class="keyword">nonatomic</span>) <span class="keyword">IBOutlet</span> <span class="built_in">UITextField</span> *textField;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">weak</span>, <span class="keyword">nonatomic</span>) <span class="keyword">IBOutlet</span> <span class="built_in">UILabel</span> *resultsField;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">IBAction</span>)uppercase;</span><br><span class="line">- (<span class="keyword">IBAction</span>)lowercase;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p><em>ViewController.m</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"ViewController.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@synthesize</span> textField;</span><br><span class="line"><span class="keyword">@synthesize</span> resultsField;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> *  重写父类的便利构造器：完成视图和控制器的绑定</span><br><span class="line"> */</span></span><br><span class="line">- (<span class="keyword">id</span>)initWithNibName:(<span class="built_in">NSString</span> *)nibNameOrNil bundle:(<span class="built_in">NSBundle</span> *)nibBundleOrNil &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> initWithNibName:nibNameOrNil bundle:nibBundleOrNil];</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">nil</span> != <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"init: text %@ / result %@"</span>, textField, resultsField);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> *  系统在nib文件加载和对象初始化完成后调用：从ios 5 不会再调用该方法了</span><br><span class="line"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)awakeFromNib &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"awake: text %@ / result %@"</span>, textField, resultsField);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> *  系统在nib文件加载和对象初始化完成后调用</span><br><span class="line"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    <span class="comment">// Do any additional setup after loading the view, typically from a nib.</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"viewDidLoad: text %@ / results %@"</span>, textField, resultsField);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置输入框的placeholder(占位符)</span></span><br><span class="line">    [textField setPlaceholder:<span class="string">@"Enter text here"</span>];</span><br><span class="line">    <span class="comment">// 设置Label的默认值</span></span><br><span class="line">    resultsField.text = <span class="string">@"Result"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> *  视图从视图层级中移除后会调用这个方法，可以在这里做一些内存清理的事情</span><br><span class="line"> *  该方法已过时</span><br><span class="line"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)viewDidUnload &#123;</span><br><span class="line">    [<span class="keyword">self</span> setTextField:<span class="literal">nil</span>];</span><br><span class="line">    [<span class="keyword">self</span> setResultsField:<span class="literal">nil</span>];</span><br><span class="line">    [<span class="keyword">super</span> viewDidUnload];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)didReceiveMemoryWarning &#123;</span><br><span class="line">    [<span class="keyword">super</span> didReceiveMemoryWarning];</span><br><span class="line">    <span class="comment">// Dispose of any resources that can be recreated.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 视图出现前调用</span></span><br><span class="line">- (<span class="keyword">void</span>)viewWillAppear:(<span class="built_in">BOOL</span>)animated</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">super</span> viewWillAppear:animated];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 视图出现后调用</span></span><br><span class="line">- (<span class="keyword">void</span>)viewDidAppear:(<span class="built_in">BOOL</span>)animated</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidAppear:animated];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 视图消失前调用</span></span><br><span class="line">- (<span class="keyword">void</span>)viewWillDisappear:(<span class="built_in">BOOL</span>)animated</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">super</span> viewWillDisappear:animated];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 视图消失后调用</span></span><br><span class="line">- (<span class="keyword">void</span>)viewDidDisappear:(<span class="built_in">BOOL</span>)animated</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidDisappear:animated];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">IBAction</span>)uppercase &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *original = textField.text;</span><br><span class="line">    <span class="built_in">NSString</span> *uppercase = [original uppercaseString];</span><br><span class="line">    resultsField.text = uppercase;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">IBAction</span>)lowercase &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *original = textField.text;</span><br><span class="line">    <span class="built_in">NSString</span> *lowercase = [original lowercaseString];</span><br><span class="line">    resultsField.text = lowercase;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h2 id="16-2-小结"><a href="#16-2-小结" class="headerlink" title="16.2    小结"></a>16.2    小结</h2>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/13/o-c基础教程第二版_15 AppKit简介/" itemprop="url">
                  15 AppKit简介
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-13T10:41:28+08:00" content="2016-05-13">
              2016-05-13
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/13/o-c基础教程第二版_15 AppKit简介/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/13/o-c基础教程第二版_15 AppKit简介/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><strong>说明：</strong><code>Application Kit</code>中包含<code>Cocoa</code>中关于用户界面的大量资源。<br><strong>注意：</strong>学习这一章节时，<code>Xcode</code>的最新版本是<code>7.2</code>，部分知识已经过时。比如目前<code>storyboard</code>已经基本取代了<code>xib</code>。</p>
</blockquote>
<h2 id="15-1-构建项目"><a href="#15-1-构建项目" class="headerlink" title="15.1    构建项目"></a>15.1    构建项目</h2><blockquote>
<p><strong>说明：</strong>下面是通过<code>Xcode</code>构建<code>Cocoa</code>应用程序项目的步骤。</p>
<ol>
<li>File-&gt;New-&gt;New Project（Create a New Xcode Project）</li>
<li>左边列表<code>Mac OS X</code>下的<code>Application</code>选项-&gt;<code>Cocoa Application</code>-&gt;Next</li>
<li>项目信息</li>
</ol>
<ul>
<li><code>Product Name</code>：应用名称</li>
<li><code>Company Identifier</code>：企业标识符，用来区分应用程序</li>
<li><code>Class Prefix</code>：伪命名空间，避免文件名冲突</li>
</ul>
<ol>
<li>复选框</li>
</ol>
<ul>
<li><code>Create Document-Based Application</code></li>
<li><code>Use Core Data</code></li>
<li><code>Include Unit Test</code></li>
<li><code>Use Automatic Reference Counting</code></li>
</ul>
</blockquote>
<h2 id="15-2-创建委托文件-interface部分"><a href="#15-2-创建委托文件-interface部分" class="headerlink" title="15.2    创建委托文件@interface部分"></a>15.2    创建委托文件<code>@interface</code>部分</h2><blockquote>
<p><strong><code>Interface Builder</code>：</strong>简称<code>IB</code>，用可视化的方式为<code>OS X</code>和<code>iOS</code>布局窗口内容，构建用户界面。<br><strong><code>IBOutlet</code>和<code>IBAction</code>：</strong>这两个关键字会经常出现在代码中，用于</p>
<ul>
<li>为<code>Interface Builder</code>提供标记</li>
<li>帮助阅读代码</li>
</ul>
</blockquote>
<h2 id="15-3-Interface-Builder"><a href="#15-3-Interface-Builder" class="headerlink" title="15.3    Interface Builder"></a>15.3    Interface Builder</h2><blockquote>
<p><strong>说明：</strong>通过<code>.xib</code>文件就可以打开<code>IB</code>的可视化编辑器。</p>
<ul>
<li><strong>nib文件：</strong>编译时，<code>.xib</code>(<code>XML</code>格式)文件会被编译为<code>nib(NeXT Interface Builder)</code>文件，它是包含了压缩对象的二进制文件，</li>
<li><strong>对象库：</strong>包含了大量可以拖入窗口的不同类型的对象。</li>
</ul>
<p><img src="http://o6ul1xz4z.bkt.clouddn.com/img/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-01-25%20%E4%B8%8B%E5%8D%8810.17.36.png" alt="Alt text"></p>
</blockquote>
<h2 id="15-4-设计用户界面"><a href="#15-4-设计用户界面" class="headerlink" title="15.4    设计用户界面"></a>15.4    设计用户界面</h2><blockquote>
<p><strong>说明：</strong>对用户界面进行布局</p>
<ol>
<li>拖入一个<code>Text Filed</code></li>
<li>拖入一个<code>Label</code></li>
<li>拖入一个<code>push button</code></li>
</ol>
</blockquote>
<p><img src="http://o6ul1xz4z.bkt.clouddn.com/img/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-01-25%20%E4%B8%8B%E5%8D%8810.42.36.png" alt="Alt text"></p>
<h2 id="15-5-创建连接"><a href="#15-5-创建连接" class="headerlink" title="15.5    创建连接"></a>15.5    创建连接</h2><blockquote>
<p><strong>说明：</strong>将<code>代码</code>与刚创建的<code>用户界面元素</code>相连接。</p>
</blockquote>
<h3 id="15-5-1-连接输出口（IBOutlet）"><a href="#15-5-1-连接输出口（IBOutlet）" class="headerlink" title="15.5.1    连接输出口（IBOutlet）"></a>15.5.1    连接输出口（IBOutlet）</h3><blockquote>
<p><strong>说明：</strong>通过拖动自动生成界面元素对应的代码。以其中的<code>Text Field</code>为例子</p>
<ol>
<li>打开辅助编辑器</li>
<li>按住<code>Control</code>键将光标从<code>文本框</code>拖动到<code>头文件</code>中<code>@property</code>那一行的下面</li>
<li>出现<code>Insert Outlet orAction</code>提示消息时松开鼠标</li>
<li>在弹出的对话框中输入<code>textField</code>，点击<code>Connect</code></li>
</ol>
</blockquote>
<h3 id="15-5-2-连接操作（IBAction）"><a href="#15-5-2-连接操作（IBAction）" class="headerlink" title="15.5.2    连接操作（IBAction）"></a>15.5.2    连接操作（IBAction）</h3><blockquote>
<p><strong>说明：</strong>将按钮连接到操作，这样按下按钮就会触发代码。以<code>UpperCae</code>按钮为例</p>
<ol>
<li>按住<code>Control</code>键和<code>UpperCase</code>按钮</li>
<li>拖动一条直线到<code>头文件</code>的最后一行<code>@property</code>语句下</li>
<li>弹出连接对话框，选择<code>Action</code>类型</li>
<li>在Name文本框中输入<code>uppercase</code>，并点击<code>Connect</code>(自动在头文件中创建方法的声明，并在实现文件中创建方法的实现)</li>
</ol>
</blockquote>
<h2 id="15-6-应用程序委托的实现"><a href="#15-6-应用程序委托的实现" class="headerlink" title="15.6    应用程序委托的实现"></a>15.6    应用程序委托的实现</h2><blockquote>
<p><strong>说明：</strong><code>IBOutlet</code>的工作方式</p>
<ol>
<li>应用程序启动时，<code>MainMenu.nib</code>被自动加载，界面对象被创建</li>
<li>分配并初始化<code>MSCApplelegate</code>实例（<code>IBOutlet</code>的实例变量）</li>
<li>建立连接：将<code>NSTextField</code>等对象的地址添加到<code>MSCAppDelegate</code>实例变量中，然后像每个每个<code>界面对象</code>发送<code>awakeFromNib</code>消息。</li>
</ol>
</blockquote>
<p><em>MSCAppDelegate.h</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Cocoa/Cocoa.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MSCAppDelegate</span> : <span class="title">NSObject</span> &lt;<span class="title">NSApplicationDelegate</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>) <span class="keyword">IBOutlet</span> <span class="built_in">NSWindow</span> *window;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">weak</span>) <span class="keyword">IBOutlet</span> <span class="built_in">NSTextField</span> *textField;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">weak</span>) <span class="keyword">IBOutlet</span> <span class="built_in">NSTextField</span> *resultsField;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">IBAction</span>)uppercase:(<span class="keyword">id</span>)sender;</span><br><span class="line">- (<span class="keyword">IBAction</span>)lowercase:(<span class="keyword">id</span>)sender;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p><em>MSCAppDelegate.m</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"MSCAppDelegate.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">MSCAppDelegate</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@synthesize</span> window = _window;</span><br><span class="line"><span class="keyword">@synthesize</span> textField = _textField;</span><br><span class="line"><span class="keyword">@synthesize</span> resultsField = _resultsField;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)init &#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="literal">nil</span> != (<span class="keyword">self</span> = [<span class="keyword">super</span> init])) &#123;</span><br><span class="line">        <span class="comment">// 此时还没和界面对象建立连接，因此都是 nil</span></span><br><span class="line">		<span class="built_in">NSLog</span> (<span class="string">@"init: text %@ / results %@"</span>, _textField, _resultsField);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">self</span>;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * 对界面对象进行一些初始化工作</span><br><span class="line"> * 连接建立后会被调用</span><br><span class="line"> *  @override</span><br><span class="line"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)awakeFromNib &#123;</span><br><span class="line">	<span class="built_in">NSLog</span> (<span class="string">@"awake: text %@ / results %@"</span>, _textField, _resultsField);</span><br><span class="line">	</span><br><span class="line">	[_textField setStringValue:<span class="string">@"Enter text here"</span>];</span><br><span class="line">	[_resultsField setStringValue:<span class="string">@"Results"</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)applicationDidFinishLaunching:(<span class="built_in">NSNotification</span> *)aNotification &#123;</span><br><span class="line">    <span class="comment">// Insert code here to initialize your application</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">IBAction</span>)uppercase:(<span class="keyword">id</span>)sender &#123;</span><br><span class="line">	<span class="built_in">NSString</span> *original = [_textField stringValue];</span><br><span class="line">	<span class="built_in">NSString</span> *uppercase = [original uppercaseString];</span><br><span class="line">	[_resultsField setStringValue:uppercase];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">IBAction</span>)lowercase:(<span class="keyword">id</span>)sender &#123;</span><br><span class="line">	<span class="built_in">NSString</span> *original = [_textField stringValue];</span><br><span class="line">	<span class="built_in">NSString</span> *lowercase = [original lowercaseString];</span><br><span class="line">	[_resultsField setStringValue:lowercase];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h2 id="15-7-小结"><a href="#15-7-小结" class="headerlink" title="15.7    小结"></a>15.7    小结</h2>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/13/o-c基础教程第二版_14 代码块和并发性/" itemprop="url">
                  14 代码块和并发行
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-13T10:41:10+08:00" content="2016-05-13">
              2016-05-13
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/13/o-c基础教程第二版_14 代码块和并发性/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/13/o-c基础教程第二版_14 代码块和并发性/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="14-1-代码块"><a href="#14-1-代码块" class="headerlink" title="14.1    代码块"></a>14.1    代码块</h2><blockquote>
<p><strong>说明：</strong><code>代码块</code>是由C语言实现的，是对C语言中函数的扩展。<br><strong>支持的语言：</strong><code>Objective-C</code>、<code>C</code> 、<code>C++</code>、<code>Objective-C++</code><br><strong>用途：</strong><code>替代函数</code>或实现<code>闭包</code><br><strong>现状：</strong><code>代码块</code>在<code>Xcode</code>的<code>GCC</code>和<code>CLang</code>工具中是有效的，但它不属于<code>ANSI</code>的<code>C</code>语言标准。关于代码块的提议已经提交给C语言标准团体。</p>
</blockquote>
<h3 id="14-1-1-代码块和函数指针"><a href="#14-1-1-代码块和函数指针" class="headerlink" title="14.1.1    代码块和函数指针"></a>14.1.1    代码块和函数指针</h3><blockquote>
<p><strong>说明：</strong><code>代码块</code>的语法借鉴了<code>函数指针</code></p>
<ul>
<li><strong>返回类型</strong>可以手动声明也可以由编译器通过代码块推导</li>
<li>具有指定类型的<strong>参数</strong>列表</li>
<li>拥有<strong>名称</strong></li>
<li>代码放在<code>{}</code>中</li>
</ul>
<p><strong>语法：</strong><code>&lt;returntype&gt; (^blockname)(list of arguments) = ^(arguments){body;}</code><br><em>实现部分推导出返回值类型</em></p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实现部分省略了返回值类型，没有参数列表</span></span><br><span class="line"><span class="keyword">void</span> (^theBlock)() = ^&#123;</span><br><span class="line">	printf(<span class="string">"Hello Blocks!"</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* 定义并实现代码块 square_block</span><br><span class="line">* 计算乘方</span><br><span class="line">* @param &#123;int&#125; number 数值</span><br><span class="line">* @return &#123;int&#125; number 乘方结果</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">int</span> (^square_block)(<span class="keyword">int</span> number) = ^(<span class="keyword">int</span> number) &#123;</span><br><span class="line">	<span class="keyword">return</span> (number * number);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 调用代码块</span></span><br><span class="line"><span class="keyword">int</span> result = square_block(<span class="number">5</span>);</span><br><span class="line">printf(<span class="string">"Result = %d\n"</span>, result);</span><br></pre></td></tr></table></figure>
<h4 id="14-1-1-1-通过代码块名调用代码块"><a href="#14-1-1-1-通过代码块名调用代码块" class="headerlink" title="14.1.1.1    通过代码块名调用代码块"></a>14.1.1.1    通过代码块名调用代码块</h4><blockquote>
<p><strong>说明：</strong>可以像调用<code>函数</code>一样调用<code>代码块</code>。<br><strong>比函数强大：</strong>代码块可以访问与它相同的有效范围内声明的变量。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 声明并初始化变量：声明时的作用域和代码块相同</span></span><br><span class="line"><span class="keyword">int</span> value = <span class="number">6</span>;</span><br><span class="line"><span class="comment">// 定义并实现代码块</span></span><br><span class="line"><span class="keyword">int</span> (^multiply_block)(<span class="keyword">int</span> number) = ^(<span class="keyword">int</span> number) &#123;</span><br><span class="line">	<span class="comment">// 访问外部同作用域声明的变量</span></span><br><span class="line">	<span class="keyword">return</span> (value * number);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="14-1-1-2-直接调用代码块（匿名）"><a href="#14-1-1-2-直接调用代码块（匿名）" class="headerlink" title="14.1.1.2    直接调用代码块（匿名）"></a>14.1.1.2    直接调用代码块（匿名）</h4><blockquote>
<p><strong>说明：</strong>使用代码块时通常不需要创建一个代码块变量，而是在代码中内联代码块的内容。<br><strong>使用场景：</strong>作为参数传递给方法或函数</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数组</span></span><br><span class="line"><span class="built_in">NSArray</span> *array = [<span class="built_in">NSArray</span> arrayWithObjects: <span class="string">@"Amir"</span>, <span class="string">@"Mishal"</span>, <span class="string">@"Irrum"</span>, <span class="string">@"Adam"</span>, <span class="literal">nil</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"Unsorted Array %@"</span>, array);</span><br><span class="line"><span class="comment">// 传递匿名代码块</span></span><br><span class="line"><span class="built_in">NSArray</span> *soredArray = [array sortedArrayUsingComparator: ^(<span class="built_in">NSString</span> *object1, <span class="built_in">NSString</span> *object2)] &#123;</span><br><span class="line">	<span class="keyword">return</span> [object1 compare: object2];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"Sorted Array %@"</span>, sortedArray);</span><br></pre></td></tr></table></figure>
<h4 id="14-1-1-3-使用typedef关键字"><a href="#14-1-1-3-使用typedef关键字" class="headerlink" title="14.1.1.3    使用typedef关键字"></a>14.1.1.3    使用<code>typedef</code>关键字</h4><blockquote>
<p><strong>说明：</strong>将<code>代码块</code>声明定义为一种类型，更易于代码的编写。<br><strong>语法：</strong><code>typedef 代码块定义;</code><br><strong>注意：</strong><code>typedef</code>后面的<code>代码块</code>定义中的代码块名不再具备<code>代码块名</code>的功能，而是一种类型名。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将代码块定义为一种类型： MKSampleMultiply2BlockRef</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">double</span> (^<span class="built_in">MKSampleMultiply2BlockRef</span>)(<span class="keyword">double</span> c, <span class="keyword">double</span> d);</span><br><span class="line"><span class="comment">// 使用新类型创建代码块</span></span><br><span class="line"><span class="built_in">MKSampleMultiply2BlockRef</span> multiply2 = ^(<span class="keyword">double</span> c, <span class="keyword">double</span> d) &#123;</span><br><span class="line">	<span class="keyword">return</span> c * d;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 调用代码块</span></span><br><span class="line">printf(<span class="string">"%f, %f"</span>, multiply2(<span class="number">4</span>, <span class="number">5</span>), multiply2(<span class="number">5</span>, <span class="number">2</span>));</span><br></pre></td></tr></table></figure>
<h4 id="14-1-1-4-代码块和变量"><a href="#14-1-1-4-代码块和变量" class="headerlink" title="14.1.1.4    代码块和变量"></a>14.1.1.4    代码块和变量</h4><blockquote>
<p><strong>说明：</strong>代码块被声明后会捕捉到创建时的上下文中的变量或函数。</p>
<ul>
<li>全局变量（包括在封闭范围内声明的本地静态变量）</li>
<li>全局函数</li>
<li>封闭范围内的参数</li>
<li><code>Objective-C</code>的实例变量</li>
<li>代码块内部的本地变量</li>
</ul>
</blockquote>
<h5 id="本地变量"><a href="#本地变量" class="headerlink" title="本地变量"></a>本地变量</h5><blockquote>
<p><strong>说明：</strong>与代码块在同一范围内声明的变量。<br><strong>捕获情况：</strong>代码块会在定义时把本地变量当作<code>常量</code>复制并保存它们的状态。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义代码块类型</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">double</span> (^<span class="built_in">MKSampleMultiplyBlockRef</span>)(<span class="keyword">void</span>);</span><br><span class="line"><span class="comment">// 本地变量</span></span><br><span class="line"><span class="keyword">double</span> a = <span class="number">10</span>, b = <span class="number">20</span>;</span><br><span class="line"><span class="comment">// 声明并实现代码块，复制并保存状态</span></span><br><span class="line"><span class="built_in">MKSampleMultiplyBlockRef</span> multiply = ^(<span class="keyword">void</span>) &#123;</span><br><span class="line">	reutrn a * b;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 调用代码块</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%f"</span>, multiply());<span class="comment">// 200</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改本地变量</span></span><br><span class="line">a = <span class="number">20</span>;</span><br><span class="line">b = <span class="number">50</span>;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%f"</span>, multiply());<span class="comment">// 200</span></span><br></pre></td></tr></table></figure>
<h5 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h5><blockquote>
<p><strong>说明：</strong>可以根据需要将变量标记为<code>静态的（全局的）</code>。<br><strong>捕获情况：</strong>同本地变量。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">double</span> a = <span class="number">10</span>, b = <span class="number">20</span>;</span><br><span class="line"><span class="built_in">MKSimpleMultiplyBlockRef</span> multiply = ^(<span class="keyword">void</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> a * b;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%f"</span>, multiply());<span class="comment">// 200</span></span><br></pre></td></tr></table></figure>
<h5 id="参数变量"><a href="#参数变量" class="headerlink" title="参数变量"></a>参数变量</h5><blockquote>
<p><strong>说明：</strong>代码块中的参数变量与函数中的参数变量具有相同的作用。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义代码块类型</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">double</span> (^<span class="built_in">MKSampleMultiply2BlockRef</span>)(<span class="keyword">double</span> c, <span class="keyword">double</span> d);</span><br><span class="line"><span class="comment">// 声明并实现代码块</span></span><br><span class="line"><span class="built_in">MKSimpleMultiply2BlockRef</span> multiply2 = ^(<span class="keyword">double</span> c, <span class="keyword">double</span> d) &#123;</span><br><span class="line">	<span class="keyword">return</span> c * d;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 调用代码块</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%f, %f"</span>, multiply2(<span class="number">4</span>, <span class="number">5</span>), multiply2(<span class="number">5</span>, <span class="number">2</span>));</span><br></pre></td></tr></table></figure>
<h5 id="block变量"><a href="#block变量" class="headerlink" title="_block变量"></a>_block变量</h5><blockquote>
<p><strong>关键字：</strong><code>_block</code><br><strong>说明：</strong><code>本地变量</code>会被<code>代码块</code>当作<code>常量</code>获取到，如果想要修改它们的值，必须通过<code>_black</code>将它们声明为<code>可修改</code>的。<br><strong>限制：</strong>由两种情况不能使用<code>_block</code>修饰</p>
<ul>
<li>长度可变数组</li>
<li>包含长度可变数组的结构体</li>
</ul>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用_block 修饰，使变量 c 在代码块中的副本可修改</span></span><br><span class="line">_block <span class="keyword">double</span> c = <span class="number">3</span>;</span><br><span class="line"><span class="built_in">MKSampleMultiplyBlockRef</span> multiply = ^(<span class="keyword">double</span> a, <span class="keyword">double</span> b) &#123;</span><br><span class="line">	c = a * b;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h5 id="代码块内部的本地变量"><a href="#代码块内部的本地变量" class="headerlink" title="代码块内部的本地变量"></a>代码块内部的本地变量</h5><blockquote>
<p><strong>说明：</strong>对<code>代码块来说</code>，和<code>本地变量</code>一样使用。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义并实现代码块</span></span><br><span class="line"><span class="keyword">void</span> (^<span class="built_in">MKSampleBlockRef</span>)(<span class="keyword">void</span>) = ^(<span class="keyword">void</span>)&#123;</span><br><span class="line">	<span class="keyword">double</span> a = <span class="number">4</span>;</span><br><span class="line">	<span class="keyword">double</span> c = <span class="number">2</span>;</span><br><span class="line">	<span class="built_in">NSLog</span>(<span class="string">@"%f"</span>, a * c);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 调用代码块</span></span><br><span class="line"><span class="built_in">MKSimpleBlockRef</span>();</span><br></pre></td></tr></table></figure>
<h3 id="14-1-2-Objective-C代码块内存管理"><a href="#14-1-2-Objective-C代码块内存管理" class="headerlink" title="14.1.2    Objective-C代码块内存管理"></a>14.1.2    Objective-C代码块内存管理</h3><blockquote>
<p><strong>说明：</strong>代码块是对象，所以可以向它发送任何与内存管理由关的信息。</p>
<ul>
<li>如果引用了一个<code>Objective-C</code>对象，必须要<code>保留</code>它</li>
<li>如果类的方法中的<code>代码块</code>通过引用访问了一个实例变量，要<code>保留</code>一次<code>self</code>（执行所在方法的对象）</li>
<li>如果通过数值访问了一个实例变量，变量需要<code>保留</code></li>
</ul>
</blockquote>
<p><em>ProcessString.h：方法中包含代码块的类</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ProcessStrings</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>) <span class="built_in">NSString</span> *theString;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)testMyString;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p><em>ProcessString.m</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"ProcessStrings.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ProcessStrings</span></span></span><br><span class="line"><span class="keyword">@synthesize</span> theString = _theString;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)testMyString</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// 代码块1</span></span><br><span class="line">    <span class="built_in">NSString</span> *string1 = ^&#123;</span><br><span class="line">    	<span class="comment">// 规则2：直接通过引用（实例变量名）访问了实例变量，若没有ARC则应该保留self</span></span><br><span class="line">        <span class="keyword">return</span> [_theString stringByAppendingString:_theString];</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSString</span> *localObject = _theString;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 代码块2</span></span><br><span class="line">    <span class="built_in">NSString</span> *string2 = ^&#123;</span><br><span class="line">    	<span class="comment">// 规则3: 通过中间变量间接访问了实例变量，如果没有ARC则要保留localObject</span></span><br><span class="line">        <span class="keyword">return</span> [localObject stringByAppendingString:localObject];</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p><em>main.m</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">"ProcessStrings.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span></span><br><span class="line">    &#123;</span><br><span class="line">        ProcessStrings *myStringProcessor = [[ProcessStrings alloc] init];</span><br><span class="line">        myStringProcessor.theString = <span class="string">@"Hello Objective Blocks!"</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 调用对象中包含代码块的方法</span></span><br><span class="line">        [myStringProcessor testMyString];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>扩展：</strong>在C语言中，必须使用<code>Block_copy()</code>和<code>Block_release()</code>函数来适当地管理内存。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> (^<span class="built_in">MKSampleVoidBlockRef</span>)(<span class="keyword">void</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">MKSampleVoidBlockRef</span> block1 = ^&#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"Block1"</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">        block1();</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">MKSampleVoidBlockRef</span> block2 = ^&#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"Block2"</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">        block2();</span><br><span class="line">        Block_release(block2);</span><br><span class="line">        </span><br><span class="line">        block2 = Block_copy(block1);</span><br><span class="line">        block2();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="14-2-并发性"><a href="#14-2-并发性" class="headerlink" title="14.2    并发性"></a>14.2    并发性</h2><blockquote>
<p><strong>说明：</strong>能够在同一时间执行多个任务的程序称为<code>并发的(concurrent)</code>程序。苹果公司提供了多种可以利用多核特性的<code>API</code>。</p>
</blockquote>
<table>
<thead>
<tr>
<th>相关技术选择</th>
<th>说明</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>POSIX线程</td>
<td>利用并发行最基础的方法是使用<code>POSIX</code>线程来处理程序的不同部分使其能够独立运行。<code>POSIX线程</code>拥有支持<code>C</code>和<code>Objective-C</code>的API。</td>
<td>因为线程是级别较低的API，必须手动管理，挑战很大</td>
</tr>
<tr>
<td>GDC(Grand Central Dipatch)</td>
<td>运行在系统级别，减少了不少线程管理的麻烦</td>
<td>可以平衡应用程序所有内同的家在，从而提高计算机或设备的运行效率</td>
</tr>
</tbody>
</table>
<h3 id="14-2-1-同步"><a href="#14-2-1-同步" class="headerlink" title="14.2.1    同步"></a>14.2.1    同步</h3><blockquote>
<p><strong>关键字：</strong><code>@synchronized</code><br><strong>说明：</strong>用来设置<code>临界区</code>，确保多个线程不会在同一时间进入<code>临界区</code>。<br><strong>相关：</strong><code>@property</code>指令的<code>atomic</code>特性会让编译器通过插入<code>@synchronize(mutex, atomic)</code>生成强制彼此互斥的<code>getter</code>和<code>setter</code>方法（降低了代码性能），而<code>nonatomic</code>特性（默认）则不会。</p>
</blockquote>
<h4 id="14-2-1-1-选择性能"><a href="#14-2-1-1-选择性能" class="headerlink" title="14.2.1.1    选择性能"></a>14.2.1.1    选择性能</h4><blockquote>
<p><strong>说明：</strong><code>NSObject</code>提供了一些可以使代码在后台以较低性能运行的方法（方法名带有<code>performSelector</code>前缀）</p>
</blockquote>
<h5 id="performSelectorInBackground实例方法"><a href="#performSelectorInBackground实例方法" class="headerlink" title="performSelectorInBackground实例方法"></a>performSelectorInBackground实例方法</h5><blockquote>
<p><strong>说明：</strong>通过创建一个线程，在后端运行一个指定的方法。<br><strong>限制：</strong>指定运行的方法（第一个参数）要遵从以下限制</p>
<ul>
<li>方法中需要<code>@autoreleasepool</code></li>
<li>方法不能有返回值，参数最多一个且必须为<code>id</code>类型</li>
</ul>
<ol>
<li><code>- (void) myMethod;</code></li>
<li><code>- (void) myMethod:(id)myObject;</code></li>
</ol>
<p><strong>原型：</strong><code>NSObject</code></p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* @param &#123;SEL&#125; 希望在后台运行的方法</span><br><span class="line">* @param &#123;id&#125; object 可以传递一个对象</span><br><span class="line">*/</span></span><br><span class="line">(<span class="keyword">void</span>) performSelectorInBackground:(nonnull SEL) withObject:(nullable <span class="keyword">id</span>)&gt;</span><br></pre></td></tr></table></figure>
<p><em>SelectorTester.h</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">SelectorTester</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>) runSelectors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p><em>SelectorTester.m</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"SelectorTester.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">SelectorTester</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> *  封装对性能选择器的调用</span><br><span class="line"> */</span></span><br><span class="line">- (<span class="keyword">void</span>) runSelectors &#123;</span><br><span class="line">    <span class="comment">// 在后端运行不带参数的方法</span></span><br><span class="line">    [<span class="keyword">self</span> performSelectorInBackground:<span class="keyword">@selector</span>(myBackgroundMethod1) withObject:<span class="literal">nil</span>];</span><br><span class="line">    <span class="comment">// 在后端运行带一个参数的方法</span></span><br><span class="line">    [<span class="keyword">self</span> performSelectorInBackground:<span class="keyword">@selector</span>(myBackgroundMethod2:) withObject:<span class="string">@"Hello Selector"</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Done performing selectors"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> *  @pravite</span><br><span class="line"> *  会被选择器调用的方法：不带参数</span><br><span class="line"> */</span></span><br><span class="line">- (<span class="keyword">void</span>) myBackgroundMethod1 &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"myBackgroundMethod1"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> *  @pravite</span><br><span class="line"> *  会被选择器调用的方法：只有一个参数</span><br><span class="line"> *  @param &#123;id&#125; object 一个对象</span><br><span class="line"> */</span></span><br><span class="line">- (<span class="keyword">void</span>) myBackgroundMethod2: (<span class="keyword">id</span>)object &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"myBackgroundMethod2 %@"</span>, object);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h4 id="14-2-1-2-调度队列"><a href="#14-2-1-2-调度队列" class="headerlink" title="14.2.1.2    调度队列"></a>14.2.1.2    调度队列</h4><blockquote>
<p><strong>说明：</strong><code>GDC</code>可以使用<code>调度队列（dispatch queue）</code>，共有3种。</p>
</blockquote>
<table>
<thead>
<tr>
<th>队列类型</th>
<th>说明</th>
<th>并行／串行</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>连续队列</td>
<td>根据指派的顺序执行任务</td>
<td>串行，先入先出（FIFO，栈）</td>
<td>可以创建多个<code>连续</code>队列，彼此并行</td>
</tr>
<tr>
<td>并发队列</td>
<td>并发执行一个或多个任务</td>
<td>并行，根据指派到队列的顺序开始执行</td>
<td>无法创建，只能从系统提供的并发队列中选择（一共3个）</td>
</tr>
<tr>
<td>主队列</td>
<td>应用程序的有效的主队列</td>
<td>主线程只有一个，无所谓串/并行</td>
<td>执行的应用程序的主线程任务</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>调度队列数据类型：</strong><code>dispatch_queue_t</code></p>
</blockquote>
<h5 id="连续队列"><a href="#连续队列" class="headerlink" title="连续队列"></a>连续队列</h5><blockquote>
<p><strong>说明：</strong>只要任务是异步提交的，队列会确保任务根据预定顺序执行，不会发生死锁。<br><strong>适用：</strong>一连串的任务需要按照一定的顺序执行的场景</p>
</blockquote>
<h6 id="dispatch-queue-create全局方法"><a href="#dispatch-queue-create全局方法" class="headerlink" title="dispatch_queue_create全局方法"></a>dispatch_queue_create全局方法</h6><blockquote>
<p><strong>说明：</strong>创建连续队列<br><strong>原型：</strong></p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* @param &#123;const char *&#125; label 队列的名称</span><br><span class="line">* @param &#123;dispatch_queue_attr_t&#125; attr 队列的特性（可以为NULL）</span><br><span class="line">* @return &#123;dispatch_queue_t&#125; 顺序队列</span><br><span class="line">*/</span></span><br><span class="line"><span class="built_in">dispatch_queue_t</span> dispatch_queue_create(<span class="keyword">const</span> <span class="keyword">char</span> *label, dispatch_queue_attr_t attr);</span><br></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 声明连续队列</span></span><br><span class="line"><span class="built_in">dispatch_queue_t</span> my_serial_queue;</span><br><span class="line"><span class="comment">// 创建连续队列</span></span><br><span class="line">my_serial_queue = dispatch_queue_create(<span class="string">"com.apress.MySerialQueue1"</span>, <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure>
<h5 id="并发队列"><a href="#并发队列" class="headerlink" title="并发队列"></a>并发队列</h5><blockquote>
<p><strong>说明：</strong>并发调度队列适用于那些可以并行运行的任务</p>
<ul>
<li>开始执行时间遵从FIFO</li>
<li>任务可以在前一个任务结束前就开始执行</li>
<li>一次所运行的任务数量是无法预测的（根据其它运行的任务的状况）</li>
</ul>
<p><strong>技巧：</strong>如果需要确保每次运行的任务的数量都是一样的，可以通过线程<code>API</code>来手动管理线程。</p>
</blockquote>
<h6 id="dispatch-get-global-queue全局方法"><a href="#dispatch-get-global-queue全局方法" class="headerlink" title="dispatch_get_global_queue全局方法"></a>dispatch_get_global_queue全局方法</h6><blockquote>
<p><strong>说明：</strong>获取系统的并发队列。<br><strong>原型：</strong><code>/usr/include/dispatch/queue.h</code></p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* @param &#123;long&#125; identifier 优先级选项</span><br><span class="line">* @param &#123;unsigned long&#125; flags 标记（可以为0）</span><br><span class="line">* @return &#123;dispatch_queue_t&#125; 顺序队列</span><br><span class="line">*/</span></span><br><span class="line"><span class="built_in">dispatch_queue_t</span> dispatch_get_global_queue(<span class="keyword">long</span> identifier, <span class="keyword">unsigned</span> <span class="keyword">long</span> flags);</span><br></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 声明并发队列</span></span><br><span class="line"><span class="built_in">dispatch_queue_t</span> my_global_queue;</span><br><span class="line"><span class="comment">// 获取并发队列（默认优先级）</span></span><br><span class="line">my_global_queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<h5 id="主队列"><a href="#主队列" class="headerlink" title="主队列"></a>主队列</h5><h6 id="dispatch-get-current-queue全局方法"><a href="#dispatch-get-current-queue全局方法" class="headerlink" title="dispatch_get_current_queue全局方法"></a>dispatch_get_current_queue全局方法</h6><blockquote>
<p><strong>说明：</strong>获取<code>当前运行的</code>队列代码块，如果在代码块的对象之外调用了这个函数，则它会返回<code>主队列</code>。<br><strong>注意：</strong>该方法在从<code>OS X 10.9</code>和<code>ios 6</code>开始被废弃，因为GCD队列本身是不可重入的，同步阻塞会导致死锁。<br><strong>用途：</strong>仍然可以作为调试手段在代码中使用。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取主线程或当前队列</span></span><br><span class="line"><span class="built_in">dispatch_queue_t</span> theQueue = dispatch_get_current_queue();</span><br></pre></td></tr></table></figure>
<h3 id="14-2-2-队列也要内存管理"><a href="#14-2-2-队列也要内存管理" class="headerlink" title="14.2.2    队列也要内存管理"></a>14.2.2    队列也要内存管理</h3><blockquote>
<p><strong>说明：</strong><code>调度队列</code>是引用计数对象，可以使用<code>dispatch_retain()</code>和<code>dispatch_release()</code>来修改队列的保留计数器的值。</p>
</blockquote>
<h4 id="14-2-2-1-队列的上下文"><a href="#14-2-2-1-队列的上下文" class="headerlink" title="14.2.2.1    队列的上下文"></a>14.2.2.1    队列的上下文</h4><blockquote>
<p><strong>说明：</strong>可以向<code>调度对象（包括调度队列）</code>指派<code>全局数据上下文</code>，可以在上下文中指派任意类型的数据，比如<code>Objective-C</code>对象或指针。<br><strong>内存管理：</strong>必须在需要<code>队列上下文</code>的时候分配内存并在队列销毁之前进行清理。</p>
</blockquote>
<h5 id="dispatch-set-context全局方法"><a href="#dispatch-set-context全局方法" class="headerlink" title="dispatch_set_context全局方法"></a>dispatch_set_context全局方法</h5><blockquote>
<p><strong>说明：</strong>为指定队列设置<code>全局上下文</code>。<br><strong>原型：</strong><code>/usr/include/dispatch/object.h</code></p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* @param &#123;dispatch_object_t&#125; object 调度队列</span><br><span class="line">* @param &#123;void *&#125; context 上下文</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">void</span> dispatch_set_context(dispatch_object_t object, <span class="keyword">void</span> *context);</span><br></pre></td></tr></table></figure>
<h5 id="dispatch-get-context全局方法"><a href="#dispatch-get-context全局方法" class="headerlink" title="dispatch_get_context全局方法"></a>dispatch_get_context全局方法</h5><blockquote>
<p><strong>说明：</strong>获得<code>调度队列</code>的<code>全局数据上下文</code>。<br><strong>原型：</strong><code>/usr/include/dispatch/object.h</code></p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* @param &#123;dispatch_object_t&#125; object 调度队列</span><br><span class="line">* @return &#123;void *&#125; 全局数据上下文</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">void</span> * dispatch_get_context(dispatch_object_t object);</span><br></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建可变字典（作为全局数据上下文）</span></span><br><span class="line"><span class="built_in">NSMutableDictionary</span> *myContext = [[<span class="built_in">NSMutableDictionary</span> alloc] initWithCapacity:<span class="number">5</span>];</span><br><span class="line"><span class="comment">// 为全局上下文添加队列需要的数据</span></span><br><span class="line">[myContext setObject:<span class="string">@"My Context"</span> forKey:<span class="string">@"title"</span>];</span><br><span class="line">[myContext setObject:[<span class="built_in">NSNumber</span> numberWithInt:<span class="number">0</span>] forKey:<span class="string">@"value"</span>];</span><br><span class="line"><span class="comment">// 为连续队列 my_serial_queue 设置全局数据上下文</span></span><br><span class="line">dispatch_set_context(my_serial_queue, (__bridge_retained <span class="keyword">void</span> *)myContext);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 提取全局数据上下文(桥接转换__bridge，告诉ARC不想自己来管理上下文的内存)</span></span><br><span class="line">myContext = (__bridge <span class="built_in">NSMutableDictionary</span> *)dispatch_get_context(my_serial_queue);</span><br></pre></td></tr></table></figure>
<h4 id="14-2-2-2-全局数据上下文内存管理"><a href="#14-2-2-2-全局数据上下文内存管理" class="headerlink" title="14.2.2.2    全局数据上下文内存管理"></a>14.2.2.2    全局数据上下文内存管理</h4><blockquote>
<p><strong>说明：</strong>编写一个<code>终结器(finalizer)</code>函数，在<code>dealloc</code>中调用。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* 终结器函数</span><br><span class="line">* @param &#123;void *&#125; context 全局数据上下文对象</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">void</span> myFinalizerFunction(<span class="keyword">void</span> *context) &#123;</span><br><span class="line">	<span class="built_in">NSLog</span>(<span class="string">@"myFinalizerFunction"</span>);</span><br><span class="line">	<span class="comment">// 桥接转换：将全局数据上下文对象桥接转换为具体类型</span></span><br><span class="line">	<span class="comment">// 其中，__bridge_transfer 将拥有权限转移到了本函数中，意味着该对象的内存管理由全局释放池换成了我们的函数</span></span><br><span class="line">	<span class="built_in">NSMutableDictionary</span> *theData = (__bridge_transfer <span class="built_in">NSMutableDictionary</span>*)context;</span><br><span class="line">	<span class="comment">// 清空作为全局数据上下文的对象</span></span><br><span class="line">	[theData removeAllObjects];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="14-2-2-3-向调度队列添加任务"><a href="#14-2-2-3-向调度队列添加任务" class="headerlink" title="14.2.2.3    向调度队列添加任务"></a>14.2.2.3    向调度队列添加任务</h4><blockquote>
<p><strong>说明：</strong>有两种方式可以向队列中添加任务，每种方式针对<code>代码块</code>和<code>函数</code>各有一个调度函数（共4个）</p>
<ul>
<li><strong>同步：</strong>队列会一直等待前面任务结束</li>
<li><strong>异步：</strong>添加任务后，不必等待任务，函数会立刻返回（推荐，因为不会阻塞其他代码的运行）</li>
</ul>
</blockquote>
<p>|<em>**</em>|同步|异步|<br>|代码块|<code>dispatch_sync</code>|<code>dispatch_async</code>|<br>|函数|<code>dispatch_sync_f</code>|<code>dispatch_async_f</code>|</p>
<h5 id="dispatch-sync全局函数"><a href="#dispatch-sync全局函数" class="headerlink" title="dispatch_sync全局函数"></a>dispatch_sync全局函数</h5><blockquote>
<p><strong>说明：</strong>向队列中<code>同步</code>添加<code>代码块</code>。<br><strong>原型：</strong><code>/use/include/dispatch/queue.h</code></p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* @param &#123;dispatch_queue_t&#125; queue 调度队列</span><br><span class="line">* @param &#123;dispatch_block_t&#125; block 代码块</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">void</span> <span class="built_in">dispatch_async</span>(<span class="built_in">dispatch_queue_t</span> queue, dispatch_block_t block);</span><br></pre></td></tr></table></figure>
<h5 id="dispatch-async全局函数"><a href="#dispatch-async全局函数" class="headerlink" title="dispatch_async全局函数"></a>dispatch_async全局函数</h5><blockquote>
<p><strong>说明：</strong>向队列中<code>异步</code>添加<code>代码块</code>。<br><strong>原型：</strong><code>/use/include/dispatch/queue.h</code></p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* @param &#123;dispatch_queue_t&#125; queue 调度队列</span><br><span class="line">* @param &#123;dispatch_block_t&#125; block 代码块</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">void</span> <span class="built_in">dispatch_async</span>(<span class="built_in">dispatch_queue_t</span> queue, dispatch_block_t block);</span><br></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 异步添加代码块：内联方式</span></span><br><span class="line"><span class="built_in">dispatch_async</span>(my_serial_queue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Serial Task 1"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 异步添加代码块：非内联</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> (^dispatch_block_t)(<span class="keyword">void</span>);</span><br><span class="line">dispatch_block_t myBlock = ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"My Prefined block"</span>);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">dispatch_async</span>(my_serial_queue, myBlock);</span><br></pre></td></tr></table></figure>
<h5 id="dispatch-sync-f全局函数"><a href="#dispatch-sync-f全局函数" class="headerlink" title="dispatch_sync_f全局函数"></a>dispatch_sync_f全局函数</h5><blockquote>
<p><strong>说明：</strong>向队列中<code>同步</code>添加<code>代码块</code>。<br><strong>原型：</strong><code>/use/include/dispatch/queue.h</code></p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* @param &#123;dispatch_queue_t&#125; queue 调度队列</span><br><span class="line">* @param &#123;void *&#125; context 需要传递的任意上下文</span><br><span class="line">* @param &#123;dispatch_function_t&#125; work 函数</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">void</span> dispatch_async_f(<span class="built_in">dispatch_queue_t</span> queue,	<span class="keyword">void</span> *context,	dispatch_function_t work);</span><br></pre></td></tr></table></figure>
<h5 id="dispatch-async-f全局函数"><a href="#dispatch-async-f全局函数" class="headerlink" title="dispatch_async_f全局函数"></a>dispatch_async_f全局函数</h5><blockquote>
<p><strong>说明：</strong>向队列中<code>异步</code>添加<code>代码块</code>。<br><strong>原型：</strong><code>/use/include/dispatch/queue.h</code></p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* @param &#123;dispatch_queue_t&#125; queue 调度队列</span><br><span class="line">* @param &#123;void *&#125; context 需要传递的任意上下文</span><br><span class="line">* @param &#123;dispatch_function_t&#125; work 函数</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">void</span> dispatch_async_f(<span class="built_in">dispatch_queue_t</span> queue,	<span class="keyword">void</span> *context,	dispatch_function_t work);</span><br></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义好要添加到队列的函数</span></span><br><span class="line"><span class="keyword">void</span> myDispatchFunction (<span class="keyword">void</span> *argument) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Serial Task %@"</span>, (__bridge <span class="built_in">NSNumber</span> *)argument);</span><br><span class="line">    <span class="comment">// 获得当前队列的全局数据上下文</span></span><br><span class="line">    <span class="built_in">NSMutableDictionary</span> *context = (__bridge <span class="built_in">NSMutableDictionary</span> *)dispatch_get_context(dispatch_get_current_queue());</span><br><span class="line">    <span class="comment">// 在字典中索引</span></span><br><span class="line">    <span class="built_in">NSNumber</span> *value = [context objectForKey:<span class="string">@"value"</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"value = %@"</span>, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 同步向队列中添加函数</span></span><br><span class="line">dispatch_async_f(my_serial_queue, (__bridge <span class="keyword">void</span> *)[<span class="built_in">NSNumber</span> numberWithInt:<span class="number">3</span>], (dispatch_function_t)myDispatchFunction);</span><br></pre></td></tr></table></figure>
<h4 id="14-2-2-3-调度队列的暂停和重启"><a href="#14-2-2-3-调度队列的暂停和重启" class="headerlink" title="14.2.2.3    调度队列的暂停和重启"></a>14.2.2.3    调度队列的暂停和重启</h4><h5 id="dispatch-suspend全局方法"><a href="#dispatch-suspend全局方法" class="headerlink" title="dispatch_suspend全局方法"></a>dispatch_suspend全局方法</h5><blockquote>
<p><strong>说明：</strong>暂停队列<br><strong>原型：</strong><code>/use/include/dispatch/object.h</code></p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* @param &#123;dispatch_object_t&#125; object 要暂停的队列</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">void</span> dispatch_suspend(dispatch_object_t object);</span><br></pre></td></tr></table></figure>
<h5 id="dispatch-resume全局方法"><a href="#dispatch-resume全局方法" class="headerlink" title="dispatch_resume全局方法"></a>dispatch_resume全局方法</h5><blockquote>
<p><strong>说明：</strong>重启队列<br><strong>原型：</strong><code>/use/include/dispatch/object.h</code></p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* @param &#123;dispatch_object_t&#125; object 要暂停的队列</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">void</span> dispatch_resume(dispatch_object_t object);</span><br></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 暂停队列</span></span><br><span class="line">dispatch_suspend(my_serial_queue);</span><br><span class="line"><span class="comment">// 重启队列</span></span><br><span class="line">dispatch_resume(my_serial_queue);</span><br></pre></td></tr></table></figure>
<h3 id="14-2-3-操作队列"><a href="#14-2-3-操作队列" class="headerlink" title="14.2.3    操作队列"></a>14.2.3    操作队列</h3><blockquote>
<p><strong>说明：</strong>有一些称为<code>操作（operation）</code>的<code>API</code>，可以让队列使用起来更加简单。</p>
<ol>
<li>创建一个<code>操作</code>对象</li>
<li>将其指派给<code>操作队列</code></li>
<li><code>操作</code>被队列执行</li>
</ol>
</blockquote>
<h4 id="操作的创建方式"><a href="#操作的创建方式" class="headerlink" title="操作的创建方式"></a><code>操作</code>的创建方式</h4><blockquote>
<p><strong>说明：</strong>一共有3种方式</p>
</blockquote>
<table>
<thead>
<tr>
<th>方式</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>调用操作（<code>NSInvocationOperation</code>）</td>
<td>前提是已经拥有一个可以完成工作的类，并且想在队列上执行</td>
</tr>
<tr>
<td>代码块操作（<code>NSBlockOperation</code>）</td>
<td>类似包含了要执行代码块的<code>dispatch_async</code>函数</td>
</tr>
<tr>
<td>自定义的<code>操作</code></td>
<td>通过继承<code>NSOperation</code>定义自己的<code>操作</code></td>
</tr>
</tbody>
</table>
<h5 id="方式一：创建调用操作"><a href="#方式一：创建调用操作" class="headerlink" title="方式一：创建调用操作"></a>方式一：创建<code>调用操作</code></h5><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">MyCustomClass</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSOperation</span> *)operationWithData: (<span class="keyword">id</span>)data &#123;</span><br><span class="line">	<span class="keyword">return</span> [[<span class="built_in">NSInvocationOperation</span> alloc] initWithTarget: <span class="keyword">self</span> selectorL <span class="keyword">@selector</span>(myWorkerMethod:)object:data];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 做具体工作的函数</span></span><br><span class="line">- (<span class="keyword">void</span>)myWorkerMethod: (<span class="keyword">id</span>)data &#123;</span><br><span class="line">	<span class="built_in">NSLog</span>(<span class="string">@"My Worker Method %@"</span>, data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h5 id="方式二：创建代码块操作"><a href="#方式二：创建代码块操作" class="headerlink" title="方式二：创建代码块操作"></a>方式二：创建<code>代码块操作</code></h5><blockquote>
<p><strong>说明：</strong>创建时作为参数的<code>代码块</code>的类型和在<code>调度队列</code>中使用的相同。</p>
<ul>
<li>一旦创建了第一个<code>代码块操作</code>，便可以通过<code>addExecutionBlock</code>方法继续添加更多的<code>代码块</code></li>
<li>根据<code>队列</code>的类型，代码块会分别以连续或并行的方式运行</li>
</ul>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSBlockOperation</span> *blockOperation = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock: ^ &#123;</span><br><span class="line">	<span class="comment">// 具体工作内容</span></span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过代码块操作，继续添加代码块</span></span><br><span class="line">[blockOperation addExecutionBlock:^&#123;</span><br><span class="line">	<span class="comment">// 更多要做工作</span></span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<h4 id="向队列中添加操作"><a href="#向队列中添加操作" class="headerlink" title="向队列中添加操作"></a>向队列中添加操作</h4><blockquote>
<p><strong>说明：</strong>可以使用<code>NSOperationQueue</code>来取代之前使用的<code>dispatch_queue</code>函数，特点如下</p>
<ul>
<li>并发执行<code>操作</code></li>
<li>具有<code>相关性</code>，也就是说，如果某个<code>操作</code>是基于其它<code>操作</code>的，则也会先被执行</li>
</ul>
<p><strong>技巧：</strong>如果要确保添加的<code>操作</code>是连续执行（串行）的，可以设置最大并发操作数为1，这样会按照<code>先入先出</code>的规范执行</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取队列</span></span><br><span class="line"><span class="built_in">NSOperationQueue</span> *currentQueue = [<span class="built_in">NSOperation</span> currentQueue];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加操作</span></span><br><span class="line">[theQueue addOperation:blockOperation];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 也可以添加代码块替代操作对象</span></span><br><span class="line">[theQueue addOperationWithBlock:^&#123;</span><br><span class="line">	<span class="built_in">NSLog</span>(<span class="string">@"my work"</span>);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<h2 id="14-3-小结"><a href="#14-3-小结" class="headerlink" title="14.3    小结"></a>14.3    小结</h2>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/13/o-c基础教程第二版_13 协议/" itemprop="url">
                  13 协议
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-13T10:40:50+08:00" content="2016-05-13">
              2016-05-13
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/13/o-c基础教程第二版_13 协议/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/13/o-c基础教程第二版_13 协议/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="13-1-正式协议"><a href="#13-1-正式协议" class="headerlink" title="13.1    正式协议"></a>13.1    正式协议</h2><blockquote>
<p><strong>说明：</strong>正式协议类似<code>Java</code>的接口。</p>
<ul>
<li><strong>声明协议：</strong>通过<code>@protocol</code>创建协议的声明。</li>
<li><strong>采用协议：</strong>在类的<code>@interface</code>声明中列出协议的名称。</li>
<li><strong>遵守协议：</strong>在类的<code>@implementation</code>中实现协议的所有方法（否则编译器会生成警告）。</li>
</ul>
</blockquote>
<h3 id="13-1-1-声明协议"><a href="#13-1-1-声明协议" class="headerlink" title="13.1.1    声明协议"></a>13.1.1    声明协议</h3><blockquote>
<p><strong>说明：</strong>类似类或类别的声明</p>
<ul>
<li>可以继承父协议，类似继承父类</li>
<li>内部是方法声明列表</li>
<li>在协议中不会引入新的实例变量</li>
</ul>
<p><strong>语法：</strong></p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@protocol</span> 协议名 &lt;父协议名</span></span><br><span class="line"><span class="comment">// 方法列表</span></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h4 id="Cocoa的NSCopying协议"><a href="#Cocoa的NSCopying协议" class="headerlink" title="Cocoa的NSCopying协议"></a>Cocoa的<code>NSCopying</code>协议</h4><blockquote>
<p><strong>说明：</strong>如果采用了该协议，对象就会知道如何创建自己的副本。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">NSCopying</span></span></span><br><span class="line">- (<span class="keyword">id</span>) copyWithZone: (<span class="built_in">NSZone</span> *) zone;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h4 id="Cocoa的NSCoding协议"><a href="#Cocoa的NSCoding协议" class="headerlink" title="Cocoa的NSCoding协议"></a>Cocoa的<code>NSCoding</code>协议</h4><blockquote>
<p><strong>说明：</strong>能够对自身进行编码和解码</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">NSCoding</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line">* 接收对象的实例变量并将其转换为NSCoder类的对象</span><br><span class="line">*</span><br><span class="line">* @param &#123;NSCoder *&#125; encoder</span><br><span class="line">*/</span></span><br><span class="line">- (<span class="keyword">void</span>) encodeWithCoder: (<span class="built_in">NSCoder</span> *) encoder;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line">* 从NSCoder对象中提取经过转换雪藏的实例变量，并使用它们去初始化新的对象</span><br><span class="line">*</span><br><span class="line">* @param &#123;NSCoder *&#125; decoder</span><br><span class="line">*/</span></span><br><span class="line">- (<span class="keyword">id</span>) initWithCoder: (<span class="built_in">NSCoder</span> *) decoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h3 id="13-1-2-采用协议"><a href="#13-1-2-采用协议" class="headerlink" title="13.1.2    采用协议"></a>13.1.2    采用协议</h3><blockquote>
<p><strong>说明：</strong>要采用某个协议，可以在类的声明中列出该协议的名称，并用<code>&lt;&gt;</code>括起来<br><strong>语法：</strong>可以同时实现多个协议，中间用<code>,</code>分隔</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> 类名: 父类明 &lt;协议1, 协议2, ...</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 实例变量</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 遵守协议实现的方法</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Car</span>: <span class="title">NSObject</span> &lt;<span class="title">NSCoping</span>, <span class="title">NSCoding</span>&gt;</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// 实例变量</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 遵守协议实现的方法</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h3 id="13-1-3-实现协议"><a href="#13-1-3-实现协议" class="headerlink" title="13.1.3    实现协议"></a>13.1.3    实现协议</h3><h2 id="13-2-复制"><a href="#13-2-复制" class="headerlink" title="13.2    复制"></a>13.2    复制</h2><blockquote>
<p><strong>说明：</strong>复制分为两类，<code>浅层复制（shallow copy）</code>和<code>深层复制（deep copy）</code></p>
</blockquote>
<table>
<thead>
<tr>
<th>复制</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>浅层复制</td>
<td>只会复制指向引用对象的指针</td>
</tr>
<tr>
<td>深层复制</td>
<td>将复制引用的对象</td>
</tr>
</tbody>
</table>
<h3 id="13-2-1-复制-Engine"><a href="#13-2-1-复制-Engine" class="headerlink" title="13.2.1    复制 Engine"></a>13.2.1    复制 Engine</h3><blockquote>
<p><strong>说明：</strong>没有实例变量或属性。</p>
</blockquote>
<p><em>Engine.h</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> *  采纳 NSCopying 协议</span><br><span class="line"> */</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Engine</span> : <span class="title">NSObject</span> &lt;<span class="title">NSCopying</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span><span class="comment">// Engine</span></span><br></pre></td></tr></table></figure>
<p><em>Engine.m</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"Engine.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Engine</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSString</span> *) description</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="string">@"I am an engine.  Vrooom!"</span>);</span><br><span class="line">&#125; <span class="comment">// description</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> *  遵守协议，实现复制自身的方法</span><br><span class="line"> *</span><br><span class="line"> *  @param zone 内存区域</span><br><span class="line"> *</span><br><span class="line"> *  @return &#123;id&#125; 复制的对象</span><br><span class="line"> */</span></span><br><span class="line">- (<span class="keyword">id</span>) copyWithZone:(<span class="built_in">NSZone</span> *)zone &#123;</span><br><span class="line">    Engine *engineCopy;</span><br><span class="line">    <span class="comment">// 创建一个当前类（Engine或其子类）创建一个新对象</span></span><br><span class="line">    engineCopy = [[[<span class="keyword">self</span> class] allocWithZone:zone] init];</span><br><span class="line">    <span class="keyword">return</span> engineCopy;</span><br><span class="line">&#125;<span class="comment">// copyWithZone</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span> <span class="comment">// Engine</span></span><br></pre></td></tr></table></figure>
<h3 id="13-2-2-复制-Tire"><a href="#13-2-2-复制-Tire" class="headerlink" title="13.2.2    复制 Tire"></a>13.2.2    复制 Tire</h3><blockquote>
<p><strong>说明：</strong>有属性，要考虑实例变量（包括子类的）的复制，需要选择合适的构造函数或者使用<code>setter</code>修改对象的属性。<br><strong>扩展：</strong>可以使用<code>C</code>语言风格的<code>指针运算符</code>直接访问实例变量。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tireCopy-&gt;pressure = presssure;</span><br><span class="line">tireCopy-&gt;treadDepth = treadDepth;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>技巧：</strong>一般来说，当设置属性不太可能涉及额外工作时，我们尽量使用init方法和访问器方法。</p>
</blockquote>
<p><em>Tire.h</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Tire</span> : <span class="title">NSObject</span> &lt;<span class="title">NSCopying</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> <span class="keyword">float</span> pressure;</span><br><span class="line"><span class="keyword">@property</span> <span class="keyword">float</span> treadDepth;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)initWithPressure:(<span class="keyword">float</span>)pressure treadDepth:(<span class="keyword">float</span>)treadDepth;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p><em>Tire.m</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"Tire.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Tire</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> *  遵守协议，实现复制自身的方法</span><br><span class="line"> *</span><br><span class="line"> *  @param zone 内存区域</span><br><span class="line"> *</span><br><span class="line"> *  @return 复制的对象</span><br><span class="line"> */</span></span><br><span class="line">- (<span class="keyword">id</span>) copyWithZone:(<span class="built_in">NSZone</span> *)zone &#123;</span><br><span class="line">    Tire *tireCopy;</span><br><span class="line">    <span class="comment">// 调用便利构造器创建对象（属性相同）</span></span><br><span class="line">    tireCopy = [[[<span class="keyword">self</span> class] allocWithZone:zone] initWithPressure:<span class="keyword">self</span>.pressure treadDepth:<span class="keyword">self</span>.treadDepth];</span><br><span class="line">    <span class="keyword">return</span> (tireCopy);</span><br><span class="line">&#125;<span class="comment">// copyWithZone</span></span><br><span class="line"><span class="comment">// 构造器</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h3 id="13-2-3-复制-Car"><a href="#13-2-3-复制-Car" class="headerlink" title="13.2.3    复制 Car"></a>13.2.3    复制 Car</h3><p><em>Car.h</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Cocoa/Cocoa.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@class</span> <span class="title">Tire</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">@class</span> <span class="title">Engine</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Car</span> : <span class="title">NSObject</span> &lt;<span class="title">NSCopying</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">@end</span> <span class="comment">// Car</span></span><br></pre></td></tr></table></figure>
<p><em>Car.m</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"Car.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"Engine.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"Tire.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Car</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>) copyWithZone:(<span class="built_in">NSZone</span> *)zone &#123;</span><br><span class="line">    Car *carCopy;</span><br><span class="line">    <span class="comment">// 创建车身</span></span><br><span class="line">    carCopy = [[[<span class="keyword">self</span> class] allocWithZone:zone] init];</span><br><span class="line">    <span class="comment">// 基本设置</span></span><br><span class="line">    carCopy.name = <span class="keyword">self</span>.name;</span><br><span class="line">    Engine *engineCopy;</span><br><span class="line">    engineCopy = [engine <span class="keyword">copy</span>];</span><br><span class="line">    carCopy.engine = engineCopy;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i= <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">        Tire *tireCopy;</span><br><span class="line">        tireCopy = [[<span class="keyword">self</span> tireAtIndex:i] <span class="keyword">copy</span>];</span><br><span class="line">        [carCopy setTire:tireCopy atIndex:i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (carCopy);</span><br><span class="line">&#125;<span class="comment">// copyWithZone</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span> <span class="comment">// Car</span></span><br></pre></td></tr></table></figure>
<h3 id="13-2-4-协议和数据"><a href="#13-2-4-协议和数据" class="headerlink" title="13.2.4    协议和数据"></a>13.2.4    协议和数据</h3><blockquote>
<p><strong>说明：</strong>可以在实例变量和方法参数的后面添加<code>&lt;协议名&gt;</code>来对对象是够遵守协议进行类型检查。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 要求 object 遵守 NSCopying 协议,否则编译器会给出警告</span></span><br><span class="line">- (<span class="keyword">void</span>) setObjectValue: (<span class="keyword">id</span>&lt;<span class="built_in">NSCopying</span>&gt;) object;</span><br></pre></td></tr></table></figure>
<h2 id="13-3-Objective-C-2-0-的新特性"><a href="#13-3-Objective-C-2-0-的新特性" class="headerlink" title="13.3    Objective-C 2.0 的新特性"></a>13.3    Objective-C 2.0 的新特性</h2><blockquote>
<p><strong>说明：</strong><code>Objective-C 2.0</code>中增加了两个新的协议修饰符：<code>@optional</code>和<code>@required</code>，用来取代<code>非正式协议</code></p>
<ul>
<li><code>@optional</code>：后面的方法声明列表可以实现也可以不实现</li>
<li><code>@required</code>后面的方法列表中的方法必须被实现</li>
</ul>
<p><strong>优点(相比非正式协议)：</strong>可以用来在类声明中明确表达我们的意图。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@proptocol BaseballPlayer</span><br><span class="line"></span><br><span class="line"><span class="comment">// 必须实现</span></span><br><span class="line">- (<span class="keyword">void</span>) drawHugeSalary;</span><br><span class="line"><span class="comment">// 可以实现</span></span><br><span class="line"><span class="keyword">@optional</span></span><br><span class="line">- (<span class="keyword">void</span>) slideeHome;</span><br><span class="line">- (<span class="keyword">void</span>) catchBall;</span><br><span class="line">- (<span class="keyword">void</span>) throwBall;</span><br><span class="line"><span class="comment">// 必须实现</span></span><br><span class="line"><span class="keyword">@required</span></span><br><span class="line">- (<span class="keyword">void</span>) swingBat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span><span class="comment">//</span></span><br></pre></td></tr></table></figure>
<h2 id="13-4-委托方法"><a href="#13-4-委托方法" class="headerlink" title="13.4    委托方法"></a>13.4    委托方法</h2><blockquote>
<p><strong>说明：</strong><code>委托</code>是一个经常与<code>协议</code>共用的特性。<br><strong>举例：</strong><code>管理者</code>将部分具体工作委托给<code>工作人员</code>完成，<code>工作人员类</code>采纳了指定<code>协议</code>。<br><img src="http://o6ul1xz4z.bkt.clouddn.com/img/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-01-22%20%E4%B8%8B%E5%8D%886.19.00.png" alt="Alt text"></p>
</blockquote>
<p><em>WorkerProtocol.h：工作人员类采纳的协议</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">WorkerProtocol</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@optional</span></span><br><span class="line">- (<span class="keyword">void</span>)doSomeOptionalWork;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@required</span></span><br><span class="line">- (<span class="keyword">void</span>)doSomeRequiredWork;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p><em>Worker1.h + Worker1.m</em> </p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"WorkerProtocol.h"</span></span></span><br><span class="line"><span class="comment">// 采纳了协议 WorkerProtocol</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Worker1</span> : <span class="title">NSObject</span> &lt;<span class="title">WorkerProtocol</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"Worker1.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Worker1</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)doSomeRequiredWork &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Worker1 doing required work."</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p><em>Worker2.h + Worker2.m</em> </p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"WorkerProtocol.h"</span></span></span><br><span class="line"><span class="comment">// 采纳了协议 WorkerProtocol</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Worker2</span> : <span class="title">NSObject</span> &lt;<span class="title">WorkerProtocol</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"Worker2.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Worker2</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)doSomeRequiredWork &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Worker2 doing required work."</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)doSomeOptionalWork &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Worker2 doing optional work."</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p><em>Manager.h + Manager.m：管理者（会委托部分工作给设置的委托对象）</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"WorkerProtocol.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Manager</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">weak</span>) <span class="keyword">id</span> &lt;WorkerProtocol&gt; delegate;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)doWork;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"Manager.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义私有方法</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Manager</span> ()</span></span><br><span class="line">- (<span class="keyword">void</span>)myWork;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Manager</span></span></span><br><span class="line"><span class="keyword">@synthesize</span> delegate;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)doWork</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 调用委托对象完成必要工作</span></span><br><span class="line">    [delegate doSomeRequiredWork];</span><br><span class="line">    <span class="comment">// 检查是否有额外工作，有则做</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">YES</span> == [delegate respondsToSelector:<span class="keyword">@selector</span>(doSomeOptionalWork)])</span><br><span class="line">    &#123;</span><br><span class="line">        [delegate doSomeOptionalWork];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 执行自己的私有方法</span></span><br><span class="line">    [<span class="keyword">self</span> myWork];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)myWork &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"I am a manager and I am working"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p><em>main.m</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"Manager.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"Worker1.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"Worker2.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 管理者</span></span><br><span class="line">        Manager *manager = [[Manager alloc] init];</span><br><span class="line">        <span class="comment">// 委托对象</span></span><br><span class="line">        Worker1 *worker1 = [[Worker1 alloc] init];</span><br><span class="line">        <span class="comment">// 为管理者设置委托对象</span></span><br><span class="line">        manager.delegate = worker1;</span><br><span class="line">        <span class="comment">// 工作（内部委托 worker1 工作）</span></span><br><span class="line">        [manager doWork];</span><br><span class="line">        </span><br><span class="line">        Worker2 *worker2 = [[Worker2 alloc] init];</span><br><span class="line">        manager.delegate = worker2;</span><br><span class="line">        [manager doWork];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="13-5-小结"><a href="#13-5-小结" class="headerlink" title="13.5    小结"></a>13.5    小结</h2>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/13/o-c基础教程第二版_12 类别/" itemprop="url">
                  12 类别
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-13T10:40:26+08:00" content="2016-05-13">
              2016-05-13
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/13/o-c基础教程第二版_12 类别/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/13/o-c基础教程第二版_12 类别/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><strong>说明：</strong>利用<code>Objective-C</code>的动态运行时分配机制，你可以为现有的类添加<code>方法</code>或<code>计算属性</code>，这种机制称为<code>类别(category)</code>。</p>
<ul>
<li>可以在类中添加属性（<code>@property</code>），且只能是<code>计算属性</code>（不能添加<code>实例变量</code>）</li>
<li>可以向一个<code>类</code>添加任意数量的<code>类别</code></li>
<li><code>类别</code>可以访问其扩展的类的<code>实例变量</code></li>
</ul>
<p><strong>总结：</strong>我将<code>类别</code>分3种</p>
</blockquote>
<table>
<thead>
<tr>
<th>种类</th>
<th><code>@interface</code></th>
<th><code>@implementation</code></th>
</tr>
</thead>
<tbody>
<tr>
<td>类别</td>
<td><code>@interface 类名(类别名)</code></td>
<td><code>@implementation 类名(类别名)</code></td>
</tr>
<tr>
<td>类扩展（匿名类别）</td>
<td><code>@interface 类名()</code></td>
<td>无</td>
</tr>
<tr>
<td>前向引导</td>
<td><code>@interface 类名(类别名)</code></td>
<td><code>@implementation 类名</code></td>
</tr>
</tbody>
</table>
<h2 id="12-1-创建类别"><a href="#12-1-创建类别" class="headerlink" title="12.1    创建类别"></a>12.1    创建类别</h2><blockquote>
<p><strong>说明：</strong>可以为人和类添加新的方法，包括那些没有源代码的类。<br><strong>技巧：</strong>通常把类别代码放在<code>独立</code>的文件中，通常以<code>类名称+类别名称</code>的风格命名。</p>
</blockquote>
<h3 id="12-1-1-开始创建类别独立文件"><a href="#12-1-1-开始创建类别独立文件" class="headerlink" title="12.1.1    开始创建类别独立文件"></a>12.1.1    开始创建类别独立文件</h3><blockquote>
<p><strong>说明：</strong>使用<code>Xcode</code>往项目中添加类别非常容易，甚至可以<code>类名称+类别名称</code>命名类别文件。</p>
<ol>
<li>新建文件<br><img src="http://o6ul1xz4z.bkt.clouddn.com/img/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-01-20%20%E4%B8%8A%E5%8D%8811.23.09.png" alt="Alt text"></li>
<li>选择模版<br><img src="http://o6ul1xz4z.bkt.clouddn.com/img/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-01-20%20%E4%B8%8A%E5%8D%8811.23.39.png" alt="Alt text"></li>
<li>文件相关<br><img src="http://o6ul1xz4z.bkt.clouddn.com/img/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-01-20%20%E4%B8%8A%E5%8D%8811.24.00.png" alt="Alt text"></li>
<li>完成<br><img src="http://o6ul1xz4z.bkt.clouddn.com/img/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-01-20%20%E4%B8%8A%E5%8D%8811.24.16.png" alt="Alt text"></li>
</ol>
</blockquote>
<h3 id="12-1-2-interface部分"><a href="#12-1-2-interface部分" class="headerlink" title="12.1.2    @interface部分"></a>12.1.2    @interface部分</h3><p><em>NSString+NumberConvience.h</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSString</span> (<span class="title">NumberConvience</span>)</span></span><br><span class="line">- (<span class="built_in">NSNumber</span> *) lengthAsNumber;</span><br><span class="line"><span class="keyword">@end</span><span class="comment">// NumberConvience</span></span><br></pre></td></tr></table></figure>
<h3 id="12-1-3-implementation部分"><a href="#12-1-3-implementation部分" class="headerlink" title="12.1.3    @implementation部分"></a>12.1.3    @implementation部分</h3><p><em>NSString+NumberConvience.m</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"NSString+NumberConvience.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSString</span> (<span class="title">NumberConvience</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * 获取NSNumber 类型的字符串长度</span><br><span class="line"> * @return &#123;NSNumber *&#125; 字符串长度</span><br><span class="line"> */</span></span><br><span class="line">- (<span class="built_in">NSNumber</span> *) lengthAsNumber &#123;</span><br><span class="line">    <span class="comment">// 获得字符串长度：NSInteger 底层是个 long int</span></span><br><span class="line">    <span class="built_in">NSUInteger</span> length = [<span class="keyword">self</span> length];</span><br><span class="line">    <span class="comment">// 将字符串长度转换为 NSNumber 类型</span></span><br><span class="line">    <span class="keyword">return</span> ([<span class="built_in">NSNumber</span> numberWithUnsignedLong: length]);</span><br><span class="line">&#125;<span class="comment">// lengthAsNumber</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p><em>main.m</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"NSString+NumberConvience.h"</span></span></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="comment">// 可变字典</span></span><br><span class="line">        <span class="built_in">NSMutableDictionary</span> *dict = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">        <span class="comment">// 添加键/值对</span></span><br><span class="line">        [dict setObject:[<span class="string">@"hello"</span> lengthAsNumber] forKey:<span class="string">@"hello"</span>];</span><br><span class="line">        [dict setObject:[<span class="string">@"iLikeFish"</span> lengthAsNumber] forKey:<span class="string">@"iLikeFish"</span>];</span><br><span class="line">        [dict setObject:[<span class="string">@"Once upon a time"</span> lengthAsNumber] forKey:<span class="string">@"Once upon a time"</span>];</span><br><span class="line">        <span class="comment">// 打印字典</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, dict);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="12-1-4-类别的缺陷"><a href="#12-1-4-类别的缺陷" class="headerlink" title="12.1.4    类别的缺陷"></a>12.1.4    类别的缺陷</h3><blockquote>
<p><strong>说明：</strong>类别有2个局限性</p>
<ul>
<li>无法向类中添加实例变量</li>
<li>当类别添加的方法和类中原有的方法重名时，类别具有更高的优先级</li>
</ul>
<p><strong>解决命名冲突：</strong>可以在类别的方法名中添加一个前缀，以确保不会发生名称冲突。<br><strong>添加实例变量：</strong>使用全局字典来存储对象与想关联的额外变量之间的映射。</p>
</blockquote>
<h3 id="12-1-5-类别的优势"><a href="#12-1-5-类别的优势" class="headerlink" title="12.1.5    类别的优势"></a>12.1.5    类别的优势</h3><blockquote>
<p><strong>说明：</strong>类别主要有3个用途</p>
<ul>
<li>将类的实现代码分散到多个不同文件或框架中</li>
<li>创建对私有方法的前向引用</li>
<li>向对象添加非正式协议（informal protocol）</li>
</ul>
</blockquote>
<h3 id="12-1-6-类扩展"><a href="#12-1-6-类扩展" class="headerlink" title="12.1.6    类扩展"></a>12.1.6    类扩展</h3><blockquote>
<p><strong>说名：</strong><code>类扩展（class extension）</code>是一个特殊的<code>类别</code>，它不需要命名(只有<code>@interface</code>没有<code>@implementation</code>)。</p>
<ul>
<li>可以包含源代码的类中使用</li>
<li>可以添加实例变量</li>
<li>可以将只读权限改成可读写的权限</li>
<li>创建数量不限</li>
</ul>
<p><strong>信息隐藏：</strong>分2种情况</p>
</blockquote>
<table>
<thead>
<tr>
<th><code>类扩展</code>所在文件</th>
<th>可访问性</th>
</tr>
</thead>
<tbody>
<tr>
<td>扩展的目标类的<code>@implementation</code>所在<code>.m</code>文件</td>
<td>目标类的内部</td>
</tr>
<tr>
<td>单独的私有<code>.h</code>文件</td>
<td>目标类的内部、目标类的子类和友类</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>注意：</strong>可以拥有多个<code>类扩展</code>，不过这样会引发很难察觉的<code>bug</code>，所以请理智使用。</p>
</blockquote>
<p><em>Things.h：类的<code>@interface</code></em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Things</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>) <span class="built_in">NSInteger</span> thing1;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">assign</span>) <span class="built_in">NSInteger</span> thing2;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)resetAllValues;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p><em>Things.m：类的<code>@implementation</code>和类扩展</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"Things.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> *  在实现文件中添加类扩展（匿名类别）</span><br><span class="line"> */</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Things</span> ()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 添加实例变量</span></span><br><span class="line">    <span class="built_in">NSInteger</span> thing4;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 修改原有属性的特性（只读－&gt;读写）</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">assign</span>) <span class="built_in">NSInteger</span> thing2;</span><br><span class="line"><span class="comment">// 添加属性</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>) <span class="built_in">NSInteger</span> thing3;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span><span class="comment">// Things ()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> *  类的原始定义</span><br><span class="line"> */</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Things</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>) resetAllValues &#123;</span><br><span class="line">    thing1 = <span class="number">100</span>;</span><br><span class="line">    thing2 = <span class="number">200</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span><span class="comment">// Things</span></span><br></pre></td></tr></table></figure>
<p><em>main.m：使用被扩展后的<code>NSString</code></em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        Things *things = [[Things alloc] init];</span><br><span class="line">        things.thing1 = <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, things);</span><br><span class="line">        [things resetAllValues];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, things);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="12-2-利用类别分散实现代码"><a href="#12-2-利用类别分散实现代码" class="headerlink" title="12.2    利用类别分散实现代码"></a>12.2    利用类别分散实现代码</h2><blockquote>
<p><strong>说明：</strong>如果想将大型的单个类分散到多个不同的<code>.m</code>文件中，可以使用<code>类别</code>。<br><strong>举例：</strong><code>AppKit</code>中的<code>NSWindow</code>，拥有大量的<code>类别</code>声明</p>
<ul>
<li><code>@interface NSWindow(NSKeyboardUI)</code></li>
<li><code>@interface NSWindow(NSToolbarSupport)</code></li>
<li><code>@interface NSWindow(NSDrag)</code></li>
<li><code>@interface NSWindow(NSCarbonExtensions)</code></li>
</ul>
<p><strong>扩展：</strong><code>类别</code>还可以将<code>方法</code>分散到<code>逻辑群组</code>中，使编程人员可以更加容易地阅读头<code>文件</code>。</p>
</blockquote>
<h3 id="在项目中使用类别"><a href="#在项目中使用类别" class="headerlink" title="在项目中使用类别"></a>在项目中使用类别</h3><blockquote>
<p><strong>说明：</strong>将类的<code>类别</code>的实现部分分散在三个独立的文件中。<br><img src="./屏幕快照 2016-01-20 下午10.54.50.png" alt="Alt text"></p>
</blockquote>
<p><em>CategoryThing.h：类的<code>@interface</code>和3个类别的<code>@interface</code></em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">CategoryThing</span> : <span class="title">NSObject</span></span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSInteger</span> thing1;</span><br><span class="line">    <span class="built_in">NSInteger</span> thing2;</span><br><span class="line">    <span class="built_in">NSInteger</span> thing3;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span><span class="comment">// CategoryThing</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> *  类扩展：Thing1</span><br><span class="line"> */</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">CategoryThing</span> (<span class="title">Thing1</span>)</span></span><br><span class="line">- (<span class="keyword">void</span>) setThing1: (<span class="built_in">NSInteger</span>) thing1;</span><br><span class="line">- (<span class="built_in">NSInteger</span>) thing1;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> *  类扩展：Thing2</span><br><span class="line"> */</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">CategoryThing</span> (<span class="title">Thing2</span>)</span></span><br><span class="line">- (<span class="keyword">void</span>) setThing2: (<span class="built_in">NSInteger</span>) thing2;</span><br><span class="line">- (<span class="built_in">NSInteger</span>) thing2;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> *  类扩展：Thing3</span><br><span class="line"> */</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">CategoryThing</span> (<span class="title">Thing3</span>)</span></span><br><span class="line">- (<span class="keyword">void</span>) setThing3: (<span class="built_in">NSInteger</span>) thing3;</span><br><span class="line">- (<span class="built_in">NSInteger</span>) thing3;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p><em>CategoryThing.m：类的<code>@implementation</code></em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"CategoryThing.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">CategoryThing</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> *  描述</span><br><span class="line"> *</span><br><span class="line"> *  @return 字符串表示的描述内容</span><br><span class="line"> */</span></span><br><span class="line">- (<span class="built_in">NSString</span> *) description &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *desc = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%ld %ld %ld"</span>, thing1, thing2, thing3];</span><br><span class="line">    <span class="keyword">return</span> (desc);</span><br><span class="line">&#125;<span class="comment">// description</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span><span class="comment">// CategoryThing</span></span><br></pre></td></tr></table></figure>
<p><em>CategoryThing+Thing1.m：类别Thing1的<code>@implementation</code></em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"CategoryThing.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">CategoryThing</span> (<span class="title">Thing1</span>)</span></span><br><span class="line">- (<span class="keyword">void</span>)setThing1:(<span class="built_in">NSInteger</span>)t1</span><br><span class="line">&#123;</span><br><span class="line">    thing1 = t1;</span><br><span class="line">&#125; <span class="comment">// setThing1</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSInteger</span>) thing1</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> (thing1);</span><br><span class="line">&#125; <span class="comment">// thing1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span> <span class="comment">// CategoryThing</span></span><br></pre></td></tr></table></figure>
<p><em>CategoryThing+Thing2.m：类别Thing2的<code>@implementation</code></em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"CategoryThing.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">CategoryThing</span> (<span class="title">Thing2</span>)</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setThing2:(<span class="built_in">NSInteger</span>)t2 &#123;</span><br><span class="line">    thing2 = t2;</span><br><span class="line">&#125; <span class="comment">// setthing2</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSInteger</span>) thing2 &#123;</span><br><span class="line">    <span class="keyword">return</span> (thing2);</span><br><span class="line">&#125; <span class="comment">// thing2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p><em>CategoryThing+Thing3.m：类别Thing3的<code>@implementation</code></em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"CategoryThing.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">CategoryThing</span> (<span class="title">Thing3</span>)</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setThing3:(<span class="built_in">NSInteger</span>)t3 &#123;</span><br><span class="line">    thing3 = t3;</span><br><span class="line">&#125; <span class="comment">// setthing3</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSInteger</span>) thing3 &#123;</span><br><span class="line">    <span class="keyword">return</span> (thing3);</span><br><span class="line">&#125; <span class="comment">// thing3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p><em>main.m：调用<code>类</code>通过<code>类别</code>扩展的功能</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"CategoryThing.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="comment">// 创建物品集合</span></span><br><span class="line">        CategoryThing *thing = [[CategoryThing alloc] init];</span><br><span class="line">        <span class="comment">// 调用通过“类别”扩展来的方法</span></span><br><span class="line">        [thing setThing1: <span class="number">5</span>];</span><br><span class="line">        [thing setThing2: <span class="number">23</span>];</span><br><span class="line">        [thing setThing3: <span class="number">42</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"Things are %@"</span>, thing);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="12-3-通过类别创建前向引用"><a href="#12-3-通过类别创建前向引用" class="headerlink" title="12.3    通过类别创建前向引用"></a>12.3    通过类别创建前向引用</h2><blockquote>
<p><strong>背景：</strong><code>Objective-C</code>的<code>私有方法</code>分两种</p>
<ul>
<li>如果在一个类的<code>@implementation</code>部分定义了某个方法，而对应的<code>@interface</code>部分没有相应的方法声明</li>
<li>通过<code>类扩展（匿名类别）</code>扩展的方法</li>
</ul>
<p>然而，<code>O-C</code>并不真的支持<code>私有方法</code>，所以<code>私有方法</code>仍然可以通过对象调用，只不过这时<code>Xcode</code>会给出警告。<br><strong>说明：</strong>当从外部访问某个<code>类</code>的<code>私有方法</code>时，为了避免<code>Xcode</code>给出警告，可以通过<code>类别</code>补充一个声明，即<code>前向引导</code>。<br><strong>扩展：</strong>实际上，苹果公司官网在知道方针中指出，应用程序不能访问类里面的私有变量和方法，如果你的应用程序有这样的行为，那么苹果公司会拒绝让它上架。<br><em>main.m：在最前面创建<code>类别</code>来补充<code>私有方法</code>的声明</em></p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Car</span> (<span class="title">Private</span>)</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>) moveTireFromPosition: (<span class="keyword">int</span>) pos1 toPosition: (<span class="keyword">int</span>) pos2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><em>Car.m：方法的实现部分是Car的<code>私有方法</code></em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Car</span></span></span><br><span class="line">...</span><br><span class="line">- (<span class="keyword">void</span>) moveTireFromPosition: (<span class="keyword">int</span>) pos1 toPosition: (<span class="keyword">int</span>) pos2 &#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h2 id="12-4-非正式协议和委托类别"><a href="#12-4-非正式协议和委托类别" class="headerlink" title="12.4    非正式协议和委托类别"></a>12.4    非正式协议和委托类别</h2><blockquote>
<p><strong>委托：</strong>将某些工作交给另一个类执行就叫做<code>委托(delegate)</code>。<br><strong>委托对象：</strong><code>委托</code>技术中，被委托用来执行某些工作的<code>对象</code>。<br><strong>说明：</strong>除了通过<code>继承</code>创建<code>委托对象</code>外，可以通过<code>类别</code>扩展<code>NSObject</code>（即创建了一个<code>非正式协议</code>），使其获得<code>委托方法</code>，从而将任何对象都变成<code>委托对象</code>。</p>
</blockquote>
<h3 id="12-4-1-iTunesFinder项目"><a href="#12-4-1-iTunesFinder项目" class="headerlink" title="12.4.1    iTunesFinder项目"></a>12.4.1    iTunesFinder项目</h3><blockquote>
<p><strong>说明：</strong>用来说明<code>Cocoa</code>中是如何使用<code>委托</code>技术的。</p>
</blockquote>
<h4 id="Bonjour"><a href="#Bonjour" class="headerlink" title="Bonjour"></a>Bonjour</h4><blockquote>
<p><strong>说明：</strong>查找由<code>Bonjour</code>发布的网络服务的<code>Cocoa类</code>是<code>NSNetServiceBrowser</code>。<br><strong>用法：</strong>告诉<code>网络服务浏览器</code>你需要的服务，并为其提供一个<code>委托对象</code>。<code>浏览器对象</code>将会向该<code>委托对象</code>发送消息，告知其发现新服务的时间。<br><em>ITunesFinder.h</em></p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Cocoa/Cocoa.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ITunesFinder</span> : <span class="title">NSObject</span> &lt;<span class="title">NSNetServiceBrowserDelegate</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p><em>ITunesFinder.m</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"ITunesFinder.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ITunesFinder</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> *  找到了网络服务时的回调方法</span><br><span class="line"> *</span><br><span class="line"> *  @param b          网络服务浏览器对象</span><br><span class="line"> *  @param service    被发现的服务</span><br><span class="line"> *  @param moreComing 一批通知是否已经完成的标记</span><br><span class="line"> */</span></span><br><span class="line">- (<span class="keyword">void</span>) netServiceBrowser:(<span class="built_in">NSNetServiceBrowser</span> *) b</span><br><span class="line">            didFindService:(<span class="built_in">NSNetService</span> *) service</span><br><span class="line">                moreComing:(<span class="built_in">BOOL</span>) moreComing &#123;</span><br><span class="line">    <span class="comment">// 获取关于该服务的所有有趣的属性</span></span><br><span class="line">    [service resolveWithTimeout:<span class="number">10</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span> (<span class="string">@"found one! Name is %@"</span>, [service name]);</span><br><span class="line">    </span><br><span class="line">&#125; <span class="comment">// didFindService</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> *  某个网络服务消失时的回调方法（用于状态刷新）</span><br><span class="line"> *</span><br><span class="line"> *  @param b          网络服务浏览器对象</span><br><span class="line"> *  @param service    被发现的服务</span><br><span class="line"> *  @param moreComing 一批通知是否已经完成的标记</span><br><span class="line"> */</span></span><br><span class="line">- (<span class="keyword">void</span>) netServiceBrowser:(<span class="built_in">NSNetServiceBrowser</span> *) b</span><br><span class="line">          didRemoveService:(<span class="built_in">NSNetService</span> *) service</span><br><span class="line">                moreComing:(<span class="built_in">BOOL</span>) moreComing</span><br><span class="line">&#123;</span><br><span class="line">    [service resolveWithTimeout:<span class="number">10</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span> (<span class="string">@"lost one! Name is %@"</span>, [service name]);</span><br><span class="line">    </span><br><span class="line">&#125; <span class="comment">// didRemoveService</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span> <span class="comment">// ITunesFinder</span></span><br></pre></td></tr></table></figure>
<p><em>main.m</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"ITunesFinder.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 创建 网络服务浏览器对象</span></span><br><span class="line">        <span class="built_in">NSNetServiceBrowser</span> *browser = [[<span class="built_in">NSNetServiceBrowser</span> alloc] init];</span><br><span class="line">        <span class="comment">// 创建 委托对象（自定义的查找iTunes资源的对象）</span></span><br><span class="line">        ITunesFinder *finder = [[ITunesFinder alloc] init];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 通知 网络服务浏览器对象所使用的委托对象为自定义的 ITunes 对象</span></span><br><span class="line">        [browser setDelegate:finder];</span><br><span class="line">        <span class="comment">// 搜索 iTunes 共享（使用TCP协议、只在本地网络中）</span></span><br><span class="line">        [browser searchForServicesOfType:<span class="string">@"_daap._tcp"</span></span><br><span class="line">                                inDomain:<span class="string">@"local."</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSLog</span> (<span class="string">@"begun browsing"</span>);</span><br><span class="line">        <span class="comment">// run循环（在 网络服务浏览器 发现新的 iTunes 共享之前会一直保持运行而不返回，即阻塞在此处而不执行后面的代码）</span></span><br><span class="line">        [[<span class="built_in">NSRunLoop</span> currentRunLoop] run];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="12-4-2-委托和类别"><a href="#12-4-2-委托和类别" class="headerlink" title="12.4.2    委托和类别"></a>12.4.2    委托和类别</h3><blockquote>
<p><strong>说明：</strong>除了通过<code>继承</code>创建<code>委托对象</code>外，可以通过<code>类别</code>扩展<code>NSObject</code>（即创建了一个<code>非正式协议</code>），使其获得<code>委托方法</code>，从而将任何对象都变成<code>委托对象</code>。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span> (<span class="title">NSNetServerBrowserDelegateMethods</span>)</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>) netServiceBrowserWillSearch: (<span class="built_in">NSNetServiceBrowser</span> *) browser;</span><br><span class="line">- (<span class="keyword">void</span>) netServiceBrowser:(<span class="built_in">NSNetServiceBrowser</span> *) b didFindService:(<span class="built_in">NSNetService</span> *) service moreComing:(<span class="built_in">BOOL</span>) moreComing;</span><br><span class="line">- (<span class="keyword">void</span>) netServiceBrowserDidStopSearch: (<span class="built_in">NSNetServiceBrowser</span> *) browser;</span><br><span class="line">- (<span class="keyword">void</span>) netServiceBrowser:(<span class="built_in">NSNetServiceBrowser</span> *) b didRemoveService:(<span class="built_in">NSNetService</span> *) service moreComing:(<span class="built_in">BOOL</span>) moreComing;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h3 id="12-4-3-响应选择器"><a href="#12-4-3-响应选择器" class="headerlink" title="12.4.3    响应选择器"></a>12.4.3    响应选择器</h3><blockquote>
<p><strong>说明：</strong><code>NSNetServiceBrowser</code>为了确定其<code>委托对象</code>是否能够处理那些发送给它的消息，会首先检查对象，询问其能否响应该选择器，是泽发送消息，否则忽略这个委托对象，程序继续运行。</p>
</blockquote>
<h4 id="选择器（selector）"><a href="#选择器（selector）" class="headerlink" title="选择器（selector）"></a>选择器（selector）</h4><blockquote>
<p><strong>说明：</strong>只是一个方法名称，但以<code>Objective-C</code>运行时使用的特殊方式编码，以快速执行查询。<br><strong>语法：</strong><code>@selector(方法名)</code><br><strong>用途：</strong><code>NSObject</code>提供了一个名为<code>responendsToSelector</code>的方法，该方法询问对象以确定其是否能够响应某个特定的消息。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Car *car = [[Car alloc] init];</span><br><span class="line"><span class="keyword">if</span> ([car responengsToSelector: <span class="keyword">@selector</span>(setEngine:)]) &#123;</span><br><span class="line">	<span class="built_in">NSLog</span>(<span class="string">@"yowza!"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="12-4-4-选择器的其它应用"><a href="#12-4-4-选择器的其它应用" class="headerlink" title="12.4.4    选择器的其它应用"></a>12.4.4    选择器的其它应用</h3><blockquote>
<p><strong>说明：</strong>选择器可以</p>
<ul>
<li>被传递</li>
<li>作为方法的参数</li>
<li>作为实例变量被存储</li>
</ul>
<p><strong>举个例子：</strong><code>Foundation</code>框架中的<code>NSTimer</code></p>
</blockquote>
<h2 id="12-5-小结"><a href="#12-5-小结" class="headerlink" title="12.5    小结"></a>12.5    小结</h2>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/13/o-c基础教程第二版_11 属性/" itemprop="url">
                  11 属性
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-13T10:40:03+08:00" content="2016-05-13">
              2016-05-13
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/13/o-c基础教程第二版_11 属性/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/13/o-c基础教程第二版_11 属性/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><strong>说明：</strong><code>O-C 2.0</code>引入了<code>属性（property）</code>，即<code>@property</code>预编译指令，它组合了新的预编译指令和新的属性访问器语法。<br><strong>用途：</strong>除非自己定义了相关代码，否则<code>@property</code>会根据<code>特性</code>自动生成属性及其<code>setter</code>和<code>getter</code>的声明和实现。<br><strong>兼容性：</strong><code>10.5+</code><br><strong>语法：</strong><code>@property[(特性)] 实例变量类型 实例变量名;</code><br><strong>注意：</strong>还有一个编译指令<code>@synthesize</code>，用来配合<code>@property</code>生成<code>getter</code>和<code>setter</code>的实现，可以省略（<code>XCode 4.4</code>之后）。</p>
</blockquote>
<h2 id="11-1-使用属性值"><a href="#11-1-使用属性值" class="headerlink" title="11.1    使用属性值"></a>11.1    使用属性值</h2><p><em>AllWeatherRadial.h</em></p>
<blockquote>
<p><strong>说明：</strong>对需要设置<code>setter</code>和<code>getter</code>的实例变量使用<code>@property</code>。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"Tire.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AllWeatherRadial</span> : <span class="title">Tire</span></span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 轮胎再潮湿的道路上的性能</span></span><br><span class="line">    <span class="keyword">float</span> rainHandling;</span><br><span class="line">    <span class="keyword">float</span> snowHandling;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 对需要设置setter和getter的实例变量使用@property(不在需要为每个属性分别声明setter和getter)</span></span><br><span class="line"><span class="keyword">@property</span> <span class="keyword">float</span> rainHandling;</span><br><span class="line"><span class="keyword">@property</span> <span class="keyword">float</span> snowHandling;</span><br><span class="line"><span class="keyword">@end</span><span class="comment">// AllWeatherRadial</span></span><br></pre></td></tr></table></figure>
<p><em>AllWeatherRadial.m</em></p>
<blockquote>
<p><strong>说明：</strong>不需要实现被设置了<code>@propery</code>的实例属性的<code>getter</code>和<code>setter</code>。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"AllWeatherRadial.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">AllWeatherRadial</span></span></span><br><span class="line">- (<span class="keyword">id</span>) initWithPressure: (<span class="keyword">float</span>) p treadDepth: (<span class="keyword">float</span>) td &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> initWithPressure: p treadDepth:td]) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * @override</span><br><span class="line"> */</span></span><br><span class="line">- (<span class="built_in">NSString</span> *) description &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *desc;</span><br><span class="line">    desc = [[<span class="built_in">NSString</span> alloc] initWithFormat:<span class="string">@"AllWeatherRadial: %.1f / %.1f / %.1f / %.1f"</span>, [<span class="keyword">self</span> pressure], [<span class="keyword">self</span> treadDepth], [<span class="keyword">self</span> rainHandling], [<span class="keyword">self</span> snowHandling]];</span><br><span class="line">    <span class="keyword">return</span> (desc);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p><em>main.m</em></p>
<blockquote>
<p><strong>说明：</strong>调用相应的属性的<code>setter</code>和<code>getter</code>。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"AllWeatherRadial.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"Car.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"Slant6.h"</span></span></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="comment">// 车身</span></span><br><span class="line">        Car *car = [[Car alloc] init];</span><br><span class="line">        <span class="comment">// 安装轮胎</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">            AllWeatherRadial *tire;</span><br><span class="line">            tire = [[AllWeatherRadial alloc] init];</span><br><span class="line">            <span class="comment">// 调用通过@property指令获得的setter和getter</span></span><br><span class="line">            [tire setRainHandling:<span class="number">23</span> + i];</span><br><span class="line">            [tire setSnowHandling:<span class="number">33</span> - i];</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"tire %d's handling is %.f %.f"</span>, i, [tire rainHandling], [tire snowHandling]);</span><br><span class="line">            [car setTire:tire atIndex:i];</span><br><span class="line">            [tire release];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 安装引擎</span></span><br><span class="line">        Engine *engine = [[Slant6 alloc] init];</span><br><span class="line">        [car setEngine:engine];</span><br><span class="line">        <span class="comment">// 使用Car</span></span><br><span class="line">        [car print];</span><br><span class="line">        [car release];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="11-1-1-简化接口代码"><a href="#11-1-1-简化接口代码" class="headerlink" title="11.1.1    简化接口代码"></a>11.1.1    简化接口代码</h3><h3 id="11-1-2-简化实现代码"><a href="#11-1-2-简化实现代码" class="headerlink" title="11.1.2    简化实现代码"></a>11.1.2    简化实现代码</h3><h3 id="11-1-3-点表达式的妙用"><a href="#11-1-3-点表达式的妙用" class="headerlink" title="11.1.3    点表达式的妙用"></a>11.1.3    点表达式的妙用</h3><blockquote>
<p><strong>说明：</strong><code>O-C 2.0</code>引入的新的语法特性，可以更加容易地访问对象的属性。<br><strong>限制：</strong>只能用于对象属性的<code>setter</code>或<code>getter</code>。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// getter</span></span><br><span class="line">tire.rainHandling = <span class="number">20</span> + i;</span><br><span class="line">tire.snowHandling = <span class="number">28</span> + i;</span><br><span class="line"></span><br><span class="line"><span class="comment">// setter</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"tire %d's handling is %.f %.f"</span>, i, tire.rainHandling, tire.snowHandling);</span><br></pre></td></tr></table></figure>
<h2 id="11-2-属性扩展"><a href="#11-2-属性扩展" class="headerlink" title="11.2    属性扩展"></a>11.2    属性扩展</h2><blockquote>
<p><strong>说明：</strong><code>@property</code>对如何生成代码还有一些<code>特性</code>可以指定，这些<code>特性</code>将影响<code>setter</code>代码的生成。</p>
</blockquote>
<table>
<thead>
<tr>
<th><code>@property</code>特性</th>
<th>说明</th>
<th>适用</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>assign</td>
<td>简单赋值，不更改<code>引用计数</code></td>
<td>基础数据类型和C数据类型</td>
<td>默认</td>
</tr>
<tr>
<td>copy</td>
<td>通过就对象复制出一个新对象（引用计数为1），并<code>释放</code>旧对象</td>
<td>不可变对象（例如NSString）</td>
<td></td>
</tr>
<tr>
<td>retain</td>
<td><code>释放</code>旧对象，将旧对象的值赋予输入对象，再<code>保留</code>输入对象</td>
<td>其它<code>O-C</code>对象</td>
<td></td>
</tr>
<tr>
<td>nonatomic</td>
<td>非线程安全</td>
<td>所有类型</td>
<td>默认，性能更好</td>
</tr>
<tr>
<td>atomic</td>
<td>某种程度的线程安全</td>
<td>所有类型</td>
<td>在多线程的环境保证<code>get</code>和<code>set</code>正确执行，但前提是是使用<code>@synthesize</code>生成的实现</td>
</tr>
<tr>
<td>readwrite</td>
<td>可读写</td>
<td>所有类型</td>
<td>默认</td>
</tr>
<tr>
<td>readonly</td>
<td>只读</td>
<td>所有类型</td>
<td>只生成<code>getter</code></td>
</tr>
<tr>
<td>getter=getter名称</td>
<td>指定生成的<code>getter</code>方法名</td>
<td>所有类型</td>
<td>默认为<code>属性名</code></td>
</tr>
<tr>
<td>setter=setter名称</td>
<td>指定生成的<code>setter</code>方法名</td>
<td>所有类型</td>
<td><code>set属性名</code>，匈牙利命名法</td>
</tr>
</tbody>
</table>
<h4 id="使用-property"><a href="#使用-property" class="headerlink" title="使用@property"></a>使用<code>@property</code></h4><blockquote>
<p><strong>说明：</strong><code>name</code>属性为<code>@property(copy)</code>，<code>engine</code>属性为<code>@property(retain)</code></p>
</blockquote>
<p><em>Car.h</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Cocoa/Cocoa.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@class</span> <span class="title">Tire</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">@class</span> <span class="title">Engine</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Car</span> : <span class="title">NSObject</span></span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSString</span> *name;</span><br><span class="line">    Engine *engine;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="built_in">NSString</span> *) name;</span><br><span class="line">- (<span class="keyword">void</span>) setName: (<span class="built_in">NSString</span> *) newName;</span><br><span class="line">- (Engine *) engine;</span><br><span class="line">- (<span class="keyword">void</span>) setEngine: (Engine *) newEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (retain) Engine *engine;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">@end</span> <span class="comment">// Car</span></span><br></pre></td></tr></table></figure>
<p><em>Car.m</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"Car.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"Engine.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"Tire.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Car</span></span></span><br><span class="line">- (<span class="built_in">NSString</span> *) name &#123;</span><br><span class="line">	<span class="keyword">return</span> (name);</span><br><span class="line">&#125;<span class="comment">// name</span></span><br><span class="line">- (<span class="keyword">void</span>) setName: (<span class="built_in">NSString</span> *) newName &#123;</span><br><span class="line">	[name release];</span><br><span class="line">	name = [newName <span class="keyword">copy</span>];</span><br><span class="line">&#125;<span class="comment">// setName</span></span><br><span class="line"></span><br><span class="line">- (Engine *) engine &#123;</span><br><span class="line">    <span class="keyword">return</span> (engine);</span><br><span class="line">&#125; <span class="comment">// engine</span></span><br><span class="line">- (<span class="keyword">void</span>) setEngine: (Engine *) newEngine &#123;</span><br><span class="line">    [newEngine retain];</span><br><span class="line">    [engine release];</span><br><span class="line">    engine = newEngine;</span><br><span class="line">&#125; <span class="comment">// setEngine</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="keyword">@end</span> <span class="comment">// Car</span></span><br></pre></td></tr></table></figure>
<h4 id="不使用-property"><a href="#不使用-property" class="headerlink" title="不使用@property"></a>不使用<code>@property</code></h4><p><em>Car.h</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Cocoa/Cocoa.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@class</span> <span class="title">Tire</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">@class</span> <span class="title">Engine</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Car</span> : <span class="title">NSObject</span></span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSString</span> *name;</span><br><span class="line">    Engine *engine;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 使用copy特性</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">copy</span>) <span class="built_in">NSString</span> name;</span><br><span class="line"><span class="comment">// 使用retain特性</span></span><br><span class="line"><span class="keyword">@property</span>(retain) Engine *engine;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">@end</span> <span class="comment">// Car</span></span><br></pre></td></tr></table></figure>
<p><em>Car.m</em></p>
<blockquote>
<p><strong>说明：</strong><code>@synthesize</code>用来生成成员变量的<code>setter</code>和<code>getter</code>的实现。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"Car.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"Engine.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"Tire.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Car</span></span></span><br><span class="line"><span class="comment">// xcode4.4 之后@synthesize就不再需要了</span></span><br><span class="line"><span class="keyword">@synthesize</span> name;</span><br><span class="line"><span class="keyword">@synthesize</span> engine;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">@end</span><span class="comment">// Car</span></span><br></pre></td></tr></table></figure>
<h3 id="11-2-1-名称的使用"><a href="#11-2-1-名称的使用" class="headerlink" title="11.2.1    名称的使用"></a>11.2.1    名称的使用</h3><p><em>Car.h</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Cocoa/Cocoa.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@class</span> <span class="title">Tire</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">@class</span> <span class="title">Engine</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Car</span> : <span class="title">NSObject</span></span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSString</span> *appellation;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><em>Car.m</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"Car.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"Engine.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"Tire.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Car</span></span></span><br><span class="line"><span class="keyword">@synthesize</span> name = appellation;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h3 id="11-2-2-只读属性"><a href="#11-2-2-只读属性" class="headerlink" title="11.2.2    只读属性"></a>11.2.2    只读属性</h3><blockquote>
<p><strong>说明：</strong>假设某个属性，不想让任何人修改它，则可以对这个<code>@property</code>使用<code>readonly</code>特性，这时，只生成一个<code>getter</code>方法而不会生成<code>setter</code>。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Me</span>: <span class="title">NSObject</span></span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">float</span> showSize;</span><br><span class="line">	<span class="built_in">NSString</span> *licenseNumber;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) <span class="keyword">float</span> showSize;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) <span class="built_in">NSString</span> *licenseNumber;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h3 id="11-2-3-自己动手有时更好"><a href="#11-2-3-自己动手有时更好" class="headerlink" title="11.2.3    自己动手有时更好"></a>11.2.3    自己动手有时更好</h3><h4 id="计算属性"><a href="#计算属性" class="headerlink" title="计算属性"></a>计算属性</h4><blockquote>
<p><strong>说明：</strong>可以通过<code>@property</code>配合<code>@dynamic</code>指令告诉编译器不生成人和代码或实例变量，通过自定义的<code>getter</code>创建一个能在运行时计算出此值的访问方法。<br><strong>注意：</strong>如果使用了<code>@dynamic</code>指令，并企图调用不存在的<code>getter</code>或<code>setter</code>方法，你将会的到一个报错。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @property</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) <span class="keyword">float</span> bodyMassIndex;</span><br><span class="line"><span class="comment">// @dynamic</span></span><br><span class="line"><span class="keyword">@dynamic</span> bodyMassIndex;</span><br><span class="line"><span class="comment">// getter</span></span><br><span class="line">- (<span class="keyword">float</span>) bodyMassIndex &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="指定getter和setter方法名"><a href="#指定getter和setter方法名" class="headerlink" title="指定getter和setter方法名"></a>指定getter和setter方法名</h4><blockquote>
<p><strong>说明：</strong>可以通过<code>@property(getter=getter名称)</code>和<code>@property(setter=setter名称)</code>自定义<code>geter</code>和<code>setter</code>方法的名称。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// getter为isHidden，setter为setHidden（默认）</span></span><br><span class="line"><span class="keyword">@property</span> (getter=isHidden) <span class="built_in">BOOL</span> hidden;</span><br></pre></td></tr></table></figure>
<h3 id="11-2-4-特性不是万能的"><a href="#11-2-4-特性不是万能的" class="headerlink" title="11.2.4    特性不是万能的"></a>11.2.4    特性不是万能的</h3><blockquote>
<p><strong>说明：</strong><code>@property</code>只能生成严格意义上的<code>getter</code>和<code>setter</code>，不支持那些需要接收额外参数的方法。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// setter有额外的参数</span></span><br><span class="line">- (<span class="keyword">void</span>) setTire: (Tire *) tire atIndex: (<span class="keyword">int</span>) index;</span><br><span class="line"><span class="comment">// getter有额外的参数</span></span><br><span class="line">- (Tire *) tireAtIndex: (<span class="keyword">int</span>) index;</span><br></pre></td></tr></table></figure>
<h2 id="11-3-小结"><a href="#11-3-小结" class="headerlink" title="11.3    小结"></a>11.3    小结</h2>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/13/o-c基础教程第二版_10 对象初始化/" itemprop="url">
                  10 对象初始化
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-13T10:39:41+08:00" content="2016-05-13">
              2016-05-13
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/13/o-c基础教程第二版_10 对象初始化/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/13/o-c基础教程第二版_10 对象初始化/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><strong>说明：</strong>创建对象有两种方式</p>
<ul>
<li><code>类名 new</code></li>
<li><code>[[类名 alloc] init]</code></li>
</ul>
<p><strong>技巧：</strong><code>Cocoa</code>惯例是使用后一种方式</p>
</blockquote>
<h2 id="10-1-分配对象"><a href="#10-1-分配对象" class="headerlink" title="10.1    分配对象"></a>10.1    分配对象</h2><blockquote>
<p><strong>说明：</strong>就是从操作系统获得一块内存，并将其指定为存放对象的实例变量的位置。<br><strong>语法：</strong>像某个类发送<code>alloc</code>消息</p>
</blockquote>
<h4 id="alloc实例方法"><a href="#alloc实例方法" class="headerlink" title="alloc实例方法"></a>alloc实例方法</h4><blockquote>
<p><strong>说明：</strong>为类实例分配一块足够大的内存，并将这块内存区域全部初始化为对应的<code>0</code>值</p>
</blockquote>
<table>
<thead>
<tr>
<th>实例变量类型</th>
<th><code>0</code>值</th>
</tr>
</thead>
<tbody>
<tr>
<td>BOOL</td>
<td>NO</td>
</tr>
<tr>
<td>int</td>
<td>0</td>
</tr>
<tr>
<td>float</td>
<td>0.0</td>
</tr>
<tr>
<td>指针</td>
<td>nil</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>注意：</strong>刚刚分配的对象不能立即使用，初始化后才能使用。<code>Objective-C</code>将对象的创建拆分为两个明确的步骤：<code>分配</code>和<code>初始化</code>。<br><strong>扩展：</strong>有些语言（包括<code>c++</code>和<code>java</code>）使用构造函数在一次操作中便执行完对象的分配和初始化。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 分配</span></span><br><span class="line">Car *car = [Car alloc];<span class="comment">// 还需要init，之后才能使用</span></span><br></pre></td></tr></table></figure>
<h3 id="10-1-1-初始化对象"><a href="#10-1-1-初始化对象" class="headerlink" title="10.1.1    初始化对象"></a>10.1.1    初始化对象</h3><blockquote>
<p><strong>说明：</strong>从操作系统取得一块内存（不一定是<code>分配</code>的内存）用于存储对象。<br><strong>语法：</strong>通过嵌套方式向<code>分配</code>操作的返回值发送<code>init</code>消息。<br><strong>注意：</strong><code>init</code>方法返回的对象可能与<code>分配</code>的对象不同，因为某些类型底层其实是<code>类蔟</code>。</p>
</blockquote>
<p><em>错误示例</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Car *car = [Car alloc];</span><br><span class="line"><span class="comment">// 我们需要的是init后的对象，car指向的对象未必和init返回的是一个对象</span></span><br><span class="line">[car init];</span><br></pre></td></tr></table></figure>
<p><em>正确示例</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Car *car = [[Car alloc] init];</span><br></pre></td></tr></table></figure>
<h3 id="10-1-2-编写初始化方法"><a href="#10-1-2-编写初始化方法" class="headerlink" title="10.1.2    编写初始化方法"></a>10.1.2    编写初始化方法</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">id</span>) init &#123;</span><br><span class="line">	<span class="comment">// 1. 兼容超类返回nil的情况</span></span><br><span class="line">	<span class="comment">// 2. 更新self表示的内存位置（因为超类的init可能返回另一个位置）</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">		<span class="comment">// ...	</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="10-1-3-初始化时要做些什么"><a href="#10-1-3-初始化时要做些什么" class="headerlink" title="10.1.3    初始化时要做些什么"></a>10.1.3    初始化时要做些什么</h3><blockquote>
<p><strong>说明：</strong>有两种方式可以选择，取决于灵活性和性能的权衡</p>
</blockquote>
<table>
<thead>
<tr>
<th>是否为实例变量创建对象</th>
<th>说明</th>
<th>适用</th>
</tr>
</thead>
<tbody>
<tr>
<td>是</td>
<td>方便，一步到位，出产即用</td>
<td>实例变量不需要定制</td>
</tr>
<tr>
<td>否</td>
<td>在某些情况下避免资源的浪费</td>
<td>实例变量需要定制</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>扩展：</strong><code>惰性求值</code>，指的是即是目前没有设置自定义属性的值，也等到调用着需要时再创建对象，可以提高程序的性能。</p>
</blockquote>
<h2 id="10-2-便利初始化函数"><a href="#10-2-便利初始化函数" class="headerlink" title="10.2    便利初始化函数"></a>10.2    便利初始化函数</h2><blockquote>
<p><strong>说明：</strong>相比<code>init</code>，完成某些额外的初始化工作，名称以<code>init</code>开头。<br><strong>适用：</strong>加入对象必须要用某些信息进行初始化，那么应该将这些信息作为init方法的一部分添加进来。</p>
</blockquote>
<h3 id="initWithContentsofFile便利初始化方法"><a href="#initWithContentsofFile便利初始化方法" class="headerlink" title="initWithContentsofFile便利初始化方法"></a>initWithContentsofFile便利初始化方法</h3><blockquote>
<p><strong>说明：</strong>打开指定路径上的文本文件，读取文件内容，并即用文件内容初始化为一个字符串。<br><strong>原型：</strong><code>NSString</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;/**</span><br><span class="line">&gt;* @param &#123;nonnull NSString *&#125; 非空字符串</span><br><span class="line">&gt;* @param &#123;nullable NSStringEncoding *&#125; usedEncoding 编码方式</span><br><span class="line">&gt;* @param &#123;NSError * _Nullable __autoreleasing * _Nullable&#125; error 错误对象</span><br><span class="line">&gt;* @return &#123;instancetype _Nullable&#125; 字符串对象（可以为空）</span><br><span class="line">&gt;*/</span><br><span class="line">&gt;- (instancetype _Nullable) initWithContentsOfFile:(nonnull NSString *) usedEncoding: (nullable NSStringEncoding *) error:(NSError * _Nullable __autoreleasing * _Nullable);</span><br></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 错误</span></span><br><span class="line"><span class="built_in">NSError</span> *error = <span class="literal">nil</span>;</span><br><span class="line"><span class="comment">// 编码</span></span><br><span class="line"><span class="built_in">NSStringEncoding</span> encoding = <span class="built_in">NSUTF8StringEncoding</span>;</span><br><span class="line"><span class="comment">// 读取文件</span></span><br><span class="line"><span class="built_in">NSString</span> *string = [[<span class="built_in">NSString</span> alloc] initWithContentsOfFile:<span class="string">@"/tmp/words.txt"</span> usedEncoding:&amp;encoding error:&amp;error];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取出错</span></span><br><span class="line"><span class="keyword">if</span> (<span class="literal">nil</span> != error) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Unable to read data from file, %@"</span>, [error localizedDescription]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 读取成功</span></span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, string);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="10-3-更多部件改进"><a href="#10-3-更多部件改进" class="headerlink" title="10.3    更多部件改进"></a>10.3    更多部件改进</h2><blockquote>
<p><strong>注意：</strong>如果做<code>iOS</code>开发，由于不支持垃圾回收，必须使用<code>ARC</code>技术。</p>
</blockquote>
<h3 id="10-3-1-Tire类的初始化"><a href="#10-3-1-Tire类的初始化" class="headerlink" title="10.3.1    Tire类的初始化"></a>10.3.1    Tire类的初始化</h3><p><em>Tire.h</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Tire</span> : <span class="title">NSObject</span></span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 轮胎压力</span></span><br><span class="line">    <span class="keyword">float</span> pressure;</span><br><span class="line">    <span class="comment">// 轮胎花纹</span></span><br><span class="line">    <span class="keyword">float</span> treadDepth;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>) setPressure: (<span class="keyword">float</span>) pressure;</span><br><span class="line">- (<span class="keyword">float</span>) pressure;</span><br><span class="line">- (<span class="keyword">void</span>) setTreadDepth: (<span class="keyword">float</span>) treadDepth;</span><br><span class="line">- (<span class="keyword">float</span>)treadDepth;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p><em>Tire.m</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"Tire.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Tire</span></span></span><br><span class="line"><span class="comment">// 构造器</span></span><br><span class="line">- (<span class="keyword">id</span>) init &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        pressure = <span class="number">34.0</span>;</span><br><span class="line">        treadDepth = <span class="number">20.0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">self</span>);</span><br><span class="line">&#125;<span class="comment">// init</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>) setPressure:(<span class="keyword">float</span>) p &#123;</span><br><span class="line">    pressure = p;</span><br><span class="line">&#125;<span class="comment">// setPressure</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">float</span>) pressure &#123;</span><br><span class="line">    <span class="keyword">return</span> (pressure);</span><br><span class="line">&#125;<span class="comment">// pressure</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>) setTreadDepth:(<span class="keyword">float</span>) td &#123;</span><br><span class="line">    treadDepth = td;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">float</span>) treadDepth &#123;</span><br><span class="line">    <span class="keyword">return</span> treadDepth;</span><br><span class="line">&#125;<span class="comment">// treadDepth</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * @override</span><br><span class="line"> */</span></span><br><span class="line">- (<span class="built_in">NSString</span> *) description &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *desc;</span><br><span class="line">    <span class="comment">// 不是通过alloc、copy、new创建的，按照内存管理规则，不需要做什么（可以认为它被加入到了自动释放池中）</span></span><br><span class="line">    desc = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"Tire: Pressure: %.1f TreadDepth: %1f"</span>, pressure, treadDepth];</span><br><span class="line">    <span class="keyword">return</span> (desc);</span><br><span class="line">&#125;<span class="comment">// description</span></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h3 id="10-3-2-更新main-函数"><a href="#10-3-2-更新main-函数" class="headerlink" title="10.3.2    更新main()函数"></a>10.3.2    更新main()函数</h3><p><em>既没有启用<code>ARC</code>，也没有启用<code>垃圾回收</code>的情形－手动管理</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"Tire.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"Car.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"Slant6.h"</span></span></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="comment">// 车身</span></span><br><span class="line">        Car *car = [[Car alloc] init];</span><br><span class="line">        <span class="comment">// 安装轮胎</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">            Tire *tire;</span><br><span class="line">            tire = [[Tire alloc] init];</span><br><span class="line">            [tire setPressure:<span class="number">23</span> + i];</span><br><span class="line">            [tire setTreadDepth:<span class="number">33</span> - i];</span><br><span class="line">            [car setTire:tire atIndex:i];</span><br><span class="line">            <span class="comment">// 按照内存管理规则，应当释放一次，其余交给自动释放池</span></span><br><span class="line">            [tire release];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 安装引擎</span></span><br><span class="line">        Engine *engine = [[Slant6 alloc] init];</span><br><span class="line">        [car setEngine:engine];</span><br><span class="line">        <span class="comment">// 使用Car</span></span><br><span class="line">        [car print];</span><br><span class="line">        <span class="comment">// 按照内存管理规则，应当释放一次，其余交给自动释放池</span></span><br><span class="line">        [car release];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>启用了<code>ARC</code>或<code>垃圾回收</code></em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"Tire.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"Car.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"Slant6.h"</span></span></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="comment">// 车身</span></span><br><span class="line">    Car *car = [[Car alloc] init];</span><br><span class="line">    <span class="comment">// 安装轮胎</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">        Tire *tire;</span><br><span class="line">        tire = [[Tire alloc] init];</span><br><span class="line">        [tire setPressure:<span class="number">23</span> + i];</span><br><span class="line">        [tire setTreadDepth:<span class="number">33</span> - i];</span><br><span class="line">        [car setTire:tire atIndex:i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 安装引擎</span></span><br><span class="line">    Engine *engine = [[Slant6 alloc] init];</span><br><span class="line">    [car setEngine:engine];</span><br><span class="line">    <span class="comment">// 使用Car</span></span><br><span class="line">    [car print];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="10-3-3-清理Car类"><a href="#10-3-3-清理Car类" class="headerlink" title="10.3.3    清理Car类"></a>10.3.3    清理Car类</h3><p><em>Car.h</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Cocoa/Cocoa.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@class</span> <span class="title">Tire</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">@class</span> <span class="title">Engine</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Car</span> : <span class="title">NSObject</span></span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 使用可变数组代替C数组（Tire *tires[4]），就不用上限检查了</span></span><br><span class="line">    <span class="built_in">NSMutableArray</span> *tires;</span><br><span class="line">    Engine *engine;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>) setEngine: (Engine *) newEngine;</span><br><span class="line">- (Engine *) engine;</span><br><span class="line">- (<span class="keyword">void</span>) setTire: (Tire *) tire atIndex: (<span class="keyword">int</span>) index;</span><br><span class="line">- (Tire *) tireAtIndex: (<span class="keyword">int</span>) index;</span><br><span class="line">- (<span class="keyword">void</span>) print;</span><br><span class="line"><span class="keyword">@end</span> <span class="comment">// Car</span></span><br></pre></td></tr></table></figure>
<p><em>Car.m</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"Car.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"Engine.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"Tire.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Car</span></span></span><br><span class="line">- (<span class="keyword">id</span>) init</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        engine = [Engine new];</span><br><span class="line">        tires = [[<span class="built_in">NSMutableArray</span> alloc] init];</span><br><span class="line">        <span class="comment">// 将每个轮胎初始化为null</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">            [tires addObject: [<span class="built_in">NSNull</span> null]];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">self</span>);</span><br><span class="line">&#125; <span class="comment">// init</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (Engine *) engine</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> (engine);</span><br><span class="line">&#125; <span class="comment">// engine</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>) setEngine: (Engine *) newEngine &#123;</span><br><span class="line">    [newEngine retain];</span><br><span class="line">    [engine release];</span><br><span class="line">    engine = newEngine;</span><br><span class="line">&#125; <span class="comment">// setEngine</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>) setTire: (Tire *) tire atIndex: (<span class="keyword">int</span>) index &#123;</span><br><span class="line">    <span class="keyword">if</span> (index &lt; <span class="number">0</span> || index &gt; <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span> (<span class="string">@"bad index (%d) in setTire:atIndex:"</span>,</span><br><span class="line">               index);</span><br><span class="line">        exit (<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    [tires replaceObjectAtIndex:index withObject:tire];</span><br><span class="line">    </span><br><span class="line">&#125; <span class="comment">// setTire:atIndex:</span></span><br><span class="line"></span><br><span class="line">- (Tire *) tireAtIndex: (<span class="keyword">int</span>) index &#123;</span><br><span class="line">    <span class="keyword">if</span> (index &lt; <span class="number">0</span> || index &gt; <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span> (<span class="string">@"bad index (%d) in tireAtIndex:"</span>,</span><br><span class="line">               index);</span><br><span class="line">        exit (<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Tire *tire;</span><br><span class="line">    tire = [tires objectAtIndex:index];</span><br><span class="line">    <span class="keyword">return</span> (tire);</span><br><span class="line">    </span><br><span class="line">&#125; <span class="comment">// tireAtIndex:</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>) print &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">        <span class="comment">// 不直接访问数组，避免代码收到将来更改的影响</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [<span class="keyword">self</span> tireAtIndex: i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSLog</span> (<span class="string">@"%@"</span>, engine);</span><br><span class="line">&#125; <span class="comment">// print</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * 确保car对象呗销毁时所有的内存都被回收</span><br><span class="line"> * @override</span><br><span class="line"> */</span></span><br><span class="line">- (<span class="keyword">void</span>) dealloc &#123;</span><br><span class="line">    [tires release];</span><br><span class="line">    [engine release];</span><br><span class="line">    [<span class="keyword">super</span> dealloc];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span> <span class="comment">// Car</span></span><br></pre></td></tr></table></figure>
<h2 id="10-4-Car-类的内存清理（垃圾回收方式和ARC方式）"><a href="#10-4-Car-类的内存清理（垃圾回收方式和ARC方式）" class="headerlink" title="10.4    Car 类的内存清理（垃圾回收方式和ARC方式）"></a>10.4    Car 类的内存清理（垃圾回收方式和ARC方式）</h2><blockquote>
<p><strong>说明：</strong>启用了<code>垃圾回收</code>或<code>ARC</code>，则不用手动管理内存。</p>
<ul>
<li>不再需要手动<code>释放</code>或<code>保留</code></li>
<li>不需要重写<code>dealloc</code>方法完成内存的清理，如果要销毁时执行一些特别的操作，可以重写<code>-finalize</code>方法</li>
</ul>
<p><strong>注意：</strong>启用了<code>垃圾回收</code>则不需要<code>@autoreleasepool</code>；启用<code>ARC</code>，则代码中必要时仍然可以使用<code>@autoreleasepool</code>。</p>
</blockquote>
<h3 id="构造便利初始化函数"><a href="#构造便利初始化函数" class="headerlink" title="构造便利初始化函数"></a>构造便利初始化函数</h3><blockquote>
<p><strong>说明：</strong>构造一个能同时获取轮胎压力和花纹深度的便利初始化函数。</p>
</blockquote>
<p><em>Tire.h</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">id</span>) initWithPressure: (<span class="keyword">float</span>) pressure treadDepth: (<span class="keyword">float</span>) treadDepth;</span><br></pre></td></tr></table></figure>
<p><em>Tire.m</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">id</span>) initWithPressure: (<span class="keyword">float</span>) p treadDepth: (<span class="keyword">float</span>) td &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        pressure = p;</span><br><span class="line">        treadDepth = td;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">self</span>);</span><br><span class="line">&#125;<span class="comment">// initWithPressure: treadDepth</span></span><br></pre></td></tr></table></figure>
<p><em>main.m</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Tire *tire;</span><br><span class="line">tire = [[Tire alloc] initWithPressure: <span class="number">23</span> + i treadDepth: <span class="number">33</span> - i];</span><br></pre></td></tr></table></figure>
<h2 id="10-5-指定初始化函数"><a href="#10-5-指定初始化函数" class="headerlink" title="10.5    指定初始化函数"></a>10.5    指定初始化函数</h2><blockquote>
<p><strong>说明：</strong>先增加几个<code>便利初始化函数</code></p>
</blockquote>
<p><em>Tire.h</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">id</span>) initWithPressure: (<span class="keyword">float</span>) pressure treadDepth: (<span class="keyword">float</span>) treadDepth;</span><br><span class="line">- (<span class="keyword">id</span>) initWithTreadDepth: (<span class="keyword">float</span>) treadDepth;</span><br><span class="line">- (<span class="keyword">id</span>) initWithPressure:(<span class="keyword">float</span>)pressure;</span><br></pre></td></tr></table></figure>
<p><em>Tire.m</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">id</span>) initWithPressure: (<span class="keyword">float</span>) p treadDepth: (<span class="keyword">float</span>) td &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        pressure = p;</span><br><span class="line">        treadDepth = td;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">self</span>);</span><br><span class="line">&#125;<span class="comment">// initWithPressure: treadDepth</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>) initWithTreadDepth: (<span class="keyword">float</span>) td &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        treadDepth = td;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">self</span>);</span><br><span class="line">&#125;<span class="comment">// initWithTreadDepth</span></span><br></pre></td></tr></table></figure>
<h3 id="10-5-1-子类化问题"><a href="#10-5-1-子类化问题" class="headerlink" title="10.5.1    子类化问题"></a>10.5.1    子类化问题</h3><blockquote>
<p><strong>说明：</strong><code>指定初始化函数</code>，即该中的某个初始化方法被指派为指定初始化函数，该类的所有初始化方法都调用指定初始化函数完成初始化。<br><strong>技巧：</strong>通常，接收参数最多的初始化方法是最终的指定初始化函数。</p>
</blockquote>
<h4 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h4><blockquote>
<p><strong>说明：</strong><code>AllWeatherRadial</code>的超类<code>Tire</code>中的构造器都没有使用<code>指定初始化函数</code>，导致<code>AllWeatherRadial</code>需要重写所有<code>Tire</code>的构造器完成对自身实例变量的初始化。</p>
</blockquote>
<p><em>AllWeatherRadial.h</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"Tire.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AllWeatherRadial</span> : <span class="title">Tire</span></span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 轮胎再潮湿的道路上的性能</span></span><br><span class="line">    <span class="keyword">float</span> rainHandling;</span><br><span class="line">    <span class="keyword">float</span> snowHandling;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>) setRainHandling: (<span class="keyword">float</span>) rainHandling;</span><br><span class="line">- (<span class="keyword">float</span>) rainHandling;</span><br><span class="line">- (<span class="keyword">void</span>) setSnowHandling: (<span class="keyword">float</span>) snowHandling;</span><br><span class="line">- (<span class="keyword">float</span>) snowHandling;</span><br><span class="line"><span class="keyword">@end</span><span class="comment">// AllWeatherRadial</span></span><br></pre></td></tr></table></figure>
<p><em>AllWeatherRadial.m</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"AllWeatherRadial.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">AllWeatherRadial</span></span></span><br><span class="line">- (<span class="keyword">void</span>) setRainHandling:(<span class="keyword">float</span>) rh &#123;</span><br><span class="line">    rainHandling = rh;</span><br><span class="line">&#125;<span class="comment">// setRainHandling</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">float</span>) rainHandling &#123;</span><br><span class="line">    <span class="keyword">return</span> (rainHandling);</span><br><span class="line">&#125;<span class="comment">// rainHandling</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>) setSnowHandling: (<span class="keyword">float</span>) sh &#123;</span><br><span class="line">    snowHandling = sh;</span><br><span class="line">&#125;<span class="comment">// setSnowHandling</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">float</span>) snowHandling &#123;</span><br><span class="line">    <span class="keyword">return</span> (snowHandling);</span><br><span class="line">&#125;<span class="comment">// snowHandling</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * @override</span><br><span class="line"> */</span></span><br><span class="line">- (<span class="built_in">NSString</span> *) description &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *desc;</span><br><span class="line">    desc = [[<span class="built_in">NSString</span> alloc] initWithFormat:<span class="string">@"AllWeatherRadial: %.1f / %.1f / %.1f / %.1f"</span>, [<span class="keyword">self</span> pressure], [<span class="keyword">self</span> treadDepth], [<span class="keyword">self</span> rainHandling], [<span class="keyword">self</span> snowHandling]];</span><br><span class="line">    <span class="keyword">return</span> (desc);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h3 id="10-5-2-Tire-类的初始化函数改进后的版本"><a href="#10-5-2-Tire-类的初始化函数改进后的版本" class="headerlink" title="10.5.2    Tire 类的初始化函数改进后的版本"></a>10.5.2    Tire 类的初始化函数改进后的版本</h3><blockquote>
<p><strong>说明：</strong>要解决上述问题，首先需要将<code>Tire</code>改造为使用<code>指定初始化函数</code>的版本。</p>
</blockquote>
<p><em>Tire.m</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">id</span>) init &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">self</span> initWithPressure: <span class="number">34.0</span> treadDepth: <span class="number">20.0</span>]) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">self</span>);</span><br><span class="line">&#125;<span class="comment">// init</span></span><br><span class="line">- (<span class="keyword">id</span>)initWithPressure: (<span class="keyword">float</span>) p &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">self</span> initWithPressure: p treadDepth: <span class="number">20</span>]) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>) initWithTreadDepth: (<span class="keyword">float</span>) td &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">self</span> initWithPressure: <span class="number">34</span> treadDepth: td]) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">self</span>);</span><br><span class="line">&#125;<span class="comment">// initWithTreadDepth</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * 参数最多的作为指定初始化函数</span><br><span class="line"> */</span></span><br><span class="line">- (<span class="keyword">id</span>) initWithPressure: (<span class="keyword">float</span>) p treadDepth: (<span class="keyword">float</span>) td &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        pressure = p;</span><br><span class="line">        treadDepth = td;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">self</span>);</span><br><span class="line">&#125;<span class="comment">// initWithPressure: treadDepth</span></span><br></pre></td></tr></table></figure>
<h3 id="10-5-3-添加AllWeatherPressure类的初始化函数"><a href="#10-5-3-添加AllWeatherPressure类的初始化函数" class="headerlink" title="10.5.3    添加AllWeatherPressure类的初始化函数"></a>10.5.3    添加AllWeatherPressure类的初始化函数</h3><blockquote>
<p><strong>说明：</strong>然后，将<code>AllWeatherPressure</code>改造为使用<code>指定初始化函数</code>的版本。只需要重载父类的<code>指定初始化函数</code>，所有构造器就可以正常使用了（因为其他构造器都调用的<code>指定初始化函数</code>）。<br><em>AllWeatherPressure.m</em></p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">id</span>) initWithPressure: (<span class="keyword">float</span>) p treadDepth: (<span class="keyword">float</span>) td &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> initWithPressure: p treadDepth:td]) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="10-6-初始化函数规则"><a href="#10-6-初始化函数规则" class="headerlink" title="10.6    初始化函数规则"></a>10.6    初始化函数规则</h2><blockquote>
<p><strong>说明：</strong>不是一定要为自己的类创建初始化函数</p>
<ul>
<li>如果不需要设置任何状态，或者<code>alloc</code>方法将内存清零的默认行为相当不错，则不可以不设置<code>指定初始化函数</code>。</li>
<li>如果子类中创建类<code>指定初始化函数</code>，则一定要在这个<code>制定初始化函数</code>中调用超类的<code>指定初始化函数</code>。</li>
</ul>
</blockquote>
<h2 id="10-7-小结"><a href="#10-7-小结" class="headerlink" title="10.7    小结"></a>10.7    小结</h2>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/13/o-c基础教程第二版_09  内存管理/" itemprop="url">
                  9 内存管理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-13T10:39:18+08:00" content="2016-05-13">
              2016-05-13
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/13/o-c基础教程第二版_09  内存管理/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/13/o-c基础教程第二版_09  内存管理/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="9-1-对象生命周期"><a href="#9-1-对象生命周期" class="headerlink" title="9.1    对象生命周期"></a>9.1    对象生命周期</h2><blockquote>
<p><strong>说明：</strong>4个过程</p>
<ol>
<li>诞生：通过<code>alloc</code>或<code>new</code>方法实现</li>
<li>生存：接收消息并执行操作</li>
<li>交友：通过复合以及向方法传递参数</li>
<li>死去：被释放掉</li>
</ol>
</blockquote>
<h3 id="9-1-1-引用计数"><a href="#9-1-1-引用计数" class="headerlink" title="9.1.1    引用计数"></a>9.1.1    引用计数</h3><blockquote>
<p><strong>说明：</strong>也叫<code>保留计数</code>，每个对象都有一个与之想关联的整数，被称作它的<code>引用计数器</code>或<code>保留计数器</code>。</p>
</blockquote>
<table>
<thead>
<tr>
<th>相关操作</th>
<th>说明</th>
<th>相关方法</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>引用计数器</code>初始化</td>
<td>被设置为1</td>
<td><code>alloc</code>、<code>new</code>、<code>copy</code></td>
</tr>
<tr>
<td><code>引用计数器</code>+1</td>
<td>新增对象引用时</td>
<td><code>retain</code></td>
</tr>
<tr>
<td><code>引用计数器</code>-1</td>
<td>引用生命周期结束或引用被断开时</td>
<td><code>release</code></td>
</tr>
<tr>
<td>销毁对象</td>
<td>释放掉已经分配的全部相关资源</td>
<td><code>dealloc</code></td>
</tr>
</tbody>
</table>
<h4 id="retain实例方法"><a href="#retain实例方法" class="headerlink" title="retain实例方法"></a>retain实例方法</h4><blockquote>
<p><strong>说明：</strong>增加对象的<code>引用计数器</code>的值。<br><strong>注意：</strong><code>Objective-C</code> 会在需要的时候自动调用它。<br><strong>原型：</strong><code>id</code></p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* @return &#123;id&#125; 接收消息的对象</span><br><span class="line">*/</span></span><br><span class="line">- (<span class="keyword">id</span>) retain;</span><br></pre></td></tr></table></figure>
<h4 id="release实例方法"><a href="#release实例方法" class="headerlink" title="release实例方法"></a>release实例方法</h4><blockquote>
<p><strong>说明：</strong>减少对象的<code>引用计数器</code>的值。<br><strong>注意：</strong><code>Objective-C</code> 会在需要的时候自动调用它。<br><strong>技巧：</strong>因为<code>retain</code>方法返回一个id类型的值，可以在接收其他消息的同时进行<code>retain</code>调用，增加对象的<code>引用计数器</code>的值并执行其他操作。<br><strong>原型：</strong><code>id</code></p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">oneway</span> <span class="keyword">void</span>) release;</span><br></pre></td></tr></table></figure>
<h4 id="retainCount实例方法"><a href="#retainCount实例方法" class="headerlink" title="retainCount实例方法"></a>retainCount实例方法</h4><blockquote>
<p><strong>说明：</strong>获取对象的<code>引用计数器</code>的值。<br><strong>原型：</strong><code>id</code></p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* @return &#123;NSUInteger&#125; 引用计数器当前值</span><br><span class="line">*/</span></span><br><span class="line">- (<span class="built_in">NSUInteger</span>) retaonCount;</span><br></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">RetainTracker</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@end</span> <span class="comment">// RetainTracker</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">RetainTracker</span></span></span><br><span class="line">- (<span class="keyword">id</span>)init</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">self</span> = [<span class="keyword">super</span> init])</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">NSLog</span> (<span class="string">@"init: Retain count of %lu."</span>, [<span class="keyword">self</span> retainCount]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">self</span>);</span><br><span class="line">&#125; <span class="comment">// init</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 重写dealloc,当引用计数器的值为0时将被自动调用</span></span><br><span class="line">- (<span class="keyword">void</span>) dealloc</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span> (<span class="string">@"dealloc called. Bye Bye."</span>);</span><br><span class="line">    [<span class="keyword">super</span> dealloc];</span><br><span class="line">    </span><br><span class="line">&#125; <span class="comment">// dealloc</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span> <span class="comment">// RetainTracker</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span><br><span class="line">&#123;</span><br><span class="line">    RetainTracker *tracker = [RetainTracker new];</span><br><span class="line">    <span class="comment">// count: 1</span></span><br><span class="line">    </span><br><span class="line">    [tracker retain]; <span class="comment">// count: 2</span></span><br><span class="line">    <span class="built_in">NSLog</span> (<span class="string">@"%lu"</span>, [tracker retainCount]);</span><br><span class="line">    </span><br><span class="line">    [tracker retain]; <span class="comment">// count: 3</span></span><br><span class="line">    <span class="built_in">NSLog</span> (<span class="string">@"%lu"</span>, [tracker retainCount]);</span><br><span class="line">    </span><br><span class="line">    [tracker release]; <span class="comment">// count: 2</span></span><br><span class="line">    <span class="built_in">NSLog</span> (<span class="string">@"%lu"</span>, [tracker retainCount]);</span><br><span class="line">    </span><br><span class="line">    [tracker release]; <span class="comment">// count: 1</span></span><br><span class="line">    <span class="built_in">NSLog</span> (<span class="string">@"%lu"</span>, [tracker retainCount]);</span><br><span class="line">    </span><br><span class="line">    [tracker retain]; <span class="comment">// count 2</span></span><br><span class="line">    <span class="built_in">NSLog</span> (<span class="string">@"%lu"</span>, [tracker retainCount]);</span><br><span class="line">    </span><br><span class="line">    [tracker release]; <span class="comment">// count 1</span></span><br><span class="line">    <span class="built_in">NSLog</span> (<span class="string">@"%lu"</span>, [tracker retainCount]);</span><br><span class="line">    </span><br><span class="line">    [tracker release]; <span class="comment">// count: 0, dealloc it</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> (<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="9-1-2-对象所有权"><a href="#9-1-2-对象所有权" class="headerlink" title="9.1.2    对象所有权"></a>9.1.2    对象所有权</h3><blockquote>
<p><strong>说明：</strong>如果一个对象（或函数）内有指向其他对象的实例变量，则称该对象（或函数）拥有这些对象，并负责确保对其拥有的对象进行清理。</p>
</blockquote>
<h3 id="9-1-3-访问方法中的保留和释放"><a href="#9-1-3-访问方法中的保留和释放" class="headerlink" title="9.1.3    访问方法中的保留和释放"></a>9.1.3    访问方法中的保留和释放</h3><blockquote>
<p><strong>说明：</strong><code>setEngine</code>方法的第一个内存管理版本。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">@class</span> <span class="title">Engine</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Car</span> : <span class="title">NSObject</span></span></span><br><span class="line">&#123;</span><br><span class="line">    Engine *engine;</span><br><span class="line">&#125;</span><br><span class="line">- (Engine *) engine;</span><br><span class="line">- (<span class="keyword">void</span>) setEngine: (Engine *) newEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span> <span class="comment">// Car</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Car</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>) init</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        engine = [Engine new];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">self</span>);</span><br><span class="line">&#125; <span class="comment">// init</span></span><br><span class="line"></span><br><span class="line">- (Engine *) engine</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> (engine);</span><br><span class="line">&#125; <span class="comment">// engine</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>) setEngine: (Engine *) newEngine</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// newEngin引用计数器加1</span></span><br><span class="line">	[newEngin retain];</span><br><span class="line">	<span class="comment">// engine应用计数器减1</span></span><br><span class="line">	[engine release];</span><br><span class="line">    engine = newEngine;</span><br><span class="line">&#125; <span class="comment">// setEngine</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h3 id="9-1-4-自动释放"><a href="#9-1-4-自动释放" class="headerlink" title="9.1.4    自动释放"></a>9.1.4    自动释放</h3><blockquote>
<p><strong>说明：</strong>有些情况下，拥有对象的实体并不能负责清理拥有的对象，如下</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不能在description中释放对象，因为先释放decription字符串对象再返回它，则保留计数器的值归0，对象马上被销毁。</span></span><br><span class="line">- (<span class="built_in">NSString</span> *)description &#123;</span><br><span class="line">	<span class="built_in">NSString</span> *description;</span><br><span class="line">	description = [[<span class="built_in">NSString</span> alloc] initWithFormat: <span class="string">@"I'm %d years old"</span>, <span class="number">4</span>];</span><br><span class="line">	<span class="keyword">return</span> (description);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>解决办法：不够优雅</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将返回的字符串赋在某个变量中</span></span><br><span class="line"><span class="built_in">NSString</span> *desc = [someObject description];</span><br><span class="line"><span class="comment">// 使用这个字符串</span></span><br><span class="line"><span class="built_in">NSSLog</span>(<span class="string">@"%@"</span>, desc);</span><br><span class="line"><span class="comment">// 销毁它</span></span><br><span class="line">[desc release];</span><br></pre></td></tr></table></figure>
<h3 id="9-1-5-所有对象放入池中"><a href="#9-1-5-所有对象放入池中" class="headerlink" title="9.1.5    所有对象放入池中"></a>9.1.5    所有对象放入池中</h3><blockquote>
<p><strong>关键字：</strong><code>@autoreleasepool</code>、<code>NSAutoreleasePool</code><br><strong>说明：</strong><code>自动释放池</code>是一个用来存放对象的池子（集合），并且能够自动释放。当自动释放池被销毁时，会想该池中所有的对象发送<code>release</code>消息。</p>
</blockquote>
<h4 id="autorelease实例方法"><a href="#autorelease实例方法" class="headerlink" title="autorelease实例方法"></a>autorelease实例方法</h4><blockquote>
<p><strong>说明：</strong>当向一个对象发送<code>autorelease</code>消息时，实际上是将该对象添加到自动释放池中。<br><strong>原型：</strong><code>id</code></p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">* @return &#123;id&#125; 接收对象</span><br><span class="line">*/</span></span><br><span class="line">- (<span class="keyword">id</span>) autorelease;</span><br></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSString</span> *)description &#123;</span><br><span class="line">	<span class="built_in">NSString</span> *description;</span><br><span class="line">	description = [[<span class="built_in">NSString</span> alloc] initWithFormat: <span class="string">@"I'm %d years old"</span>, <span class="number">4</span>];</span><br><span class="line">	<span class="comment">// 通过autorelease方法将字符串加入到自动释放池</span></span><br><span class="line">	<span class="keyword">return</span> ([description autorelease]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NSLog函数的代码运行结束以后，自动释放池会被自动销毁（假设上下文存在已经创建好的自动释放池）</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [someObject description]);</span><br></pre></td></tr></table></figure>
<h3 id="9-1-6-自动释放池的创建和销毁"><a href="#9-1-6-自动释放池的创建和销毁" class="headerlink" title="9.1.6    自动释放池的创建和销毁"></a>9.1.6    自动释放池的创建和销毁</h3><blockquote>
<p><strong>说明：</strong>自动释放池应该什么时候创建？什么时候销毁？</p>
</blockquote>
<h4 id="9-1-6-1-创建"><a href="#9-1-6-1-创建" class="headerlink" title="9.1.6.1    创建"></a>9.1.6.1    创建</h4><blockquote>
<p><strong>说明：</strong>有两种方式</p>
</blockquote>
<table>
<thead>
<tr>
<th>自动释放池的创建</th>
<th>说明</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>@autorelease{}</code></td>
<td><code>{}</code>内的代码都会被放入这个新池子中</td>
<td>定义在<code>{}</code>内的变量在外部无法使用</td>
</tr>
<tr>
<td><code>NSAutoreleasePool</code>对象</td>
<td>创建和释放<code>NSAutoreleasePool</code>对象之间的代码会使用这个新的池子</td>
<td>性能不如<code>@autorelease{}</code>方式</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>扩展：</strong>可以使用<code>drain方法</code>清空自定释放池中的对象而不销毁自动释放池（Mac OS 10.4+）</p>
</blockquote>
<h4 id="9-1-6-2-销毁"><a href="#9-1-6-2-销毁" class="headerlink" title="9.1.6.2    销毁"></a>9.1.6.2    销毁</h4><blockquote>
<p><strong>说明：</strong>使用<code>AppKit</code>时，<code>Cocoa</code>定期自动地为你创建和销毁自动释放池，通常是在程序处理完当前事件（如鼠标单击或者键盘按下）以后执行这些操作。</p>
</blockquote>
<h3 id="9-1-7-自动释放池的工作流程"><a href="#9-1-7-自动释放池的工作流程" class="headerlink" title="9.1.7    自动释放池的工作流程"></a>9.1.7    自动释放池的工作流程</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">RetainTracker</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@end</span> <span class="comment">// RetainTracker</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">RetainTracker</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>) init</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init])</span><br><span class="line">    &#123;</span><br><span class="line">		<span class="built_in">NSLog</span> (<span class="string">@"init: Retain count of %lu."</span>, [<span class="keyword">self</span> retainCount]);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">self</span>);</span><br><span class="line">&#125; <span class="comment">// init</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>) dealloc</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">NSLog</span> (<span class="string">@"dealloc called. Bye Bye."</span>);</span><br><span class="line">	[<span class="keyword">super</span> dealloc];</span><br><span class="line">&#125; <span class="comment">// dealloc</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span> <span class="comment">// RetainTracker</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* 方式一：NSAutoreleasePool对象 */</span></span><br><span class="line">    <span class="built_in">NSAutoreleasePool</span> *pool = [[<span class="built_in">NSAutoreleasePool</span> alloc] init];</span><br><span class="line">	</span><br><span class="line">    RetainTracker *tracker = [RetainTracker new]; <span class="comment">// count: 1</span></span><br><span class="line">	</span><br><span class="line">    [tracker retain]; <span class="comment">// count: 2</span></span><br><span class="line">    [tracker autorelease]; <span class="comment">// count: still 2</span></span><br><span class="line">    [tracker release]; <span class="comment">// count: 1</span></span><br><span class="line">	</span><br><span class="line">    <span class="built_in">NSLog</span> (<span class="string">@"releasing pool"</span>);</span><br><span class="line">    [pool release];<span class="comment">// 销毁自动释放池</span></span><br><span class="line">    <span class="comment">// gets nuked, sends release to tracker</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* 方式二：@autorelease代码块 */</span></span><br><span class="line">    <span class="keyword">@autoreleasepool</span></span><br><span class="line">    &#123;</span><br><span class="line">        RetainTracker *tracker2 = [RetainTracker new]; <span class="comment">// count: 1</span></span><br><span class="line">        </span><br><span class="line">        [tracker2 retain]; <span class="comment">// count: 2</span></span><br><span class="line">        [tracker2 autorelease]; <span class="comment">// count: still 2</span></span><br><span class="line">        [tracker2 release]; <span class="comment">// count: 1</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSLog</span> (<span class="string">@"auto releasing pool"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> (<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="9-2-Cocoa-的内存管理规则"><a href="#9-2-Cocoa-的内存管理规则" class="headerlink" title="9.2    Cocoa 的内存管理规则"></a>9.2    Cocoa 的内存管理规则</h2><blockquote>
<p><strong>说明：</strong><code>Cocoa</code>有一些内存管理约定，它们都是一些很简单的规则，可用用于整个工具集內。</p>
<ul>
<li>如果使用<code>new</code>、<code>alloc</code>、<code>copy</code>方法创建了一个对象：当不再使用该对象时，应该向该对象发送一条<code>release</code>或<code>autorelease</code>消息</li>
<li>如果通过其他方法获得一个对象：如果对象的保留计数器的值为1，而且已经被设置为自动释放，那么你不需要执任何操作来确保对象的到清理，除非打算在一段时间内拥有该对象，则需要<code>保留</code>它并确保在操作完成时<code>释放</code>它。</li>
<li>如果<code>保留</code>了某个对象：需要（最终）<code>释放</code>或<code>自动释放</code>该对象（即保持<code>retain</code>方法和<code>release</code>方法使用次数相等）。<br><strong>技巧：</strong>以上规则可以归结为下表(两个维度：对象的来历？用完就销毁还是保留？)</li>
</ul>
</blockquote>
<table>
<thead>
<tr>
<th>对象的来历</th>
<th>用完就销毁</th>
<th>和拥有者同命</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>alloc</code>、<code>new</code>、<code>copy</code></td>
<td>不在使用时释放对象</td>
<td>在<code>dealloc方法中释放对象</code></td>
</tr>
<tr>
<td><strong>其它方法</strong></td>
<td>不需要执行任何操作</td>
<td>获得对象时<code>保留</code>，在<code>dealloc</code>方法中<code>释放</code>对象</td>
</tr>
</tbody>
</table>
<h3 id="9-2-1-临时对象"><a href="#9-2-1-临时对象" class="headerlink" title="9.2.1    临时对象"></a>9.2.1    临时对象</h3><blockquote>
<p><strong>说明：</strong>临时对象指的是，在代码中使用某个对象，但是并未打算长期拥有该对象。<br><strong>内存管理：</strong>如果是用<code>new</code>、<code>alloc</code>、<code>copy</code>方法获得这个对象，就需要安排好该对象的内存释放（通常使用<code>release</code>）。<br><em>alloc</em></p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 维度1:通过alloc创建可变数组</span></span><br><span class="line"><span class="comment">// 维度2:临时使用</span></span><br><span class="line">KSMutableArray *array;</span><br><span class="line">array = [[<span class="built_in">NSMutableArray</span> alloc] init];</span><br><span class="line"><span class="comment">// 使用array</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 不使用时销毁</span></span><br><span class="line">[array release];</span><br></pre></td></tr></table></figure>
<p><em>其它方法</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 维度1:其它方法（工厂方法arrayWithCapacity已经将该对象的引用计数器设置为1且设置了自动释放，即已经放在了自动释放池中）</span></span><br><span class="line"><span class="comment">// 维度2:临时使用</span></span><br><span class="line"><span class="built_in">NSMutableArray</span> *array;</span><br><span class="line">array = [<span class="built_in">NSMutableArray</span> arrayWithCapacity: <span class="number">17</span>];</span><br><span class="line"><span class="comment">// 使用array</span></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p><em>其它方法（全局单例）</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSColor</span> *color;</span><br><span class="line"><span class="comment">// blueColor方法返回一个全局单例对象，这个对象永远不会被销毁，也不需要手动销毁</span></span><br><span class="line">color = [<span class="built_in">NSColor</span> blueColor];</span><br></pre></td></tr></table></figure>
<h3 id="9-2-2-拥有对象"><a href="#9-2-2-拥有对象" class="headerlink" title="9.2.2    拥有对象"></a>9.2.2    拥有对象</h3><blockquote>
<p><strong>说明：</strong><code>拥有对象</code>指的是希望在多个代码中一直拥有某个对象，比如</p>
<ul>
<li>将对象放进<code>集合</code>中（<code>NSArray</code>、<code>NSDictionary</code>等）</li>
<li>作为其它对象的<code>实例变量</code>使用</li>
<li>作为<code>全局变量</code>使用（比较罕见）</li>
</ul>
<p><strong>内存管理：</strong>见<a href="">9.2-技巧</a></p>
<ul>
<li>使用<code>new</code>、<code>alloc</code>、<code>copy</code>方法获得一个对象：只需保证在拥有者的<code>dealloc</code>方法中释放它</li>
<li>其它方法获得一个对象：获得后<code>保留</code>该对象，并保证在拥有者的<code>dealloc</code>方法中释放它<br><em><code>new</code>、实例变量</em></li>
</ul>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>) doStuff &#123;</span><br><span class="line">	<span class="comment">// 通过new获得一个对象并赋值给实例变量</span></span><br><span class="line">	flonkArray = [<span class="built_in">NSMutableArray</span> new];<span class="comment">// count 1, autoreleased</span></span><br><span class="line">	[flonkArray retain];<span class="comment">// count 2, autoreleased</span></span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>) dealloc &#123;</span><br><span class="line">	<span class="comment">// 释放实例变量指向的空间</span></span><br><span class="line">	[flonkArray release];<span class="comment">// count 0</span></span><br><span class="line">	<span class="comment">// 重写了dealloc别忘记调用超类的dealloc</span></span><br><span class="line">	[<span class="keyword">super</span> dealloc];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>其它方法、实例变量</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>) doStuff &#123;</span><br><span class="line">	<span class="comment">// 通过new获得一个对象并赋值给实例变量</span></span><br><span class="line">	flonkArray = [<span class="built_in">NSMutableArray</span> arrayWithCapacity: <span class="number">17</span>];<span class="comment">// count 1</span></span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>) dealloc &#123;</span><br><span class="line">	<span class="comment">// 释放实例变量指向的空间</span></span><br><span class="line">	[flonkArray release];<span class="comment">// count 0</span></span><br><span class="line">	<span class="comment">// 重写了dealloc别忘记调用超类的dealloc</span></span><br><span class="line">	[<span class="keyword">super</span> dealloc];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="清理自动释放池"><a href="#清理自动释放池" class="headerlink" title="清理自动释放池"></a>清理自动释放池</h4><blockquote>
<p><strong>说明：</strong>自动释放池被清理的时间是完全确定的</p>
<ul>
<li>在代码中手动销毁</li>
<li>使用AppKit时是在循环结束时销毁</li>
</ul>
<p><strong>原理：</strong>自动释放池存放在栈中，新建的自动释放池被添加到栈顶，接收<code>autorelease</code>消息的对象将被放入最顶端的自动释放池。<br><strong>注意：</strong>自动释放池的分配和销毁操作代价很小，如果一个循环中会创建大量对象，可以创建在循环中常见自己的自动释放池，每创建一批就释放一批。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建自动释放池</span></span><br><span class="line"><span class="built_in">NSAutoreleasePool</span> *pool;</span><br><span class="line">pool = [[<span class="built_in">NSAutoreleasePool</span> alloc] init];</span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++) &#123;</span><br><span class="line">	<span class="comment">// 创建字符串对象</span></span><br><span class="line">	<span class="keyword">id</span> object = [someArray objectAtIndex: i];</span><br><span class="line">	<span class="built_in">NSString</span> *desc = [object description];</span><br><span class="line">	<span class="keyword">if</span> (i % <span class="number">1000</span> == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">// 每创建1000个对象清理到上一个自动释放池</span></span><br><span class="line">		[pool release];</span><br><span class="line">		<span class="comment">// 并新建一个自动释放池</span></span><br><span class="line">		pool = [[<span class="built_in">NSAutoreleasePool</span> alloc] init];</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 释放最后一个自动释放池</span></span><br><span class="line">[pool release];</span><br></pre></td></tr></table></figure>
<h3 id="9-2-3-垃圾回收"><a href="#9-2-3-垃圾回收" class="headerlink" title="9.2.3    垃圾回收"></a>9.2.3    垃圾回收</h3><blockquote>
<p><strong>说明：</strong><code>Objective-C2.0</code>引入了自动内存管理机制，也称为<code>垃圾回收</code><br><strong>触发：</strong>类似自动释放池</p>
<ul>
<li>在时间循环结束时触发</li>
<li>也可以自己触发（如果不是GUI程序）</li>
</ul>
<p><strong>开启：</strong><code>垃圾回收</code>是一个可选择的是否启动的功能（项目信息窗口-&gt;Build Settings选项卡-&gt;Require[-fobjc-gc-only]选项）<br><strong>限制：</strong>只支持<code>OS X</code>应用开发，无法在<code>iOS</code>应用程序上应用。<br><strong>扩展：</strong>苹果对<code>iOS</code>开发的一些建议</p>
<ul>
<li>不要在自己的代码中使用<code>autorelease</code>方法</li>
<li>不要使用会返回自动释放对象的一些便利方法（比如<code>NSString</code>中以<code>stringWith</code>开头的工厂方法）</li>
</ul>
</blockquote>
<h3 id="9-2-4-自动引用计数"><a href="#9-2-4-自动引用计数" class="headerlink" title="9.2.4    自动引用计数"></a>9.2.4    自动引用计数</h3><blockquote>
<p><strong>背景：</strong><code>iOS</code>不支持垃圾回收，因为移动设备比电脑更加私人化、资源更少，垃圾回收存在潜在的体验问题。但苹果提供了另外一个方案来祢补，那就是<code>自动引用计数（automatic regerence counting, ARC）</code><br><strong>说明：</strong><code>ARC</code>不是垃圾回收器，它是在编译期（而不是运行期）工作的，它在代码中插入了合适的<code>retain</code>和<code>release</code>语句。<br><strong>注意：</strong><code>ARC</code>是一个可选的功能，必需明确地启用或禁用。<br><strong>开发环境限制：</strong>以下是编写（或运行）<code>ARC</code>代码所需的条件</p>
<ul>
<li>Xcode4.2 以上的版本</li>
<li>Apple LLVM 3.0 以上版本的编译器</li>
<li><code>OS X 10.7</code>以上版本的系统</li>
</ul>
<p><strong>运行环境限制：</strong>以下是运行移动设备必需满足的条件</p>
<ul>
<li>ios 4.0以上的移动设备或<code>OS X10.6</code>以上版本的64位系统的电脑</li>
<li><code>归零弱引用</code>需要<code>iOS 5.0</code>或<code>OS X 10.7</code>以上版本的系统</li>
</ul>
<p><strong>作用对象限制：</strong><code>ARC</code>只对可保留的对象指针<code>(ROPs)</code>有效</p>
<ul>
<li>代码块指针</li>
<li><code>Objective-C</code>对象指针</li>
<li>通过<code>_attribute((NSObject))</code>类型定义的指针</li>
</ul>
<p><strong>技巧：</strong>如果想在代码中使用<code>ARC</code>，必需满足以下三个条件</p>
<ul>
<li>能够确定哪些对象需要进行内存管理</li>
<li>能够表明如何去管理对象：就是说必需能够对某个对象的引用计数器的值进行加1和减1的操作（<code>NSObject</code>的子类都可以）</li>
<li>有可行的办法传递对象的所有权（在调用者和接受者之间）</li>
</ul>
<p><strong>注意：</strong>如果使用的指针不支持<code>ARC</code>，那么你不得不亲自手动管理它们。</p>
</blockquote>
<h4 id="弱引用"><a href="#弱引用" class="headerlink" title="弱引用"></a>弱引用</h4><blockquote>
<p><strong>说明：</strong>通常变量和<code>Objective-C</code>对象之间都是<code>强引用</code>，可以通过对属性使用了<code>assign</code>特性声明为<code>弱引用</code>。<br><strong>用途：</strong>处理<code>保留循环（retain cycle）</code>带来的内存泄漏。<br><strong>限制：</strong><code>弱引用</code>指向的对象有可能被提前释放，直接使用会导致问题。<br><img src="http://o6ul1xz4z.bkt.clouddn.com/img/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-01-14%20%E4%B8%8B%E5%8D%8811.14.20.png" alt="Alt text"></p>
</blockquote>
<h4 id="归零弱引用"><a href="#归零弱引用" class="headerlink" title="归零弱引用"></a>归零弱引用</h4><blockquote>
<p><strong>说明：</strong>在指向的对象被释放之后，这种弱引用就会被设置为<code>nil</code>，然后就可以像平常的指针一样被处理了。<br><strong>语法：</strong></p>
</blockquote>
<table>
<thead>
<tr>
<th>方式</th>
<th>说明</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>_weak</code>关键字</td>
<td>声明变量时使用<code>_weak</code>修饰</td>
<td><code>_weak NSString *myString;</code></td>
</tr>
<tr>
<td><code>@property(weak)</code></td>
<td>对属性使用<code>weak</code>特性</td>
<td><code>@property(weak) NSString *myString;</code></td>
</tr>
<tr>
<td><code>_unsafe_unretained</code>关键字和<code>unsafe_unretained</code>特性</td>
<td>告诉<code>ARC</code>这个特殊的引用是弱引用</td>
<td>前提是：不支持弱引用、使用了ARC</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>兼容性：</strong><code>iOS 5+</code>和<code>OS X 10.7+</code><br><strong>属性命名限制：</strong>使用<code>ARC</code>的时候，有两种命名规则</p>
<ul>
<li>属性名称不能以<code>new</code>开头</li>
<li>属性不能只有一个<code>read-only</code>而没有内存管理特性（除非启用了<code>ARC</code>功能）</li>
</ul>
<p><strong>注意：</strong>内存管理的<code>关键字</code>和<code>特性</code>是不能一起使用的，两者相互排斥。<br><strong>扩展：</strong><code>强引用</code>也有自己的<code>_strong</code>关键字和<code>strong</code>特性</p>
</blockquote>
<h4 id="将已有的项目转换成支持ARC的"><a href="#将已有的项目转换成支持ARC的" class="headerlink" title="将已有的项目转换成支持ARC的"></a>将已有的项目转换成支持<code>ARC</code>的</h4><blockquote>
<p><strong>前提：</strong>必须确保垃圾回收机制没有启动（<code>垃圾回收</code>和<code>ARC</code>是无法一同使用的）。<br><strong>说明：</strong><code>ARC</code>默认是启动了的，如果一个项目没有是在没有启动<code>ARC</code>的情况下开发的，可以转换（通过Edit-&gt;Convert-&gt;To Objective-C ARC…）</p>
</blockquote>
<h4 id="桥接转换"><a href="#桥接转换" class="headerlink" title="桥接转换"></a>桥接转换</h4><blockquote>
<p><strong>指针分两类：</strong><code>ROP</code>和<code>non-ROP</code></p>
</blockquote>
<table>
<thead>
<tr>
<th>分类</th>
<th>说明</th>
<th>是否被<code>ARC</code>（启用了的话）管理</th>
</tr>
</thead>
<tbody>
<tr>
<td>可保留对象指针(<code>ROP</code>)</td>
<td>NSobject的所有子类</td>
<td>是</td>
</tr>
<tr>
<td>不可保留对象指针(<code>non-ROP</code>)</td>
<td>C语言集合类型</td>
<td>否</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>拥有者权限：</strong>这个概念只有在启用了<code>ARC</code>的情况下才有意义。指的是<code>ROP</code>和<code>non-ROP</code>相互转换时指针所有权情况，用来告诉<code>ARC</code>如何工作</p>
<p><strong>用途：</strong>通过<code>桥接转换</code>，可以在转换类型的同时控制<code>拥有者权限</code><br><strong>说明：</strong>有3种类型的桥接转换</p>
</blockquote>
<table>
<thead>
<tr>
<th>关键字</th>
<th>语法</th>
<th>对象的保留计数器</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>_bridge</code></td>
<td><code>non-ROP变量=(__bridge)ROP变量;</code>或<code>ROP变量=(__bridge)non-ROP变量;</code></td>
<td>不变化</td>
<td>指针的所有权仍会留在原变量</td>
</tr>
<tr>
<td><code>_bridge_restained</code></td>
<td><code>non-ROP变量=(__bridge_restained)ROP变量;</code></td>
<td>加1</td>
</tr>
<tr>
<td><code>_bridge_transfer</code></td>
<td><code>ROP变量=(__bridge_transfer)non-ROP变量;</code></td>
<td>减1</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>技巧：</strong></p>
<ul>
<li>结构体（<code>struct</code>）和集合体（<code>union</code>）不能使用<code>ROP</code>作为成员。可以通过使用<code>void *</code>和<code>桥接转换</code>来解决这个问题</li>
<li>有时需要释放不支持<code>ARC</code>的对象或执行其他清理操作，所以仍要实现<code>dealloc</code>方法，但是不能直接调用<code>[super dealloc]</code></li>
</ul>
<p><strong>注意：</strong><code>ARC</code>中的代码存在如下限制</p>
</blockquote>
<table>
<thead>
<tr>
<th>内存管理方法</th>
<th>不能调用</th>
<th>不能重写</th>
</tr>
</thead>
<tbody>
<tr>
<td>retain</td>
<td>- [x]</td>
<td>- [x]</td>
</tr>
<tr>
<td>retainCount</td>
<td>- [x]</td>
<td>- [x]</td>
</tr>
<tr>
<td>release</td>
<td>- [x]</td>
<td>- [x]</td>
</tr>
<tr>
<td>autorelease</td>
<td>- [x]</td>
<td>- [x]</td>
</tr>
<tr>
<td>dealloc</td>
<td>- [x]</td>
</tr>
</tbody>
</table>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ROP</span></span><br><span class="line"><span class="built_in">NSString</span> *theString = <span class="string">@"Learn Objective-C"</span>;</span><br><span class="line"><span class="comment">// 结构体</span></span><br><span class="line"><span class="keyword">struct</span> &#123;</span><br><span class="line">    int32_t foo;</span><br><span class="line">    <span class="keyword">char</span> *bar;</span><br><span class="line">    <span class="built_in">NSString</span> *baz;</span><br><span class="line">&#125; MyStruct;</span><br><span class="line"><span class="comment">// 转成C语言提供的类型（void *），并指定所有权</span></span><br><span class="line">MyStruct.baz = (_bridge_restained <span class="keyword">void</span> *)theString;</span><br><span class="line"><span class="comment">// non-ROP 转 ROP</span></span><br><span class="line"><span class="built_in">NSString</span> *myString = (_bridge_transfer <span class="built_in">NSString</span> *)MyStruct.baz;</span><br></pre></td></tr></table></figure>
<h2 id="9-3-异常"><a href="#9-3-异常" class="headerlink" title="9.3    异常"></a>9.3    异常</h2><blockquote>
<p><strong>说明：</strong>异常就是异常事件，比如数组溢出，如果<code>捕捉</code>并<code>处理</code>，就会痰乱程序流程。</p>
<ul>
<li>异常对象：<code>Cocoa</code>中使用<code>NSException</code>类来表示异常，可以创建<code>NSException</code>子类作为自己的异常（如果通过其它类型的对象来<code>抛出异常</code>，<code>Cocoa</code>不会处理它们）</li>
<li>抛出异常：在运行时系统中创建并处理异常的行为</li>
<li>捕捉异常：处理被<code>抛出</code>的异常的行为</li>
</ul>
<p><strong>注意：</strong></p>
<ul>
<li>如果要项目支持异常特性，要确保<code>-fobj-exceptions</code>（Enable Objecytive-C Exception）项被打开</li>
<li><code>Cocoa</code>框架处理错误的方式通常是退出程序</li>
<li>如果一个异常被抛出但没有被捕捉，程序会在异常断点处停止运行并通知有这个异常</li>
</ul>
</blockquote>
<h3 id="9-3-1-与异常有关的关键字"><a href="#9-3-1-与异常有关的关键字" class="headerlink" title="9.3.1    与异常有关的关键字"></a>9.3.1    与异常有关的关键字</h3><blockquote>
<p><strong>说明：</strong>都以<code>@</code>开头</p>
</blockquote>
<table>
<thead>
<tr>
<th>关键字</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>@try</code></td>
<td>定义可能包含异常的代码块</td>
</tr>
<tr>
<td><code>@catch</code></td>
<td>定义处理已抛出异常的代码块，接收一个参数，通常是<code>NSException</code>或其子类</td>
</tr>
<tr>
<td><code>@finally</code></td>
<td>定义无论是够有抛出异常都会执行的代码块</td>
</tr>
<tr>
<td><code>@throw</code></td>
<td>抛出异常</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>语法：</strong><code>@try-catch-finally</code></p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@try</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@catch</span> (<span class="built_in">NSException</span> *exception) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@finally</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="9-3-2-捕捉不同类型的异常"><a href="#9-3-2-捕捉不同类型的异常" class="headerlink" title="9.3.2    捕捉不同类型的异常"></a>9.3.2    捕捉不同类型的异常</h3><blockquote>
<p><strong>说明：</strong>可以根据需要处理的异常类型过使用多个<code>@catch</code>代码块。处理代码应该按照从具体到抽象的顺序排序，并在最后使用一个通用的处理代码</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@try</span> &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@catch</span> (myCustomException) &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@catch</span> (<span class="built_in">NSException</span> *exception) &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@catch</span> (<span class="keyword">id</span> value) &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@finally</span> &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>注意：</strong>C语言程序员经常会在异常处理代码中使用<code>setjmp</code>和<code>longjmp</code>语句。在<code>@try</code>中则不可以，但可以使用<code>goto</code>和<code>return</code>语句退出异常处理代码。</p>
</blockquote>
<h3 id="9-3-3-抛出异常"><a href="#9-3-3-抛出异常" class="headerlink" title="9.3.3    抛出异常"></a>9.3.3    抛出异常</h3><blockquote>
<p><strong>说明：</strong>异常的抛出分两种，<code>自动</code>和<code>手动</code>，后者有<code>2</code>中方式</p>
</blockquote>
<table>
<thead>
<tr>
<th>手动抛出异常</th>
<th>异常对象类型</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>@throw 异常对象</code></td>
<td>id</td>
</tr>
<tr>
<td>向某个异常对象发送<code>raise</code>消息</td>
<td><code>NSException</code>或其子类</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>注意：</strong>在<code>@try</code>和<code>@catch</code>中都可以抛出异常，后者会引发下一个异常处理调用（<code>@finally</code>会在<code>@throw</code>之前被调用）<br><strong>扩展：</strong><code>Objective-C</code>的异常机制与<code>C++</code>的异常机制兼容。<br><strong>性能问题：</strong><code>@try</code>建立异常不会产生消耗，但捕捉异常会消耗大量资源并影响程序运行的速度。</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSExceptionn</span> *theException = [<span class="built_in">NSException</span> exceptionWithName: _];</span><br><span class="line"><span class="keyword">@throw</span> theException;<span class="comment">// 或者[theException raise]</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@try</span> &#123;</span><br><span class="line">	<span class="built_in">NSException</span> *e = _;</span><br><span class="line">	<span class="keyword">@throw</span> e;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@catch</span> (<span class="built_in">NSException</span> *e) &#123;</span><br><span class="line">	<span class="comment">// 可以不指定异常对象（默认重复抛出）</span></span><br><span class="line">	<span class="keyword">@throw</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="9-3-4-异常也需要内存管理"><a href="#9-3-4-异常也需要内存管理" class="headerlink" title="9.3.4    异常也需要内存管理"></a>9.3.4    异常也需要内存管理</h3><blockquote>
<p><strong>说明：</strong>如果代码出现了异常，程序会被中断，原本没有内存问题的代码或许会因此出现内存泄漏。</p>
</blockquote>
<p><em>问题描述</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)mySimpleMethod &#123;</span><br><span class="line">	<span class="comment">// 创建一个字典</span></span><br><span class="line">	<span class="built_in">NSDictionary</span> *dictionary = [[<span class="built_in">NSDictionary</span> alloc] initWith_.];</span><br><span class="line">	<span class="comment">// 对字典进行操作，假设操作中出现了异常，则程序会从方法中跳出寻找异常处理代码</span></span><br><span class="line">	[<span class="keyword">self</span> processDictionary: dictionary];</span><br><span class="line">	<span class="comment">// 释放字典：由于方法已经退出来了，所以字典没有释放</span></span><br><span class="line">	[dictionary release];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>解决方式：<code>@try-@finally</code></em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)mySimpleMethod &#123;</span><br><span class="line">	<span class="comment">// 创建一个字典</span></span><br><span class="line">	<span class="built_in">NSDictionary</span> *dictionary = [[<span class="built_in">NSDictionary</span> alloc] initWith_.];</span><br><span class="line">	<span class="keyword">@try</span> &#123;</span><br><span class="line">		<span class="comment">// 对字典进行操作，假设操作中出现了异常，则程序会从方法中跳出寻找异常处理代码</span></span><br><span class="line">		[<span class="keyword">self</span> processDictionary: dictionary];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">@finally</span> &#123;</span><br><span class="line">		<span class="comment">// 释放字典：由于方法已经退出来了，所以字典没有释放</span></span><br><span class="line">		[dictionary release];</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="9-3-5-异常和自动释放池"><a href="#9-3-5-异常和自动释放池" class="headerlink" title="9.3.5    异常和自动释放池"></a>9.3.5    异常和自动释放池</h3><blockquote>
<p><strong>说明：</strong>通常，开发人员并不知道异常对象何时释放，所以异常几乎总是作为自动释放对象创建。<br><strong>注意：</strong><code>@finally</code>代码块会在<code>@catch</code>中的<code>@throw</code>语句执行之前被调用，因此如果在<code>@finally</code>将自动释放池销毁，那么就会导致<code>僵尸异常</code>。</p>
</blockquote>
<p><em>僵尸异常示例</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)myMechod &#123;</span><br><span class="line">	<span class="comment">// 自动释放池</span></span><br><span class="line">	<span class="built_in">NSAutoreleasePool</span> *pool = [[<span class="built_in">NSAutoreleasePool</span> alloc] init];</span><br><span class="line">	<span class="comment">// 字典</span></span><br><span class="line">	<span class="built_in">NSDictionary</span> *myDictionary = [[<span class="built_in">NSDictionary</span> alloc] initWithObjectsAndKey: <span class="string">@"asdfads"</span>, <span class="literal">nil</span>];</span><br><span class="line">	<span class="keyword">@try</span> &#123;</span><br><span class="line">		<span class="comment">// 操作字典</span></span><br><span class="line">		[<span class="keyword">self</span> processDictionaty: myDictionary];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">@catch</span> (<span class="built_in">NSException</span> *e) &#123;</span><br><span class="line">		<span class="comment">// pool在下面的@throw被调用之前就被释放了，释放池中的异常对象随之被销毁，导致僵尸异常</span></span><br><span class="line">		<span class="keyword">@throw</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">@finally</span> &#123;</span><br><span class="line">		<span class="comment">// 销毁自动释放池</span></span><br><span class="line">		[pool release];</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>避免僵尸异常：在<code>自动释放池</code>外<code>保留</code>异常对象</em></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)myMechod &#123;</span><br><span class="line">	<span class="keyword">id</span> savedException = <span class="literal">nil</span>;</span><br><span class="line">	<span class="comment">// 自动释放池</span></span><br><span class="line">	<span class="built_in">NSAutoreleasePool</span> *pool = [[<span class="built_in">NSAutoreleasePool</span> alloc] init];</span><br><span class="line">	<span class="comment">// 字典</span></span><br><span class="line">	<span class="built_in">NSDictionary</span> *myDictionary = [[<span class="built_in">NSDictionary</span> alloc] initWithObjectsAndKey: <span class="string">@"asdfads"</span>, <span class="literal">nil</span>];</span><br><span class="line">	<span class="keyword">@try</span> &#123;</span><br><span class="line">		<span class="comment">// 操作字典</span></span><br><span class="line">		[<span class="keyword">self</span> processDictionaty: myDictionary];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">@catch</span> (<span class="built_in">NSException</span> *e) &#123;</span><br><span class="line">		<span class="comment">// 通过retain方法，将异常对象放入当前池而不是pool中，因为savedException定义的位置在pool定义之前。</span></span><br><span class="line">		savedException = [e retain];</span><br><span class="line">		<span class="comment">// pool在下面的@throw被调用之前就被释放了</span></span><br><span class="line">		<span class="keyword">@throw</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">@finally</span> &#123;</span><br><span class="line">		<span class="comment">// 销毁自动释放池</span></span><br><span class="line">		[pool release];</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="9-4-小结"><a href="#9-4-小结" class="headerlink" title="9.4    小结"></a>9.4    小结</h2>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Sean" />
          <p class="site-author-name" itemprop="name">Sean</p>
          <p class="site-description motion-element" itemprop="description">整理了一批过去一段时间ios相关的笔记，其它的笔记也整理下？源码分享出来？再说吧...反正也只有自己会看吧...</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">94</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Sean</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"lapuda-er"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  

  

  

  

</body>
</html>
