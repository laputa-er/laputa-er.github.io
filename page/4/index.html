<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="整理了一批过去一段时间ios相关的笔记，其它的笔记也整理下？源码分享出来？再说吧...反正也只有自己会看吧...">
<meta property="og:type" content="website">
<meta property="og:title" content="Sean">
<meta property="og:url" content="http://laputa-er.github.io/page/4/index.html">
<meta property="og:site_name" content="Sean">
<meta property="og:description" content="整理了一批过去一段时间ios相关的笔记，其它的笔记也整理下？源码分享出来？再说吧...反正也只有自己会看吧...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Sean">
<meta name="twitter:description" content="整理了一批过去一段时间ios相关的笔记，其它的笔记也整理下？源码分享出来？再说吧...反正也只有自己会看吧...">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://laputa-er.github.io/page/4/"/>

  <title> Sean </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Sean</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">笔记分享</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/13/TSPL2_23 范型/" itemprop="url">
                  23 范型
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-13T20:05:48+08:00" content="2016-05-13">
              2016-05-13
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/13/TSPL2_23 范型/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/13/TSPL2_23 范型/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><strong>说明：</strong>泛型代码可以让你编写<code>适用自定义需求以及任意类型</code>的<code>灵活可重用</code>的<code>函数</code>和<code>类型</code>。<br><strong>意义：</strong>它的可以让你<code>避免重复的代码</code>，用一种清晰和抽象的方式来表达代码的意图。</p>
</blockquote>
<h2 id="23-1-泛型所解决的问题"><a href="#23-1-泛型所解决的问题" class="headerlink" title="23.1    泛型所解决的问题"></a>23.1    泛型所解决的问题</h2><blockquote>
<p><strong>说明：</strong>有了泛型，就不必为各种不同类型重复创建类似的<code>函数</code>或<code>类型</code>。</p>
</blockquote>
<h2 id="23-2-泛型函数"><a href="#23-2-泛型函数" class="headerlink" title="23.2    泛型函数"></a>23.2    泛型函数</h2><blockquote>
<p><strong>说明：</strong><code>泛型函数</code>可以适用于<code>任何类型</code><br><strong>语法：</strong><code>func 函数名&lt;T&gt;(){...}</code></p>
<ul>
<li>函数名后面跟着<code>&lt;占位类型名&gt;</code>（比如字母 <code>T</code>）来代替实际类型名</li>
<li>函数被调用时，<code>T</code> 所代表的类型都会<code>由传入的值的类型推断出来</code></li>
</ul>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***************** 不使用泛型的方法 ****************/</span></span><br><span class="line"><span class="comment">/**</span><br><span class="line">* 交换两个值</span><br><span class="line">* @param &#123;String&#125; inout a 第一个值</span><br><span class="line">* @param &#123;String&#125; inout b 第二个值</span><br><span class="line">*/</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">swapTwStrings</span><span class="params">(<span class="keyword">inout</span> a: String, <span class="keyword">inout</span> <span class="number">_</span> b: String)</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> temporaryA = a</span><br><span class="line">    a = b</span><br><span class="line">    b = temporaryA</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * 交换两个值</span><br><span class="line"> * @param &#123;Double&#125; inout a 第一个值</span><br><span class="line"> * @param &#123;Double&#125; inout b 第二个值</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">swapTwoDoubles</span><span class="params">(<span class="keyword">inout</span> a: Double, <span class="keyword">inout</span> <span class="number">_</span> b: Double)</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> temporaryA = a</span><br><span class="line">    a = b</span><br><span class="line">    b = temporaryA</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/****************** 使用泛型的方法 ******************/</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">swapTwoValues</span>&lt;T&gt;<span class="params">(<span class="keyword">inout</span> a: T, <span class="keyword">inout</span> <span class="number">_</span> b: T)</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> temporaryA = a</span><br><span class="line">    a = b</span><br><span class="line">    b = temporaryA</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用泛型（自动推断 T 占位符的类型）</span></span><br><span class="line"><span class="keyword">var</span> someInt = <span class="number">3</span></span><br><span class="line"><span class="keyword">var</span> anotherInt = <span class="number">107</span></span><br><span class="line">swapTwoValues(&amp;someInt, &amp;anotherInt)</span><br></pre></td></tr></table></figure>
<h2 id="23-3-类型参数"><a href="#23-3-类型参数" class="headerlink" title="23.3    类型参数"></a>23.3    类型参数</h2><blockquote>
<p><strong>说明：</strong>类型参数指定并命名一个<code>占位类型</code>，并且紧随在函数名后面，使用一对尖括号括起来（例如 <code>&lt;T&gt;</code>）。<code>类型参数</code>会在函数调用时被实际类型所替换。在<code>泛型函数体</code>中可以用来</p>
<ul>
<li>定义一个函数的<code>参数类型</code></li>
<li>作为函数的<code>返回类型</code></li>
<li>用作函数主体中的<code>注释类型</code></li>
</ul>
</blockquote>
<h2 id="23-4-命名类型参数"><a href="#23-4-命名类型参数" class="headerlink" title="23.4    命名类型参数"></a>23.4    命名类型参数</h2><blockquote>
<p><strong>说明：</strong>下面是一些指导性的意见。</p>
<ul>
<li>在大多数情况下，类型参数具有一个<code>描述性名字</code></li>
<li>当它们之间的关系没有意义时，通常使用<code>单一的字母</code>来命名</li>
</ul>
<p><strong>注意：</strong>始终使用<code>大写字母开头的驼峰式命名法</code>来为类型参数命名，以表明它们是占位类型，而不是一个值。</p>
</blockquote>
<h2 id="23-5-泛型类型"><a href="#23-5-泛型类型" class="headerlink" title="23.5    泛型类型"></a>23.5    泛型类型</h2><blockquote>
<p><strong>说明：</strong>除了泛型函数，<code>Swift</code> 还允许你定义泛型类型。这些自定义<code>类</code>、<code>结构体</code>和<code>枚举</code>可以适用于<code>任何类型</code>。</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/****************** 不使用泛型的结构体 ******************/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">IntStack</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> items = [<span class="type">Int</span>]()</span><br><span class="line">    <span class="comment">// 入栈：变异方法,需要修改自身的属性</span></span><br><span class="line">    <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">push</span><span class="params">(item: Int)</span></span> &#123;</span><br><span class="line">        items.append(item)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 出栈：变异方法，需要修改自身的属性</span></span><br><span class="line">    <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">pop</span><span class="params">()</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> items.removeLast()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/****************** 使用泛型的机构体 ******************/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Stack</span>&lt;<span class="title">Element</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> items = [<span class="type">Element</span>]()</span><br><span class="line">    <span class="comment">// 入栈：变异方法,需要修改自身的属性</span></span><br><span class="line">    <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">push</span><span class="params">(item: Element)</span></span> &#123;</span><br><span class="line">        items.append(item)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 出栈：变异方法，需要修改自身的属性</span></span><br><span class="line">    <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">pop</span><span class="params">()</span></span> -&gt; <span class="type">Element</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> items.removeLast()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 字符串栈实例</span></span><br><span class="line"><span class="keyword">var</span> stackOfStrings = <span class="type">Stack</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 入栈</span></span><br><span class="line">stackOfStrings.push(<span class="string">"uno"</span>)</span><br><span class="line">stackOfStrings.push(<span class="string">"dos"</span>)</span><br><span class="line">stackOfStrings.push(<span class="string">"tres"</span>)</span><br><span class="line">stackOfStrings.push(<span class="string">"cuatro"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 出栈</span></span><br><span class="line"><span class="keyword">let</span> fromTheTop = stackOfStrings.pop()</span><br></pre></td></tr></table></figure>
<h2 id="23-6-扩展一个泛型类型"><a href="#23-6-扩展一个泛型类型" class="headerlink" title="23.6    扩展一个泛型类型"></a>23.6    扩展一个泛型类型</h2><blockquote>
<p><strong>说明：</strong>扩展泛型类型和扩展普通类型类似，特别的地方在于</p>
<ul>
<li><code>不需要</code>在扩展的定义中提供<code>类型参数列表</code></li>
<li>原始类型定义中声明的类型参数列表在扩展中可以直接使用</li>
<li>这些来自原始类型中的参数名称会被用作<code>原始定义中类型参数的引用</code></li>
</ul>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 泛型结构体：栈</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Stack</span>&lt;<span class="title">Element</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> items = [<span class="type">Element</span>]()</span><br><span class="line">    <span class="comment">// 入栈：变异方法,需要修改自身的属性</span></span><br><span class="line">    <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">push</span><span class="params">(item: Element)</span></span> &#123;</span><br><span class="line">        items.append(item)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 出栈：变异方法，需要修改自身的属性</span></span><br><span class="line">    <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">pop</span><span class="params">()</span></span> -&gt; <span class="type">Element</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> items.removeLast()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 扩展泛型类型(原始类型定义中声明的类型参数列表在扩展中可以直接使用)</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Stack</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> topItem: <span class="type">Element</span>? &#123;</span><br><span class="line">        <span class="keyword">return</span> items.isEmpty ? <span class="literal">nil</span> : items[items.<span class="built_in">count</span> - <span class="number">1</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 字符串栈实例</span></span><br><span class="line"><span class="keyword">var</span> stackOfStrings = <span class="type">Stack</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 入栈</span></span><br><span class="line">stackOfStrings.push(<span class="string">"uno"</span>)</span><br><span class="line">stackOfStrings.push(<span class="string">"dos"</span>)</span><br><span class="line">stackOfStrings.push(<span class="string">"tres"</span>)</span><br><span class="line">stackOfStrings.push(<span class="string">"cuatro"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 出栈</span></span><br><span class="line"><span class="keyword">let</span> fromTheTop = stackOfStrings.pop()</span><br></pre></td></tr></table></figure>
<h2 id="23-6-类型约束"><a href="#23-6-类型约束" class="headerlink" title="23.6    类型约束"></a>23.6    类型约束</h2><blockquote>
<p><strong>说明：</strong>类型约束可以指定一个<code>类型参数</code>必须继承自指定类，或者符合一个特定的协议或协议组合。</p>
</blockquote>
<h3 id="23-6-1-类型约束语法"><a href="#23-6-1-类型约束语法" class="headerlink" title="23.6.1    类型约束语法"></a>23.6.1    类型约束语法</h3><blockquote>
<p><strong>说明：</strong>在一个<code>类型参数名</code>后面放置一个<code>类名</code>或者<code>协议名</code>，通过<code>:</code>分隔，从而定义类型约束，它们将作为类型参数列表的一部分。<br><strong>语法：</strong>以<code>泛型函数</code>为例（<code>泛型类型</code>与此类似）</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">someFunction</span>&lt;T: SomeClass, U: SomeProtocol&gt;<span class="params">(someT: T, someU: U)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 这里是泛型函数的函数体部分</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="23-6-2-类型约束实践"><a href="#23-6-2-类型约束实践" class="headerlink" title="23.6.2    类型约束实践"></a>23.6.2    类型约束实践</h3><blockquote>
<p><strong>注意：</strong>不是所有的 <code>Swift</code> 类型都可以用等式符<code>==</code>进行比较。Swift 标准库中定义了一个 <code>Equatable</code> 协议，该协议要求任何符合该协议的类型必须实现等式符<code>==</code>。<br><strong>扩展：</strong>所有的 <code>Swift 标准类型</code>自动支持 <code>Equatable</code> 协议</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/************  非泛型   ************/</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">findStringIndex</span><span class="params">(array: [String], <span class="number">_</span> valueToFind: String)</span></span> -&gt; <span class="type">Int</span>? &#123;</span><br><span class="line">    <span class="keyword">for</span> (index, value) <span class="keyword">in</span> array.<span class="built_in">enumerate</span>() &#123;</span><br><span class="line">        <span class="keyword">if</span> value == valueToFind &#123;</span><br><span class="line">            <span class="keyword">return</span> index</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 数组</span></span><br><span class="line"><span class="keyword">let</span> strings = [<span class="string">"cat"</span>, <span class="string">"dog"</span>, <span class="string">"llama"</span>, <span class="string">"parakeet"</span>, <span class="string">"terrapin"</span>]</span><br><span class="line"><span class="comment">// 调用函数</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> foundIndex = findStringIndex(strings, <span class="string">"llama"</span>) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"The index of llama is \(foundIndex)"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**********  泛型（带有约束）  *********/</span></span><br><span class="line"><span class="comment">/**</span><br><span class="line">* 获得相应值在数组中的位置</span><br><span class="line">* @desc 为了保证证支持等式操作符，T 必需实现 Equatable 协议</span><br><span class="line">* @param &#123;[T]&#125; 目标数组</span><br><span class="line">* @param &#123;T&#125; 目标值</span><br><span class="line">* @reutrn &#123;Int?&#125; 下标</span><br><span class="line">*/</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">findIndex</span>&lt;T: Equatable&gt;<span class="params">(array: [T], <span class="number">_</span> valueToFind: T)</span></span> -&gt; <span class="type">Int</span>? &#123;</span><br><span class="line">    <span class="keyword">for</span> (index, value) <span class="keyword">in</span> array.<span class="built_in">enumerate</span>() &#123;</span><br><span class="line">        <span class="keyword">if</span> value == valueToFind &#123;</span><br><span class="line">            <span class="keyword">return</span> index</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="23-7-关联类型"><a href="#23-7-关联类型" class="headerlink" title="23.7    关联类型"></a>23.7    关联类型</h2><blockquote>
<p><strong>用途：</strong><code>定义一个协议时</code>，有的时候声明<code>一个或多个</code>关联类型作为协议定义的一部分将会，作为一种用来<code>占位</code>的类型，实现协议是会推断出<code>实际类型</code>。<br><strong>说明：</strong>关联类型作为协议的一部分，为某个类型提供了一个<code>占位名</code>（或者说别名），其代表的<code>实际类型在协议被采纳时才会被指定</code>。<br><strong>语法：</strong>你可以通过 <code>typealias</code> 关键字来指定关联类型。</p>
</blockquote>
<h3 id="23-7-1-关联类型实践"><a href="#23-7-1-关联类型实践" class="headerlink" title="23.7.1    关联类型实践"></a>23.7.1    关联类型实践</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 协议</span></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Container</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 定义关联类型</span></span><br><span class="line">    <span class="keyword">typealias</span> <span class="type">ItemType</span></span><br><span class="line">    <span class="comment">// 必须可以通过 append(_:) 方法添加一个新元素到容器里</span></span><br><span class="line">    <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">append</span><span class="params">(item: ItemType)</span></span></span><br><span class="line">    <span class="comment">// 必须可以通过 count 属性获取容器中元素的数量，并返回一个 Int 值</span></span><br><span class="line">    <span class="keyword">var</span> <span class="built_in">count</span>: <span class="type">Int</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">    <span class="comment">// 必须可以通过接受 Int 索引值的下标检索到每一个元素。</span></span><br><span class="line">    <span class="keyword">subscript</span>(i: <span class="type">Int</span>) -&gt; <span class="type">ItemType</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现协议（非泛型）</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">IntStack</span>: <span class="title">Container</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 自身部分</span></span><br><span class="line">    <span class="keyword">var</span> items = [<span class="type">Int</span>]()</span><br><span class="line">    <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">push</span><span class="params">(item: Int)</span></span> &#123;</span><br><span class="line">        items.append(item)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">pop</span><span class="params">()</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> items.removeLast()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Container 协议的实现部分</span></span><br><span class="line">    <span class="keyword">typealias</span> <span class="type">ItemType</span> = <span class="type">Int</span><span class="comment">// 可以省略（因为类型推断）</span></span><br><span class="line">    <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">append</span><span class="params">(item: Int)</span></span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.push(item)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> <span class="built_in">count</span>: <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> items.<span class="built_in">count</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">subscript</span>(i: <span class="type">Int</span>) -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> items[i]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现协议（泛型）</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Stack</span>&lt;<span class="title">Element</span>&gt;: <span class="title">Container</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Stack&lt;Element&gt; 的原始实现部分</span></span><br><span class="line">    <span class="keyword">var</span> items = [<span class="type">Element</span>]()</span><br><span class="line">    <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">push</span><span class="params">(item: Element)</span></span> &#123;</span><br><span class="line">        items.append(item)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">pop</span><span class="params">()</span></span> -&gt; <span class="type">Element</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> items.removeLast()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Container 协议的实现部分</span></span><br><span class="line">    <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">append</span><span class="params">(item: Element)</span></span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.push(item)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> <span class="built_in">count</span>: <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> items.<span class="built_in">count</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">subscript</span>(i: <span class="type">Int</span>) -&gt; <span class="type">Element</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> items[i]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="23-7-2-通过扩展一个存在的类型来指定关联类型"><a href="#23-7-2-通过扩展一个存在的类型来指定关联类型" class="headerlink" title="23.7.2    通过扩展一个存在的类型来指定关联类型"></a>23.7.2    通过扩展一个存在的类型来指定关联类型</h3><blockquote>
<p><strong>说明：</strong>扩展让一个已存在的类型符合一个协议，其中就包括使用了关联类型的协议。</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 协议：容器</span></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Container</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 定义关联类型</span></span><br><span class="line">    <span class="keyword">typealias</span> <span class="type">ItemType</span></span><br><span class="line">    <span class="comment">// 必须可以通过 append(_:) 方法添加一个新元素到容器里</span></span><br><span class="line">    <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">append</span><span class="params">(item: ItemType)</span></span></span><br><span class="line">    <span class="comment">// 必须可以通过 count 属性获取容器中元素的数量，并返回一个 Int 值</span></span><br><span class="line">    <span class="keyword">var</span> <span class="built_in">count</span>: <span class="type">Int</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">    <span class="comment">// 必须可以通过接受 Int 索引值的下标检索到每一个元素。</span></span><br><span class="line">    <span class="keyword">subscript</span>(i: <span class="type">Int</span>) -&gt; <span class="type">ItemType</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Array 本身就具备 Container 指定的实现</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Array</span>: <span class="title">Container</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="23-8-where字句"><a href="#23-8-where字句" class="headerlink" title="23.8    where字句"></a>23.8    where字句</h2><blockquote>
<p><strong>说明：</strong>可以在<code>参数列表</code>中通过 <code>where</code> 子句为<code>关联类型</code>定义约束</p>
<ul>
<li>使一个<code>关联类型</code>符合某个特定的协议</li>
<li>使某个特定的类型参数和<code>关联类型</code>必须类型相同</li>
</ul>
<p><strong>语法：</strong>将 <code>where</code> 关键字紧跟在类型参数列表后面来定义 <code>where</code> 子句</p>
<ul>
<li><code>where</code> 子句后跟<code>一个或者多个</code>针对关联类型的约束</li>
<li>以及<code>一个或多个</code>类型参数和关联类型间的相等关系</li>
</ul>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 协议：容器</span></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Container</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 定义关联类型</span></span><br><span class="line">    <span class="keyword">typealias</span> <span class="type">ItemType</span></span><br><span class="line">    <span class="comment">// 必须可以通过 append(_:) 方法添加一个新元素到容器里</span></span><br><span class="line">    <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">append</span><span class="params">(item: ItemType)</span></span></span><br><span class="line">    <span class="comment">// 必须可以通过 count 属性获取容器中元素的数量，并返回一个 Int 值</span></span><br><span class="line">    <span class="keyword">var</span> <span class="built_in">count</span>: <span class="type">Int</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">    <span class="comment">// 必须可以通过接受 Int 索引值的下标检索到每一个元素。</span></span><br><span class="line">    <span class="keyword">subscript</span>(i: <span class="type">Int</span>) -&gt; <span class="type">ItemType</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line">* 检查两个 Container 实例是否包含相同顺序的相同元素</span><br><span class="line">* @param &#123;C1&#125; someContainer</span><br><span class="line">* @param &#123;C2&#125; anotherContainer</span><br><span class="line">* @return &#123;Bool&#125; true 匹配，false 不匹配</span><br><span class="line">*/</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">allItemsMatch</span>&lt;</span><br><span class="line">    C1: Container, C2: Container</span><br><span class="line">    where C1.ItemType == C2.ItemType, C1.ItemType: Equatable&gt;</span><br><span class="line">    <span class="params">(someContainer: C1, <span class="number">_</span> anotherContainer: C2)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检查两个容器含有相同数量的元素</span></span><br><span class="line">        <span class="keyword">if</span> someContainer.<span class="built_in">count</span> != anotherContainer.<span class="built_in">count</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检查每一对元素是否相等</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..&lt;someContainer.<span class="built_in">count</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> someContainer[i] != anotherContainer[i] &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;       </span><br><span class="line">        <span class="comment">// 所有元素都匹配，返回 true</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/13/TSPL2_22 协议/" itemprop="url">
                  22 协议
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-13T20:05:28+08:00" content="2016-05-13">
              2016-05-13
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/13/TSPL2_22 协议/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/13/TSPL2_22 协议/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="22-1-协议的语法"><a href="#22-1-协议的语法" class="headerlink" title="22.1    协议的语法"></a>22.1    协议的语法</h2><blockquote>
<p><strong>说明：</strong>协议的定义方式与<code>类</code>,<code>结构体</code>,<code>枚举</code>的定义非常相似。</p>
<ul>
<li>要使类遵循某个协议,需要在<code>类型名称后</code>加上<code>协议名称</code>,中间以<code>:</code> 分隔,作为类型定义的一部分</li>
<li>遵循多个 协议时,各协议之间用逗号<code>,</code> 分隔</li>
<li>如果类在遵循协议的同时拥有父类,应该将<code>父类名</code>放在<code>协议名之前</code>,以<code>,</code>分隔</li>
</ul>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义协议</span></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">SomeProtocol</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 协议内容</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现协议</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SomeStructure</span>: <span class="title">FirstProtocol</span>, <span class="title">AnotherProtocol</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 结构体内容</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 继承类并实现协议</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SomeClass</span>: <span class="title">SomeSuperClass</span>, <span class="title">FirstProtocol</span>, <span class="title">AnotherProtocol</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 类的内容</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="22-2-对属性的规定"><a href="#22-2-对属性的规定" class="headerlink" title="22.2    对属性的规定"></a>22.2    对属性的规定</h2><blockquote>
<p><strong>说明：</strong>表现在<code>4</code>个方面</p>
<ul>
<li>名称</li>
<li>类型</li>
<li>可读还是可写</li>
<li>实例属性还是类属性</li>
</ul>
<p><strong>注意：</strong>不指定是<code>存储型属性</code>还是<code>计算型属性</code></p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义协议</span></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">FullyNamed</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 只读属性</span></span><br><span class="line">    <span class="keyword">var</span> fullName: <span class="type">String</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现协议</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Starship</span>: <span class="title">FullyNamed</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="keyword">prefix</span>: <span class="type">String</span>?</span><br><span class="line">    <span class="keyword">var</span> name: <span class="type">String</span></span><br><span class="line">    <span class="keyword">init</span>(name: <span class="type">String</span>, <span class="keyword">prefix</span>: <span class="type">String</span>? = <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.name = name</span><br><span class="line">        <span class="keyword">self</span>.<span class="keyword">prefix</span> = <span class="keyword">prefix</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 只读计算属性</span></span><br><span class="line">    <span class="keyword">var</span> fullName: <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">prefix</span> != <span class="literal">nil</span> ? <span class="keyword">prefix</span>! + <span class="string">" "</span> : <span class="string">""</span>) + name</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建实例</span></span><br><span class="line"><span class="keyword">var</span> ncc1701 = <span class="type">Starship</span>(name: <span class="string">"Enterprise"</span>, <span class="keyword">prefix</span>: <span class="string">"USS"</span>)</span><br></pre></td></tr></table></figure>
<h3 id="22-2-1-可读-amp-可写"><a href="#22-2-1-可读-amp-可写" class="headerlink" title="22.2.1    可读&amp;可写"></a>22.2.1    可读&amp;可写</h3><blockquote>
<p><strong>说明：</strong>在协议中指定属性规则是都使用<code>var</code>（不使用<code>let</code>）</p>
</blockquote>
<table>
<thead>
<tr>
<th>可读&amp;可写</th>
<th>协议</th>
<th>实现</th>
</tr>
</thead>
<tbody>
<tr>
<td>可读</td>
<td><code>{get}</code></td>
<td>可以只读，可以可读可写</td>
</tr>
<tr>
<td>可写</td>
<td><code>{get set}</code></td>
<td>不能是<code>常量</code>或<code>只读计算属性</code></td>
</tr>
</tbody>
</table>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义协议</span></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">SomeProtocol</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 可读可写</span></span><br><span class="line">    <span class="keyword">var</span> mustBeSettable : <span class="type">Int</span> &#123; <span class="keyword">get</span> <span class="keyword">set</span> &#125;</span><br><span class="line">    <span class="comment">// 只读</span></span><br><span class="line">    <span class="keyword">var</span> doesNotNeedToBeSettable: <span class="type">Int</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="22-2-2-实例属性-amp-类属性"><a href="#22-2-2-实例属性-amp-类属性" class="headerlink" title="22.2.2    实例属性&amp;类属性"></a>22.2.2    实例属性&amp;类属性</h3><blockquote>
<p><strong>说明：</strong></p>
</blockquote>
<table>
<thead>
<tr>
<th>实例属性&amp;类属性</th>
<th>协议</th>
<th>实现</th>
</tr>
</thead>
<tbody>
<tr>
<td>实例属性</td>
<td>默认</td>
<td>默认</td>
</tr>
<tr>
<td>类属性</td>
<td><code>static</code></td>
<td><code>static</code>或<code>class</code></td>
</tr>
</tbody>
</table>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义协议</span></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">AnotherProtocol</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 类属性</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> someTypeProperty: <span class="type">Int</span> &#123; <span class="keyword">get</span> <span class="keyword">set</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="22-3-对方法的规定"><a href="#22-3-对方法的规定" class="headerlink" title="22.3    对方法的规定"></a>22.3    对方法的规定</h2><blockquote>
<p><strong>说明：</strong>协议可以要求采纳协议的类型实现某些指定的<code>实例方法</code>或<code>类方法</code>。<br><strong>语法：</strong>像普通方法一样放在协议的定义中，但是不需要<code>{}</code>和方法体</p>
<ul>
<li>可以在协议中定义具有<code>可变参数</code>的方法，和普通方法的定义方式相同</li>
<li><code>不支持</code>为协议中的方法的参数提供默认值</li>
<li>在协议中定义类方法的时候，总是使用 <code>static</code> 关键字作为前缀；当类类型采纳协议时，除了 <code>static</code> 关键字，还可以使用 <code>class</code> 关键字作为前缀</li>
</ul>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义协议</span></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">SomeProtocol</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 类方法</span></span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">someTypeMethod</span><span class="params">()</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义协议</span></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">RandomNumberGenerator</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 实例方法</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">random</span><span class="params">()</span></span> -&gt; <span class="type">Double</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 线性同余随机数生成器</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LinearCongruentialGenerator</span>: <span class="title">RandomNumberGenerator</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 存储上一次生成的随机数</span></span><br><span class="line">    <span class="keyword">var</span> lastRandom = <span class="number">42.0</span></span><br><span class="line">    <span class="keyword">let</span> m = <span class="number">139968.0</span></span><br><span class="line">    <span class="keyword">let</span> a = <span class="number">3877.0</span></span><br><span class="line">    <span class="keyword">let</span> <span class="built_in">c</span> = <span class="number">29573.0</span></span><br><span class="line">    <span class="comment">// 获取随机数</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">random</span><span class="params">()</span></span> -&gt; <span class="type">Double</span> &#123;</span><br><span class="line">        lastRandom = ((lastRandom * a + <span class="built_in">c</span>) % m)</span><br><span class="line">        <span class="keyword">return</span> lastRandom / m</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 创建实例</span></span><br><span class="line"><span class="keyword">let</span> generator = <span class="type">LinearCongruentialGenerator</span>()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"Here's a random number: \(generator.random())"</span>)<span class="comment">// 0.37464991998171”</span></span><br></pre></td></tr></table></figure>
<h2 id="22-4-对Mutating方法的规定"><a href="#22-4-对Mutating方法的规定" class="headerlink" title="22.4    对Mutating方法的规定"></a>22.4    对Mutating方法的规定</h2><blockquote>
<p><strong>说明：</strong>如果你在<code>协议中</code>定义了一个<code>实例方法</code>，该方法会改变采纳该协议的类型的<code>实例</code>，那么在定义协议时需要在方法前加 <code>mutating</code></p>
</blockquote>
<table>
<thead>
<tr>
<th>实现者</th>
<th>协议</th>
<th>实现</th>
</tr>
</thead>
<tbody>
<tr>
<td>类类型</td>
<td><code>mutating</code></td>
<td>不用写 <code>mutating</code> 关键字</td>
</tr>
<tr>
<td>值类型</td>
<td><code>mutating</code></td>
<td>必须写<code>mutating</code> 关键字</td>
</tr>
</tbody>
</table>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 协议</span></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Togglable</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 当它被调用时，将改变实例属性，从而切换采纳该协议类型的实例的状态</span></span><br><span class="line">    <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">toggle</span><span class="params">()</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现协议：开关</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">OnOffSwitch</span>: <span class="title">Togglable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">Off</span>, <span class="type">On</span></span><br><span class="line">    <span class="comment">// 实现协议定义的 mutating 方法</span></span><br><span class="line">    <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">toggle</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> <span class="keyword">self</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">Off</span>:</span><br><span class="line">            <span class="keyword">self</span> = <span class="type">On</span></span><br><span class="line">        <span class="keyword">case</span> <span class="type">On</span>:</span><br><span class="line">            <span class="keyword">self</span> = <span class="type">Off</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 创建实例</span></span><br><span class="line"><span class="keyword">var</span> lightSwitch = <span class="type">OnOffSwitch</span>.<span class="type">Off</span></span><br><span class="line"><span class="comment">// 调用 mutating 方法</span></span><br><span class="line">lightSwitch.toggle()</span><br></pre></td></tr></table></figure>
<h2 id="22-5-对构造器的规定"><a href="#22-5-对构造器的规定" class="headerlink" title="22.5    对构造器的规定"></a>22.5    对构造器的规定</h2><blockquote>
<p><strong>说明：</strong>协议可以要求采纳协议的类型实现指定的构造器<br><strong>语法：</strong>你可以像编写普通构造器那样，在协议的定义里<code>写下构造器的声明</code>，但<code>不需要写{}和构造器的实体</code></p>
</blockquote>
<h3 id="22-5-1-构造器要求在类中的实现"><a href="#22-5-1-构造器要求在类中的实现" class="headerlink" title="22.5.1    构造器要求在类中的实现"></a>22.5.1    构造器要求在类中的实现</h3><blockquote>
<p><strong>说明：</strong>使用<code>required</code> 修饰符（除非在<code>final</code>类中），可以是<code>指定构造器</code>或<code>便利构造器</code></p>
<ul>
<li>如果一个子类<code>重写</code>了父类的指定构造器，并且该构造器<code>满足了某个协议</code>的要求，那么该构造器的实现需要同时标注 <code>required</code> 和 <code>override</code> 修饰符</li>
<li>如果类已经被标记为 <code>final</code>，那么不需要在协议构造器的实现中使用 <code>required</code> 修饰符，因为<code>final</code> 类不能有子类</li>
</ul>
<p><strong>注意：</strong>使用 <code>required</code> 修饰符可以确保所有子类也必须提供此构造器实现，从而也能符合协议。</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 协议</span></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">SomeProtocol</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 构造器要求</span></span><br><span class="line">    <span class="keyword">init</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 父类：没有实现协议</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SomeSuperClass</span> </span>&#123;</span><br><span class="line">    <span class="keyword">init</span>() &#123;</span><br><span class="line">        <span class="comment">// 这里是构造器的实现部分</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 子类：既继承了父类，也实现了协议</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SomeSubClass</span>: <span class="title">SomeSuperClass</span>, <span class="title">SomeProtocol</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 因为继承自父类，需要加上 override</span></span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">override</span> <span class="keyword">init</span>() &#123;</span><br><span class="line">        <span class="comment">// 这里是构造器的实现部分</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="22-5-2-可失败构造器要求"><a href="#22-5-2-可失败构造器要求" class="headerlink" title="22.5.2    可失败构造器要求"></a>22.5.2    可失败构造器要求</h3><blockquote>
<p><strong>说明：</strong>协议还可以为采纳协议的类型定义<code>可失败构造器要求</code></p>
</blockquote>
<table>
<thead>
<tr>
<th>构造器</th>
<th>协议</th>
<th>实现</th>
</tr>
</thead>
<tbody>
<tr>
<td>可失败构造器</td>
<td><code>init?</code></td>
<td><code>init?</code>或<code>init</code></td>
</tr>
<tr>
<td>非可失败构造器</td>
<td><code>init</code></td>
<td><code>init</code>或<code>init!</code></td>
</tr>
</tbody>
</table>
<h2 id="22-6-协议作为类型"><a href="#22-6-协议作为类型" class="headerlink" title="22.6    协议作为类型"></a>22.6    协议作为类型</h2><blockquote>
<p><strong>说明：</strong>尽管协议本身并未实现任何功能，但是协议可以被当做一个成熟的类型来使用。</p>
<ul>
<li>作为函数、方法或构造器中的<code>参数类型</code>或<code>返回值类型</code></li>
<li>作为<code>常量</code>、<code>变量</code>或<code>属性</code>的类型</li>
<li>作为数组、字典或其他<code>容器中的元素类型</code></li>
</ul>
<p><strong>注意：</strong>作为一种类型，协议类型的名称应与其他类型的写法相同（<code>大写字母开头的驼峰式写法</code>）</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 协议</span></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">RandomNumberGenerator</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">random</span><span class="params">()</span></span> -&gt; <span class="type">Double</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LinearCongruentialGenerator</span>: <span class="title">RandomNumberGenerator</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 存储上一次生成的随机数</span></span><br><span class="line">    <span class="keyword">var</span> lastRandom = <span class="number">42.0</span></span><br><span class="line">    <span class="keyword">let</span> m = <span class="number">139968.0</span></span><br><span class="line">    <span class="keyword">let</span> a = <span class="number">3877.0</span></span><br><span class="line">    <span class="keyword">let</span> <span class="built_in">c</span> = <span class="number">29573.0</span></span><br><span class="line">    <span class="comment">// 获取随机数</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">random</span><span class="params">()</span></span> -&gt; <span class="type">Double</span> &#123;</span><br><span class="line">        lastRandom = ((lastRandom * a + <span class="built_in">c</span>) % m)</span><br><span class="line">        <span class="keyword">return</span> lastRandom / m</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 骰子</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dice</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 骰子的面</span></span><br><span class="line">    <span class="keyword">let</span> sides: <span class="type">Int</span></span><br><span class="line">    <span class="comment">// 使用协议类型声明常量</span></span><br><span class="line">    <span class="keyword">let</span> generator: <span class="type">RandomNumberGenerator</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 使用协议类型作为参数（需要传递一个实现了该协议枚举、结构体或类的实例）</span></span><br><span class="line">    <span class="keyword">init</span>(sides: <span class="type">Int</span>, generator: <span class="type">RandomNumberGenerator</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.sides = sides</span><br><span class="line">        <span class="keyword">self</span>.generator = generator</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 掷骰子</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">roll</span><span class="params">()</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">Int</span>(generator.random() * <span class="type">Double</span>(sides)) + <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 创建骰子实例</span></span><br><span class="line"><span class="keyword">var</span> d6 = <span class="type">Dice</span>(sides: <span class="number">6</span>, generator: <span class="type">LinearCongruentialGenerator</span>())</span><br><span class="line"></span><br><span class="line"><span class="comment">// 掷骰子5次</span></span><br><span class="line"><span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> <span class="number">1</span>...<span class="number">5</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Random dice roll is \(d6.roll())"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="22-7-委托（代理）模式"><a href="#22-7-委托（代理）模式" class="headerlink" title="22.7    委托（代理）模式"></a>22.7    委托（代理）模式</h2><blockquote>
<p><strong>描述：</strong>委托是一种<code>设计模式</code>，它允许<code>类或结构体</code>将一些需要它们负责的功能委托给其他类型的实例。<br><strong>说明：</strong>委托模式的实现很简单</p>
<ul>
<li>定义协议来封装那些需要被委托的功能，这样就能确保采纳协议的类型能提供这些功能</li>
<li>委托模式可以用来响应特定的动作，或者接收外部数据源提供的数据，而无需关心外部数据源的类型。</li>
</ul>
<p><strong>案例：</strong><code>游戏</code>将监控这一功能委托给<code>游戏监控器</code>。</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 协议</span></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">RandomNumberGenerator</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">random</span><span class="params">()</span></span> -&gt; <span class="type">Double</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LinearCongruentialGenerator</span>: <span class="title">RandomNumberGenerator</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 存储上一次生成的随机数</span></span><br><span class="line">    <span class="keyword">var</span> lastRandom = <span class="number">42.0</span></span><br><span class="line">    <span class="keyword">let</span> m = <span class="number">139968.0</span></span><br><span class="line">    <span class="keyword">let</span> a = <span class="number">3877.0</span></span><br><span class="line">    <span class="keyword">let</span> <span class="built_in">c</span> = <span class="number">29573.0</span></span><br><span class="line">    <span class="comment">// 获取随机数</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">random</span><span class="params">()</span></span> -&gt; <span class="type">Double</span> &#123;</span><br><span class="line">        lastRandom = ((lastRandom * a + <span class="built_in">c</span>) % m)</span><br><span class="line">        <span class="keyword">return</span> lastRandom / m</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 骰子</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dice</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 骰子的面</span></span><br><span class="line">    <span class="keyword">let</span> sides: <span class="type">Int</span></span><br><span class="line">    <span class="comment">// 使用协议类型声明常量</span></span><br><span class="line">    <span class="keyword">let</span> generator: <span class="type">RandomNumberGenerator</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 使用协议类型作为参数（需要传递一个实现了该协议枚举、结构体或类的实例）</span></span><br><span class="line">    <span class="keyword">init</span>(sides: <span class="type">Int</span>, generator: <span class="type">RandomNumberGenerator</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.sides = sides</span><br><span class="line">        <span class="keyword">self</span>.generator = generator</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 掷骰子</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">roll</span><span class="params">()</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">Int</span>(generator.random() * <span class="type">Double</span>(sides)) + <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 协议：掷骰子游戏</span></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">DiceGame</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 骰子</span></span><br><span class="line">    <span class="keyword">var</span> dice: <span class="type">Dice</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">    <span class="comment">// 进行游戏</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">play</span><span class="params">()</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 协议：追踪 DiceGame</span></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">DiceGameDelegate</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 游戏开始</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">gameDidStart</span><span class="params">(game: DiceGame)</span></span></span><br><span class="line">    <span class="comment">// 游戏进行</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">game</span><span class="params">(game: DiceGame, didStartNewTurnWithDiceRoll diceRoll:Int)</span></span></span><br><span class="line">    <span class="comment">// 游戏结束</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">gameDidEnd</span><span class="params">(game: DiceGame)</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现：蛇梯棋游戏</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SnakesAndLadders</span>: <span class="title">DiceGame</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> finalSquare = <span class="number">25</span></span><br><span class="line">    <span class="comment">// 实现属性（要求只读，可以声明为 let ）</span></span><br><span class="line">    <span class="keyword">let</span> dice = <span class="type">Dice</span>(sides: <span class="number">6</span>, generator: <span class="type">LinearCongruentialGenerator</span>())</span><br><span class="line">    <span class="keyword">var</span> square = <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> board: [<span class="type">Int</span>]</span><br><span class="line">    <span class="keyword">init</span>() &#123;</span><br><span class="line">        board = [<span class="type">Int</span>](<span class="built_in">count</span>: finalSquare + <span class="number">1</span>, repeatedValue: <span class="number">0</span>)</span><br><span class="line">        board[<span class="number">03</span>] = +<span class="number">08</span>; board[<span class="number">06</span>] = +<span class="number">11</span>; board[<span class="number">09</span>] = +<span class="number">09</span>; board[<span class="number">10</span>] = +<span class="number">02</span></span><br><span class="line">        board[<span class="number">14</span>] = -<span class="number">10</span>; board[<span class="number">19</span>] = -<span class="number">11</span>; board[<span class="number">22</span>] = -<span class="number">02</span>; board[<span class="number">24</span>] = -<span class="number">08</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 游戏监控器</span></span><br><span class="line">    <span class="keyword">var</span> delegate: <span class="type">DiceGameDelegate</span>?</span><br><span class="line">    <span class="comment">// 实现方法</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">play</span><span class="params">()</span></span> &#123;</span><br><span class="line">        square = <span class="number">0</span></span><br><span class="line">        <span class="comment">// 开始游戏</span></span><br><span class="line">        delegate?.gameDidStart(<span class="keyword">self</span>)</span><br><span class="line">        gameLoop: <span class="keyword">while</span> square != finalSquare &#123;</span><br><span class="line">            <span class="keyword">let</span> diceRoll = dice.roll()</span><br><span class="line">            delegate?.game(<span class="keyword">self</span>, didStartNewTurnWithDiceRoll: diceRoll)</span><br><span class="line">            <span class="keyword">switch</span> square + diceRoll &#123;</span><br><span class="line">            <span class="keyword">case</span> finalSquare:</span><br><span class="line">                <span class="keyword">break</span> gameLoop</span><br><span class="line">            <span class="keyword">case</span> <span class="keyword">let</span> newSquare <span class="keyword">where</span> newSquare &gt; finalSquare:</span><br><span class="line">                <span class="keyword">continue</span> gameLoop</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                square += diceRoll</span><br><span class="line">                square += board[square]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 结束游戏</span></span><br><span class="line">        delegate?.gameDidEnd(<span class="keyword">self</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现：游戏监控器</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DiceGameTracker</span>: <span class="title">DiceGameDelegate</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> numberOfTurns = <span class="number">0</span></span><br><span class="line">    <span class="comment">// 游戏开始时被调用</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">gameDidStart</span><span class="params">(game: DiceGame)</span></span> &#123;</span><br><span class="line">        numberOfTurns = <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> game <span class="keyword">is</span> <span class="type">SnakesAndLadders</span> &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Started a new game of Snakes and Ladders"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"The game is using a \(game.dice.sides)-sided dice"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 游戏进行时被调用</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">game</span><span class="params">(game: DiceGame, didStartNewTurnWithDiceRoll diceRoll: Int)</span></span> &#123;</span><br><span class="line">        ++numberOfTurns</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Rolled a \(diceRoll)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 游戏结束时被调用</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">gameDidEnd</span><span class="params">(game: DiceGame)</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"The game lasted for \(numberOfTurns) turns"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监控器实例</span></span><br><span class="line"><span class="keyword">let</span> tracker = <span class="type">DiceGameTracker</span>()</span><br><span class="line"><span class="comment">// 游戏实例</span></span><br><span class="line"><span class="keyword">let</span> game = <span class="type">SnakesAndLadders</span>()</span><br><span class="line"><span class="comment">// 将监控器实例提供给游戏实例(不是必需的)</span></span><br><span class="line">game.delegate = tracker</span><br><span class="line"><span class="comment">// 游戏开始</span></span><br><span class="line">game.play()</span><br></pre></td></tr></table></figure>
<h2 id="22-8-在扩展中添加协议成员"><a href="#22-8-在扩展中添加协议成员" class="headerlink" title="22.8    在扩展中添加协议成员"></a>22.8    在扩展中添加协议成员</h2><blockquote>
<p><strong>说明：</strong>即便无法修改源代码，依然可以通过扩展令已有类型采纳并符合协议。<br><strong>原理：</strong>通过扩展令已有类型采纳并符合协议时，该类型的所有实例也会随之获得协议中定义的各项功能。</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 协议：要求提供一个能描述自身的计算属性</span></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">TextRepresentable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> textualDescription: <span class="type">String</span> &#123;<span class="keyword">get</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 骰子</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dice</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 骰子的面</span></span><br><span class="line">    <span class="keyword">let</span> sides: <span class="type">Int</span></span><br><span class="line">    <span class="keyword">init</span>(sides: <span class="type">Int</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.sides = sides</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//  通过extension使骰子实现协议</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Dice</span>: <span class="title">TextRepresentable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> textualDescription: <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"A \(sides)-sided dice"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 创建实例</span></span><br><span class="line"><span class="keyword">let</span> d12 = <span class="type">Dice</span>(sides: <span class="number">12</span>)</span><br><span class="line"><span class="built_in">print</span>(d12.textualDescription)</span><br></pre></td></tr></table></figure>
<h2 id="22-9-通过扩展补充协议声明"><a href="#22-9-通过扩展补充协议声明" class="headerlink" title="22.9    通过扩展补充协议声明"></a>22.9    通过扩展补充协议声明</h2><blockquote>
<p><strong>说明：</strong>可以通过扩展<code>空的扩展体</code>补充协议声明。需要两个前提</p>
<ul>
<li><code>已经实现了</code>协议中所有要求</li>
<li><code>没有声明</code>为遵循该协议</li>
</ul>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 协议：要求提供一个能描述自身的计算属性</span></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">TextRepresentable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> textualDescription: <span class="type">String</span> &#123;<span class="keyword">get</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 结构体（没有声明实现的协议）</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Hamster</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> name: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> textualDescription: <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"A hamster named \(name)"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过扩展补充协议声明</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Hamster</span>: <span class="title">TextRepresentable</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建实例</span></span><br><span class="line"><span class="keyword">let</span> simonTheHamster = <span class="type">Hamster</span>(name: <span class="string">"Simon"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 作为 TextRepresentable 类型使用</span></span><br><span class="line"><span class="keyword">let</span> somethingTextRepresentable: <span class="type">TextRepresentable</span> = simonTheHamster</span><br><span class="line"><span class="built_in">print</span>(somethingTextRepresentable.textualDescription)</span><br></pre></td></tr></table></figure>
<h2 id="22-10-集合中的协议类型"><a href="#22-10-集合中的协议类型" class="headerlink" title="22.10    集合中的协议类型"></a>22.10    集合中的协议类型</h2><blockquote>
<p><strong>说明：</strong>协议类型可以在集合使用,表示<code>集合中的元素均为协议类型</code><br><strong>注意：</strong>被当作协议类型使用后，只能使用和访问协议指定的功能（丢失具体类型的特色能力）。</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 协议类型数组</span></span><br><span class="line"><span class="keyword">let</span> things: [<span class="type">TextRepresentable</span>] = [game, d12, simonTheHamster]</span><br><span class="line"><span class="comment">// 遍历</span></span><br><span class="line"><span class="keyword">for</span> thing <span class="keyword">in</span> things &#123;</span><br><span class="line">    <span class="built_in">print</span>(thing.textualDescription)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="22-11-协议的继承"><a href="#22-11-协议的继承" class="headerlink" title="22.11    协议的继承"></a>22.11    协议的继承</h2><blockquote>
<p><strong>说明：</strong>协议能够继承一个或多个其他协议，可以在继承的协议的基础上增加新的要求。和类的继承类似<br><strong>语法：</strong>多个被继承的协议间用<code>,</code>分隔</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">InheritingProtocol</span>: <span class="title">SomeProtocol</span>, <span class="title">AnotherProtocol</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 这里是协议的定义部分</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 父类协议</span></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">TextRepresentable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> textualDescription: <span class="type">String</span> &#123;<span class="keyword">get</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 子类协议</span></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">PrettyTextRepresentable</span>: <span class="title">TextRepresentable</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 额外要求采纳协议的类型提供一个返回值为 String 类型的 prettyTextualDescription 属性</span></span><br><span class="line">    <span class="keyword">var</span> prettyTextualDescription: <span class="type">String</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过扩展让已有类实现子类协议（要同时实现父类协议）</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">SnakesAndLadders</span>: <span class="title">PrettyTextRepresentable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> prettyTextualDescription: <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> output = textualDescription + <span class="string">":\n"</span></span><br><span class="line">        <span class="keyword">for</span> index <span class="keyword">in</span> <span class="number">1</span>...finalSquare &#123;</span><br><span class="line">            <span class="keyword">switch</span> board[index] &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="keyword">let</span> ladder <span class="keyword">where</span> ladder &gt; <span class="number">0</span>:</span><br><span class="line">                output += <span class="string">"▲ "</span></span><br><span class="line">            <span class="keyword">case</span> <span class="keyword">let</span> snake <span class="keyword">where</span> snake &lt; <span class="number">0</span>:</span><br><span class="line">                output += <span class="string">"▼ "</span></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                output += <span class="string">"○ "</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> output</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 已有的实例也会获取到这种实现</span></span><br><span class="line"><span class="built_in">print</span>(game.prettyTextualDescription)</span><br></pre></td></tr></table></figure>
<h2 id="22-12-类类型专属协议"><a href="#22-12-类类型专属协议" class="headerlink" title="22.12    类类型专属协议"></a>22.12    类类型专属协议</h2><blockquote>
<p><strong>说明：</strong>以在<code>协议的继承列表</code>中，通过添加 <code>class</code> 关键字来限制协议只能被<code>类</code>类型采纳，而<code>结构体</code>或<code>枚举</code>不能采纳该协议<br><strong>语法：</strong><code>class</code> 关键字必须<code>第一个出现在协议的继承列表中</code>(在其他继承的协议之前)<br><strong>应用：</strong>当协议定义的要求需要采纳协议的类型必须是<code>引用</code>语义而非<code>值</code>语义时，应该采用类类型专属协议。</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">SomeClassOnlyProtocol</span>: <span class="title">class</span>, <span class="title">SomeInheritedProtocol</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 这里是类类型专属协议的定义部分</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="22-13-协议合成"><a href="#22-13-协议合成" class="headerlink" title="22.13    协议合成"></a>22.13    协议合成</h2><blockquote>
<p><strong>说明：</strong>有时候需要同时采纳多个协议，你可以将多个协议采用 <code>protocol&lt;SomeProtocol, AnotherProtocol&gt;</code> 这样的格式进行组合，作为一种<code>临时协议</code>存在，这个过程称为 <code>协议合成</code>。<br><strong>语法：</strong>可以在 <code>protocol&lt;&gt;</code> 中罗列任意多个你想要采纳的协议，以<code>,</code>分隔。<br><strong>注意：</strong>协议合成并不会生成新的、永久的协议类型，而是将多个协议中的要求合成到一个<code>只在局部作用域有效</code>的<code>临时协议</code>中。</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 协议1</span></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Named</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> name: <span class="type">String</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 协议2</span></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Aged</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> age: <span class="type">Int</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现两个协议</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Person</span>: <span class="title">Named</span>, <span class="title">Aged</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> name: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> age: <span class="type">Int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line">* 协议合成</span><br><span class="line">* @param &#123;protocol&lt;Named, Aged&gt;&#125; celebrator 实现了两种协议的类型的实例</span><br><span class="line">*/</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">wishHappyBirthday</span><span class="params">(celebrator: <span class="keyword">protocol</span>&lt;Named, Aged&gt;)</span></span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Happy birthday \(celebrator.name) - you're \(celebrator.age)!"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建实例</span></span><br><span class="line"><span class="keyword">let</span> birthdayPerson = <span class="type">Person</span>(name: <span class="string">"Malcolm"</span>, age: <span class="number">21</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 传递符合两种协议的实例给函数</span></span><br><span class="line">wishHappyBirthday(birthdayPerson)</span><br></pre></td></tr></table></figure>
<h2 id="22-14-检验协议的一致性"><a href="#22-14-检验协议的一致性" class="headerlink" title="22.14    检验协议的一致性"></a>22.14    检验协议的一致性</h2><blockquote>
<p><strong>说明：</strong>其实就是检验<code>是否符合某协议</code>，或者转换到指定的协议类型。检查和转换到某个协议类型在语法上和<code>类型的检查和转换</code>完全相同</p>
</blockquote>
<table>
<thead>
<tr>
<th>操作符</th>
<th>用途</th>
<th>返回值</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>is</code></td>
<td>用来检查实例是否符合某个协议</td>
<td>符合则返回 <code>true</code>，否则返回 <code>false</code></td>
<td></td>
</tr>
<tr>
<td><code>as?</code></td>
<td>返回指定协议的可选值</td>
<td>，当实例符合某个协议时，返回类型为协议类型的可选值，否则返回 <code>nil</code></td>
<td></td>
</tr>
<tr>
<td><code>as!</code></td>
<td>将实例强制向下转换到某个协议类型</td>
<td>指定的协议类型</td>
<td>如果强转失败，会引发运行时错误</td>
</tr>
</tbody>
</table>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 协议</span></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">HasArea</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> area: <span class="type">Double</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现1</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Circle</span>: <span class="title">HasArea</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> pi = <span class="number">3.1415927</span></span><br><span class="line">    <span class="keyword">var</span> radius: <span class="type">Double</span></span><br><span class="line">    <span class="keyword">var</span> area: <span class="type">Double</span> &#123; <span class="keyword">return</span> pi * radius * radius &#125;</span><br><span class="line">    <span class="keyword">init</span>(radius: <span class="type">Double</span>) &#123; <span class="keyword">self</span>.radius = radius &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现2</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Country</span>: <span class="title">HasArea</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> area: <span class="type">Double</span></span><br><span class="line">    <span class="keyword">init</span>(area: <span class="type">Double</span>) &#123; <span class="keyword">self</span>.area = area &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不实现</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> legs: <span class="type">Int</span></span><br><span class="line">    <span class="keyword">init</span>(legs: <span class="type">Int</span>) &#123; <span class="keyword">self</span>.legs = legs &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对应实例</span></span><br><span class="line"><span class="keyword">let</span> objects: [<span class="type">AnyObject</span>] = [</span><br><span class="line">    <span class="type">Circle</span>(radius: <span class="number">2.0</span>),</span><br><span class="line">    <span class="type">Country</span>(area: <span class="number">243_610</span>),</span><br><span class="line">    <span class="type">Animal</span>(legs: <span class="number">4</span>)</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历，使用 as?</span></span><br><span class="line"><span class="keyword">for</span> object <span class="keyword">in</span> objects &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> objectWithArea = object <span class="keyword">as</span>? <span class="type">HasArea</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Area is \(objectWithArea.area)"</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Something that doesn't have an area"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="22-15-对可选协议的规定"><a href="#22-15-对可选协议的规定" class="headerlink" title="22.15    对可选协议的规定"></a>22.15    对可选协议的规定</h2><blockquote>
<p><strong>说明：</strong>协议可以定义可选要求，采纳协议的类型可以选择是否实现这些要求。<br><strong>语法：</strong>在协议中使用 <code>optional</code>关键字作为前缀来定义可选要求。</p>
<ul>
<li>使用可选要求时，它们的类型会自动变成可选的</li>
<li>需要<code>import Foundation</code></li>
</ul>
<p><strong>限制：</strong></p>
<ul>
<li><strong>定义协议：</strong>可选的协议要求只能用在标记 <code>@objc</code> 特性的协议中</li>
<li><strong>采纳协议：</strong>标记 <code>@objc</code> 特性的协议只能被<code>继承自 Objective-C 类的类</code>或者<code>@objc 类</code>采纳</li>
</ul>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="comment">/**</span><br><span class="line">* @objc</span><br><span class="line">* 协议：只能被 [继承自 Objective-C 类的类] 或者 [@objc 类]采纳</span><br><span class="line">*/</span></span><br><span class="line">objc <span class="class"><span class="keyword">protocol</span> <span class="title">CounterDataSource</span> </span>&#123;</span><br><span class="line">    <span class="keyword">optional</span> <span class="function"><span class="keyword">func</span> <span class="title">incrementForCount</span><span class="params">(<span class="built_in">count</span>: Int)</span></span> -&gt; <span class="type">Int</span></span><br><span class="line">    <span class="keyword">optional</span> <span class="keyword">var</span> fixedIncrement: <span class="type">Int</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Counter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="built_in">count</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> dataSource: <span class="type">CounterDataSource</span>?</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">increment</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> amount = dataSource?.incrementForCount?(<span class="built_in">count</span>) &#123;</span><br><span class="line">            <span class="built_in">count</span> += amount</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">let</span> amount = dataSource?.fixedIncrement &#123;</span><br><span class="line">            <span class="built_in">count</span> += amount</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line">* 采纳协议</span><br><span class="line">* 继承了 NSObject，所以可以采纳 CounterDataSource</span><br><span class="line">*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreeSource</span>: <span class="title">NSObject</span>, <span class="title">CounterDataSource</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> fixedIncrement = <span class="number">3</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> counter = <span class="type">Counter</span>()</span><br><span class="line">counter.dataSource = <span class="type">ThreeSource</span>()</span><br><span class="line"><span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> <span class="number">1</span>...<span class="number">4</span> &#123;</span><br><span class="line">    counter.increment()</span><br><span class="line">    <span class="built_in">print</span>(counter.<span class="built_in">count</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="22-16-协议扩展"><a href="#22-16-协议扩展" class="headerlink" title="22.16    协议扩展"></a>22.16    协议扩展</h2><blockquote>
<p><strong>说明：</strong>协议可以通过<code>扩展</code>来为<code>采纳协议的类型</code>提供属性、方法以及下标脚本的实现。<br><strong>优点：</strong>扩展协议不但扩展了要求，同时提供了实现。因而<code>无需</code>在每个采纳协议的类型中都重复同样的实现，也<code>无需</code>使用全局函数。</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义协议</span></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">RandomNumberGenerator</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 实例方法</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">random</span><span class="params">()</span></span> -&gt; <span class="type">Double</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 采纳协议：线性同余随机数生成器</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LinearCongruentialGenerator</span>: <span class="title">RandomNumberGenerator</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 存储上一次生成的随机数</span></span><br><span class="line">    <span class="keyword">var</span> lastRandom = <span class="number">42.0</span></span><br><span class="line">    <span class="keyword">let</span> m = <span class="number">139968.0</span></span><br><span class="line">    <span class="keyword">let</span> a = <span class="number">3877.0</span></span><br><span class="line">    <span class="keyword">let</span> <span class="built_in">c</span> = <span class="number">29573.0</span></span><br><span class="line">    <span class="comment">// 获取随机数</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">random</span><span class="params">()</span></span> -&gt; <span class="type">Double</span> &#123;</span><br><span class="line">        lastRandom = ((lastRandom * a + <span class="built_in">c</span>) % m)</span><br><span class="line">        <span class="keyword">return</span> lastRandom / m</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 扩展协议（同时提供了实现）</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">RandomNumberGenerator</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">randomBool</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> random() &gt; <span class="number">0.5</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 采纳了协议的类型的实例</span></span><br><span class="line"><span class="keyword">let</span> generator = <span class="type">LinearCongruentialGenerator</span>()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"Here's a random number: \(generator.random())"</span>)</span><br><span class="line"><span class="comment">// 打印 “Here's a random number: 0.37464991998171”</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"And here's a random Boolean: \(generator.randomBool())"</span>)</span><br></pre></td></tr></table></figure>
<h3 id="22-16-1-提供默认实现"><a href="#22-16-1-提供默认实现" class="headerlink" title="22.16.1    提供默认实现"></a>22.16.1    提供默认实现</h3><blockquote>
<p><strong>说明：</strong>可以通过<code>协议扩展</code>来为协议要求的属性、方法以及下标脚本提供<code>默认的实现</code>。<br><strong>注意：</strong>如果采纳协议的类型为这些要求提供了自己的实现，那么这些<code>自定义实现将会替代扩展中的默认实现</code>被使用。</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 扩展协议</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">PrettyTextRepresentable</span>  </span>&#123;</span><br><span class="line">	<span class="comment">// 为协议提供一个默认的属性</span></span><br><span class="line">    <span class="keyword">var</span> prettyTextualDescription: <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> textualDescription</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="22-16-2-为协议扩展添加限制条件"><a href="#22-16-2-为协议扩展添加限制条件" class="headerlink" title="22.16.2    为协议扩展添加限制条件"></a>22.16.2    为协议扩展添加限制条件</h3><blockquote>
<p><strong>说明：</strong>在<code>扩展协议</code>的时候，可以<code>指定一些限制条件</code>，只有采纳协议的类型满足这些限制条件时，才能获得协议扩展提供的<code>默认实现</code>。<br><strong>语法：</strong>这些限制条件写在<code>协议名之后</code>，使用 <code>where</code> 子句来描述.</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 协议：要求提供一个能描述自身的计算属性</span></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">TextRepresentable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> textualDescription: <span class="type">String</span> &#123;<span class="keyword">get</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 结构体（没有声明实现的协议）</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Hamster</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> name: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> textualDescription: <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"A hamster named \(name)"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过扩展补充协议声明</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Hamster</span>: <span class="title">TextRepresentable</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过扩展采纳协议</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">CollectionType</span> <span class="title">where</span> <span class="title">Generator</span>.<span class="title">Element</span>: <span class="title">TextRepresentable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> textualDescription: <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> itemsAsText = <span class="keyword">self</span>.<span class="built_in">map</span> &#123; $<span class="number">0</span>.textualDescription &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"["</span> + itemsAsText.joinWithSeparator(<span class="string">", "</span>) + <span class="string">"]"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> murrayTheHamster = <span class="type">Hamster</span>(name: <span class="string">"Murray"</span>)</span><br><span class="line"><span class="keyword">let</span> morganTheHamster = <span class="type">Hamster</span>(name: <span class="string">"Morgan"</span>)</span><br><span class="line"><span class="keyword">let</span> mauriceTheHamster = <span class="type">Hamster</span>(name: <span class="string">"Maurice"</span>)</span><br><span class="line"><span class="keyword">let</span> hamsters = [murrayTheHamster, morganTheHamster, mauriceTheHamster]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(hamsters.textualDescription)</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/13/TSPL2_21 扩展/" itemprop="url">
                  21 扩展
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-13T19:57:35+08:00" content="2016-05-13">
              2016-05-13
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/13/TSPL2_21 扩展/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/13/TSPL2_21 扩展/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><strong>说明：</strong><code>扩展</code>就是为一个已有的<code>类</code>、<code>结构体</code>、<code>枚举类型</code>或者<code>协议类型</code>添加新功能(包括没有权限获取原始源代码的情况)。</p>
<ul>
<li>添加<code>计算型属性</code>和<code>计算类型属性</code></li>
<li>定义<code>实例方法</code>和<code>类型方法</code></li>
<li>提供新的<code>构造器</code></li>
<li>定义<code>下标</code></li>
<li>定义和使用新的<code>嵌套类型</code></li>
<li>是一个有类型符合某个<code>协议</code></li>
</ul>
<p><strong>注意：</strong></p>
<ul>
<li>扩展可以为一个类型添加新的功能，但是<code>不能重写已有的功能</code>。</li>
<li>如果你通过扩展为一个已有类型添加新功能，那么新功能对该类型的所有已有实例都是可用的，<code>即使它们是在这个扩展定义之前创建的</code>。</li>
</ul>
</blockquote>
<h2 id="21-1-扩展语法"><a href="#21-1-扩展语法" class="headerlink" title="21.1    扩展语法"></a>21.1    扩展语法</h2><blockquote>
<p><strong>说明：</strong>使用<code>extension</code>声明扩展</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 形式一：为SomeType添加功能</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">SomeType</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 为 SomeType 添加的新功能写到这里</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 形式二：使SomeType实现协议</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">SomeType</span>: <span class="title">SomeProtocol</span>, <span class="title">AnotherProctocol</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 协议实现写到这里</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="21-2-计算型属性"><a href="#21-2-计算型属性" class="headerlink" title="21.2    计算型属性"></a>21.2    计算型属性</h2><blockquote>
<p><strong>说明：</strong>扩展可以为已有类型添加<code>计算型实例属性</code>和<code>计算型类型属性</code>。<br><strong>注意：</strong>不可以添加<code>存储型属性</code>，也不可以为已有属性<code>添加属性观察器</code>。</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 为Double添加一些只读计算属性</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Double</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 千米</span></span><br><span class="line">    <span class="keyword">var</span> km: <span class="type">Double</span> &#123; <span class="keyword">return</span> <span class="keyword">self</span> * <span class="number">1_000.0</span> &#125;</span><br><span class="line">    <span class="comment">// 米</span></span><br><span class="line">    <span class="keyword">var</span> m : <span class="type">Double</span> &#123; <span class="keyword">return</span> <span class="keyword">self</span> &#125;</span><br><span class="line">    <span class="comment">// 厘米</span></span><br><span class="line">    <span class="keyword">var</span> cm: <span class="type">Double</span> &#123; <span class="keyword">return</span> <span class="keyword">self</span> / <span class="number">100.0</span> &#125;</span><br><span class="line">    <span class="comment">// 毫米</span></span><br><span class="line">    <span class="keyword">var</span> mm: <span class="type">Double</span> &#123; <span class="keyword">return</span> <span class="keyword">self</span> / <span class="number">1_000.0</span> &#125;</span><br><span class="line">    <span class="comment">// 尺</span></span><br><span class="line">    <span class="keyword">var</span> ft: <span class="type">Double</span> &#123; <span class="keyword">return</span> <span class="keyword">self</span> / <span class="number">3.28084</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 访问计算属性</span></span><br><span class="line"><span class="keyword">let</span> oneInch = <span class="number">25.4</span>.mm<span class="comment">// 0.0254</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> threeFeet = <span class="number">3</span>.ft<span class="comment">// 0.914399970739201</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> aMarathon = <span class="number">42</span>.km + <span class="number">195</span>.m<span class="comment">// 42195.0</span></span><br></pre></td></tr></table></figure>
<h2 id="21-3-构造器"><a href="#21-3-构造器" class="headerlink" title="21.3    构造器"></a>21.3    构造器</h2><blockquote>
<p><strong>说明：</strong>扩展可以为已有类型添加<code>新的构造器</code>(便利构造器)</p>
<ul>
<li>在为值类型扩展的构造器中调用<code>逐一构造器</code>：值类型的原始实现中未定义任何定制的构造器时</li>
</ul>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 大小</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Size</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> width = <span class="number">0.0</span>, height = <span class="number">0.0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 坐标</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Point</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> x = <span class="number">0.0</span>, y = <span class="number">0.0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 正方形</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Rect</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 原点</span></span><br><span class="line">    <span class="keyword">var</span> origin = <span class="type">Point</span>()</span><br><span class="line">    <span class="comment">// 大小</span></span><br><span class="line">    <span class="keyword">var</span> size = <span class="type">Size</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建实例：默认构造器</span></span><br><span class="line"><span class="keyword">let</span> defaultRect = <span class="type">Rect</span>()</span><br><span class="line"><span class="comment">// 创建实例：逐一成员构造器</span></span><br><span class="line"><span class="keyword">let</span> memberwiseRect = <span class="type">Rect</span>(origin: <span class="type">Point</span>(x: <span class="number">2.0</span>, y: <span class="number">2.0</span>),</span><br><span class="line">    size: <span class="type">Size</span>(width: <span class="number">5.0</span>, height: <span class="number">5.0</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 扩展 Rect</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Rect</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 添加一个新的构造器</span></span><br><span class="line">    <span class="keyword">init</span>(center: <span class="type">Point</span>, size: <span class="type">Size</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> originX = center.x - (size.width / <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">let</span> originY = center.y - (size.height / <span class="number">2</span>)</span><br><span class="line">        <span class="comment">// 调用逐一成员构造器</span></span><br><span class="line">        <span class="keyword">self</span>.<span class="keyword">init</span>(origin: <span class="type">Point</span>(x: originX, y: originY), size: size)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 使用扩展的构造器创建 Rect 的实例</span></span><br><span class="line"><span class="keyword">let</span> centerRect = <span class="type">Rect</span>(center: <span class="type">Point</span>(x: <span class="number">4.0</span>, y: <span class="number">4.0</span>),</span><br><span class="line">    size: <span class="type">Size</span>(width: <span class="number">3.0</span>, height: <span class="number">3.0</span>))</span><br></pre></td></tr></table></figure>
<h2 id="21-4-方法"><a href="#21-4-方法" class="headerlink" title="21.4    方法"></a>21.4    方法</h2><blockquote>
<p><strong>说明：</strong>扩展可以为已有类型添加新的<code>实例方法</code>和<code>类型方法</code>。<br><strong>注意：</strong><code>结构体</code>和<code>枚举</code>类型中修改 <code>self</code> 或<code>其属性</code>的方法必须将该实例方法标注为 <code>mutating</code>，正如来自原始实现的<code>变异方法</code>一样。</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 扩展 Int 类型</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Int</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">    * 添加一个实例方法</span><br><span class="line">    * 按照自身数目重复执行一个任务</span><br><span class="line">    * @param &#123;() -&gt; Void&#125; task 函数</span><br><span class="line">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">repetitions</span><span class="params">(task: <span class="params">()</span></span></span> -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="keyword">self</span> &#123;</span><br><span class="line">            task()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用扩展的实例方法</span></span><br><span class="line"><span class="number">3</span>.repetitions(&#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Hello!"</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更简洁的方式（使用尾随闭包）</span></span><br><span class="line"><span class="number">3</span>.repetitions &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Goodbye!"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>添加变异方法</em></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Int</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 结构体和枚举类型中修改 self 或其属性的方法必须将该实例方法标注为 mutating</span></span><br><span class="line">    <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">square</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">self</span> = <span class="keyword">self</span> * <span class="keyword">self</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 创建实例</span></span><br><span class="line"><span class="keyword">var</span> someInt = <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用扩展的实例方法</span></span><br><span class="line">someInt.square()</span><br></pre></td></tr></table></figure>
<h2 id="21-5-下标"><a href="#21-5-下标" class="headerlink" title="21.5    下标"></a>21.5    下标</h2><blockquote>
<p><strong>说明：</strong>扩展可以为已有类型添加新<code>下标</code></p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 扩展 Int 类型</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Int</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* 添加一个下标</span><br><span class="line">     * 从右往左数</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">subscript</span>(<span class="keyword">var</span> digitIndex: <span class="type">Int</span>) -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> decimalBase = <span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> digitIndex &gt; <span class="number">0</span> &#123;</span><br><span class="line">            decimalBase *= <span class="number">10</span></span><br><span class="line">            --digitIndex</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">self</span> / decimalBase) % <span class="number">10</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">746381295</span>[<span class="number">0</span>]<span class="comment">// 5</span></span><br><span class="line"></span><br><span class="line"><span class="number">746381295</span>[<span class="number">1</span>]<span class="comment">// 9</span></span><br><span class="line"></span><br><span class="line"><span class="number">746381295</span>[<span class="number">2</span>]<span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line"><span class="number">746381295</span>[<span class="number">8</span>]<span class="comment">// 7</span></span><br></pre></td></tr></table></figure>
<h2 id="21-6-嵌套类型"><a href="#21-6-嵌套类型" class="headerlink" title="21.6    嵌套类型"></a>21.6    嵌套类型</h2><blockquote>
<p><strong>说明：</strong>扩展可以为已有的<code>类</code>、<code>结构体</code>和<code>枚举</code>添加新的<code>嵌套类型</code></p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 扩展 Int 类型</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Int</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 数字类型（正、0、负）</span></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">Kind</span> </span>&#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">Negative</span>, <span class="type">Zero</span>, <span class="type">Positive</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 计算属性：获取数字类型</span></span><br><span class="line">    <span class="keyword">var</span> kind: <span class="type">Kind</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> <span class="keyword">self</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> .<span class="type">Zero</span></span><br><span class="line">        <span class="keyword">case</span> <span class="keyword">let</span> x <span class="keyword">where</span> x &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> .<span class="type">Positive</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> .<span class="type">Negative</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line">* 判断数组中 Int 的类型</span><br><span class="line">* @param &#123;[Int]&#125; numbers Int数组</span><br><span class="line">*/</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printIntegerKinds</span><span class="params">(numbers: [Int])</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> number <span class="keyword">in</span> numbers &#123;</span><br><span class="line">        <span class="keyword">switch</span> number.kind &#123;</span><br><span class="line">        <span class="keyword">case</span> .<span class="type">Negative</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"- "</span>, terminator: <span class="string">""</span>)</span><br><span class="line">        <span class="keyword">case</span> .<span class="type">Zero</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"0 "</span>, terminator: <span class="string">""</span>)</span><br><span class="line">        <span class="keyword">case</span> .<span class="type">Positive</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"+ "</span>, terminator: <span class="string">""</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">""</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 调用</span></span><br><span class="line">printIntegerKinds([<span class="number">3</span>, <span class="number">19</span>, -<span class="number">27</span>, <span class="number">0</span>, -<span class="number">6</span>, <span class="number">0</span>, <span class="number">7</span>])<span class="comment">// + + - 0 - 0 +swift</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/13/TSPL2_20 类型嵌套/" itemprop="url">
                  20 类型嵌套
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-13T19:57:17+08:00" content="2016-05-13">
              2016-05-13
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/13/TSPL2_20 类型嵌套/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/13/TSPL2_20 类型嵌套/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><strong>说明：</strong><code>Swift</code> 允许你定义嵌套类型，可以在支持的类型中定义嵌套的<code>枚举</code>、<code>类</code>和<code>结构体</code>。可以根据需要定义<code>多级嵌套</code>。<br><strong>用途：</strong>方便地定义工具类或结构体来使用。</p>
</blockquote>
<h2 id="20-1-嵌套类型实践"><a href="#20-1-嵌套类型实践" class="headerlink" title="20.1    嵌套类型实践"></a>20.1    嵌套类型实践</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line">* 扑克牌</span><br><span class="line">* 没有自定义构造器的结构体：因此有默认的成员构造器</span><br><span class="line">*/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">BlackjackCard</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 嵌套的 Suit 枚举</span></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">Suit</span>: <span class="title">Character</span> </span>&#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">Spades</span> = <span class="string">"♠"</span>, <span class="type">Hearts</span> = <span class="string">"♡"</span>, <span class="type">Diamonds</span> = <span class="string">"♢"</span>, <span class="type">Clubs</span> = <span class="string">"♣"</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 嵌套的 Rank 枚举</span></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">Rank</span>: <span class="title">Int</span> </span>&#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">Two</span> = <span class="number">2</span>, <span class="type">Three</span>, <span class="type">Four</span>, <span class="type">Five</span>, <span class="type">Six</span>, <span class="type">Seven</span>, <span class="type">Eight</span>, <span class="type">Nine</span>, <span class="type">Ten</span></span><br><span class="line">        <span class="keyword">case</span> <span class="type">Jack</span>, <span class="type">Queen</span>, <span class="type">King</span>, <span class="type">Ace</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">Values</span> </span>&#123;</span><br><span class="line">            <span class="keyword">let</span> first: <span class="type">Int</span>, second: <span class="type">Int</span>?</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> values: <span class="type">Values</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            <span class="keyword">case</span> .<span class="type">Ace</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="type">Values</span>(first: <span class="number">1</span>, second: <span class="number">11</span>)</span><br><span class="line">            <span class="keyword">case</span> .<span class="type">Jack</span>, .<span class="type">Queen</span>, .<span class="type">King</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="type">Values</span>(first: <span class="number">10</span>, second: <span class="literal">nil</span>)</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="type">Values</span>(first: <span class="keyword">self</span>.rawValue, second: <span class="literal">nil</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 用嵌套在结构体内部的类型声明属性</span></span><br><span class="line">    <span class="keyword">let</span> rank: <span class="type">Rank</span>, suit: <span class="type">Suit</span></span><br><span class="line">    <span class="keyword">var</span> description: <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> output = <span class="string">"suit is \(suit.rawValue),"</span></span><br><span class="line">        output += <span class="string">" value is \(rank.values.first)"</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> second = rank.values.second &#123;</span><br><span class="line">            output += <span class="string">" or \(second)"</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> output</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建实例（嵌套类型也能用于类型推断）</span></span><br><span class="line"><span class="keyword">let</span> theAceOfSpades = <span class="type">BlackjackCard</span>(rank: .<span class="type">Ace</span>, suit: .<span class="type">Spades</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"theAceOfSpades:\(theAceOfSpades.description)"</span>)</span><br></pre></td></tr></table></figure>
<h2 id="20-2-嵌套类型的引用"><a href="#20-2-嵌套类型的引用" class="headerlink" title="20.2    嵌套类型的引用"></a>20.2    嵌套类型的引用</h2><blockquote>
<p><strong>说明：</strong>在外部引用嵌套类型时，在<code>嵌套类型的类型名</code>前加上<code>其外部类型的类型名</code>作为前缀。</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引用嵌套类型</span></span><br><span class="line"><span class="keyword">let</span> heartsSymbol = <span class="type">BlackjackCard</span>.<span class="type">Suit</span>.<span class="type">Hearts</span>.rawValue</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/13/TSPL2_19 类型转换（Type Casting）/" itemprop="url">
                  19 类型转换
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-13T19:56:57+08:00" content="2016-05-13">
              2016-05-13
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/13/TSPL2_19 类型转换（Type Casting）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/13/TSPL2_19 类型转换（Type Casting）/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><strong>说明：</strong><code>类型转换</code>可以判断实例的类型，也可以将实例看做是其父类或者子类的实例。<br><strong>操作符：</strong><code>is</code>和<code>as</code></p>
<ul>
<li>检查值的类型：<code>is</code></li>
<li>转换类型：<code>as</code></li>
</ul>
</blockquote>
<h2 id="19-1-定义一个类层次作为例子"><a href="#19-1-定义一个类层次作为例子" class="headerlink" title="19.1    定义一个类层次作为例子"></a>19.1    定义一个类层次作为例子</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//多媒体文件</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MediaItem</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> name:<span class="type">String</span></span><br><span class="line">    <span class="keyword">init</span>(name:<span class="type">String</span>)&#123;</span><br><span class="line">        <span class="keyword">self</span>.name = name</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//电影</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Movie</span>:<span class="title">MediaItem</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> director:<span class="type">String</span></span><br><span class="line">    <span class="keyword">init</span>(name:<span class="type">String</span>, director:<span class="type">String</span>)&#123;</span><br><span class="line">        <span class="keyword">self</span>.director = director</span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>(name: name)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//歌曲</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Song</span>:<span class="title">MediaItem</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> artist:<span class="type">String</span></span><br><span class="line">    <span class="keyword">init</span>(name: <span class="type">String</span>,artist:<span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.artist = artist</span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>(name: name)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//存储多媒体文件的数组（迭代该数组取出的每一项类型都会是MediaItem）</span></span><br><span class="line"><span class="keyword">let</span> library = [</span><br><span class="line">    <span class="type">Movie</span>(name: <span class="string">"Casablance"</span>, director: <span class="string">"Michael Curtiz"</span>),</span><br><span class="line">    <span class="type">Song</span>(name: <span class="string">"Blue Suede Shoes"</span>, artist: <span class="string">"Elvis Presley"</span>),</span><br><span class="line">    <span class="type">Movie</span>(name: <span class="string">"Citizen Kane"</span>, director: <span class="string">"Orson Welles"</span>),</span><br><span class="line">    <span class="type">Song</span>(name: <span class="string">"The One And The Only"</span>, artist: <span class="string">"Chesney Jawkes"</span>),</span><br><span class="line">    <span class="type">Song</span>(name: <span class="string">"Never Gonna Give You up"</span>, artist: <span class="string">"Rick Astley"</span>)</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h2 id="19-2-检查类型"><a href="#19-2-检查类型" class="headerlink" title="19.2    检查类型"></a>19.2    检查类型</h2><blockquote>
<p><strong>说明：</strong><code>类型检查操作符(is)</code>，用来检查一个实例是否属于<code>特定子类型</code>。若实例属于那个子类型，类型检查操作符返回 <code>true</code>，否则返回 <code>false</code>。</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//计算电影和歌曲类型分别的有多少个</span></span><br><span class="line"><span class="keyword">var</span> movieCount = <span class="number">0</span></span><br><span class="line"><span class="keyword">var</span> songCount = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> library&#123;</span><br><span class="line">    <span class="comment">//通过is判断一个实例具体是某种类型的哪种子类型</span></span><br><span class="line">    <span class="keyword">if</span> item <span class="keyword">is</span> <span class="type">Movie</span>&#123;</span><br><span class="line">        ++movieCount</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> item <span class="keyword">is</span> <span class="type">Song</span>&#123;</span><br><span class="line">        ++songCount</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">println</span>(<span class="string">"Media library contains \(movieCount) movies and \(songCount) songs"</span>)</span><br></pre></td></tr></table></figure>
<h2 id="19-3-向下转型"><a href="#19-3-向下转型" class="headerlink" title="19.3    向下转型"></a>19.3    向下转型</h2><blockquote>
<p><strong>两种方式：</strong>可选形式和强制形式<br><strong>注意：</strong>类型转换不影响原本被转换的实例</p>
</blockquote>
<table>
<thead>
<tr>
<th><em>**</em></th>
<th>可选形式</th>
<th>强制形式</th>
</tr>
</thead>
<tbody>
<tr>
<td>类型转换操作符</td>
<td><code>as?</code></td>
<td><code>as</code></td>
</tr>
<tr>
<td>适用场景</td>
<td>试图向下转型为一个不确定的类型</td>
<td>向下转成一个确定的类型</td>
</tr>
<tr>
<td>返回值</td>
<td>返回试图向下转成的的类型的可选值</td>
<td>返回目标类型</td>
</tr>
</tbody>
</table>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//向下转型(不改变原本实例，指示获得转变后的实例来使用)</span></span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> library&#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> movie = item <span class="keyword">as</span>? <span class="type">Movie</span>&#123;</span><br><span class="line">        <span class="built_in">println</span>(<span class="string">"Movie:'\(movie.name)',dir.\(movie.director)"</span>)</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">let</span> song = item <span class="keyword">as</span>? <span class="type">Song</span>&#123;</span><br><span class="line">        <span class="built_in">println</span>(<span class="string">"Song:'\(song.name)',by \(song.artist)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="19-4-Any和AnyObject的类型转换"><a href="#19-4-Any和AnyObject的类型转换" class="headerlink" title="19.4    Any和AnyObject的类型转换"></a>19.4    <code>Any</code>和<code>AnyObject</code>的类型转换</h2><blockquote>
<p><strong>Swift为不确定类型提供了两种特殊类型别名：</strong></p>
<ul>
<li><code>AnyObject</code>：可以代表任何<code>class</code>类型的实例</li>
<li><code>Any</code>：可以表示任何类型，除了方法类型</li>
</ul>
<p><strong>注意：</strong>只有当你明确的需要它的行为和功能时才使用<code>Any</code>和<code>AnyObject</code></p>
</blockquote>
<h3 id="19-4-1-AnyObject类型"><a href="#19-4-1-AnyObject类型" class="headerlink" title="19.4.1    AnyObject类型"></a>19.4.1    <code>AnyObject</code>类型</h3><blockquote>
<p><strong>用途：</strong>在工作中使用 <code>Cocoa APIs</code> 时，我们经常会接收到一个 <code>[AnyObject]</code> 类型的数组，或者说“一个任意类型对象的数组”。这是因为 <code>Objective-C</code> 没有明确的类型化数组。<br><strong>说明：</strong>从 <code>Xcode 7</code> 和 <code>Swift 2.0</code> 开始，由于 <code>Objective-C</code> 引入了轻量泛型，集合类型已经可以类型化了，在 <code>Swift</code> 中使用 <code>Cocoa API</code> 也越来越少遇到 <code>AnyObjec</code> 类型了。<br><strong>技巧：</strong>可以使用强制形式的类型转换<code>as</code>来下转数组中的每一项到比 <code>AnyObject</code> 更明确的类型</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//AnyObject:可以代表任何class类型的实例</span></span><br><span class="line"><span class="keyword">let</span> someObjects:[<span class="type">AnyObject</span>] = [</span><br><span class="line">    <span class="type">Movie</span>(name: <span class="string">"2001:A Space Obyssey"</span>, director: <span class="string">"Stanley Kubrick"</span>),</span><br><span class="line">    <span class="type">Movie</span>(name: <span class="string">"Moon"</span>, director: <span class="string">"Duncan Jones"</span>),</span><br><span class="line">    <span class="type">Movie</span>(name: <span class="string">"Alien"</span>, director: <span class="string">"Ridley Scott"</span>)</span><br><span class="line">]</span><br><span class="line"><span class="comment">//方式一</span></span><br><span class="line"><span class="keyword">for</span> object <span class="keyword">in</span> someObjects&#123;</span><br><span class="line">    <span class="keyword">let</span> movie = object <span class="keyword">as</span> <span class="type">Movie</span></span><br><span class="line">    <span class="built_in">println</span>(<span class="string">"Movie:'\(movie.name)',dir.Stanley Kubrick"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//方式二（更简洁）</span></span><br><span class="line"><span class="keyword">for</span> movie <span class="keyword">in</span> someObjects <span class="keyword">as</span> [<span class="type">Movie</span>]&#123;</span><br><span class="line">    <span class="built_in">println</span>(<span class="string">"Movie:'\(movie.name)',dir.\(movie.director)"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="19-4-2-Any类型"><a href="#19-4-2-Any类型" class="headerlink" title="19.4.2    Any类型"></a>19.4.2    <code>Any</code>类型</h3><p><strong>注意：</strong>在<code>switch</code>语句的<code>case</code>中使用<code>as</code>而不是<code>as?</code>是安全的，不会导致运行时错误</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Any类型</span></span><br><span class="line"><span class="keyword">var</span> things = [<span class="type">Any</span>]()</span><br><span class="line">things.append(<span class="number">0</span>)</span><br><span class="line">things.append(<span class="number">0.0</span>)</span><br><span class="line">things.append(<span class="number">42</span>)</span><br><span class="line">things.append(<span class="number">3.141592654</span>)</span><br><span class="line">things.append(<span class="string">"hello"</span>)</span><br><span class="line">things.append(<span class="type">Movie</span>(name: <span class="string">"Ghostbusters"</span>, director: <span class="string">"Ivan Reitman"</span>))</span><br><span class="line">things.append(&#123;(name:<span class="type">String</span>) -&gt; <span class="type">String</span> <span class="keyword">in</span> <span class="string">"Hello,\(name)"</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> thing <span class="keyword">in</span> things &#123;</span><br><span class="line">    <span class="keyword">switch</span> thing &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span> <span class="keyword">as</span> <span class="type">Int</span>:</span><br><span class="line">        <span class="built_in">println</span>(<span class="string">"zero as an Int"</span>)</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span> <span class="keyword">as</span> <span class="type">Double</span>:</span><br><span class="line">        <span class="built_in">println</span>(<span class="string">"zero as a Double"</span>)</span><br><span class="line">    <span class="keyword">case</span> <span class="keyword">let</span> someInt <span class="keyword">as</span> <span class="type">Int</span>:</span><br><span class="line">        <span class="built_in">println</span>(<span class="string">"an integer value of \(someInt)"</span>)</span><br><span class="line">    <span class="keyword">case</span> <span class="keyword">let</span> someDouble <span class="keyword">as</span> <span class="type">Double</span> <span class="keyword">where</span> someDouble &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">println</span>(<span class="string">"a positive double value of \(someDouble)"</span>)</span><br><span class="line">    <span class="keyword">case</span> <span class="keyword">is</span> <span class="type">Double</span>:</span><br><span class="line">        <span class="built_in">println</span>(<span class="string">"some other double value that I don't want to print"</span>)</span><br><span class="line">    <span class="keyword">case</span> <span class="keyword">let</span> someString <span class="keyword">as</span> <span class="type">String</span>:</span><br><span class="line">        <span class="built_in">println</span>(<span class="string">"a string value of \"\(someString)\""</span>)</span><br><span class="line">    <span class="keyword">case</span> <span class="keyword">let</span> (x, y) <span class="keyword">as</span> (<span class="type">Double</span>, <span class="type">Double</span>):</span><br><span class="line">        <span class="built_in">println</span>(<span class="string">"an (x, y) point at \(x), \(y)"</span>)</span><br><span class="line">    <span class="keyword">case</span> <span class="keyword">let</span> movie <span class="keyword">as</span> <span class="type">Movie</span>:</span><br><span class="line">        <span class="built_in">println</span>(<span class="string">"a movie called '\(movie.name)', dir. \(movie.director)"</span>)</span><br><span class="line">    <span class="keyword">case</span> <span class="keyword">let</span> stringConverter <span class="keyword">as</span> <span class="type">String</span> -&gt; <span class="type">String</span>:</span><br><span class="line">        <span class="built_in">println</span>(stringConverter(<span class="string">"Michael"</span>))</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">println</span>(<span class="string">"something else"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/13/TSPL2_18 错误处理/" itemprop="url">
                  18 错误处理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-13T19:56:39+08:00" content="2016-05-13">
              2016-05-13
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/13/TSPL2_18 错误处理/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/13/TSPL2_18 错误处理/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><strong>说明：</strong><code>错误处理</code>是响应错误以及从错误中恢复的过程。<code>可选类型</code>可用来表示值缺失，但是当某个操作失败时，最好能得知失败的原因，从而可以作出相应的应对。<br><strong>扩展：</strong><code>Swift</code> 中的错误处理涉及到错误处理模式，这会用到 <code>Cocoa</code> 和 <code>Objective-C</code> 中的<code>NSError</code></p>
</blockquote>
<h2 id="18-1-表示并抛出错误"><a href="#18-1-表示并抛出错误" class="headerlink" title="18.1    表示并抛出错误"></a>18.1    表示并抛出错误</h2><blockquote>
<p><strong>说明：</strong>错误用符合<code>ErrorType</code>协议的类型的值来表示。这个空协议表明该类型可以用于错误处理。<br><strong>技巧：</strong>Swift 的<code>枚举</code>类型尤为适合构建一组相关的错误状态，枚举的关联值还可以提供错误状态的额外信息。</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 自动贩卖机错误</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">VendingMachineError</span>: <span class="title">ErrorType</span> </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">InvalidSelection</span><span class="comment">// 选择无效</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">InsufficientFunds</span>(coinsNeeded: <span class="type">Int</span>)<span class="comment">// 金额不足</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">OutOfStock</span><span class="comment">// 缺货</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 抛出“金额不足”的错误</span></span><br><span class="line"><span class="keyword">throw</span> <span class="type">VendingMachineError</span>.<span class="type">InsufficientFunds</span>(coinsNeeded: <span class="number">5</span>)</span><br></pre></td></tr></table></figure>
<h2 id="18-2-处理错误"><a href="#18-2-处理错误" class="headerlink" title="18.2    处理错误"></a>18.2    处理错误</h2><blockquote>
<p><strong>说明：</strong>某个错误被抛出时，附近的某部分代码必须负责处理这个错误。有<code>4</code>中给处理错误的方式</p>
<ul>
<li>把函数<code>抛出</code>的错误传递给调用此函数的代码</li>
<li>用<code>do-catch</code>语句处理错误</li>
<li>将错误作为<code>可选类型</code>处理</li>
<li><code>断言</code>此错误根本不会发生</li>
</ul>
<p><strong>标识可能出错的地方：</strong>在调用一个能抛出错误的<code>函数</code>、<code>方法</code>或者<code>构造器</code>之前，加上<code>try</code>关键字，或者<code>try?</code>或<code>try!</code>这种变体</p>
<p><strong>引伸：</strong>和其他语言中的异常处理不同的是，Swift 中的错误处理并不涉及解除调用栈，就此而言，<code>throw语句</code>的性能特性是可以和<code>return语句</code>相媲美的。</p>
</blockquote>
<h3 id="18-2-1-用throwing函数传递错误"><a href="#18-2-1-用throwing函数传递错误" class="headerlink" title="18.2.1    用throwing函数传递错误"></a>18.2.1    用throwing函数传递错误</h3><blockquote>
<p><strong>说明：</strong>一个标有<code>throws</code>关键字的函数被称作<code>throwing 函数</code>。</p>
<ul>
<li>调用<code>throwing函数</code>必须使用<code>try</code></li>
<li>调用<code>throwing函数</code>必须要么直接处理这些错误（使用<code>do-catch</code>语句，<code>try?</code>或<code>try!</code>）；要么继续将这些错误传递下去</li>
</ul>
<p><strong>用途：</strong>可以在其内部抛出错误，并将错误传递到函数<code>被调用时的作用域</code>。<br><strong>语法：</strong>在函数声明的<code>参数列表</code>和<code>-&gt;</code>之间加上<code>throws</code>关键字。</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">canThrowErrors</span><span class="params">()</span></span> <span class="keyword">throws</span> -&gt; <span class="type">String</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>注意：</strong>只有 <code>throwing函数</code>可以传递错误。任何在某个<code>非 throwing 函数</code>内部抛出的错误只能在函数内部处理。</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 自动贩卖机错误</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">VendingMachineError</span>: <span class="title">ErrorType</span> </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">InvalidSelection</span><span class="comment">// 选择无效</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">InsufficientFunds</span>(coinsNeeded: <span class="type">Int</span>)<span class="comment">// 金额不足</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">OutOfStock</span><span class="comment">// 缺货</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 商品</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Item</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> price: <span class="type">Int</span></span><br><span class="line">    <span class="keyword">var</span> <span class="built_in">count</span>: <span class="type">Int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自动贩卖机</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VendingMachine</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 食品清单</span></span><br><span class="line">    <span class="keyword">var</span> inventory = [</span><br><span class="line">        <span class="string">"Candy Bar"</span>: <span class="type">Item</span>(price: <span class="number">12</span>, <span class="built_in">count</span>: <span class="number">7</span>),</span><br><span class="line">        <span class="string">"Chips"</span>: <span class="type">Item</span>(price: <span class="number">10</span>, <span class="built_in">count</span>: <span class="number">4</span>),</span><br><span class="line">        <span class="string">"Pretzels"</span>: <span class="type">Item</span>(price: <span class="number">7</span>, <span class="built_in">count</span>: <span class="number">11</span>)</span><br><span class="line">    ]</span><br><span class="line">    <span class="comment">// 投币数量</span></span><br><span class="line">    <span class="keyword">var</span> coinsDeposited = <span class="number">0</span></span><br><span class="line">    <span class="comment">// 发放食品</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">dispenseSnack</span><span class="params">(snack: String)</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Dispensing \(snack)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span><br><span class="line">    * 出售</span><br><span class="line">    * throwing方法：会抛出相应错误（如果有的话）</span><br><span class="line">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">vend</span><span class="params">(itemNamed name: String)</span></span> <span class="keyword">throws</span> &#123;</span><br><span class="line">        <span class="comment">// 是否有对应商品</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">var</span> item = inventory[name] <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="type">VendingMachineError</span>.<span class="type">InvalidSelection</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 是否还有剩余</span></span><br><span class="line">        <span class="keyword">guard</span> item.<span class="built_in">count</span> &gt; <span class="number">0</span> <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="type">VendingMachineError</span>.<span class="type">OutOfStock</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 投币是否足够</span></span><br><span class="line">        <span class="keyword">guard</span> item.price &lt;= coinsDeposited <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="type">VendingMachineError</span>.<span class="type">InsufficientFunds</span>(coinsNeeded: item.price - coinsDeposited)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 没问题，进行交易</span></span><br><span class="line">        coinsDeposited -= item.price</span><br><span class="line">        --item.<span class="built_in">count</span></span><br><span class="line">        inventory[name] = item</span><br><span class="line">        dispenseSnack(name)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> favoriteSnacks = [</span><br><span class="line">    <span class="string">"Alice"</span>: <span class="string">"Chips"</span>,</span><br><span class="line">    <span class="string">"Bob"</span>: <span class="string">"Licorice"</span>,</span><br><span class="line">    <span class="string">"Eve"</span>: <span class="string">"Pretzels"</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span><br><span class="line">* 买小吃</span><br><span class="line">*/</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">buyFavoriteSnack</span><span class="params">(person: String, vendingMachine: VendingMachine)</span></span> <span class="keyword">throws</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> snackName = favoriteSnacks[person] ?? <span class="string">"Candy Bar"</span></span><br><span class="line">    <span class="comment">// 调用throwing方法必须使用try关键字</span></span><br><span class="line">    <span class="keyword">try</span> vendingMachine.vend(itemNamed: snackName)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="18-2-2-用Do-Catch处理错误"><a href="#18-2-2-用Do-Catch处理错误" class="headerlink" title="18.2.2    用Do-Catch处理错误"></a>18.2.2    用Do-Catch处理错误</h3><blockquote>
<p><strong>说明：</strong>可以使用一个<code>do-catch</code>语句运行一段闭包代码来处理错误。如果在<code>do</code>子句中的代码抛出了一个错误，这个错误会与<code>catch</code>子句做匹配，从而决定哪条子句能处理它。</p>
<ul>
<li>在<code>catch</code>后面写一个匹配模式来表明这个子句能处理什么样的错误</li>
<li>如果一条<code>catch</code>子句没有指定匹配模式，那么这条子句可以匹配任何错误，并且把错误绑定到一个名字为<code>error</code>的局部常量</li>
<li><code>catch</code>子句不必将<code>do</code>子句中的代码所抛出的每一个可能的错误都作处理</li>
<li>如果所有<code>catch</code>子句都未处理错误，错误就会传递到周围的作用域（要么是一个外围的<code>do-catch</code>错误处理语句，要么是一个<code>throwing</code> 函数的内部）</li>
</ul>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个售卖机实例</span></span><br><span class="line"><span class="keyword">var</span> vendingMachine = <span class="type">VendingMachine</span>()</span><br><span class="line"><span class="comment">// 投币</span></span><br><span class="line">vendingMachine.coinsDeposited = <span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="comment">// 买最喜欢的零食</span></span><br><span class="line">    <span class="keyword">try</span> buyFavoriteSnack(<span class="string">"Alice"</span>, vendingMachine: vendingMachine)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 没有该商品</span></span><br><span class="line"><span class="keyword">catch</span> <span class="type">VendingMachineError</span>.<span class="type">InvalidSelection</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Invalid Selection"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 卖完了</span></span><br><span class="line"><span class="keyword">catch</span> <span class="type">VendingMachineError</span>.<span class="type">OutOfStock</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Out of Stock."</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 投币不足</span></span><br><span class="line"><span class="keyword">catch</span> <span class="type">VendingMachineError</span>.<span class="type">InsufficientFunds</span>(<span class="keyword">let</span> coinsNeeded) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Insufficent funds. Please insert an additional \(coinsNeeded)"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="18-2-3-将错误转换成可选值"><a href="#18-2-3-将错误转换成可选值" class="headerlink" title="18.2.3    将错误转换成可选值"></a>18.2.3    将错误转换成可选值</h3><blockquote>
<p><strong>语法：</strong><code>try?</code><br><strong>说明：</strong>使用<code>try?</code>调用表达式，返回相应表达式返回值的<code>可选类型</code>（如果表达式抛出错误，则表达式<code>nil</code>）<br><strong>技巧：</strong>如果你想对所有的错误都采用同样的方式来处理，用<code>try?</code>就可以让你写出简洁的错误处理代码</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// throwing 函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">someThrowingFunction</span><span class="params">()</span></span> <span class="keyword">throws</span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 调用 throwing 函数 */</span></span><br><span class="line"><span class="comment">// 方式一：使用 try? 调用</span></span><br><span class="line"><span class="keyword">let</span> x = <span class="keyword">try</span>? someThrowingFunction()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式二：方式一的等价形式</span></span><br><span class="line"><span class="keyword">let</span> y: <span class="type">Int</span>?</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    y = <span class="keyword">try</span> someThrowingFunction()</span><br><span class="line">&#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    y = <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从磁盘获取</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fetchDataFromDisk</span><span class="params">()</span></span> -&gt; <span class="type">String</span>? &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从服务器获取</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fetchDataFromServer</span><span class="params">()</span></span> -&gt; <span class="type">String</span>? &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line">* 获取数据</span><br><span class="line">*/</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fetchData</span><span class="params">()</span></span> -&gt; <span class="type">String</span>? &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> data = <span class="keyword">try</span>? fetchDataFromDisk() &#123;</span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> data = <span class="keyword">try</span>? fetchDataFromServer() &#123;</span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="18-2-4-禁用错误传递"><a href="#18-2-4-禁用错误传递" class="headerlink" title="18.2.4        禁用错误传递"></a>18.2.4        禁用错误传递</h3><blockquote>
<p><strong>语法：</strong><code>try!</code><br><strong>说明：</strong>其实就是把<code>抛出错误</code>转变为<code>运行时断言</code><br><strong>应用：</strong>确定<code>throwing</code> 函数实际上在运行时<code>不会抛出错误</code>的才能使用。<br><strong>注意：</strong>如果实际上抛出了错误，你会得到一个运行时错误（而不会传递错误）</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 确定图片资源是存在的</span></span><br><span class="line"><span class="keyword">let</span> photo = <span class="keyword">try</span>! loadImage(<span class="string">"./Resources/John Appleseed.jpg"</span>)</span><br></pre></td></tr></table></figure>
<h2 id="18-3-指定清理操作"><a href="#18-3-指定清理操作" class="headerlink" title="18.3    指定清理操作"></a>18.3    指定清理操作</h2><blockquote>
<p><strong>说明：</strong>使用<code>defer</code>语句指定在即将离开<code>当前代码块</code>时执行一系列语句。<br><strong>支持情景：</strong>不管是以何种方式离开当前代码块的</p>
<ul>
<li>由于抛出错误而离开</li>
<li>诸如<code>return</code>或者<code>break</code>的语句</li>
</ul>
<p><strong>语法：</strong>由<code>defer</code>关键字和要被延迟执行的语句组成</p>
<ul>
<li>延迟执行的语句不能包含任何<code>控制转移语句</code>（<code>break</code>或是<code>return</code>语句，或是抛出一个错误）</li>
<li>延迟执行的操作会按照它们被指定时的顺序的<code>相反顺序</code>执行</li>
</ul>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 处理文件</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processFile</span><span class="params">(filename: String)</span></span> <span class="keyword">throws</span> &#123;</span><br><span class="line">    <span class="comment">// 如果文件存在</span></span><br><span class="line">    <span class="keyword">if</span> exists(filename) &#123;</span><br><span class="line">        <span class="comment">// 打开文件</span></span><br><span class="line">        <span class="keyword">let</span> file = open(filename)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 当前代码块结束时执行</span></span><br><span class="line">        <span class="keyword">defer</span> &#123;</span><br><span class="line">            close(file)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 处理打开的文件</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">let</span> line = <span class="keyword">try</span> file.readline() &#123;</span><br><span class="line">            <span class="comment">// 处理文件。</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 根据 defer 语句的指定，close(file) 会在这里被隐式调用，即作用域的最后。</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/13/TSPL2_17 可选链式调用/" itemprop="url">
                  17 可选链式调用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-13T19:56:10+08:00" content="2016-05-13">
              2016-05-13
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/13/TSPL2_17 可选链式调用/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/13/TSPL2_17 可选链式调用/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><strong>是什么：</strong>是一种可以在当前值可能为<code>nil</code>的可选值上调用属性、方法及下标脚本的过程<br><strong>使用场景</strong>：请求或调用的目标当前可能为空(<code>nil</code>)，这时使用<code>!</code>在一个连续调用的过程中有报错的可能。这时可以用作用域链的方式。<br><strong>特点：</strong></p>
<ol>
<li>如果可选的目标有值，调用成功；否则一律返回<code>nil</code>。</li>
<li>多次请求或调用可以被链接在一起形成一个链，如果任何一个节点为<code>nil</code>，将导致整个链实效。</li>
<li>不论你调用的属性、方法、下标脚本等返回的值是不是可选值，返回结果都是一个可选值。</li>
</ol>
<p><strong>适用类型：</strong>任意类型</p>
</blockquote>
<h2 id="17-1-可选链可替代强制解析"><a href="#17-1-可选链可替代强制解析" class="headerlink" title="17.1    可选链可替代强制解析"></a>17.1    可选链可替代强制解析</h2><blockquote>
<p><strong>说明：</strong>在调用的属性、方法或下标脚本的可选值后面放一个<code>?</code><br><strong>比较（与<code>!</code>）：</strong>当可选值为<code>nil</code>时</p>
</blockquote>
<table>
<thead>
<tr>
<th>强制解析</th>
<th>可选链</th>
</tr>
</thead>
<tbody>
<tr>
<td>引发运行时错误</td>
<td>可选链即刻实效</td>
</tr>
</tbody>
</table>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//人</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span>&#123;</span><br><span class="line">    <span class="comment">//无论该属性是否设置为可选型，都可以通过可选链的方式（?）访问</span></span><br><span class="line">    <span class="keyword">var</span> residence:<span class="type">Residence</span>?</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//住宅</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Residence</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> numberOfRooms = <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//实例化一个人的实例，拥有一个默认值为nil的可选型属性</span></span><br><span class="line"><span class="keyword">let</span> john = <span class="type">Person</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">//let roomCount = join.residence!.numberOfRooms//join.residence使用感叹号将导致运行时错误</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line">*join.residence?.numberOfRooms：始终返回一个可选型（不会像!，当join.residence为nil时报错）</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> roomCount = john.residence?.numberOfRooms &#123;</span><br><span class="line">    <span class="built_in">println</span>(<span class="string">"John's residence has \(roomCount) room(s)."</span>)</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="built_in">println</span>(<span class="string">"Unable to retrieve the number of rooms."</span>)<span class="comment">//residence的值为nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="17-2-为可选链定义模型类"><a href="#17-2-为可选链定义模型类" class="headerlink" title="17.2    为可选链定义模型类"></a>17.2    为可选链定义模型类</h2><blockquote>
<p><strong>和定义普通类区别：</strong>期望用可选链调用的属性应当定义为可选型</p>
</blockquote>
<h2 id="17-3-通过可选链调用属性"><a href="#17-3-通过可选链调用属性" class="headerlink" title="17.3    通过可选链调用属性"></a>17.3    通过可选链调用属性</h2><blockquote>
<p><strong>方式：</strong>调用时在属性后面添加后缀<code>?</code></p>
</blockquote>
<h2 id="17-4-通过可选链调用方法"><a href="#17-4-通过可选链调用方法" class="headerlink" title="17.4    通过可选链调用方法"></a>17.4    通过可选链调用方法</h2><blockquote>
<p><strong>方式：</strong>调用时在方法名后面添加后缀<code>?</code></p>
</blockquote>
<h2 id="17-5-使用可选链调用下标脚本"><a href="#17-5-使用可选链调用下标脚本" class="headerlink" title="17.5    使用可选链调用下标脚本"></a>17.5    使用可选链调用下标脚本</h2><blockquote>
<p><strong>方式：</strong>在下标脚本括号的前面添加<code>?</code></p>
</blockquote>
<h2 id="17-6-连接多层可选链式调用"><a href="#17-6-连接多层可选链式调用" class="headerlink" title="17.6    连接多层可选链式调用"></a>17.6    连接多层可选链式调用</h2><blockquote>
<p><strong>说明：</strong>可以通过连接多个可选链式调用在更深的模型层级中访问属性、方法以及下标。</p>
<ul>
<li>如果你访问的值不是可选的，可选链式调用将会返回可选值</li>
<li>如果你访问的值就是可选的，可选链式调用不会让可选返回值变得“更可选”</li>
</ul>
</blockquote>
<h2 id="17-7-链接可选返回值的方法"><a href="#17-7-链接可选返回值的方法" class="headerlink" title="17.7    链接可选返回值的方法"></a>17.7    链接可选返回值的方法</h2><p><strong>说明：</strong>除了获得可选类型属性值，还可以通过可选链调用一个返回可选类型值的方法并按需链接该方法的返回值。<br><strong>方式：</strong>在调用方法的括号的后面添加<code>?</code></p>
<p>#综合案例：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//人</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span>&#123;</span><br><span class="line">    <span class="comment">//无论该属性是否设置为可选型，都可以通过可选链的方式（?）访问</span></span><br><span class="line">    <span class="keyword">var</span> residence:<span class="type">Residence</span>?</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//房间</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Room</span></span>&#123;</span><br><span class="line">    <span class="keyword">let</span> name:<span class="type">String</span></span><br><span class="line">    <span class="keyword">init</span>(name:<span class="type">String</span>)&#123;</span><br><span class="line">        <span class="keyword">self</span>.name = name</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//住宅</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Residence</span></span>&#123;</span><br><span class="line">    <span class="comment">//存储房间的数组</span></span><br><span class="line">    <span class="keyword">var</span> rooms = [<span class="type">Room</span>]()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//计算属性（返回房间数）</span></span><br><span class="line">    <span class="keyword">var</span> numberOfRooms:<span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> rooms.<span class="built_in">count</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//下标脚本（使能通过下标直接访问房间）</span></span><br><span class="line">    <span class="keyword">subscript</span>(i:<span class="type">Int</span>)-&gt;<span class="type">Room</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> rooms[i]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span><br><span class="line">    *打印房间数目</span><br><span class="line">    *有一个隐式的返回值类型void，使用可选链的方式调用返回void?(可选型)</span><br><span class="line">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">printNumberOfRooms</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">println</span>(<span class="string">"The number of rooms is \(numberOfRooms)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//地址</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Address</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> buildingName:<span class="type">String</span>?<span class="comment">//大厦名称</span></span><br><span class="line">    <span class="keyword">var</span> buildingNumber:<span class="type">String</span>?<span class="comment">//楼牌号</span></span><br><span class="line">    <span class="keyword">var</span> street:<span class="type">String</span>?<span class="comment">//大街</span></span><br><span class="line">    <span class="comment">//获得大厦的名称或楼牌号</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">buildingIdentifier</span><span class="params">()</span></span> -&gt; <span class="type">String</span>?&#123;</span><br><span class="line">        <span class="keyword">if</span> (buildingName != <span class="literal">nil</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> buildingName</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(buildingNumber != <span class="literal">nil</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> buildingNumber</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//实例化一个人的实例，拥有一个默认值为nil的可选型属性</span></span><br><span class="line"><span class="keyword">let</span> john = <span class="type">Person</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">//通过可选链调用属性:下面的写法有问题，不知道为什么</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> roomCount = john.residence?.numberOfRooms &#123;</span><br><span class="line">    <span class="built_in">println</span>(<span class="string">"John's residence has \(roomCount) rooms."</span>)</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="built_in">println</span>(<span class="string">"Unable to retrieve the number of rooms."</span>)<span class="comment">//residence的值为nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//通过可选链调用方法:下面的写法报错了，不明白为什么</span></span><br><span class="line"><span class="keyword">if</span> john.residence?.printNumberOfRooms?()&#123;</span><br><span class="line">    <span class="built_in">println</span>(<span class="string">"It was possible to print the number of rooms."</span>)</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="built_in">println</span>(<span class="string">"It was possible to print the number of rooms."</span>)<span class="comment">//john的residence不存在</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//通过可选链调用下标脚本</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> firstRoomName = <span class="built_in">join</span>.residence?[<span class="number">0</span>].name&#123;</span><br><span class="line">    <span class="built_in">println</span>(<span class="string">"The first room name is \(firstRoomName)."</span>)</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="built_in">println</span>(<span class="string">"Unable to retrieve the fit=rst room name."</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> johnsHouse = <span class="type">Residence</span>()</span><br><span class="line">johnsHouse.rooms += <span class="type">Room</span>(name:<span class="string">"Living Room"</span>)</span><br><span class="line">johnsHouse.rooms += <span class="type">Room</span>(name:<span class="string">"Kitchen"</span>)</span><br><span class="line">john.residence = johnsHouse</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> firstRoomName = john.residence?[<span class="number">0</span>].name&#123;</span><br><span class="line">    <span class="built_in">println</span>(<span class="string">"The first room name is \(firstRoomName)."</span>)</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="built_in">println</span>(<span class="string">"Unable to retrieve the first room name."</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//连接多层链接</span></span><br><span class="line"><span class="keyword">let</span> johnsAddress = <span class="type">Address</span>()</span><br><span class="line">johnsAddress.buildingName = <span class="string">"The Larches"</span></span><br><span class="line">johnsAddress.street = <span class="string">"Laurel Street"</span></span><br><span class="line">john.residence!.address = johnsAddress</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> johnsStreet = john.residence?.address?.street&#123;</span><br><span class="line">    <span class="built_in">println</span>(<span class="string">"John's street name is \(johnsStreet)."</span>)</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="built_in">println</span>(<span class="string">"Unable to retrieve the address."</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//链接可选返回值的方法</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> buildingIdentifier = john.residence?.address?.buildingIdentifier()&#123;</span><br><span class="line">    <span class="built_in">println</span>(<span class="string">"John's building idetifier is \(buildingIdentifier)"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> upper = john.residence?.address?.buildingIdentifier()?.uppercaseString&#123;</span><br><span class="line">    <span class="built_in">println</span>(<span class="string">"John's uppercase building identifier is \(upper)"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/13/TSPL2_16 自动引用计数(ARC)/" itemprop="url">
                  16 自动引用计数（ARC）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-13T19:47:34+08:00" content="2016-05-13">
              2016-05-13
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/13/TSPL2_16 自动引用计数(ARC)/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/13/TSPL2_16 自动引用计数(ARC)/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><strong>说明：</strong><code>Swift</code> 使用自动引用计数<code>（ARC）</code>机制来跟踪和管理你的应用程序的内存。<br><strong>适用类型：</strong>类(结构体和枚举是值类型)</p>
</blockquote>
<h2 id="16-1-自动引用计数的工作机制"><a href="#16-1-自动引用计数的工作机制" class="headerlink" title="16.1        自动引用计数的工作机制"></a>16.1        自动引用计数的工作机制</h2><blockquote>
<p><strong>说明：</strong>当你每次创建一个类的新的实例的时候，<code>ARC</code> 会分配一大块内存用来储存实例的信息。内存中会包含实例的类型信息，以及这个实例所有相关属性的值。</p>
<p><strong>强引用：</strong>无论将实例赋值给<code>属性</code>、<code>常量</code>还是<code>变量</code>，都会对此实例创建<code>强引用</code>。当一个实例的引用计数为0时，实例将被<code>ARC</code>销毁。</p>
</blockquote>
<h2 id="16-2-自动引用计数实践"><a href="#16-2-自动引用计数实践" class="headerlink" title="16.2        自动引用计数实践"></a>16.2        自动引用计数实践</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.创建类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> name:<span class="type">String</span></span><br><span class="line">    <span class="keyword">init</span>(name:<span class="type">String</span>)&#123;</span><br><span class="line">        <span class="keyword">self</span>.name = name</span><br><span class="line">        <span class="built_in">println</span>(<span class="string">"\(name) is being initialized"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">deinit</span>&#123;</span><br><span class="line">        <span class="built_in">println</span>(<span class="string">"\(name) is being deinitialized"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//2.创建实例</span></span><br><span class="line"><span class="keyword">var</span> reference1:<span class="type">Person</span>?</span><br><span class="line"><span class="keyword">var</span> reference2:<span class="type">Person</span>?</span><br><span class="line"><span class="keyword">var</span> reference3:<span class="type">Person</span>?</span><br><span class="line"></span><br><span class="line"><span class="comment">//reference1和Person类的新实例之间建立了一个强引用</span></span><br><span class="line">reference1 = <span class="type">Person</span>(name: <span class="string">"Join Appleseed"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//为该实例再增加两个强引用</span></span><br><span class="line">reference2 = reference1</span><br><span class="line">reference3 = reference1</span><br><span class="line"></span><br><span class="line"><span class="comment">//3.断开所有强引用，之后ARC销毁实例的内存</span></span><br><span class="line">reference1 = <span class="literal">nil</span></span><br><span class="line">reference2 = <span class="literal">nil</span></span><br><span class="line">reference3 = <span class="literal">nil</span></span><br></pre></td></tr></table></figure>
<h2 id="16-3-类实例之间的循环强引用"><a href="#16-3-类实例之间的循环强引用" class="headerlink" title="16.3        类实例之间的循环强引用"></a>16.3        类实例之间的循环强引用</h2><blockquote>
<p><strong>循环强引用：</strong>两个类实例互相保持对方的<code>强引用</code>，并让对方不被销毁。<br><strong>解决思路：</strong>通过定义类之间的关系为<code>弱引用</code>或<code>无主引用</code>，以此替代强引用。</p>
</blockquote>
<table>
<thead>
<tr>
<th>细分情况</th>
<th>分析（两个实例各自引用对方的属性）</th>
<th>解决思路</th>
</tr>
</thead>
<tbody>
<tr>
<td>情况1</td>
<td>都允许为<code>nil</code></td>
<td>其中一个属性使用<code>弱引用</code></td>
</tr>
<tr>
<td>情况2</td>
<td>一个允许为<code>nil</code>，另一个不允许</td>
<td>不允许为<code>nil</code>的属性使用<code>无主引用</code></td>
</tr>
<tr>
<td>情况3</td>
<td>都不允许为<code>nil</code></td>
<td>一个使用<code>无主引用</code>，一个使用<code>隐式解析可选属性</code></td>
</tr>
</tbody>
</table>
<h2 id="16-4-解决实例之间的循环强引用"><a href="#16-4-解决实例之间的循环强引用" class="headerlink" title="16.4        解决实例之间的循环强引用"></a>16.4        解决实例之间的循环强引用</h2><blockquote>
<p><strong>解决方法：</strong>用弱引用或无主导引用替代强引用</p>
<ol>
<li><strong>弱引用（weak reference）适用：</strong>生命周期中会变为<code>nil</code>的实例</li>
<li><strong>无主引用（unowned reference）适用：</strong>初始化赋值后再也不会被赋值为nil的实例</li>
</ol>
</blockquote>
<h3 id="16-4-1-弱引用"><a href="#16-4-1-弱引用" class="headerlink" title="16.4.1        弱引用"></a>16.4.1        弱引用</h3><blockquote>
<p><strong>关键字：</strong><code>weak</code><br><strong>说明：</strong>弱引用不会对其引用的实例保持强引用，因而不会阻止 <code>ARC</code> 销毁被引用的实例</p>
<ul>
<li>因为弱引用可以没有值，你必须将每一个弱引用声明为可选类型</li>
<li>弱引用必须被声明为变量（<code>var</code>），表明需要在运行时修改</li>
<li><code>ARC</code>在引用的实例被销毁之后自动将弱引用关联的变量或属性赋值为<code>nil</code></li>
</ul>
<p><strong>语法：</strong>声明<code>属性</code>或者<code>变量</code>时，在前面加上<code>weak</code>关键字</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> name:<span class="type">String</span></span><br><span class="line">    <span class="keyword">init</span>(name:<span class="type">String</span>)&#123;</span><br><span class="line">        <span class="keyword">self</span>.name = name</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> apartment:<span class="type">Apartment</span>?</span><br><span class="line">    <span class="keyword">deinit</span>&#123;</span><br><span class="line">        <span class="built_in">println</span>(<span class="string">"Apartment #\(name) is being dinitialized"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//旅馆可以没有客人，客人声明为弱引用类型</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Apartment</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> number:<span class="type">Int</span></span><br><span class="line">    <span class="keyword">init</span>(number:<span class="type">Int</span>)&#123;</span><br><span class="line">        <span class="keyword">self</span>.number = number</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">weak</span> <span class="keyword">var</span> tenant:<span class="type">Person</span>?</span><br><span class="line">    <span class="keyword">deinit</span>&#123;</span><br><span class="line">        <span class="built_in">println</span>(<span class="string">"Apartment #\(number) is being deinitialized"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建实例</span></span><br><span class="line"><span class="keyword">var</span> john:<span class="type">Person</span>?</span><br><span class="line"><span class="keyword">var</span> number73:<span class="type">Apartment</span>?</span><br><span class="line">john = <span class="type">Person</span>(name: <span class="string">"John Appleseed"</span>)</span><br><span class="line">number73 = <span class="type">Apartment</span>(number: <span class="number">73</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//引用</span></span><br><span class="line">john!.apartment = number73<span class="comment">//强引用</span></span><br><span class="line">number73!.tenant = john<span class="comment">//弱引用</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//断开两个实例和变量之间的引用（引用计数降为0）</span></span><br><span class="line">john = <span class="literal">nil</span><span class="comment">//因为另一个指向Person实例的引用是弱引用，因此Person实例被销毁</span></span><br><span class="line">number73 = <span class="literal">nil</span><span class="comment">//另一个指向Apartment实例的引用所在的实例已经被销毁，因此Apartment此时讲呗销毁</span></span><br></pre></td></tr></table></figure>
<h3 id="16-4-2-无主引用"><a href="#16-4-2-无主引用" class="headerlink" title="16.4.2        无主引用"></a>16.4.2        无主引用</h3><blockquote>
<p><strong>关键字：</strong><code>unowned</code><br><strong>说明：</strong>在声明属性或者变量时，在前面加上关键字unowned表示这是一个无主引用。</p>
<ul>
<li>不会牢牢保持住引用的实例</li>
<li>总是被定义为非可选型（永远是有值的），总是可以被直接访问</li>
<li><code>ARC</code>无法在实例被销毁后将无主引用设为<code>nil</code>（因为非可选类型的变量不允许被赋值为<code>nil</code>）</li>
</ul>
<p><strong>注意：</strong>使用无主引用，必须确保引用始终指向一个未销毁的实例。</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//用户</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Customer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> name:<span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> card:<span class="type">CreditCard</span>?</span><br><span class="line">    <span class="keyword">init</span>(name:<span class="type">String</span>)&#123;</span><br><span class="line">        <span class="keyword">self</span>.name = name</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">deinit</span>&#123;</span><br><span class="line">        <span class="built_in">println</span>(<span class="string">"\(name) is being deinitialized"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//信用卡</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CreditCard</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> number:<span class="type">Int</span></span><br><span class="line">    <span class="keyword">unowned</span> <span class="keyword">let</span> customer:<span class="type">Customer</span></span><br><span class="line">    <span class="keyword">init</span>(number:<span class="type">Int</span>, customer:<span class="type">Customer</span>)&#123;</span><br><span class="line">        <span class="keyword">self</span>.number = number</span><br><span class="line">        <span class="keyword">self</span>.customer = customer</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">deinit</span>&#123;</span><br><span class="line">        <span class="built_in">println</span>(<span class="string">"Card #\(number) is being deinitialized"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> john:<span class="type">Customer</span>?</span><br><span class="line">john = <span class="type">Customer</span>(name: <span class="string">"John Appleseed"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//给john一张信用卡（同时给信用卡关联一个用户）</span></span><br><span class="line">john!.card = <span class="type">CreditCard</span>(number:<span class="number">1234_5678_9021_3456</span>, customer:john!)</span><br><span class="line"></span><br><span class="line"><span class="comment">//Customer实例的引用被断开后，实例被销毁，同时断开了对信用卡实例的引用，因此信用卡实例也被销毁</span></span><br><span class="line">john = <span class="literal">nil</span></span><br></pre></td></tr></table></figure>
<h3 id="16-4-3-无主引用以及隐式可选属性"><a href="#16-4-3-无主引用以及隐式可选属性" class="headerlink" title="16.4.3         无主引用以及隐式可选属性"></a>16.4.3         无主引用以及隐式可选属性</h3><blockquote>
<p><strong>说明：</strong>两个属性都必须有值，并且初始化完成后永远不会为<code>nil</code>。在这种场景中，需要一个类使用<code>无主属性</code>，而另外一个类使用<code>隐式解析可选属性</code>。</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//国家</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Country</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> name:<span class="type">String</span></span><br><span class="line">    <span class="comment">//首都：声明为隐式解析可选类型的属性，默认值为nil，但是不需要展开值就能够访问。</span></span><br><span class="line">    <span class="keyword">let</span> capitality:<span class="type">City</span>!</span><br><span class="line">    <span class="keyword">init</span>(name:<span class="type">String</span>, capitalName:<span class="type">String</span>)&#123;</span><br><span class="line">        <span class="keyword">self</span>.name = name<span class="comment">//给name属性赋值后，构造过程第一阶段就结束了（完成初始化）</span></span><br><span class="line">        <span class="keyword">self</span>.capitality = <span class="type">City</span>(name:capitalName, country:<span class="keyword">self</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//城市</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">City</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> name:<span class="type">String</span></span><br><span class="line">    <span class="keyword">unowned</span> <span class="keyword">let</span> country:<span class="type">Country</span></span><br><span class="line">    <span class="keyword">init</span>(name:<span class="type">String</span>, country:<span class="type">Country</span>)&#123;</span><br><span class="line">        <span class="keyword">self</span>.name = name</span><br><span class="line">        <span class="keyword">self</span>.country = country</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> country = <span class="type">Country</span>(name: <span class="string">"Canada"</span>, capitalName: <span class="string">"Ottawa"</span>)</span><br></pre></td></tr></table></figure>
<h2 id="16-5-闭包引起的循环强引用"><a href="#16-5-闭包引起的循环强引用" class="headerlink" title="16.5        闭包引起的循环强引用"></a>16.5        闭包引起的循环强引用</h2><blockquote>
<p><strong>原理：</strong>实例内部的闭包捕获<code>self</code>，从而在实例和闭包之间产生循环强引用。<br><strong>情景：</strong></p>
<ol>
<li>闭包中访问实例的属性（<code>self.someproperty</code>）</li>
<li>闭包中访问实例的方法（<code>self.someMethod</code>）</li>
</ol>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HTMLElement</span> </span>&#123;</span><br><span class="line">    <span class="comment">//元素名称</span></span><br><span class="line">    <span class="keyword">let</span> name:<span class="type">String</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//元素文本</span></span><br><span class="line">    <span class="keyword">let</span> text:<span class="type">String</span>?</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//闭包:根据text是否存在值，该闭包返回带文本的标签或仅仅是标签</span></span><br><span class="line">    <span class="comment">//声明为lazy:意味着使用该闭包时，实例的初始化一定已经完成，因此在闭包中可以访问`self`</span></span><br><span class="line">    <span class="built_in">lazy</span> <span class="keyword">var</span> asHTML:()-&gt;<span class="type">String</span>=&#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> text = <span class="keyword">self</span>.text &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"&lt;\(self.name)\(text)&lt;/\(self.name)&gt;"</span></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"&lt;\(self.name)&gt;"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//构造器</span></span><br><span class="line">    <span class="keyword">init</span>(name:<span class="type">String</span>, text:<span class="type">String</span>? = <span class="literal">nil</span>)&#123;</span><br><span class="line">        <span class="keyword">self</span>.name = name</span><br><span class="line">        <span class="keyword">self</span>.text = text</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//析构函数</span></span><br><span class="line">    <span class="keyword">deinit</span>&#123;</span><br><span class="line">        <span class="built_in">println</span>(<span class="string">"\(name) is being deinitialized"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> paragraph:<span class="type">HTMLElement</span>? = <span class="type">HTMLElement</span>(name: <span class="string">"p"</span>, text: <span class="string">"hello, world"</span>)<span class="comment">//该类实例和其中的闭包之间产生了循环强引用</span></span><br><span class="line"><span class="built_in">println</span>(paragraph!.asHTML())</span><br><span class="line"></span><br><span class="line">paragraph = <span class="literal">nil</span><span class="comment">//实例并没有被销毁</span></span><br></pre></td></tr></table></figure>
<h2 id="16-6-解决闭包引起的循环强引用"><a href="#16-6-解决闭包引起的循环强引用" class="headerlink" title="16.6        解决闭包引起的循环强引用"></a>16.6        解决闭包引起的循环强引用</h2><blockquote>
<p><strong>捕获列表：</strong>定义了闭包体内捕获一个或多个引用类型的规则（<code>弱引用</code>或<code>无主引用</code>）。<br><strong>解决方式：</strong>在定义<code>闭包</code>时同时定义<code>捕获列表</code>作为闭包的一部分<br><strong>注意：</strong>只要在闭包中使用<code>self</code>的成员，就要用<code>self.someProperty</code>或<code>self.someMethod</code></p>
</blockquote>
<h3 id="16-6-1-定义捕获列表"><a href="#16-6-1-定义捕获列表" class="headerlink" title="16.6.1        定义捕获列表"></a>16.6.1        定义捕获列表</h3><blockquote>
<p><strong>捕获列表：</strong>[{<code>weak</code>|<code>unknowed</code>} {实例}, {<code>weak</code>|<code>unknowed</code>} {实例}, …]<br><strong>说明：</strong>捕获列表中的每一项都由一对元素组成，一个元素是<code>weak</code>或<code>unowned</code>关键字，另一个元素是类实例的引用</p>
<ol>
<li>捕获列表放在闭包参数和返回值之前（需要指出闭包的参数和返回值类型）：有参数列表和返回类型</li>
</ol>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//类或结构体中定义一个闭包</span></span><br><span class="line"><span class="built_in">lazy</span> <span class="keyword">var</span> someClosure:(<span class="type">Int</span>, <span class="type">String</span>) -&gt; <span class="type">String</span> = &#123;</span><br><span class="line">    <span class="comment">// 闭包定义一个捕获列表</span></span><br><span class="line">    [<span class="keyword">unowned</span> <span class="keyword">self</span>, <span class="keyword">weak</span> delegate = <span class="keyword">self</span>.delegate] (index:<span class="type">Int</span>, stringToProcess:<span class="type">String</span>) -&gt; <span class="type">String</span> <span class="keyword">in</span></span><br><span class="line">    <span class="comment">// 下面时闭包函数体</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<ol>
<li>通过上下文推断（省略类型说明）：闭包没有定义参数列表或返回值时</li>
</ol>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">lazy</span> <span class="keyword">var</span> someClosure:()-&gt;<span class="type">String</span> = &#123;</span><br><span class="line">	<span class="comment">// 定义捕获列表</span></span><br><span class="line">    [unknowed <span class="keyword">self</span>, <span class="keyword">weak</span> delegate = <span class="keyword">self</span>.delegate] <span class="keyword">in</span></span><br><span class="line">    <span class="comment">// 下面时闭包函数体</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="16-6-2-弱引用和无主引用"><a href="#16-6-2-弱引用和无主引用" class="headerlink" title="16.6.2        弱引用和无主引用"></a>16.6.2        弱引用和无主引用</h3><blockquote>
<p><strong>说明：</strong><code>捕获列表</code>中引用的引用类型可以是<code>weak</code>或<code>unowned</code>，选择的依据是</p>
<ul>
<li>捕获的引用绝对不会为<code>nil</code>：将闭包内的捕获定义为<code>无主引用</code></li>
<li>捕获引用有可能为<code>nil</code>：将闭包内的捕获定义为<code>弱引用</code>（可选型）</li>
</ul>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HTMLElement</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 元素名称</span></span><br><span class="line">    <span class="keyword">let</span> name:<span class="type">String</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 元素文本</span></span><br><span class="line">    <span class="keyword">let</span> text:<span class="type">String</span>?</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 闭包:根据text是否存在值，该闭包返回带文本的标签或仅仅是标签</span></span><br><span class="line">    <span class="comment">// 声明为lazy:意味着使用该闭包时，实例的初始化一定已经完成，因此在必报中可以访问`self`</span></span><br><span class="line">    <span class="built_in">lazy</span> <span class="keyword">var</span> asHTML:<span class="type">Void</span> &gt; <span class="type">String</span> = &#123;</span><br><span class="line">        [<span class="keyword">unowned</span> <span class="keyword">self</span>] <span class="keyword">in</span><span class="comment">// 用无助引用而不是强引用捕获`self`</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> text = <span class="keyword">self</span>.text &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"&lt;\(self.name)\(text)&lt;/\(self.name)&gt;"</span></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"&lt;\(self.name)&gt;"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构造器</span></span><br><span class="line">    <span class="keyword">init</span>(name:<span class="type">String</span>, text:<span class="type">String</span>? = <span class="literal">nil</span>)&#123;</span><br><span class="line">        <span class="keyword">self</span>.name = name</span><br><span class="line">        <span class="keyword">self</span>.text = text</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 析构函数</span></span><br><span class="line">    <span class="keyword">deinit</span>&#123;</span><br><span class="line">        <span class="built_in">println</span>(<span class="string">"\(name) is being deinitialized"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> paragraph:<span class="type">HTMLElement</span>? = <span class="type">HTMLElement</span>(name: <span class="string">"p"</span>, text: <span class="string">"hello, world"</span>)<span class="comment">// 该类实例和其中的闭包之间产生了循环强引用</span></span><br><span class="line"><span class="built_in">println</span>(paragraph!.asHTML())</span><br><span class="line"></span><br><span class="line">paragraph = <span class="literal">nil</span><span class="comment">// 实例被销毁</span></span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/13/TSPL2_15 析构过程/" itemprop="url">
                  15 析构过程
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-13T19:47:13+08:00" content="2016-05-13">
              2016-05-13
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/13/TSPL2_15 析构过程/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/13/TSPL2_15 析构过程/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><strong>关键字：</strong><code>deinit</code><br><strong>支持：</strong>类<br><strong>数量：</strong>最多一个<br><strong>参数：</strong>无<br><strong>如何被调用：</strong>类的实例被释放之前自动调用（不允许主动调用）<br><strong>用途：</strong>当实例释放时进行一些额外的处理（比如关闭打开的文件）</p>
</blockquote>
<h2 id="15-1-析构过程原理"><a href="#15-1-析构过程原理" class="headerlink" title="15.1        析构过程原理"></a>15.1        析构过程原理</h2><blockquote>
<p><strong>语法：</strong>不带<code>()</code>也不需要<code>参数</code></p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">deinit</span>&#123;</span><br><span class="line">	<span class="comment">// 手动释放一些资源</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>父类析构器的调用：</strong></p>
</blockquote>
<table>
<thead>
<tr>
<th>子类是否定义了析构函数</th>
<th>具体析构过程</th>
</tr>
</thead>
<tbody>
<tr>
<td>是</td>
<td>子类析构函数实现的最后，父类的析构函数被调用</td>
</tr>
<tr>
<td>否</td>
<td>父类的析构函数被自动调用</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>访问属性：</strong>可以访问所有请求实例的属性</p>
</blockquote>
<h2 id="15-2-析构过程操作"><a href="#15-2-析构过程操作" class="headerlink" title="15.2        析构过程操作"></a>15.2        析构过程操作</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//银行</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Bank</span> </span>&#123;</span><br><span class="line">    <span class="comment">//硬币数量</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> coinsInBank = <span class="number">10_000</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//分发硬币</span></span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">vendCoins</span><span class="params">(<span class="keyword">var</span> numberOfCoinsToVend:Int)</span></span>-&gt;<span class="type">Int</span>&#123;</span><br><span class="line">        numberOfCoinsToVend = <span class="built_in">min</span>(numberOfCoinsToVend, coinsInBank)</span><br><span class="line">        coinsInBank -= numberOfCoinsToVend</span><br><span class="line">        <span class="keyword">return</span> numberOfCoinsToVend</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获得硬币</span></span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">receiveCoins</span><span class="params">(coins:Int)</span></span>&#123;</span><br><span class="line">        coinsInBank += coins</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//玩家</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Player</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> coinsInPurse:<span class="type">Int</span></span><br><span class="line">    <span class="comment">//初始化玩家的硬币数量</span></span><br><span class="line">    <span class="keyword">init</span>(coins:<span class="type">Int</span>)&#123;</span><br><span class="line">        coinsInPurse = <span class="type">Bank</span>.vendCoins(coins)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//玩家从银行获得硬币</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">winCoins</span><span class="params">(coins:Int)</span></span>&#123;</span><br><span class="line">        coinsInPurse += <span class="type">Bank</span>.vendCoins(coins)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//玩家退出时归还所有硬币</span></span><br><span class="line">    <span class="keyword">deinit</span>&#123;</span><br><span class="line">        <span class="type">Bank</span>.receiveCoins(coinsInPurse)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> playerOne:<span class="type">Player</span>? = <span class="type">Player</span>(coins: <span class="number">100</span>)<span class="comment">//拥有100个硬币的玩家</span></span><br><span class="line">playerOne!.winCoins(<span class="number">2_000</span>)<span class="comment">//赢得2000个硬币</span></span><br><span class="line">playerOne = <span class="literal">nil</span><span class="comment">//玩家退出</span></span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/13/TSPL2_14  构造过程/" itemprop="url">
                  14 构造过程
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-13T19:46:54+08:00" content="2016-05-13">
              2016-05-13
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/13/TSPL2_14  构造过程/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/13/TSPL2_14  构造过程/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><strong>构造过程：</strong>为某个类、结构体或枚举的实例中的每个属性设置初始值和为其执行必要准备和初始化任务。<br><strong>构造器：</strong>用来创建特定类型实例的特殊方法，保证实例在第一次使用前完成正确的初始化。</p>
</blockquote>
<h2 id="14-1-存储型属性的初始赋值"><a href="#14-1-存储型属性的初始赋值" class="headerlink" title="14.1    存储型属性的初始赋值"></a>14.1    存储型属性的初始赋值</h2><blockquote>
<p><strong>背景：</strong>类和结构体在创建实例时，必须为所有<code>存储型属性</code>设置合适的初始值。存储型属性的值不能处于一个未知的状态。<br><strong>说明：</strong>可以在<code>构造器中</code>为存储型属性赋初值，也可以在<code>定义属性时</code>为其设置默认值</p>
</blockquote>
<table>
<thead>
<tr>
<th>初始化时机</th>
<th>初始化方式</th>
<th>是否触发属性观察器</th>
<th>是否自动推导类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>定义属性时</td>
<td>设置默认值</td>
<td>否</td>
<td>是</td>
</tr>
<tr>
<td>构造器中</td>
<td>为存储型属性赋初始值</td>
<td>否</td>
<td>否</td>
</tr>
</tbody>
</table>
<h3 id="14-1-1-构造器"><a href="#14-1-1-构造器" class="headerlink" title="14.1.1    构造器"></a>14.1.1    构造器</h3><blockquote>
<p><strong>说明：</strong>构造器在创建某个特定类型的新实例时被调用，以<code>init</code>关键字声明构造函数</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Fahrenheit</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> temperature:<span class="type">Double</span></span><br><span class="line">    <span class="keyword">init</span>()&#123;</span><br><span class="line">        temperature = <span class="number">32.0</span><span class="comment">//在构造其中为存储型属性赋初值</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> f = <span class="type">Fahrenheit</span>()</span><br><span class="line"><span class="built_in">println</span>(<span class="string">"The default temperature is \(f.temperature) Fahrenheit"</span>)</span><br></pre></td></tr></table></figure>
<h3 id="14-1-2-默认属性值"><a href="#14-1-2-默认属性值" class="headerlink" title="14.1.2        默认属性值"></a>14.1.2        默认属性值</h3><blockquote>
<p><strong>说明：</strong>相比<code>在构造器中设置初始值</code>有如下优点</p>
<ol>
<li>将属性的声明和初始化结合得更紧密</li>
<li>使构造器更加简洁、清晰</li>
<li>能够自动推导出属性的类型（不需要声明属性的类型）</li>
<li>充分利用默认构造器、构造器继承</li>
</ol>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Fahrenheit</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> temperature = <span class="number">32.0</span><span class="comment">//在构造其中为存储型属性赋初值</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="14-2-自定义构造过程"><a href="#14-2-自定义构造过程" class="headerlink" title="14.2    自定义构造过程"></a>14.2    自定义构造过程</h2><h3 id="14-2-1-构造参数"><a href="#14-2-1-构造参数" class="headerlink" title="14.2.1    构造参数"></a>14.2.1    构造参数</h3><blockquote>
<p><strong>说明：</strong>构造器参数的功能和语法跟函数和方法参数相同。</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Celsius</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> temperatureInCelsius:<span class="type">Double</span> = <span class="number">0.0</span></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">    *第一个构造器：带有一个构造参数</span><br><span class="line">    *外部名：fromFahrenheit;内部名：fahreheit</span><br><span class="line">    */</span></span><br><span class="line">    <span class="keyword">init</span>(fromFshreheit fahreheit:<span class="type">Double</span>)&#123;</span><br><span class="line">        temperatureInCelsius = (fahreheit - <span class="number">32.0</span>) / <span class="number">1.8</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">    *第二个构造器：带有一个构造参数</span><br><span class="line">    *外部名：fromKelvin;内部名：kelvin</span><br><span class="line">    */</span></span><br><span class="line">    <span class="keyword">init</span>(fromKelvin kelvin:<span class="type">Double</span>)&#123;</span><br><span class="line">        temperatureInCelsius = kelvin - <span class="number">273.15</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> boilingPointOfWater = <span class="type">Celsius</span>(fromFshreheit: <span class="number">212.0</span>)</span><br><span class="line"><span class="keyword">let</span> freezingPointOfWater = <span class="type">Celsius</span>(fromFshreheit: <span class="number">273.15</span>)</span><br></pre></td></tr></table></figure>
<h3 id="14-2-2-内部和外部参数名"><a href="#14-2-2-内部和外部参数名" class="headerlink" title="14.2.2    内部和外部参数名"></a>14.2.2    内部和外部参数名</h3><blockquote>
<p><strong>说明：</strong>和<code>函数（方法）</code>不同点在于第一个参数也会有外部参数名（同后面的其它参数一样）。<br><strong>注意：</strong>如果构造起定义了某个外部参数名，就必须使用它。</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Color</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> red, green, blue: <span class="type">Double</span></span><br><span class="line">    <span class="comment">// 外部参数名默认同内部参数名</span></span><br><span class="line">    <span class="keyword">init</span>(red: <span class="type">Double</span>, green: <span class="type">Double</span>, blue: <span class="type">Double</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.red   = red</span><br><span class="line">        <span class="keyword">self</span>.green = green</span><br><span class="line">        <span class="keyword">self</span>.blue  = blue</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 取消外部参数名</span></span><br><span class="line">    <span class="keyword">init</span>(<span class="number">_</span> white: <span class="type">Double</span>) &#123;</span><br><span class="line">        red   = white</span><br><span class="line">        green = white</span><br><span class="line">        blue  = white</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果你在定义构造器时没有提供参数的外部名字，Swift 会为每个构造器的参数自动生成一个跟内部名字相同的外部名。</span></span><br><span class="line"><span class="keyword">let</span> magenta = <span class="type">Color</span>(red: <span class="number">1.0</span>, green: <span class="number">0.0</span>, blue: <span class="number">1.0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> halfGray = <span class="type">Color</span>(<span class="number">0.5</span>)</span><br></pre></td></tr></table></figure>
<h3 id="14-2-3-可选属性类型"><a href="#14-2-3-可选属性类型" class="headerlink" title="14.2.3    可选属性类型"></a>14.2.3    可选属性类型</h3><blockquote>
<p><strong>说明：</strong>如果你定制的类型包含一个逻辑上允许取值为空的存储型属性，需要将它定义为可选类型。</p>
<ul>
<li>可选类型的属性将自动初始化为<code>nil</code></li>
</ul>
<p><strong>使用场景</strong>：</p>
<ol>
<li>无法在初始化时赋值</li>
<li>在之后某个时间点可以赋值为空</li>
</ol>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 问题调查</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SurveryQuestion</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> text:<span class="type">String</span></span><br><span class="line">    <span class="comment">// 回答可以为空</span></span><br><span class="line">    <span class="keyword">var</span> response:<span class="type">String</span>?<span class="comment">// nil</span></span><br><span class="line">    <span class="keyword">init</span>(text:<span class="type">String</span>)&#123;</span><br><span class="line">        <span class="keyword">self</span>.text = text</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">ask</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">println</span>(text)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> cheeseQuestion = <span class="type">SurveryQuestion</span>(text: <span class="string">"Do you like cheese?"</span>)</span><br><span class="line">cheeseQuestion.ask()</span><br><span class="line">cheeseQuestion.response = <span class="string">"Yes, I do like cheese."</span></span><br></pre></td></tr></table></figure>
<h3 id="14-2-4-构造过程中常量属性的修改"><a href="#14-2-4-构造过程中常量属性的修改" class="headerlink" title="14.2.4    构造过程中常量属性的修改"></a>14.2.4    构造过程中常量属性的修改</h3><blockquote>
<p><strong>说明：</strong>可以在构造过程中的任意时间点修改常量属性的值</p>
</blockquote>
<table>
<thead>
<tr>
<th>实例属性类型</th>
<th>可修改时机</th>
<th>是否可在子类中修改</th>
</tr>
</thead>
<tbody>
<tr>
<td>常量属性</td>
<td>构造过程结束前</td>
<td>否</td>
</tr>
<tr>
<td>变量属性</td>
<td>实例的整个生命周期</td>
<td>是</td>
</tr>
</tbody>
</table>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SurveyQuestion</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 常量属性</span></span><br><span class="line">    <span class="keyword">let</span> text: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> response: <span class="type">String</span>?</span><br><span class="line">    <span class="keyword">init</span>(text: <span class="type">String</span>) &#123;</span><br><span class="line">	    <span class="comment">// 在构造过程中修改常量</span></span><br><span class="line">        <span class="keyword">self</span>.text = text</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">ask</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(text)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> beetsQuestion = <span class="type">SurveyQuestion</span>(text: <span class="string">"How about beets?"</span>)</span><br><span class="line">beetsQuestion.ask()</span><br><span class="line"><span class="comment">// 输出 "How about beets?"</span></span><br><span class="line">beetsQuestion.response = <span class="string">"I also like beets. (But not with cheese.)"</span></span><br></pre></td></tr></table></figure>
<h2 id="14-3-默认构造器"><a href="#14-3-默认构造器" class="headerlink" title="14.3    默认构造器"></a>14.3    默认构造器</h2><blockquote>
<p><strong>说明：</strong>满足以下条件的<code>结构体</code>或<code>类</code>会拥有一个默认的构造器。</p>
<ol>
<li>所有属性已提供默认值</li>
<li>自身没有定义任何构造器</li>
</ol>
<p><strong>注意：</strong>类必须要没有父类的基类</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1:所有属性都有默认值；2:基类；3:没有定义构造器</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShoppingListItem</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> name:<span class="type">String</span>?</span><br><span class="line">    <span class="keyword">var</span> quantity = <span class="number">1</span></span><br><span class="line">    <span class="keyword">var</span> purchased = <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> item = <span class="type">ShoppingListItem</span>()</span><br></pre></td></tr></table></figure>
<h3 id="14-3-1-结构体的逐一成员构造器"><a href="#14-3-1-结构体的逐一成员构造器" class="headerlink" title="14.3.1    结构体的逐一成员构造器"></a>14.3.1    结构体的逐一成员构造器</h3><blockquote>
<p><strong>说明：</strong>满足了以下条件的<code>结构体</code>将自动获得一个<code>逐一成员构造器</code>。</p>
<ul>
<li>没有自定义构造器</li>
</ul>
<p><strong>用途</strong>：用来初始化结构体新实例里成员属性的快捷方法<br><strong>语法</strong>：在调用逐一成员构造器时，通过与成员属性名相同的参数名进行传值来完成对成员属性的初始赋值。</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Size</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> width = <span class="number">0.0</span>, height = <span class="number">0.0</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 通过逐一成员构造器创建结构体实例</span></span><br><span class="line"><span class="keyword">let</span> twoByTwo = <span class="type">Size</span>(width: <span class="number">2.0</span>, height: <span class="number">2.0</span>)</span><br></pre></td></tr></table></figure>
<h2 id="14-4-值类型的构造器代理"><a href="#14-4-值类型的构造器代理" class="headerlink" title="14.4    值类型的构造器代理"></a>14.4    值类型的构造器代理</h2><blockquote>
<p><strong>说明</strong>：<code>构造器代理</code>指在构造器中调用其它构造器完成构造过程</p>
</blockquote>
<table>
<thead>
<tr>
<th>类型</th>
<th></th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>值类型</td>
<td>结构体、枚举</td>
<td>只能代理给本身提供的其它构造器，可以在构造器内部使用<code>self.init</code>调用其它构造器</td>
</tr>
<tr>
<td>类类型</td>
<td>类</td>
<td>代理给本身的构造器或父类的构造器（完成父类的初始化）</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>注意：</strong>一旦在类型的原始定义中定义了构造器</p>
<ul>
<li><strong>结构体：</strong>无法访问<code>默认构造器</code>和<code>逐一成员构造器</code></li>
<li><strong>类：</strong>无法访问<code>默认构造器</code></li>
</ul>
<p><strong>引伸：</strong>假如你希望<code>默认构造器</code>、<code>逐一成员构造器</code>以及你自己的<code>自定义构造器</code>都能用来创建实例，可以将自定义的构造器写到<code>扩展</code>中。</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Size</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> width = <span class="number">0.0</span>, height = <span class="number">0.0</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Point</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> x = <span class="number">0.0</span>, y = <span class="number">0.0</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Rect</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> origin = <span class="type">Point</span>()</span><br><span class="line">    <span class="keyword">var</span> size = <span class="type">Size</span>()</span><br><span class="line">    <span class="comment">//充当默认构造器（原本的默认构造器不符合存在条件）:没有执行任何定制的构造过程，将返回一个Rect实例</span></span><br><span class="line">    <span class="keyword">init</span>()&#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//充当逐一成员构造器（原本的默认成员逐一构造器不符合存在条件）</span></span><br><span class="line">    <span class="keyword">init</span>(origin:<span class="type">Point</span>, size:<span class="type">Size</span>)&#123;</span><br><span class="line">        <span class="keyword">self</span>.origin = origin</span><br><span class="line">        <span class="keyword">self</span>.size = size</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//该构造器将部分构造过程代理给上面的第二个构造器</span></span><br><span class="line">    <span class="keyword">init</span>(center:<span class="type">Point</span>, size:<span class="type">Size</span>)&#123;</span><br><span class="line">        <span class="keyword">let</span> originX = center.x - (size.width / <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">let</span> originY = center.y - (size.height / <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">self</span>.<span class="keyword">init</span>(origin:<span class="type">Point</span>(x:originX, y:originY), size:size)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用第一个构造器</span></span><br><span class="line"><span class="keyword">let</span> basicRect = <span class="type">Rect</span>()<span class="comment">//basicRect的原点(0.0, 0.0)，尺寸是(5.0, 5.0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//使用第二个构造器</span></span><br><span class="line"><span class="keyword">let</span> originRect = <span class="type">Rect</span>(origin: <span class="type">Point</span>(x: <span class="number">2.0</span>, y: <span class="number">2.0</span>), size:<span class="type">Size</span>(width: <span class="number">3.0</span>, height: <span class="number">3.0</span>))<span class="comment">//originRect的原点是（2.0, 2.0）,尺寸是(5.0, 5.0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//使用第三个构造器</span></span><br><span class="line"><span class="keyword">let</span> centerRect = <span class="type">Rect</span>(center: <span class="type">Point</span>(x:<span class="number">4.0</span>, y:<span class="number">4.0</span>), size: <span class="type">Size</span>(width: <span class="number">3.0</span>, height: <span class="number">3.0</span>))<span class="comment">//centerRect的原点是（2.5, 2.5）,尺寸是(3.0, 3.0)</span></span><br></pre></td></tr></table></figure>
<h2 id="14-5-类的继承和构造过程"><a href="#14-5-类的继承和构造过程" class="headerlink" title="14.5    类的继承和构造过程"></a>14.5    类的继承和构造过程</h2><blockquote>
<p><strong>说明：</strong><code>类</code>里面的所有<code>存储型属性</code>（包括所有继承自父类的属性）都必须在构造过程中设置初始值。<code>Swift</code> 为类提供了两种构造器来确保实例中所有存储型属性都能获得初始值</p>
<ul>
<li>指定构造器</li>
<li>便利构造器</li>
</ul>
</blockquote>
<h3 id="14-5-1-指定构造器和便利构造器"><a href="#14-5-1-指定构造器和便利构造器" class="headerlink" title="14.5.1    指定构造器和便利构造器"></a>14.5.1    指定构造器和便利构造器</h3><blockquote>
<p><strong>说明：</strong><code>指定构造器</code>是类中最主要的构造器，<code>便利构造器</code>是类中比较次要的、辅助型的构造器。</p>
</blockquote>
<table>
<thead>
<tr>
<th>特性</th>
<th>指定构造器</th>
<th>便利构造器</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>使用场景</strong></td>
<td>必需</td>
<td>必要时（快捷调用某个指定构造器来使类更加清晰）</td>
</tr>
<tr>
<td><strong>数量</strong></td>
<td>至少一个(可以从父类继承)</td>
<td>至少零个</td>
</tr>
<tr>
<td><strong>用途</strong></td>
<td>初始化类中所有属性，初始化父类</td>
<td>次要、辅助型构造器</td>
</tr>
<tr>
<td><strong>使用</strong></td>
<td>根据父类链往上调用父类的构造器</td>
<td>调用同一个类中的指定构造器</td>
</tr>
<tr>
<td><strong>构造器链规则</strong></td>
<td>总是向上代理</td>
<td>总是横向代理</td>
</tr>
</tbody>
</table>
<pre><code>&gt;**语法：**`指定构造器`和`便利构造器`
</code></pre><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 指定构造器</span></span><br><span class="line"><span class="keyword">init</span>(parameters) &#123;</span><br><span class="line">    statements</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 便利构造器：init关键字之前放置convenience关键字</span></span><br><span class="line"><span class="keyword">convenience</span> <span class="keyword">init</span>(parameters) &#123;</span><br><span class="line">    statements</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="14-5-2-构造器链"><a href="#14-5-2-构造器链" class="headerlink" title="14.5.2    构造器链"></a>14.5.2    构造器链</h3><ul>
<li><strong>指定构造器</strong></li>
</ul>
<ol>
<li>必须调用直接父类的指定构造器</li>
</ol>
<ul>
<li><strong>便利构造器</strong></li>
</ul>
<ol>
<li>必须调用同一类中的其它构造器</li>
<li>必须最终以调用一个指定构造器结束</li>
</ol>
<h3 id="14-5-3-两段式构造过程"><a href="#14-5-3-两段式构造过程" class="headerlink" title="14.5.3    两段式构造过程"></a>14.5.3    两段式构造过程</h3><h4 id="14-5-3-1-两个阶段"><a href="#14-5-3-1-两个阶段" class="headerlink" title="14.5.3.1     两个阶段"></a>14.5.3.1     两个阶段</h4><blockquote>
<p><strong>阶段一：</strong>通过构造器设置初始值</p>
</blockquote>
<table>
<thead>
<tr>
<th>成员</th>
<th>状态</th>
</tr>
</thead>
<tbody>
<tr>
<td>实例方法</td>
<td>不能调用</td>
</tr>
<tr>
<td>实例属性</td>
<td>不能读取</td>
</tr>
<tr>
<td><code>self</code></td>
<td>不能引用</td>
</tr>
</tbody>
</table>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">st=&gt;start: 开始</span><br><span class="line">e=&gt;end: 结束</span><br><span class="line">op1=&gt;operation: 构造器被调用（某个指定构造器或便利构造器）</span><br><span class="line">op2=&gt;operation: 完成新实例内存的分配（内存并没有真的被初始化）</span><br><span class="line">op3=&gt;operation: 由指定构造器确保所在类中的所有存储属性完成赋值（内存完成初始化）</span><br><span class="line">op4=&gt;operation: 指定构造器沿着构造器链依次调用父类构造器（完成父类属性初始化）</span><br><span class="line">cond=&gt;condition: 是否有父类?</span><br><span class="line"></span><br><span class="line">st-&gt;op1-&gt;op2-&gt;op3-&gt;cond</span><br><span class="line">cond(yes)-&gt;op4-&gt;e</span><br><span class="line">cond(no)-&gt;e</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>阶段二：</strong>在新实例准备使用之前进一步定制它们的存储型属性(可以访问<code>self</code>，修改属性、调用实例方法)<br><strong>特点：</strong>沿构造器链从上往下</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">st=&gt;start: 开始</span><br><span class="line">e=&gt;end: 结束</span><br><span class="line">op1=&gt;operation: 构造器链上的每个类的指定构造器完成对父类的构造（代理方式）之后，进一步定制实例</span><br><span class="line"> </span><br><span class="line">st-&gt;op1-&gt;e</span><br></pre></td></tr></table></figure>
<h4 id="14-5-3-2-安全检查"><a href="#14-5-3-2-安全检查" class="headerlink" title="14.5.3.2        安全检查"></a>14.5.3.2        安全检查</h4><ul>
<li>指定构造器中的安全检查</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">st=&gt;start: 调用指定构造器</span><br><span class="line">e=&gt;end: 结束</span><br><span class="line">op1=&gt;operation: 所在类所有属性初始化完成</span><br><span class="line">op2=&gt;operation: 将其它构造任务向上代理给父类的构造器</span><br><span class="line">op3=&gt;operation: 为继承的属性设置新值</span><br><span class="line">op5=&gt;operation: 指定构造器赋予的新值将被父类中的构造器覆盖</span><br><span class="line">op4=&gt;operation: 对象内存初始化失败</span><br><span class="line">cond1=&gt;condition: 检查1：上一步是否完成？</span><br><span class="line">cond2=&gt;condition: 检查2：上一步是否执行？</span><br><span class="line">st-&gt;op1-&gt;cond1</span><br><span class="line">cond1(yes)-&gt;op2-&gt;cond2</span><br><span class="line">cond1(no)-&gt;op4-&gt;op2</span><br><span class="line">cond2(yes)-&gt;op3-&gt;e</span><br><span class="line">cond2(no)-&gt;op5-&gt;op3</span><br></pre></td></tr></table></figure>
<ul>
<li>便利构造器中的安全检查</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">st=&gt;start: 调用便利构造器</span><br><span class="line">e=&gt;end: 结束</span><br><span class="line">op1=&gt;operation: 代理调用所在类中的其它构造器</span><br><span class="line">op2=&gt;operation: 为继承的属性设置新值</span><br><span class="line">op3=&gt;operation: 便利构造器赋予的新值将被所在类中的其它指定构造器覆盖</span><br><span class="line">op4=&gt;operation: 不能调用方法、访问属性的值、调用self</span><br><span class="line">cond1=&gt;condition: 检查3：上一步是否完成？</span><br><span class="line">cond2=&gt;condition: 检查4：第一阶段是否构造完成？</span><br><span class="line"></span><br><span class="line">st-&gt;op1-&gt;cond1</span><br><span class="line">cond1(yes)-&gt;op2-&gt;cond2</span><br><span class="line">cond1(no)-&gt;op3-&gt;op2</span><br><span class="line">cond2(yes)-&gt;e</span><br><span class="line">cond2(no)-&gt;op4-&gt;e</span><br></pre></td></tr></table></figure>
<h3 id="14-5-4-构造器的继承和重写"><a href="#14-5-4-构造器的继承和重写" class="headerlink" title="14.5.4    构造器的继承和重写"></a>14.5.4    构造器的继承和重写</h3><blockquote>
<p><strong>说明：</strong>编写一个和父类中指定构造器相匹配的子类构造器时，你实际上是在重写父类的这个指定构造器。</p>
<ul>
<li>子类不会默认继承父类的构造器(除非满足一定条件)</li>
<li>子类可以重载父类的构造器</li>
<li>子类可以在初始化时修改继承来的<code>变量属性</code>，但是不能修改继承来的<code>常量属性</code></li>
<li>重载构造器一定需要使用<code>override</code>（即使将父类的指定构造器重写为了便利构造器）</li>
</ul>
<p><strong>注意：</strong>子类中“重写”一个父类<code>便利构造器</code>时，不需要加<code>override</code>前缀（子类不能直接调用父类的<code>便利构造器</code>，因此并没有真的<code>重写</code>）</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 基类（超类、父类）</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Vehicle</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> numberOfWheels = <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> description: <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"\(numberOfWheels) wheel(s)"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> vehicle = <span class="type">Vehicle</span>()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"Vehicle:\(vehicle.description)"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 子类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bicycle</span>: <span class="title">Vehicle</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 重写父类的默认构造器</span></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">init</span>() &#123;</span><br><span class="line">        <span class="comment">// 代理到父类的默认构造器</span></span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>()</span><br><span class="line">        numberOfWheels = <span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> bicycle = <span class="type">Bicycle</span>()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"Bicycle:\(bicycle.description)"</span>)</span><br></pre></td></tr></table></figure>
<h3 id="14-5-5-自动构造器的继承"><a href="#14-5-5-自动构造器的继承" class="headerlink" title="14.5.5    自动构造器的继承"></a>14.5.5    自动构造器的继承</h3><blockquote>
<p><strong>说明：</strong>子类在默认情况下不会继承父类的构造器。但是如果满足特定条件，父类构造器是可以被自动继承的。</p>
</blockquote>
<table>
<thead>
<tr>
<th>特定条件</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>子类没有定义任何指定构造器</td>
<td>自动继承父类所有的指定构造器</td>
</tr>
<tr>
<td>子类提供了所有父类构造器的实现（继承过来的也算）</td>
<td>自动继承所有父类的便利构造器</td>
</tr>
</tbody>
</table>
<h4 id="14-5-5-1-指定构造器和便利构造器语法"><a href="#14-5-5-1-指定构造器和便利构造器语法" class="headerlink" title="14.5.5.1        指定构造器和便利构造器语法"></a>14.5.5.1        指定构造器和便利构造器语法</h4><blockquote>
<ul>
<li><strong>指定构造器</strong></li>
</ul>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">init</span>(parameters)&#123;</span><br><span class="line">	<span class="comment">//构造过程</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li><strong>便利构造器</strong></li>
</ul>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">convenience</span> <span class="keyword">init</span>(paramaters)&#123;</span><br><span class="line">	<span class="comment">//构造过程</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="14-5-5-2-指定构造器和便利构造器实战"><a href="#14-5-5-2-指定构造器和便利构造器实战" class="headerlink" title="14.5.5.2        指定构造器和便利构造器实战"></a>14.5.5.2        指定构造器和便利构造器实战</h4><blockquote>
<p>第一层：食品类</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">*父类</span><br><span class="line">*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Food</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> name:<span class="type">String</span></span><br><span class="line">    <span class="comment">//指定构造器</span></span><br><span class="line">    <span class="keyword">init</span>(name:<span class="type">String</span>)&#123;</span><br><span class="line">        <span class="keyword">self</span>.name = name</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//便利构造器</span></span><br><span class="line">    <span class="keyword">convenience</span> <span class="keyword">init</span>()&#123;</span><br><span class="line">        <span class="comment">//代理给指定构造器</span></span><br><span class="line">        <span class="keyword">self</span>.<span class="keyword">init</span>(name:<span class="string">"[Unnamed]"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用指定构造器</span></span><br><span class="line"><span class="keyword">let</span> namedMeat = <span class="type">Food</span>(name:<span class="string">"Bacon"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用便利构造器</span></span><br><span class="line"><span class="keyword">let</span> mysteryMeat = <span class="type">Food</span>();</span><br></pre></td></tr></table></figure>
<blockquote>
<p>第二层：调味剂类</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">*子类(继承了父类的构造器)</span><br><span class="line">*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RecipeIngredient</span>:<span class="title">Food</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> quantity:<span class="type">Int</span></span><br><span class="line">    <span class="comment">//子类特制的构造器</span></span><br><span class="line">    <span class="keyword">init</span>(name:<span class="type">String</span>, quantity:<span class="type">Int</span>)&#123;</span><br><span class="line">        <span class="keyword">self</span>.quantity = quantity</span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>(name:name)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//重写父类的便利构造器</span></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">convenience</span> <span class="keyword">init</span>(name:<span class="type">String</span>)&#123;</span><br><span class="line">        <span class="keyword">self</span>.<span class="keyword">init</span>(name:name, quantity:<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用父类的便利构造器</span></span><br><span class="line"><span class="keyword">let</span> oneMysteryItem = <span class="type">RecipeIngredient</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用子类的便利构造器（重写了父类的指定构造器）</span></span><br><span class="line"><span class="keyword">let</span> oneBacon = <span class="type">RecipeIngredient</span>(name:<span class="string">"Bacon"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用子类自己的指定构造器</span></span><br><span class="line"><span class="keyword">let</span> sixEggs = <span class="type">RecipeIngredient</span>(name: <span class="string">"Eggs"</span>, quantity: <span class="number">6</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>第三层：购物清单类</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">*子类的子类</span><br><span class="line">*继承父类所有指定构造器和便利构造器（1.所有属性提供了默认值；2.自己没有定义任何构造器；）</span><br><span class="line">*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShoppingListItem</span>:<span class="title">RecipeIngredient</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> purchased = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">var</span> description:<span class="type">String</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> output = <span class="string">"\(quantity) x \(name)"</span></span><br><span class="line">        output += purchased ? <span class="string">"√"</span> : <span class="string">"x"</span></span><br><span class="line">        <span class="keyword">return</span> output</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> breakfastList = [</span><br><span class="line">    <span class="type">ShoppingListItem</span>(),</span><br><span class="line">    <span class="type">ShoppingListItem</span>(name: <span class="string">"Bacon"</span>),</span><br><span class="line">    <span class="type">ShoppingListItem</span>(name: <span class="string">"Eggs"</span>, quantity: <span class="number">6</span>)</span><br><span class="line">]</span><br><span class="line">breakfastList[<span class="number">0</span>].name = <span class="string">"Orange juice"</span></span><br><span class="line">breakfastList[<span class="number">0</span>].purchased = <span class="literal">true</span></span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> breakfastList&#123;</span><br><span class="line">    <span class="built_in">println</span>(item.description)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="14-6-可失败构造器"><a href="#14-6-可失败构造器" class="headerlink" title="14.6    可失败构造器"></a>14.6    可失败构造器</h2><blockquote>
<p><strong>支持：</strong>类、结构体、枚举<br><strong>说明：</strong>在构造自身的过程中有可能失败的情况，可以定义一个（或多个）可失败的构造器，“失败”是指</p>
<ol>
<li>构造器传入无效的参数</li>
<li>缺少某种需要的外部资源</li>
<li>不满足某种必要条件等</li>
</ol>
<p><strong>语法：</strong><code>init?</code></p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">init</span>? (...) &#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>注意：</strong>严格说来构造器并不支持返回值（失败构造器表明失败的<code>return</code>是个特例）</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Animal</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> species:<span class="type">String</span></span><br><span class="line">    <span class="keyword">init</span>?(species:<span class="type">String</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span> species.isEmpty &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.species = species</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//构造成功案例</span></span><br><span class="line"><span class="keyword">let</span> someCreature = <span class="type">Animal</span>(species: <span class="string">"Giraffe"</span>)<span class="comment">//Animal?类型</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> giraffe = someCreature&#123;</span><br><span class="line">    <span class="built_in">println</span>(<span class="string">"An animal was initialzed with a species of \(giraffe.species)"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//构造失败案例</span></span><br><span class="line"><span class="keyword">let</span> anonymousCreature = <span class="type">Animal</span>(species: <span class="string">""</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> anonymousCreature == <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="built_in">println</span>(<span class="string">"The anonymous creature could not be initialized"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="14-6-1-枚举类型的可失败构造器"><a href="#14-6-1-枚举类型的可失败构造器" class="headerlink" title="14.6.1        枚举类型的可失败构造器"></a>14.6.1        枚举类型的可失败构造器</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">TemperatureUnit</span></span>&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">Kelvin</span>, <span class="type">Celsius</span>, <span class="type">Fahrenheit</span></span><br><span class="line">    <span class="comment">//可失败构造器：当没有匹配的项时构造失败</span></span><br><span class="line">    <span class="keyword">init</span>?(symbol:<span class="type">Character</span>)&#123;</span><br><span class="line">        <span class="keyword">switch</span> symbol &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"K"</span>:</span><br><span class="line">                <span class="keyword">self</span> = .<span class="type">Kelvin</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">"C"</span>:</span><br><span class="line">                <span class="keyword">self</span> = .<span class="type">Celsius</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">"F"</span>:</span><br><span class="line">                <span class="keyword">self</span> = .<span class="type">Fahrenheit</span></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//构造成功例子</span></span><br><span class="line"><span class="keyword">let</span> fahrenheitUnit = <span class="type">TemperatureUnit</span>(symbol: <span class="string">"F"</span>)</span><br><span class="line"><span class="keyword">if</span> fahrenheitUnit != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="built_in">println</span>(<span class="string">"This is a defined temperature unit , so initialization succeeded."</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//构造失败例子</span></span><br><span class="line"><span class="keyword">let</span> unknowUnit = <span class="type">TemperatureUnit</span>(symbol:<span class="string">"F"</span>)</span><br><span class="line"><span class="keyword">if</span> unknowUnit == <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="built_in">println</span>(<span class="string">"This is a defined temperature unit, so initialization succeeded."</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="14-6-2-带原始值的枚举类型的可失败构造器"><a href="#14-6-2-带原始值的枚举类型的可失败构造器" class="headerlink" title="14.6.2        带原始值的枚举类型的可失败构造器"></a>14.6.2        带原始值的枚举类型的可失败构造器</h3><blockquote>
<p><strong>说明：</strong>带原始值的枚举类型会自带一个可失败构造器</p>
<ul>
<li>该可失败构造器有一个名为<code>rawValue</code>的参数，其类型和枚举类型的原始值类型一致</li>
<li>如果该参数的值能够和某个枚举成员的原始值匹配，则该构造器会构造相应的枚举成员，否则构造失败</li>
</ul>
<p><strong>语法：</strong><code>init?(rawValue:)</code></p>
</blockquote>
<table>
<thead>
<tr>
<th>组成</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>参数名</td>
<td><code>rawValue</code></td>
</tr>
<tr>
<td>参数类型</td>
<td>和case的原始值（绑定的值）类型一致</td>
</tr>
<tr>
<td>返回值</td>
<td>参数和某个成员的原始值匹配则返回该值；否则构造失败，返回<code>nil</code></td>
</tr>
</tbody>
</table>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">TemperatureUnit</span>:<span class="title">Character</span></span>&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">Kelvin</span> = <span class="string">"K"</span>, <span class="type">Celsius</span> = <span class="string">"C"</span>, <span class="type">Fahrenheit</span> = <span class="string">"F"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//构造成功例子</span></span><br><span class="line"><span class="keyword">let</span> fahrenheitUnit = <span class="type">TemperatureUnit</span>(rawValue: <span class="string">"F"</span>)</span><br><span class="line"><span class="keyword">if</span> fahrenheitUnit != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="built_in">println</span>(<span class="string">"This is a defined temperature unit , so initialization succeeded."</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//构造失败例子</span></span><br><span class="line"><span class="keyword">let</span> unknowUnit = <span class="type">TemperatureUnit</span>(rawValue:<span class="string">"F"</span>)</span><br><span class="line"><span class="keyword">if</span> unknowUnit == <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="built_in">println</span>(<span class="string">"This is a defined temperature unit, so initialization succeeded."</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="14-6-3-类的可失败构造器"><a href="#14-6-3-类的可失败构造器" class="headerlink" title="14.6.3        类的可失败构造器"></a>14.6.3        类的可失败构造器</h3><blockquote>
<p><strong>说明：</strong>类的所有属性被初始化完毕，以及构造器之间的代理调用都结束后才能触发败行为。</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Product</span> </span>&#123;</span><br><span class="line">    <span class="comment">//隐式解析可选类型</span></span><br><span class="line">    <span class="keyword">let</span> name:<span class="type">String</span>!<span class="comment">//默认为nil</span></span><br><span class="line">    <span class="keyword">init</span>?(name:<span class="type">String</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span> name.isEmpty &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.name = name</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="14-6-4-构造失败的传递"><a href="#14-6-4-构造失败的传递" class="headerlink" title="14.6.4        构造失败的传递"></a>14.6.4        构造失败的传递</h3><blockquote>
<p><strong>传递方式：</strong><code>横向代理</code>和<code>向上代理</code></p>
</blockquote>
<table>
<thead>
<tr>
<th>传递方式</th>
<th>支持</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>横向代理</td>
<td>结构体、枚举、类</td>
<td>可失败构造器可以横向代理其它构造器（包括可失败构造器）</td>
</tr>
<tr>
<td>向上代理</td>
<td>类</td>
<td>子类的可失败构造器可以向上代理父类的构造器（包括可失败构造器）</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>注意：</strong></p>
<ol>
<li>当代理可失败构造器触发构造失败时，整个构造过程将终止（无论横向代理还是向上代理）</li>
<li>非可失败构造器不能代理失败构造器 (<code>init!</code>声明的除外，但会触发断言)</li>
</ol>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Product</span> </span>&#123;</span><br><span class="line">    <span class="comment">//隐式解析可选类型</span></span><br><span class="line">    <span class="keyword">let</span> name:<span class="type">String</span>!<span class="comment">//默认为nil</span></span><br><span class="line">    <span class="keyword">init</span>?(name:<span class="type">String</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span> name.isEmpty &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.name = name</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CartItem</span>:<span class="title">Product</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> quantity:<span class="type">Int</span>!<span class="comment">//确保构造失败仍完成初始化</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//可失败构造器</span></span><br><span class="line">    <span class="keyword">init</span>?(name:<span class="type">String</span>, quantity:<span class="type">Int</span>)&#123;</span><br><span class="line">        <span class="comment">//在可能触发构造失败的代理之前完成代理构造过程</span></span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>(name: name)</span><br><span class="line">        <span class="keyword">if</span> quantity &lt; <span class="number">1</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.quantity = quantity</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//1.构造成功案例</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> twoSocks = <span class="type">CartItem</span>(name: <span class="string">"sock"</span>, quantity: <span class="number">2</span>)&#123;</span><br><span class="line">    <span class="built_in">println</span>(<span class="string">"Item:\(twoSocks.name), quantity:\(twoSocks.quantity)"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//2.子类自身构造失败</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> zeroShirts = <span class="type">CartItem</span>(name: <span class="string">"shirt"</span>, quantity: <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="built_in">println</span>(<span class="string">"Item:\(zeroShirts.name), quantity:\(zeroShirts.quantity)"</span>)</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="built_in">println</span>(<span class="string">"Unable to initialize zero shirt"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//3.代理父类构造过程失败</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> oneUnnamed = <span class="type">CartItem</span>(name: <span class="string">""</span>, quantity: <span class="number">1</span>)&#123;</span><br><span class="line">    <span class="built_in">println</span>(<span class="string">"Item:\(oneUnnamed.name),quantity:\(oneUnnamed.quantity)"</span>)</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="built_in">println</span>(<span class="string">"Unable to initialize one unnamed product"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="14-6-5-重写一个可失败构造器"><a href="#14-6-5-重写一个可失败构造器" class="headerlink" title="14.6.5        重写一个可失败构造器"></a>14.6.5        重写一个可失败构造器</h3><blockquote>
<p><strong>说明：</strong>可以在子类中重写父类的<code>可失败构造器</code>（通过定义一个<code>可失败构造器</code>或<code>非可失败构造器</code>）<br><strong>用途：</strong>即使父类的构造器为可失败构造器，但当子类的构造器在构造过程不可能失败时，我们也可以把它修改过来。<br><strong>情景：</strong></p>
<ol>
<li>子类的<code>可失败构造器</code>覆盖父类的可失败构造器</li>
<li>子类的<code>非可失败构造器</code>覆盖父类的可失败构造器</li>
</ol>
<p><strong>注意：</strong></p>
<ul>
<li>当你用子类的<code>非可失败构造器</code>重写父类的可失败构造器时，向上代理到父类的可失败构造器的唯一方式是对父类的可失败构造器的返回值进行<code>强制解包</code>。</li>
<li>你可以用<code>非可失败构造器</code>重写可失败构造器，但反过来却不行</li>
</ul>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 父类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Document</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 该构造器创建了一个 name 属性的值为 nil 的 document 实例</span></span><br><span class="line">    <span class="keyword">var</span> name: <span class="type">String</span>?</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 非可失败构造器</span></span><br><span class="line">    <span class="keyword">init</span>() &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 可失败构造器</span></span><br><span class="line">    <span class="keyword">init</span>?(name: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.name = name</span><br><span class="line">        <span class="keyword">if</span> name.isEmpty &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 子类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AutomaticallyNamedDocument</span>: <span class="title">Document</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 重写非可失败构造器</span></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">init</span>() &#123;</span><br><span class="line">        <span class="comment">// 代理到父类的可失败构造器</span></span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>()</span><br><span class="line">        <span class="keyword">self</span>.name = <span class="string">"[Untitled]"</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 重写失败构造器</span></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">init</span>(name: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="comment">// 代理到父类的非可失败构造器</span></span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>()</span><br><span class="line">        <span class="keyword">if</span> name.isEmpty &#123;</span><br><span class="line">            <span class="keyword">self</span>.name = <span class="string">"[Untitled]"</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.name = name</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 子类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UntitledDocument</span>: <span class="title">Document</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 重写父类的非可失败构造器</span></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">init</span>() &#123;</span><br><span class="line">        <span class="comment">// 使用强制解包来调用父类的可失败构造器</span></span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>(name: <span class="string">"[Untitled]"</span>)!</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="14-6-6-可失败构造器init"><a href="#14-6-6-可失败构造器init" class="headerlink" title="14.6.6        可失败构造器init!"></a>14.6.6        可失败构造器<code>init!</code></h3><blockquote>
<p><strong>说明：</strong>构造<code>可失败构造器</code>其实有两种方式，两种方式创建的构造器可以相互<code>代理调用</code>，也可以相互<code>重写</code>对方。</p>
<ul>
<li><code>init?</code></li>
<li><code>init!</code>：会构建一个相应类型的隐式解包可选类型的对象。</li>
</ul>
<p><strong>描述：</strong>用<code>init!</code>声明的<code>可失败构造器</code><br><strong>注意：</strong>还可以用<code>init</code>代理到<code>init!</code>，不过，一旦<code>init!</code>构造失败，则会触发一个断言。</p>
</blockquote>
<h2 id="14-7-必要构造器"><a href="#14-7-必要构造器" class="headerlink" title="14.7    必要构造器"></a>14.7    必要构造器</h2><blockquote>
<p><strong>说明：</strong>在类的构造器前添加<code>required</code>修饰符，称为<code>必要构造器</code>。所有该类的子类都必须实现该构造器。在子类重写父类的<code>必要构造器时</code>，必须在子类的构造器前也添加<code>required</code>修饰符。</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 父类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SomeClass</span> </span>&#123;</span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">init</span>()&#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 子类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SomeSubClass</span>:<span class="title">SomeClass</span> </span>&#123;</span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">init</span>() &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="14-8-通过闭包和函数来设置属性的默认值"><a href="#14-8-通过闭包和函数来设置属性的默认值" class="headerlink" title="14.8    通过闭包和函数来设置属性的默认值"></a>14.8    通过闭包和函数来设置属性的默认值</h2><blockquote>
<p><strong>说明：</strong>如果某个<code>存储型属性的默认值</code>需要一些<code>定制或设置</code>，你可以使用<code>闭包</code>或<code>全局函数</code>为其提供定制的默认值。<br><strong>限制：</strong><code>立即执行闭包</code>执行时，实例的其他部分还没有初始化，因此</p>
<ol>
<li>不能够在闭包中访问其它属性</li>
<li>不能使用<code>self</code>属性</li>
<li>不能调用其它实例方法</li>
</ol>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="class"><span class="keyword">class</span> <span class="title">SomeClass</span>:<span class="title">SomeType</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> someProperty:<span class="type">SomeType</span> = &#123;</span><br><span class="line">        <span class="comment">//在这个必包中给someProperty创建一个默认值</span></span><br><span class="line">        <span class="comment">//someValue必须和SomeType类型相同</span></span><br><span class="line">        <span class="keyword">return</span> someValue</span><br><span class="line">    &#125;()<span class="comment">//立即执行此闭包（否则将会将必包本身赋值给属性）</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Checkedboard</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> boardColors:[<span class="type">Bool</span>] = &#123;</span><br><span class="line">        <span class="keyword">var</span> temporaryBoard = [<span class="type">Bool</span>]()</span><br><span class="line">        <span class="keyword">var</span> isBlack = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">1</span>...<span class="number">10</span>&#123;</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="number">1</span>...<span class="number">10</span>&#123;</span><br><span class="line">                temporaryBoard.append(isBlack)</span><br><span class="line">                isBlack = !isBlack</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> temporaryBoard</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">squareIsBlackAtRow</span><span class="params">(row:Int, column:Int)</span></span>-&gt;<span class="type">Bool</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> boardColors[(row * <span class="number">10</span>) + column]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> board = <span class="type">Checkedboard</span>()</span><br><span class="line"><span class="built_in">println</span>(board.squareIsBlackAtRow(<span class="number">0</span>, column: <span class="number">1</span>))</span><br><span class="line"><span class="built_in">println</span>(board.squareIsBlackAtRow(<span class="number">9</span>, column: <span class="number">9</span>))</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Sean" />
          <p class="site-author-name" itemprop="name">Sean</p>
          <p class="site-description motion-element" itemprop="description">整理了一批过去一段时间ios相关的笔记，其它的笔记也整理下？源码分享出来？再说吧...反正也只有自己会看吧...</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">100</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Sean</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"lapuda-er"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  

  

  

  

</body>
</html>
